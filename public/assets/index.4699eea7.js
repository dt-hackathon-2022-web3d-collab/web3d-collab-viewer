var Zm=Object.defineProperty,Km=Object.defineProperties;var eg=Object.getOwnPropertyDescriptors;var bh=Object.getOwnPropertySymbols;var tg=Object.prototype.hasOwnProperty,ig=Object.prototype.propertyIsEnumerable;var ga=(i,e,t)=>e in i?Zm(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,dt=(i,e)=>{for(var t in e||(e={}))tg.call(e,t)&&ga(i,t,e[t]);if(bh)for(var t of bh(e))ig.call(e,t)&&ga(i,t,e[t]);return i},_a=(i,e)=>Km(i,eg(e));var r=(i,e,t)=>(ga(i,typeof e!="symbol"?e+"":e,t),t);import{Q as P,V as y,P as sg,W as yh,a as ba,S as vh,b as wh,U as ng,E as he,M as ii,T as Hi,v as rg,O as x,c as Q,d as $,I as og,D as ag,e as lg,f as cg,g as hg,R as dg,Z as ug,K as fg,A as pg,G as mg,N as gg,h as _g,L as bg,i as yg,j as vg,k as wg,l as Be,m as Pg,n as ir,o as ya,p as xg,B as zi,q as Og,r as Cg,s as _e,t as si,u as Sg,w as Rg,x as Ph,C as Eg,y as va,z as Ag,F as Tg,H as xh,J as g,X as Lg,Y as Gi,_ as wa,$ as Pa,a0 as Oh,a1 as sr,a2 as Dg,a3 as kg,a4 as xa,a5 as Ig,a6 as Ch,a7 as Mg,a8 as jg,a9 as Fg,aa as Oa,ab as Sh,ac as Bg,ad as Ug,ae as Ng,af as Ca,ag as nr,ah as Rh,ai as $g,aj as Wg,ak as rr,al as Eh,am as Ah,an as $s,ao as Hg,ap as zg,aq as Th,ar as Gg,as as Vg,at as qg,au as Qg,av as Lh,aw as Xg,ax as Dh,ay as Ws,az as Yg,aA as Jg,aB as Zg,aC as Kg,aD as e_,aE as t_,aF as i_,aG as s_,aH as kh,aI as n_,aJ as r_,aK as o_,aL as a_,aM as l_,aN as c_,aO as Ih,aP as Sa,aQ as h_,aR as d_,aS as Mh,aT as u_,aU as f_,aV as p_,aW as m_,aX as jh,aY as Ra,aZ as g_,a_ as __,a$ as b_,b0 as y_,b1 as v_,b2 as Ea,b3 as Fh,b4 as Bh,b5 as Uh,b6 as w_,b7 as P_,b8 as x_,b9 as O_,ba as C_,bb as S_,bc as R_,bd as E_,be as A_,bf as T_,bg as Hs,bh as L_,bi as D_,bj as k_,bk as I_,bl as M_,bm as j_,bn as Nh}from"./vendor.f5e9bc67.js";const F_=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}};F_();const zs="__isActiveInHierarchy",Vi="builtin_components";function ni(i,e){try{e?i(e):i()}catch(t){return console.error(t),!1}return!0}var B_=Object.defineProperty,z=(i,e)=>B_(i,"name",{value:e,configurable:!0});const Aa=z(()=>i=>i,"nameofFactory");function U_(i){return Aa()(i)}z(U_,"nameof");function N_(){return!!O("debug")}z(N_,"isDebugMode");let Ta=!1;const La=[];setTimeout(()=>{Ta&&console.log(La)},100);function Gs(){return new URLSearchParams(window.location.search)}z(Gs,"getUrlParams");function O(i){Ta&&!La.includes(i)&&La.push(i);const e=Gs();if(e.has(i)){const t=e.get(i);return t||!0}return!1}z(O,"getParam");Ta=O("help")===!0;function $_(i,e){const t=Gs();t.has(i)?t.set(i,e):t.append(i,e),document.location.search=t.toString()}z($_,"setParam");function W_(i,e,t=!0){const s=Gs();s.has(i)?s.set(i,e):s.append(i,e),t?$h(i,s):Da(i,s)}z(W_,"setParamWithoutReload");function Vs(i,e,t){i.has(e)?i.set(e,t.toString()):i.append(e,t.toString())}z(Vs,"setOrAddParamsToUrl");function $h(i,e){window.history.pushState(null,i,"?"+e.toString())}z($h,"pushState");function Da(i,e){window.history.replaceState(null,i,"?"+e.toString())}z(Da,"setState");function H_(i){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=t.length,n=0;n<i;n++)e+=t.charAt(Math.floor(Math.random()*s));return e}z(H_,"makeId");function Wh(i,e){return Math.floor(Math.random()*(e-i+1))+i}z(Wh,"randomNumber");const Hh=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],zh=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function Gh(){const i=Hh[Math.floor(Math.random()*Hh.length)],e=zh[Math.floor(Math.random()*zh.length)];return i+"_"+e}z(Gh,"makeIdFromRandomWords");function Vh(i){return i=i.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,""),i.trim()}z(Vh,"sanitizeString");function ri(i,e,t=!0,s=!1){var n;if(e==null)return null;if(e.userData&&e.userData.guid===i)return e;if(e.guid==i)return e;if(s&&((n=e.userData)==null?void 0:n.components)){for(const o of e.userData.components)if(o.guid===i)return o}if(t){if(e.scenes)for(const o in e.scenes){const a=e.scenes[o],l=ri(i,a,t,s);if(l)return l}if(e.children)for(const o in e.children){const a=e.children[o],l=ri(i,a,t,s);if(l)return l}}}z(ri,"tryFindObject");function or(i,e){if(i!=null&&typeof i=="object"){let t;Array.isArray(i)?t=[]:(t=Object.create(i),Object.assign(t,i));for(const s of Object.keys(i)){const n=i[s];e&&!e(i,s,n)?t[s]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?t[s]=n.clone():t[s]=or(n,e)}return t}return i}z(or,"deepClone");function qh(i){return new Promise((e,t)=>{setTimeout(e,i)})}z(qh,"delay");function Qh(i,e){if(e&&i&&!e.includes("/")){const t=i.lastIndexOf("/");if(t>=0)return i.substring(0,t+1)+e}return e}z(Qh,"getPath");var z_=Object.defineProperty,Qe=(i,e)=>z_(i,"name",{value:e,configurable:!0});const G_=O("debugnewscripts"),j=[];function qi(i){if(!(i.new_scripts.length<=0)){if(G_&&console.log("Register new components",i.new_scripts.length,i.alias?"element: "+i.alias:""),i.new_scripts_pre_setup_callbacks.length>0){for(const e of i.new_scripts_pre_setup_callbacks)!e||e();i.new_scripts_pre_setup_callbacks.length=0}j.length=0,i.new_scripts.length>0&&j.push(...i.new_scripts),i.new_scripts.length=0;for(let e=0;e<j.length;e++)try{const t=j[e];if(t.destroyed)continue;if(!t.gameObject){console.error("MISSING GAMEOBJECT - will ignore",t),j.splice(e,1),e--;continue}t.context=i,Qi(t.gameObject),ka(t,i)}catch(t){console.error(t),ut(j[e],i),j.splice(e,1),e--}for(let e=0;e<j.length;e++)try{const t=j[e];if(t.destroyed){ut(j[e],i),j.splice(e,1),e--;continue}t.__internalAwake!==void 0&&(t.gameObject||console.error("MISSING GAMEOBJECT",t,t.gameObject),Qi(t.gameObject),t.activeAndEnabled&&ni(t.__internalAwake.bind(t)))}catch(t){console.error(t),ut(j[e],i),j.splice(e,1),e--}for(let e=0;e<j.length;e++)try{const t=j[e];if(t.destroyed||t.enabled===!1||(Qi(t.gameObject),t.activeAndEnabled===!1))continue;t.__internalEnable!==void 0&&(t.enabled=!0,ni(t.__internalEnable.bind(t)))}catch(t){console.error(t),ut(j[e],i),j.splice(e,1),e--}for(let e=0;e<j.length;e++)try{const t=j[e];if(t.destroyed||!t.gameObject)continue;i.new_script_start.push(t)}catch(t){console.error(t),ut(j[e],i),j.splice(e,1),e--}j.length=0;for(const e of i.new_scripts_post_setup_callbacks)e&&e();i.new_scripts_post_setup_callbacks.length=0}}Qe(qi,"processNewScripts");function Xh(i){!i||(i.__internalDisable(),ut(i,i.context))}Qe(Xh,"processRemoveFromScene");function Yh(i){for(let e=0;e<i.new_script_start.length;e++)try{const t=i.new_script_start[e];if(t.destroyed||t.activeAndEnabled===!1)continue;ni(t.__internalAwake.bind(t)),ni(t.__internalEnable.bind(t)),ni(t.__internalStart.bind(t)),i.new_script_start.splice(e,1),e--}catch(t){console.error(t),ut(i.new_script_start[e],i),i.new_script_start.splice(e,1),e--}}Qe(Yh,"processStart");function ka(i,e){e.scripts.indexOf(i)===-1&&(e.scripts.push(i),i.earlyUpdate&&e.scripts_earlyUpdate.push(i),i.update&&e.scripts_update.push(i),i.lateUpdate&&e.scripts_lateUpdate.push(i),i.onBeforeRender&&e.scripts_onBeforeRender.push(i),i.onAfterRender&&e.scripts_onAfterRender.push(i))}Qe(ka,"addScriptToArrays");function ut(i,e){ft(i,e.new_scripts),ft(i,e.new_script_start),ft(i,e.scripts),ft(i,e.scripts_earlyUpdate),ft(i,e.scripts_update),ft(i,e.scripts_lateUpdate),ft(i,e.scripts_onBeforeRender),ft(i,e.scripts_onAfterRender),e.stopAllCoroutinesFrom(i)}Qe(ut,"removeScriptFromContext");function ft(i,e){const t=e.indexOf(i);t>=0&&e.splice(t,1)}Qe(ft,"removeFromArray");const V_={},Jh={};function Zh(){if(!k.Current){console.trace("Invalid call - no current context.");return}Ia(k.Current.scene,k.Current.scene.visible,!0)}Qe(Zh,"updateIsActive");function Ia(i,e,t){const s=p.isActiveSelf(i);V_[i.uuid]=s,e&&(e=p.isActiveSelf(i)),i[zs]=e;{const n=Jh[i.uuid];n!==void 0&&n!==e&&t&&Kh(i,o=>{e?(ni(o.__internalAwake.bind(o)),o.onEnable()):o.onDisable()})}if(Jh[i.uuid]=e,i.children)for(const n of i.children)Ia(n,e,t)}Qe(Ia,"updateIsActiveInHierarchyRecursiveRuntime");function Qi(i){let e=!0,t=i,s=!1;for(;t&&t;){if(t.type==="Scene"&&(s=!0),!p.isActiveSelf(t)){e=!1;break}t=t.parent}if(!i){console.error("GO is null");return}i[zs]=e&&s}Qe(Qi,"updateActiveInHierarchyWithoutEventCall");function Kh(i,e){var t;if((t=i.userData)==null?void 0:t.components)for(const s of i.userData.components)e(s)}Qe(Kh,"perComponent");function ed(i,e){var s;if(!i)return;const t=(s=e==null?void 0:e.new_scripts)!=null?s:k.Current.new_scripts;t.includes(i)||t.push(i)}const q_=function(i,e){if(!i||!i.userData.components)return;const t=i.userData.components.indexOf(e);t<0||(e.gameObject=null,i.userData.components.splice(t,1))},td=function(i,e,t=!0){e.userData||(e.userData={}),e.userData.components||(e.userData.components=[]),e.userData.components.push(i),i.gameObject=e,ed(i);try{i.__internalAwake&&t&&(Qi(e),i.__internalAwake())}catch(s){console.error(s)}},Q_=function(i,e){if(i.gameObject!==e){if(i.gameObject&&i.gameObject.userData.components){const t=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(t,1)}if(!e.userData.components)e.userData.components=[];else if(e.userData.components.includes(i))return;e.userData.components.push(i),i.gameObject=e}},X_=function(i){var e;if(i.gameObject&&i.gameObject.userData.components){const t=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(t,1)}i.__internalDisable&&i.__internalDisable(),i.onDestroy&&i.onDestroy(),ut(i,(e=i.context)!=null?e:k.Current),i.__destroyed=!0,i.gameObject=null},id=function(i,e,t){var s;if(!((s=e==null?void 0:e.userData)==null?void 0:s.components))return null;for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];if(i===null||o.constructor.name===i.name||o.constructor.name===i)if(t)t.push(o);else return o}for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];let a=Object.getPrototypeOf(o.constructor);do{if(a===i)if(t)t.push(o);else return o;a=Object.getPrototypeOf(a)}while(a)}return t},Ma=function(i,e){return id(i,e,null)},ja=function(i,e,t){return t||(t=[]),id(i,e,t)},Fa=function(i,e,t){var n;const s=Ma(i,e);if(t===!1&&s.enabled===!1)return null;if(s)return s;for(let o=0;o<((n=e==null?void 0:e.children)==null?void 0:n.length);o++){const a=Fa(i,e.children[o]);if(a)return a}return null},Ba=function(i,e,t){var s;t||(t=[]),ja(i,e,t);for(let n=0;n<((s=e==null?void 0:e.children)==null?void 0:s.length);n++)Ba(i,e.children[n],t);return t},sd=function(i,e){if(!e)return null;const t=Ma(i,e);return t||sd(i,e.parent)},nd=function(i,e,t){return t||(t=[]),e?(ja(i,e,t),nd(i,e.parent,t)):t},Y_=function(i,e,t){if(!i)return null;if(!e&&(e=k.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),null;const s=e.isScene===!0||e.isObject3D===!0?e:e==null?void 0:e.scene;for(const n in s.children){const o=s.children[n];if(t===!1&&o[zs]===!1)continue;if(o.constructor==i)return o;const a=Fa(i,o);if(a)return a}return null},J_=function(i,e,t){if(!i)return e;if(!t&&(t=k.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),e;const s=t.isScene===!0||t.isObject3D===!0?t:t==null?void 0:t.scene;if(!s)return e;for(const n in s.children){const o=s.children[n];if(o.constructor==i)return o;Ba(i,o,e)}return e};var Z_=Object.defineProperty,K_=(i,e)=>Z_(i,"name",{value:e,configurable:!0});class rd{random(){return Math.random()}clamp(e,t,s){return e<t?t:e>s?s:e}clamp01(e){return this.clamp(e,0,1)}lerp(e,t,s){return s=s<0?0:s,s=s>1?1:s,e+(t-e)*s}moveTowards(e,t,s){return e+=s,(s<0&&e<t||s>0&&e>t)&&(e=t),e}toDegrees(e){return e*180/Math.PI}toRadians(e){return e*Math.PI/180}}K_(rd,"MathHelper");const L=new rd;var eb=Object.defineProperty,B=(i,e)=>eb(i,"name",{value:e,configurable:!0});class od{constructor(e,t){r(this,"_factory");r(this,"_cache",[]);r(this,"_maxSize");r(this,"_index",0);this._factory=e,this._maxSize=t}get(){let e=this._index++;return e>=this._cache.length&&(e>=this._maxSize?e=this._index=0:this._cache.push(this._factory())),this._cache[e]}}B(od,"CircularBuffer");const tb=new P().setFromAxisAngle(new y(0,1,0),Math.PI);function ib(i,e){i.lookAt(e),i.quaternion.multiply(tb)}B(ib,"lookAtInverse");const Ua=new od(()=>new y,30);y.prototype.slerp=function(i,e){const t=this.length(),s=i.length(),n=L.lerp(t,s,e);return this.lerp(i,e).normalize().multiplyScalar(n)};function R(i,e=null,t=!0){const s=Ua.get();return i?i.parent?(t&&i.updateWorldMatrix(!0,!1),i.matrixWorldNeedsUpdate&&i.updateMatrixWorld(),s.setFromMatrixPosition(i.matrixWorld),e&&e.copy(s),e!=null?e:s):s.copy(i.position):s.set(0,0,0)}B(R,"getWorldPosition");function F(i,e){var n;if(!i)return;const t=Ua.get();e!==t&&t.copy(e),((n=i==null?void 0:i.parent)!=null?n:i).worldToLocal(t),i.position.set(t.x,t.y,t.z)}B(F,"setWorldPosition");function ar(i,e,t,s){const n=Ua.get();n.set(e,t,s),F(i,n)}B(ar,"setWorldPositionXYZ");const oi=new P,qs=new P,Na=new P;function re(i,e=null){if(!i)return qs.set(0,0,0,1);const t=e!=null?e:qs;return i.parent?(i.getWorldQuaternion(t),t):t.copy(i.quaternion)}B(re,"getWorldQuaternion");function oe(i,e){if(!i)return;e!==oi&&oi.copy(e);const t=oi,s=i==null?void 0:i.parent;s==null||s.getWorldQuaternion(Na),Na.invert();const n=Na.multiply(t);i.quaternion.set(n.x,n.y,n.z,n.w)}B(oe,"setWorldQuaternion");function ad(i,e,t,s,n){oi.set(e,t,s,n),oe(i,oi)}B(ad,"setWorldQuaternionXYZW");const lr=new y,sb=new y;function nb(i,e=null){return i?i.parent?(i.getWorldScale(e!=null?e:lr),e!=null?e:lr):lr.copy(i.position):lr.set(0,0,0)}B(nb,"getWorldScale");function rb(i,e){if(!i)return;if(!i.parent){i.scale.copy(e);return}const t=sb;i.parent.getWorldScale(t),t.divide(e),i.scale.copy(t)}B(rb,"setWorldScale");const ob=new y,ld=new P;function ab(i){return re(i,ld),ob.set(0,0,1).applyQuaternion(ld)}B(ab,"forward");const cd=new he,hd=new he,lb=new y;function dd(i){return i.getWorldQuaternion(qs),hd.setFromQuaternion(qs),hd}B(dd,"getWorldEuler");function ud(i,e){oe(i,qs.setFromEuler(e))}B(ud,"setWorldEuler");function $a(i){const e=dd(i),t=lb;return t.set(e.x,e.y,e.z),t.x=L.toDegrees(t.x),t.y=L.toDegrees(t.y),t.z=L.toDegrees(t.z),t}B($a,"getWorldRotation");function cb(i,e){cr(i,e.x,e.y,e.z,!0)}B(cb,"setWorldRotation");function cr(i,e,t,s,n=!0){n&&(e=L.toRadians(e),t=L.toRadians(t),s=L.toRadians(s)),cd.set(e,t,s),oi.setFromEuler(cd),oe(i,oi)}B(cr,"setWorldRotationXYZ");function hr(i,e=!0){!i||(e?B(function t(s){console.groupCollapsed((s.name?s.name:"(no name : "+s.type+")")+" %o",s),s.children.forEach(t),console.groupEnd()},"printGraph")(i):i.traverse(function(t){for(var s="|___",n=t;n.parent!==null;)s="	"+s,n=n.parent;console.log(s+t.name+" <"+t.type+">")}))}B(hr,"logHierarchy");const hb=new sg(2,2,1,1),dr=new yh({antialias:!1}),db=new ba,Wa=new vh,fd=new wh({uniforms:{blitTexture:new ng(null)},vertexShader:`
        varying vec2 vUv;
        void main(){
            vUv = uv;
            gl_Position = vec4(position.xy * 1.0,0.,.999999);
        }`,fragmentShader:`
        uniform sampler2D blitTexture;
        varying vec2 vUv;
        void main(){
            vec2 uv = vUv;
            uv.y = 1.0 - uv.y;
            gl_FragColor = vec4(uv.xy, 0, 1);
            gl_FragColor = texture2D( blitTexture, uv);
        }`});function pd(i){fd.uniforms.blitTexture.value=i;const e=new ii(hb,fd);return e.frustumCulled=!1,Wa.children.length=0,Wa.add(e),dr.setSize(i.image.width,i.image.height),dr.clear(),dr.render(Wa,db),new Hi(dr.domElement)}B(pd,"copyTexture");function md(i){return typeof HTMLImageElement!="undefined"&&i instanceof HTMLImageElement||typeof HTMLCanvasElement!="undefined"&&i instanceof HTMLCanvasElement||typeof OffscreenCanvas!="undefined"&&i instanceof OffscreenCanvas||typeof ImageBitmap!="undefined"&&i instanceof ImageBitmap}B(md,"isImageBitmap");function gd(i,e=!1){if(!i)return null;(e===!0||i.isCompressedTexture===!0)&&(i=pd(i));const t=i.image;if(md(t)){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const n=s.getContext("2d");return n?(n.drawImage(t,0,0,t.width,t.height,0,0,s.width,s.height),s):(console.error("Failed getting canvas 2d context"),null)}return null}B(gd,"textureToCanvas");var ub=Object.defineProperty,de=(i,e)=>ub(i,"name",{value:e,configurable:!0});const ur=O("debugcomponents"),fb="eff8ba80-635d-11ec-90d6-0242ac120003";class Ee{constructor(e){r(this,"_originalSeed");r(this,"_seed");this._originalSeed=e,this._seed=e}get seed(){return this._seed}generateUUID(){const e=this._seed;return this._seed-=1,rg(e.toString(),fb)}static createFromString(e){return new Ee(this.hash(e))}static hash(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}de(Ee,"InstantiateIdProvider");var ai;(function(i){i.NewInstanceCreated="new-instance-created",i.InstanceDestroyed="instance-destroyed"})(ai||(ai={}));class Ha{constructor(e){r(this,"guid");this.guid=e}}de(Ha,"DestroyInstanceModel");function fr(i,e,t=!0){if(!i)return;const s=i;if(p.destroy(i,t),!e){console.warn("Can not send destroy: No networking connection provided",i.guid);return}if(!e.isConnected){console.warn("Can not send destroy: not connected",i.guid);return}let n=i.guid;if(!n&&s.uuid&&(n=s.uuid),!n){console.warn("Can not send destroy: failed to find guid",i);return}const o=new Ha(n);e.send(ai.InstanceDestroyed,o)}de(fr,"syncDestroy");function _d(i,e){const t=new Ha(i);e.send(ai.InstanceDestroyed,t)}de(_d,"sendDestroyed");function bd(i){i.connection.beginListen(ai.InstanceDestroyed,e=>{ur&&console.log("[Remote] Destroyed",i.scene,e);const t=p.findByGuid(e.guid,i.scene);t&&p.destroy(t)})}de(bd,"beginListenDestroy");class pb{constructor(e,t,s){r(this,"filename");r(this,"hash");r(this,"size");this.filename=e,this.hash=t,this.size=s}}de(pb,"HostData");class yd{constructor(e,t){r(this,"guid");r(this,"originalGuid");r(this,"seed");r(this,"visible");r(this,"hostData");r(this,"dontSave");r(this,"parent");r(this,"position");r(this,"rotation");r(this,"scale");this.originalGuid=e,this.guid=t}}de(yd,"NewInstanceModel");function za(i,e,t,s){var c;const n=i;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(e.context||(e.context=k.Current),!e.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=e?dt({},e):null,{instance:a,seed:l}=wd(n,e);if(a){const h=a;if(h.guid){ur&&console.log("[Local] new instance","gameobject:",a==null?void 0:a.guid);const d=new yd(n.guid,h.guid);d.seed=l,o&&(o.position&&(d.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(d.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(d.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),d.position||(d.position={x:h.position.x,y:h.position.y,z:h.position.z}),d.rotation||(d.rotation={x:h.quaternion.x,y:h.quaternion.y,z:h.quaternion.z,w:h.quaternion.w}),d.scale||(d.scale={x:h.scale.x,y:h.scale.y,z:h.scale.z}),d.visible=n.visible,(o==null?void 0:o.parent)&&(typeof o.parent=="string"?d.parent=o.parent:d.parent=o.parent.guid),d.hostData=t,s===!1&&(d.dontSave=!0),(c=e==null?void 0:e.context)==null||c.connection.send(ai.NewInstanceCreated,d)}else console.warn("Missing guid, can not send new instance event",h)}return a}de(za,"syncInstantiate");function pr(){return Math.random()*9999999}de(pr,"generateSeed");function vd(i){i.connection.beginListen(ai.NewInstanceCreated,async e=>{const t=await Od(e.originalGuid,i.scene);if(!t){console.warn("could not find object that was instantiated: "+e.guid);return}const s=new Ae;e.position&&(s.position=new y(e.position.x,e.position.y,e.position.z)),e.rotation&&(s.rotation=new P(e.rotation.x,e.rotation.y,e.rotation.z,e.rotation.w)),e.scale&&(s.scale=new y(e.scale.x,e.scale.y,e.scale.z)),s.parent=e.parent,e.seed&&(s.idProvider=new Ee(e.seed)),s.visible=e.visible,s.context=i,ur&&i.alias&&console.log("[Remote] instantiate in: "+i.alias);const n=p.instantiate(t,s);n&&(e.parent==="scene"&&i.scene.add(n),ur&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,t))})}de(vd,"beginListenInstantiate");function wd(i,e){const t=pr(),s=e!=null?e:new Ae;s.idProvider=new Ee(t);const n=p.instantiate(i,s);return{seed:t,instance:n}}de(wd,"instantiateSeeded");const Pd={};function xd(i,e){Pd[i]=e}de(xd,"registerPrefabProvider");async function Od(i,e){const t=Pd[i];if(t!=null){const s=await t(i);if(s)return s}return Ga(i,e)}de(Od,"tryResolvePrefab");function Ga(i,e){if(e===null||!i)return null;if(e.guid===i)return e;if(e.children)for(const t of e.children){const s=Ga(i,t);if(s)return s}return null}de(Ga,"tryFindObjectByGuid");var mb=Object.defineProperty,mr=(i,e)=>mb(i,"name",{value:e,configurable:!0});const kt=O("debugcomponents");var Cd;(function(i){i[i.None=0]="None",i[i.HideInHierarchy=1]="HideInHierarchy",i[i.HideInInspector=2]="HideInInspector",i[i.DontSaveInEditor=4]="DontSaveInEditor",i[i.NotEditable=8]="NotEditable",i[i.DontSaveInBuild=16]="DontSaveInBuild",i[i.DontUnloadUnusedAsset=32]="DontUnloadUnusedAsset",i[i.DontSave=52]="DontSave",i[i.HideAndDontSave=61]="HideAndDontSave"})(Cd||(Cd={}));class Ae{constructor(){r(this,"idProvider");r(this,"parent");r(this,"keepWorldPosition");r(this,"position");r(this,"rotation");r(this,"scale");r(this,"visible");r(this,"context")}}mr(Ae,"InstantiateOptions");x.prototype.SetActive=function(i){this.visible=i};class p extends x{constructor(){super(...arguments);r(this,"guid")}static setActive(e,t){!e||(e.visible=t)}static isActiveSelf(e){return e.visible||p.isUsingInstancing(e)}static isActiveInHierarchy(e){return e[zs]||p.isUsingInstancing(e)}static markAsInstancedRendered(e,t){e.__isUsingInstancing=t}static isUsingInstancing(e){return e.__isUsingInstancing===!0}static foreachComponent(e,t,s=!0){if(!!e){if(e.userData.components)for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];if(o instanceof v){const a=t(o);if(a!==void 0)return a}}if(s&&e.children)for(let n=0;n<e.children.length;n++){const o=e.children[n];if(!o)continue;const a=p.foreachComponent(o,t,s);if(a!==void 0)return a}}}static instantiateSynced(e,t){return e?za(e,t):null}static instantiate(e,t=null){if(e===null)return null;let s=null;t!==null&&(t.x!==void 0?(s=new Ae,s.position=t):s=t);let n=k.Current;(s==null?void 0:s.context)&&(n=s.context),kt&&n.alias&&console.log("context",n.alias),s&&!s.idProvider&&(s.idProvider=new Ee(Date.now()));const o=[],a={},l={},c=this.internalInstantiate(n,e,s,o,a,l);c&&(this.resolveReferences(a),this.resolveAndBindSkinnedMeshBones(l,a)),kt&&(hr(e,!0),hr(c,!0));const h={};for(const d in o){const u=o[d],_=u.guid;s&&s.idProvider&&(u.guid=s.idProvider.generateUUID(),h[_]=u.guid,kt&&console.log(u.name,u.guid)),ed(u,n),u.__internalNewInstanceCreated&&u.__internalNewInstanceCreated()}for(const d in o){const u=o[d];u.resolveGuids&&u.resolveGuids(h),u.enabled!==!1&&(u.enabled=!0)}return qi(n),c}static internalInstantiate(e,t,s,n,o,a){var u;if(!t)return null;const l=t.userData;t.userData={};const c=t.children;t.children=[];let h;if(h=t.clone(!1),t.userData=l,t.children=c,o[t.uuid]={original:t,clone:h},t.type==="SkinnedMesh"&&(a[t.uuid]={original:t,clone:h}),(s==null?void 0:s.visible)!==void 0&&(h.visible=s.visible),s==null?void 0:s.idProvider){h.uuid=s.idProvider.generateUUID();const _=h;_&&(_.guid=h.uuid)}t.animations&&t.animations.length>0&&(h.animations=[...t.animations]);const d=t.parent;if(d&&d.add(h),(s==null?void 0:s.position)?F(h,s.position):h.position.copy(t.position),(s==null?void 0:s.rotation)?oe(h,s.rotation):h.quaternion.copy(t.quaternion),(s==null?void 0:s.scale)?h.scale.copy(s.scale):h.scale.copy(t.scale),(s==null?void 0:s.parent)&&s.parent!=="scene"){let _=null;if(typeof s.parent=="string"?_=ri(s.parent,e.scene,!0):_=s.parent,_){const b=s.keepWorldPosition===!0?_.attach:_.add;b?b.call(_,h):console.error("Invalid parent object",_,"received when instantiating:",t)}else console.warn("could not find parent:",s.parent)}for(const[_,b]of Object.entries(t.userData))_!=="components"&&(h.userData[_]=b);if((u=t.userData)==null?void 0:u.components){const _=t.userData.components,b=[];h.userData.components=b;for(let w=0;w<_.length;w++){const C=_[w],S=Object.create(C);Object.assign(S,C),b.push(S),S.gameObject=h,n.push(S)}}s&&(s.position=void 0,s.rotation=void 0,s.scale=void 0,s.parent=void 0);for(const _ in t.children){const b=t.children[_],w=p.internalInstantiate(e,b,s,n,o,a);w&&h.add(w)}return h}static resolveAndBindSkinnedMeshBones(e,t){for(const s in e){const n=e[s],o=n.original,a=o.skeleton,l=n.clone;if(!a){console.warn("Skinned mesh has no skeleton?",n);continue}const c=a.bones,h=l.skeleton.clone();l.skeleton=h,l.bindMatrix.clone().copy(o.bindMatrix),l.bindMatrixInverse.copy(o.bindMatrixInverse);const d=[];h.bones=d;for(let u=0;u<c.length;u++){const _=c[u],w=t[_.uuid].clone;d.push(w)}}for(const s in e){const n=e[s].clone;n.skeleton.update(),n.bind(n.skeleton,n.bindMatrix),n.updateMatrixWorld(!0)}}static resolveReferences(e){var t;for(const s in e){const o=e[s].clone;if((t=o.userData)==null?void 0:t.components)for(let a=0;a<o.userData.components.length;a++){const l=o.userData.components[a],c=Object.entries(l);for(const[h,d]of c)if(Array.isArray(d)){const u=[];l[h]=u;for(let _=0;_<d.length;_++){const b=d[_];if(typeof b!="object"){u.push(b);continue}const w=this.postProcessNewInstance(l,h,b,e);w!==void 0?u.push(w):u.push(b)}}else if(typeof d=="object"){const u=this.postProcessNewInstance(l,h,d,e);u!==void 0&&(l[h]=u)}}}}static postProcessNewInstance(e,t,s,n){var o,a;if(s instanceof Ue||s instanceof v){const l=s.gameObject;if(l){const c=l.uuid,h=(o=n[c])==null?void 0:o.clone;if(!h){kt&&console.log("reference did not change",t,e,s);return}const d=l.userData.components.indexOf(s);if(d>=0)return kt&&console.log(t,c),h.userData.components[d];console.warn("could not find component",t,s)}}else if(s instanceof x){if(t==="gameObject")return;const l=s;if(l){const c=l.uuid,h=(a=n[c])==null?void 0:a.clone;if(h)return kt&&console.log(t,"old",s,"new",h),h}}}static destroySynced(e,t,s=!0){if(!e)return;const n=e;t=t!=null?t:k.Current,fr(n,t.connection,s)}static destroy(e,t=!0,s=!0){const n=e;if(n.isComponent){n.destroy();return}const o=e;if(kt&&console.log(o),t&&o.children)for(const l of o.children)p.destroy(l,t,!1);const a=o.userData.components;if(a){let l=a.length;for(let c=0;c<a.length;c++){const h=a[c];h.destroy&&(kt&&console.log("destroying",h),h.destroy()),a.length<l&&(l=a.length,c--)}}s&&o.removeFromParent()}static add(e,t,s){if(!(!e||!t)){if(e===t){console.warn("Can not add object to self",e);return}s||(s=k.Current),t.add(e),Qi(e),s?p.foreachComponent(e,n=>{ka(n,s),s.new_script_start.includes(n)===!1&&s.new_script_start.push(n)},!0):console.warn("Missing context")}}static remove(e){var t;!e||((t=e.parent)==null||t.remove(e),p.foreachComponent(e,s=>{Xh(s)},!0))}static invokeOnChildren(e,t,...s){this.invoke(e,t,!0,s)}static invoke(e,t,s=!1,...n){!e||this.foreachComponent(e,o=>{const a=o[t];a&&typeof a=="function"&&a.bind(o)(...n)},s)}static addNewComponent(e,t,s=!0){const n=new t;return td(n,e,s),n}static addComponent(e,t){if(t.gameObject==null)throw new Error("Did you mean to create a new component? Use addNewComponent");Q_(t,e)}static removeComponent(e){return q_(e.gameObject,e),e}static getOrAddComponent(e,t){const s=this.getComponent(e,t);return s||this.addNewComponent(e,t)}static getComponent(e,t){return e===null?null:Ma(t,e)}static getComponents(e,t,s=null){return e===null?s!=null?s:[]:ja(t,e,s)}static findByGuid(e,t){return ri(e,t,!0,!0)}static findObjectOfType(e,t,s=!0){return Y_(e,t,s)}static findObjectsOfType(e,t){const s=[];return J_(e,s,t),s}static getComponentInChildren(e,t){return Fa(t,e)}static getComponentsInChildren(e,t,s=null){return Ba(t,e,s)}static getComponentInParent(e,t){return sd(t,e)}static getComponentsInParent(e,t,s=null){return nd(t,e,s)}static getAllComponents(e){var n;return[...(n=e.userData)==null?void 0:n.components]}static*iterateComponents(e){var s;const t=(s=e==null?void 0:e.userData)==null?void 0:s.components;if(t&&Array.isArray(t))for(let n=0;n<t.length;n++)yield t[n]}}mr(p,"GameObject");x.prototype.addNewComponent=function(i){return p.addNewComponent(this,i)};x.prototype.removeComponent=function(i){return p.removeComponent(i)};x.prototype.getOrAddComponent=function(i){return p.getOrAddComponent(this,i)};x.prototype.getComponent=function(i){return p.getComponent(this,i)};x.prototype.getComponents=function(i,e){return p.getComponents(this,i,e)};x.prototype.getComponentInChildren=function(i){return p.getComponentInChildren(this,i)};x.prototype.getComponentsInChildren=function(i,e){return p.getComponentsInChildren(this,i,e)};x.prototype.getComponentInParent=function(i){return p.getComponentInParent(this,i)};x.prototype.getComponentInParent=function(i,e){return p.getComponentsInParent(this,i,e)};const qe=class{constructor(){r(this,"__context");r(this,"__name");r(this,"gameObject");r(this,"guid","invalid");r(this,"sourceId");r(this,"__didAwake",!1);r(this,"__didStart",!1);r(this,"__didEnable",!1);r(this,"__isEnabled");r(this,"__destroyed",!1);r(this,"_worldPosition");r(this,"_worldQuaternion");r(this,"_worldEuler");r(this,"_worldRotation");this.__internalNewInstanceCreated()}get isComponent(){return!0}get context(){var e;return(e=this.__context)!=null?e:k.Current}set context(e){this.__context=e}get scene(){return this.context.scene}get layer(){var e,t;return(t=(e=this.gameObject)==null?void 0:e.userData)==null?void 0:t.layer}get name(){var e;return(e=this.gameObject)==null?void 0:e.userData.name}set name(e){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=e,this.__name=e):this.__name=e}get tag(){var e;return(e=this.gameObject)==null?void 0:e.userData.tag}set tag(e){this.gameObject&&(this.gameObject.userData.tag=e)}get static(){var e;return(e=this.gameObject)==null?void 0:e.userData.static}get hideFlags(){var e;return(e=this.gameObject)==null?void 0:e.userData.hideFlags}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const e=this.gameObject[zs];return e===void 0?!0:e}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(e,t=Ce.Update){return this.context.registerCoroutineUpdate(this,e,t)}stopCoroutine(e,t=Ce.Update){this.context.unregisterCoroutineUpdate(e,t)}get destroyed(){return this.__destroyed}destroy(){this.destroyed||X_(this)}__internalNewInstanceCreated(){this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(){this.__didEnable||(this.__didEnable=!0,this.onEnable())}__internalDisable(){!this.__didEnable||(this.__didEnable=!1,this.onDisable())}get worldPosition(){return this._worldPosition||(this._worldPosition=new y),R(this.gameObject,this._worldPosition),this._worldPosition}set worldPosition(e){F(this.gameObject,e)}setWorldPosition(e,t,s){qe._worldPositionBuffer.set(e,t,s),this.worldPosition=qe._worldPositionBuffer}get worldQuaternion(){return this._worldQuaternion||(this._worldQuaternion=new P),re(this.gameObject,this._worldQuaternion)}set worldQuaternion(e){oe(this.gameObject,e)}setWorldQuaternion(e,t,s,n){qe._worldQuaternionBuffer.set(e,t,s,n),this.worldQuaternion=qe._worldQuaternionBuffer}get worldEuler(){return this._worldEuler||(this._worldEuler=new he),this._worldEuler.setFromQuaternion(this.worldQuaternion),this._worldEuler}set worldEuler(e){var t;this._worldQuaternion||(this._worldQuaternion=new P),(t=this._worldQuaternion)==null||t.setFromEuler(e),this.worldQuaternion=this._worldQuaternion}get worldRotation(){const e=this.worldEuler;this._worldRotation||(this._worldRotation=new y);const t=this._worldRotation;return t.set(e.x,e.y,e.z),t.x=L.toDegrees(t.x),t.y=L.toDegrees(t.y),t.z=L.toDegrees(t.z),t}set worldRotation(e){this.setWorldRotation(e.x,e.y,e.z,!0)}setWorldRotation(e,t,s,n=!0){n&&(e=L.toRadians(e),t=L.toRadians(t),s=L.toRadians(s)),qe._worldEulerBuffer.set(e,t,s),qe._worldQuaternionBuffer.setFromEuler(qe._worldEulerBuffer),this.worldQuaternion=qe._worldQuaternionBuffer}get forward(){return qe._forward.set(0,0,1).applyQuaternion(this.worldQuaternion)}};let Ue=qe;r(Ue,"_worldPositionBuffer",new y),r(Ue,"_worldQuaternionBuffer",new P),r(Ue,"_worldEulerBuffer",new he),r(Ue,"_tempQuaternionBuffer2",new P),r(Ue,"_forward",new y(0,0,1));mr(Ue,"Component");class v extends Ue{get enabled(){var e;return(e=this.__isEnabled)!=null?e:!0}set enabled(e){e!==this.__isEnabled&&(this.__isEnabled=e,!!this.__didAwake&&(e?this.__internalEnable():this.__internalDisable()))}}mr(v,"Behaviour");var gb=Object.defineProperty,_b=(i,e)=>gb(i,"name",{value:e,configurable:!0}),gr;(function(i){i.PointerDown="pointerDown"})(gr||(gr={}));class Sd extends EventTarget{constructor(e){super();r(this,"_doubleClickTimeThreshold",.5);r(this,"_longPressTimeThreshold",1);r(this,"_specialCursorTrigger",0);r(this,"context");r(this,"_pointerDown",[!1]);r(this,"_pointerUp",[!1]);r(this,"_pointerClick",[!1]);r(this,"_pointerDoubleClick",[!1]);r(this,"_pointerPressed",[!1]);r(this,"_pointerPositions",[new Q]);r(this,"_pointerPositionsLastFrame",[new Q]);r(this,"_pointerPositionsDelta",[new Q]);r(this,"_pointerPositionsRC",[new Q]);r(this,"_pointerPositionDown",[new Q]);r(this,"_pointerDownTime",[]);r(this,"_pointerUpTime",[]);r(this,"_pointerIds",[]);r(this,"_pointerTypes",[""]);r(this,"_mouseWheelChanged",[!1]);r(this,"_pointerEvent",[]);r(this,"keysPressed",{});this.context=e,this.context.post_render_callbacks.push(this.onEndOfFrame.bind(this));const t=this.context.renderer.domElement;t.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!0}),t.addEventListener("touchend",this.onTouchUp.bind(this),!1),t.addEventListener("pointerdown",this.onPointerDown.bind(this),!1),t.addEventListener("pointermove",this.onPointerMove.bind(this),!1),t.addEventListener("pointerup",this.onPointerUp.bind(this),!1),t.addEventListener("wheel",this.onMouseWheel.bind(this),{passive:!0}),window.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("keypress",this.onKeyPressed.bind(this),!1),window.addEventListener("keyup",this.onKeyUp.bind(this),!1),window.addEventListener("blur",this.onLostFocus.bind(this))}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}setCursorPointer(){this._specialCursorTrigger+=1,this.context.domElement.style.cursor="pointer"}setCursorNormal(){this._specialCursorTrigger-=1,this._specialCursorTrigger=Math.max(0,this._specialCursorTrigger),this._specialCursorTrigger===0&&(this.context.domElement.style.cursor="default")}getPointerPressedCount(){let e=0;for(let t=0;t<this._pointerPressed.length;t++)this._pointerPressed[t]&&e++;return e}getPointerPosition(e){return e>=this._pointerPositions.length?null:this._pointerPositions[e]}getPointerPositionLastFrame(e){return e>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[e]}getPointerPositionDelta(e){return e>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[e]}getPointerPositionRC(e){return e>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[e]}getPointerDown(e){return e>=this._pointerDown.length?!1:this._pointerDown[e]}getPointerUp(e){return e>=this._pointerUp.length?!1:this._pointerUp[e]}getPointerPressed(e){return e>=this._pointerPressed.length?!1:this._pointerPressed[e]}getPointerClicked(e){return e>=this._pointerClick.length?!1:this._pointerClick[e]}getPointerDoubleClicked(e){return e>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[e]}getPointerDownTime(e){return e>=this._pointerDownTime.length?-1:this._pointerDownTime[e]}getPointerUpTime(e){return e>=this._pointerUpTime.length?-1:this._pointerUpTime[e]}getPointerLongPress(e){return e>=this._pointerDownTime.length?!1:this.getPointerPressed(e)&&this.context.time.time-this._pointerDownTime[e]>this._longPressTimeThreshold}getIsMouse(e){return e>=this._pointerTypes.length?!1:this._pointerTypes[e]==="mouse"}getIsTouch(e){return e>=this._pointerTypes.length?!1:this._pointerTypes[e]==="touch"}getTouchesPressedCount(){let e=0;for(let t=0;t<this._pointerPressed.length;t++)this._pointerPressed[t]&&this.getIsTouch(t)&&e++;return e}getMouseWheelChanged(e=0){return e>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[e]}getPointerEvent(e){var t;if(!(e>=this._pointerEvent.length))return(t=this._pointerEvent[e])!=null?t:void 0}getKeyDown(){for(const e in this.keysPressed){const t=this.keysPressed[e];if(t.startFrame===this.context.time.frameCount)return t.key}return null}getKeyPressed(){for(const e in this.keysPressed){const t=this.keysPressed[e];if(t.pressed)return t.key}return null}isKeyDown(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.startFrame)===this.context.time.frameCount&&this.keysPressed[e].pressed}isKeyUp(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.frame)===this.context.time.frameCount&&!this.keysPressed[e].pressed}isKeyPressed(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.pressed)}createPointerDown(e){this.onDown(e)}createPointerMove(e){this.onMove(e)}createPointerUp(e){this.onUp(e)}onLostFocus(){for(const e in this.keysPressed)this.keysPressed[e].pressed=!1}onEndOfFrame(){for(let e=0;e<this._pointerUp.length;e++)this._pointerUp[e]=!1;for(let e=0;e<this._pointerDown.length;e++)this._pointerDown[e]=!1;for(let e=0;e<this._pointerClick.length;e++)this._pointerClick[e]=!1;for(let e=0;e<this._pointerDoubleClick.length;e++)this._pointerDoubleClick[e]=!1;for(const e of this._pointerPositionsDelta)e.set(0,0);for(let e=0;e<this._mouseWheelChanged.length;e++)this._mouseWheelChanged[e]=!1}onKeyDown(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];t&&t.pressed||(this.keysPressed[e.keyCode]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:e.key})}onKeyPressed(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];!t||(t.pressed=!0,t.frame=this.context.time.frameCount+1)}onKeyUp(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];!t||(t.pressed=!1,t.frame=this.context.time.frameCount+1)}onMouseWheel(e){this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0}onTouchMove(e){}onTouchUp(e){}onPointerDown(e){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;e.preventDefault&&e.preventDefault();let t=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(t=e.button),this.onDown({button:t,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e})}onPointerMove(e,t=void 0){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;t!==!0&&e.preventDefault();let s=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(s=e.button),s<0&&(s=0);const n={button:s,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e};this.onMove(n)}onPointerUp(e,t=void 0){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;t!==!0&&e.preventDefault();let s=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(s=e.button),this._pointerIds[s]=-1,this.onUp({button:s,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e})}isInRect(e){return!0}onDown(e){if(!!this.isInRect(e)){for(this.setPointerState(e.button,this._pointerPressed,!0),this.setPointerState(e.button,this._pointerDown,!0),this.setPointerStateT(e.button,this._pointerEvent,e.source);e.button>=this._pointerTypes.length;)this._pointerTypes.push(e.pointerType);for(this._pointerTypes[e.button]=e.pointerType===void 0?"mouse":e.pointerType;e.button>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new Q);this._pointerPositionDown[e.button].set(e.clientX,e.clientY),e.button>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[e.button]=this.context.time.time,this.updatePointerPosition(e),k.Current=this.context,this.dispatchEvent(new Event(gr.PointerDown))}}onMove(e){!this.isInRect(e)||(this.updatePointerPosition(e),this.setPointerStateT(e.button,this._pointerEvent,e.source))}onUp(e){if(this.setPointerState(e.button,this._pointerPressed,!1),this.setPointerStateT(e.button,this._pointerEvent,e.source),!this.isInRect(e))return;if(this.setPointerState(e.button,this._pointerUp,!0),this.updatePointerPosition(e),!this._pointerPositionDown[e.button]){console.warn("Received pointer up event without matching down event for button: "+e.button);return}const t=e.clientX-this._pointerPositionDown[e.button].x,s=e.clientY-this._pointerPositionDown[e.button].y;if(e.button>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),Math.abs(t)<5&&Math.abs(s)<5){this.setPointerState(e.button,this._pointerClick,!0);const n=this._pointerUpTime[e.button],o=this.context.time.time-n;o<this._doubleClickTimeThreshold&&o>0&&this.setPointerState(e.button,this._pointerDoubleClick,!0)}this._pointerUpTime[e.button]=this.context.time.time}updatePointerPosition(e){for(;e.button>=this._pointerPositions.length;)this._pointerPositions.push(new Q);for(;e.button>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new Q);for(;e.button>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new Q);const t=this._pointerPositionsLastFrame[e.button];t.copy(this._pointerPositions[e.button]),this._pointerPositionsDelta[e.button].set(e.clientX-t.x,e.clientY-t.y),this._pointerPositions[e.button].x=e.clientX,this._pointerPositions[e.button].y=e.clientY;const s=e.clientX+window.scrollX,n=e.clientY+window.scrollY;for(;e.button>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new Q);this._pointerPositionsRC[e.button].x=(s-this.context.domX)/this.context.domWidth*2-1,this._pointerPositionsRC[e.button].y=-((n-this.context.domY)/this.context.domHeight)*2+1}getPointerIndex(e){for(let t=0;t<this._pointerIds.length;t++)if(this._pointerIds[t]===e)return t;for(let t=0;t<this._pointerIds.length;t++)if(this._pointerIds[t]===-1&&(this._pointerIds[t]=e),this._pointerIds[t]===e)return t;return this._pointerIds.push(e),this._pointerIds.length-1}setPointerState(e,t,s){for(;t.length<=e;)t.push(!1);t[e]=s}setPointerStateT(e,t,s){for(;t.length<=e;)t.push(null);t[e]=s}}_b(Sd,"Input");var pt;(function(i){i[i.BACKSPACE=8]="BACKSPACE",i[i.TAB=9]="TAB",i[i.ENTER=13]="ENTER",i[i.SHIFT=16]="SHIFT",i[i.CTRL=17]="CTRL",i[i.ALT=18]="ALT",i[i.PAUSE=19]="PAUSE",i[i.CAPS_LOCK=20]="CAPS_LOCK",i[i.ESCAPE=27]="ESCAPE",i[i.SPACE=32]="SPACE",i[i.PAGE_UP=33]="PAGE_UP",i[i.PAGE_DOWN=34]="PAGE_DOWN",i[i.END=35]="END",i[i.HOME=36]="HOME",i[i.LEFT_ARROW=37]="LEFT_ARROW",i[i.UP_ARROW=38]="UP_ARROW",i[i.RIGHT_ARROW=39]="RIGHT_ARROW",i[i.DOWN_ARROW=40]="DOWN_ARROW",i[i.INSERT=45]="INSERT",i[i.DELETE=46]="DELETE",i[i.KEY_0=48]="KEY_0",i[i.KEY_1=49]="KEY_1",i[i.KEY_2=50]="KEY_2",i[i.KEY_3=51]="KEY_3",i[i.KEY_4=52]="KEY_4",i[i.KEY_5=53]="KEY_5",i[i.KEY_6=54]="KEY_6",i[i.KEY_7=55]="KEY_7",i[i.KEY_8=56]="KEY_8",i[i.KEY_9=57]="KEY_9",i[i.KEY_A=65]="KEY_A",i[i.KEY_B=66]="KEY_B",i[i.KEY_C=67]="KEY_C",i[i.KEY_D=68]="KEY_D",i[i.KEY_E=69]="KEY_E",i[i.KEY_F=70]="KEY_F",i[i.KEY_G=71]="KEY_G",i[i.KEY_H=72]="KEY_H",i[i.KEY_I=73]="KEY_I",i[i.KEY_J=74]="KEY_J",i[i.KEY_K=75]="KEY_K",i[i.KEY_L=76]="KEY_L",i[i.KEY_M=77]="KEY_M",i[i.KEY_N=78]="KEY_N",i[i.KEY_O=79]="KEY_O",i[i.KEY_P=80]="KEY_P",i[i.KEY_Q=81]="KEY_Q",i[i.KEY_R=82]="KEY_R",i[i.KEY_S=83]="KEY_S",i[i.KEY_T=84]="KEY_T",i[i.KEY_U=85]="KEY_U",i[i.KEY_V=86]="KEY_V",i[i.KEY_W=87]="KEY_W",i[i.KEY_X=88]="KEY_X",i[i.KEY_Y=89]="KEY_Y",i[i.KEY_Z=90]="KEY_Z",i[i.LEFT_META=91]="LEFT_META",i[i.RIGHT_META=92]="RIGHT_META",i[i.SELECT=93]="SELECT",i[i.NUMPAD_0=96]="NUMPAD_0",i[i.NUMPAD_1=97]="NUMPAD_1",i[i.NUMPAD_2=98]="NUMPAD_2",i[i.NUMPAD_3=99]="NUMPAD_3",i[i.NUMPAD_4=100]="NUMPAD_4",i[i.NUMPAD_5=101]="NUMPAD_5",i[i.NUMPAD_6=102]="NUMPAD_6",i[i.NUMPAD_7=103]="NUMPAD_7",i[i.NUMPAD_8=104]="NUMPAD_8",i[i.NUMPAD_9=105]="NUMPAD_9",i[i.MULTIPLY=106]="MULTIPLY",i[i.ADD=107]="ADD",i[i.SUBTRACT=109]="SUBTRACT",i[i.DECIMAL=110]="DECIMAL",i[i.DIVIDE=111]="DIVIDE",i[i.F1=112]="F1",i[i.F2=113]="F2",i[i.F3=114]="F3",i[i.F4=115]="F4",i[i.F5=116]="F5",i[i.F6=117]="F6",i[i.F7=118]="F7",i[i.F8=119]="F8",i[i.F9=120]="F9",i[i.F10=121]="F10",i[i.F11=122]="F11",i[i.F12=123]="F12",i[i.NUM_LOCK=144]="NUM_LOCK",i[i.SCROLL_LOCK=145]="SCROLL_LOCK",i[i.SEMICOLON=186]="SEMICOLON",i[i.EQUALS=187]="EQUALS",i[i.COMMA=188]="COMMA",i[i.DASH=189]="DASH",i[i.PERIOD=190]="PERIOD",i[i.FORWARD_SLASH=191]="FORWARD_SLASH",i[i.GRAVE_ACCENT=192]="GRAVE_ACCENT",i[i.OPEN_BRACKET=219]="OPEN_BRACKET",i[i.BACK_SLASH=220]="BACK_SLASH",i[i.CLOSE_BRACKET=221]="CLOSE_BRACKET",i[i.SINGLE_QUOTE=222]="SINGLE_QUOTE"})(pt||(pt={}));var bb=Object.defineProperty,yb=(i,e)=>bb(i,"name",{value:e,configurable:!0});class Qs{constructor(e,t){r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new $(1,1,0,0));r(this,"context");r(this,"gameObject");r(this,"lightmapTexture",null);r(this,"lightmapScaleOffsetUniform",{value:new $(1,1,0,0)});r(this,"lightmapUniform",{value:null});r(this,"beforeRenderCallback");this.gameObject=e,this.context=t}get lightmap(){return this.lightmapTexture}set lightmap(e){e!==this.lightmapTexture&&(this.lightmapTexture=e,this.setupLightmap())}init(e,t,s,n=!1){if(console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=e,this.lightmapIndex<0)return;this.lightmapScaleOffset=t,this.lightmapTexture=s,n&&this.setLightmapDebugMaterial(),this.setupLightmap()}bindOnBeforeRender(){this.beforeRenderCallback=this.onBeforeRenderThreeComplete.bind(this),this.context.addBeforeRenderListener(this.gameObject,this.beforeRenderCallback)}onBeforeRenderThreeComplete(e,t,s,n,o,a){this.onBeforeRenderThree(o)}setupLightmap(){if(this.gameObject.type==="Object3D")return;if(this.gameObject.type==="Group"){console.warn("Lightmap on multimaterial object is not supported yet... please ask kindly for implementation.");return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const e=this.gameObject;e.geometry.getAttribute("uv2")||e.geometry.setAttribute("uv2",e.geometry.getAttribute("uv"));const t=this.gameObject.material.clone();if(this.gameObject.material=t,this.gameObject.material.onBeforeCompile=(s,n)=>{s.uniforms.lightmap=this.lightmapUniform,s.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform},this.lightmapIndex>=0){const s=this.lightmapTexture,n=this.gameObject.material;n&&s&&(n.uniforms||(n.uniforms={}),n.lightMap=s,n.uniforms.lightmap={value:s})}}onBeforeRenderThree(e){const t=e.uniforms;t&&t.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,t.lightmap=this.lightmapUniform,t.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}setLightmapDebugMaterial(){this.gameObject.material=new wh({vertexShader:`
                attribute vec2 uv2;
                varying vec2 vUv2;
                void main()
                {
                    vUv2 = uv2;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightmap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv2;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));

                    vec4 lightMapTexel = texture2D( lightmap, lUv);
                    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
                    //lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
                    //lightMapTexel.a = 1.;
                    //lightMapTexel = conv_sRGBToLinear(lightMapTexel);
                    // lightMapTexel.rgb = vec3(1.);

                    // gl_FragColor = vec4(vUv2.xy, 0, 1);
                    gl_FragColor = lightMapTexel;
                }
                `,defines:{USE_LIGHTMAP:""}})}}yb(Qs,"RendererLightmap");var vb=Object.defineProperty,_r=(i,e)=>vb(i,"name",{value:e,configurable:!0});const f=_r(function(i){if(i===void 0&&(i=null),!Array.isArray(i))i=Va(i);else for(let e=0;e<i.length;e++){const t=i[e];i[e]=Va(t)}return function(e,t){Object.getOwnPropertyDescriptor(e,"$serializedTypes")||(e.$serializedTypes={});const s=e.$serializedTypes=e.$serializedTypes||{};s[t]=i}},"serializeable");function Va(i){var e,t;switch((t=(e=i==null?void 0:i.prototype)==null?void 0:e.constructor)==null?void 0:t.name){case"Number":case"String":case"Boolean":return null}return i}_r(Va,"setNullForPrimitiveTypes");const wb="__NEEDLE__ALL_PROPERTIES";function Pb(i){i[wb]=!0}_r(Pb,"allProperties");const xb="__NEEDLE__STRICT";function Ob(i){i[xb]=!0}_r(Ob,"strict");var Cb=Object.defineProperty,br=(i,e)=>Cb(i,"name",{value:e,configurable:!0});const qa=O("debugstencil");function Rd(i,e){return(i&1<<e.layer)!=0}br(Rd,"matchesLayer");const Ti=class{constructor(e,t){r(this,"parser");r(this,"source");this.parser=e,this.source=t}static applyStencil(e){var n;if(!e)return;const t=e.sourceId;if(qa&&console.log(t,Ti.stencils),!t)return;const s=Ti.stencils[t];if(!!s)for(let o=s.length-1;o>=0;o--){const a=s[o];if(Rd(a.layer,e)){qa&&console.log(a);const l=(n=e.material)==null?void 0:n.clone();l&&(e.material=l,e.gameObject.renderOrder=a.event*1e3+a.index*50,l.stencilWrite=!0,l.stencilWriteMask=255,l.stencilFuncMask=255,l.stencilRef=a.value,l.stencilFunc=a.compareFunc,l.stencilZPass=a.passOp,l.stencilFail=a.failOp,l.stencilZFail=a.zFailOp);break}}}afterRoot(e){const t=this.parser.json.extensions;if(t){const s=t[Sb];if(s){qa&&console.log(s);const n=s.stencil;if(n&&Array.isArray(n))for(const o of n){const a=dt({},o);a.compareFunc=Td(a.compareFunc),a.passOp=yr(a.passOp),a.failOp=yr(a.failOp),a.zFailOp=yr(a.zFailOp),Ti.stencils[this.source]||(Ti.stencils[this.source]=[]),Ti.stencils[this.source].push(a)}}}return null}};let Xs=Ti;r(Xs,"stencils",{});br(Xs,"NEEDLE_render_objects");var Ed;(function(i){i[i.Keep=0]="Keep",i[i.Zero=1]="Zero",i[i.Replace=2]="Replace",i[i.IncrementSaturate=3]="IncrementSaturate",i[i.DecrementSaturate=4]="DecrementSaturate",i[i.Invert=5]="Invert",i[i.IncrementWrap=6]="IncrementWrap",i[i.DecrementWrap=7]="DecrementWrap"})(Ed||(Ed={}));var Ad;(function(i){i[i.Disabled=0]="Disabled",i[i.Never=1]="Never",i[i.Less=2]="Less",i[i.Equal=3]="Equal",i[i.LessEqual=4]="LessEqual",i[i.Greater=5]="Greater",i[i.NotEqual=6]="NotEqual",i[i.GreaterEqual=7]="GreaterEqual",i[i.Always=8]="Always"})(Ad||(Ad={}));function yr(i){switch(i){case 0:return fg;case 1:return ug;case 2:return dg;case 3:return hg;case 4:return cg;case 6:return lg;case 7:return ag;case 5:return og}return 0}br(yr,"ToThreeStencilOp");function Td(i){switch(i){case 1:return wg;case 2:return vg;case 3:return yg;case 4:return bg;case 5:return _g;case 6:return gg;case 7:return mg;case 8:return pg}return 0}br(Td,"ToThreeCompareFunction");const Sb="NEEDLE_render_objects";var Ld=Object.defineProperty,Rb=Object.getOwnPropertyDescriptor,mt=(i,e)=>Ld(i,"name",{value:e,configurable:!0}),li=(i,e,t,s)=>{for(var n=s>1?void 0:s?Rb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Ld(e,t,n),n};const Dd=O("noInstancing"),kd=!!O("debuglightmaps");class Qa{constructor(){r(this,"path",null);r(this,"asset",null);r(this,"default")}}mt(Qa,"FieldWithDefault");var Id;(function(i){i[i.Both=0]="Both",i[i.Back=1]="Back",i[i.Front=2]="Front"})(Id||(Id={}));class Md{constructor(e){r(this,"_renderer");r(this,"_targets",[]);this._renderer=e;const t=this.setMaterial.bind(this),s=this.getMaterial.bind(this),n=e.gameObject;if(this._targets=[],n)switch(n.type){case"Group":this._targets=[...n.children];break;case"Mesh":this._targets.push(n);break}return new Proxy(this,{get(o,a){if(typeof a=="string"){const l=parseInt(a);if(!isNaN(l))return s(l)}return o[a]},set(o,a,l){return typeof a=="string"&&t(l,Number.parseInt(a)),Reflect.set(o,a,l)}})}is(e){return this._renderer===e}get length(){return this._targets.length}setMaterial(e,t){if(t<0||t>=this._targets.length)return;const s=this._targets[t];!s||(s.material=e)}getMaterial(e){if(e<0)return null;const t=this._targets;if(e>=t.length)return null;const s=t[e];return s?s.material:null}}mt(Md,"SharedMaterialArray");const jd=class extends v{constructor(){super(...arguments);r(this,"receiveShadows",!1);r(this,"shadowCastingMode",wr.Off);r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new $(1,1,0,0));r(this,"enableInstancing");r(this,"renderOrder");r(this,"allowOcclusionWhenDynamic",!0);r(this,"_lightmaps");r(this,"_sharedMaterials");r(this,"_lightmapTextureOverride");r(this,"_isInstancingEnabled",!1);r(this,"handles");r(this,"prevLayers")}get material(){return this.gameObject.material}set material(i){this.gameObject.material=i}get sharedMaterials(){return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._sharedMaterials=new Md(this)),this._sharedMaterials}static get shouldSuppressInstancing(){return Dd}get lightmap(){var i;return((i=this._lightmaps)==null?void 0:i.length)?this._lightmaps[0].lightmap:null}set lightmap(i){var e;if(this._lightmapTextureOverride=i,i===void 0&&(i=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(e=this._lightmaps)==null?void 0:e.length)for(const t of this._lightmaps)t.lightmap=i}get activeSelf(){return this.enabled}set activeSelf(i){const e=typeof i=="number"?i>.5:i;this.enabled=e,e&&(this.gameObject.visible=!0)}awake(){var e,t;const i=this.gameObject.type;if(i==="Group"){for(const s of this.gameObject.children)s.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let s=0;for(let n=0;n<this.gameObject.children.length;n++){const o=this.gameObject.children[n];if(!(o.type!=="Mesh"||p.getComponent(o,jd))){if(this.renderOrder.length<=s){console.error("Incorrect element count",this);break}o.renderOrder=this.renderOrder[s],s+=1}}}}if(this.lightmapIndex>=0){const s=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(s){if(this._lightmaps=[],i==="Mesh"){if(!((e=this.gameObject.material)==null?void 0:e.isMeshBasicMaterial)){const n=new Qs(this.gameObject,this.context);this._lightmaps.push(n),n.init(this.lightmapIndex,this.lightmapScaleOffset,s,kd)}}else if(i==="Group"){for(const n of this.gameObject.children)if(!((t=n.material)==null?void 0:t.isMeshBasicMaterial)){const o=new Qs(n,this.context);this._lightmaps.push(o),o.init(this.lightmapIndex,this.lightmapScaleOffset,s,kd),o.bindOnBeforeRender()}}}}(i==="Mesh"||i==="SkinnedMesh")&&(this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0]),this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree.bind(this)))}setInstancingEnabled(i){if(this._isInstancingEnabled===i)return i&&(this.handles===void 0||this.handles!=null&&this.handles.length>0);if(this._isInstancingEnabled=i,i){if(this.handles===void 0){if(this.handles=Eb.setup(this.gameObject,this.context,null,{rend:this,foundMeshes:0}),this.handles)return p.markAsInstancedRendered(this.gameObject,!0),!0}else if(this.handles!==null){for(const e of this.handles)e.updateInstanceMatrix(!0),e.add();return p.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this.handles)for(const e of this.handles)e.remove();return!0}return!1}start(){if(this.enableInstancing&&!Dd&&this.setInstancingEnabled(!0),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.gameObject.type==="Group")for(let i=0;i<this.gameObject.children.length;i++){const e=this.gameObject.children[i];e.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this._isInstancingEnabled?this.setInstancingEnabled(!0):this.enabled&&(this.gameObject.visible=!0,this.applyStencil())}onDisable(){this.handles&&this.handles.length>0?this.setInstancingEnabled(!1):this.enabled||(this.gameObject.visible=!1)}onDestroy(){this.handles=null}applyStencil(){Xs.applyStencil(this)}onBeforeRenderThree(i,e,t,s,n,o){var a;if(!t&&this.context.isInXR){const l=this.context.renderer.xr.getCamera();((a=l.cameras)==null?void 0:a.length)>0&&(t=l)}if(this._lightmaps)for(const l of this._lightmaps)l.onBeforeRenderThree(n)}onBeforeRender(){var e;if(!this.gameObject)return;const i=this.gameObject[Ya]===!0||this.gameObject.matrixWorldNeedsUpdate;if(this.gameObject.type==="Group"&&((e=this.gameObject.children)==null?void 0:e.length)>0)for(const t of this.gameObject.children)this.applySettings(t);else this.applySettings(this.gameObject);if(i&&(delete this.gameObject[Ya],this.handles)){for(let t=this.handles.length-1;t>=0;t--)this.handles[t].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this.handles&&this.handles.length<=0&&p.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this.handles)for(let t=0;t<this.handles.length;t++){const s=this.handles[t];this.prevLayers||(this.prevLayers=[]);const n=s.object.layers.mask;t>=this.prevLayers.length?this.prevLayers.push(n):this.prevLayers[t]=n,s.object.layers.disableAll()}}onAfterRender(){if(this._isInstancingEnabled&&this.handles&&this.prevLayers&&this.prevLayers.length>=this.handles.length)for(let i=0;i<this.handles.length;i++){const e=this.handles[i];e.object.layers.mask=this.prevLayers[i]}}applySettings(i){i.receiveShadow=this.receiveShadows,this.shadowCastingMode==wr.On?i.castShadow=!0:i.castShadow=!1}};let X=jd;mt(X,"Renderer");li([f()],X.prototype,"receiveShadows",2);li([f()],X.prototype,"shadowCastingMode",2);li([f()],X.prototype,"lightmapIndex",2);li([f($)],X.prototype,"lightmapScaleOffset",2);li([f()],X.prototype,"enableInstancing",2);li([f()],X.prototype,"renderOrder",2);li([f()],X.prototype,"allowOcclusionWhenDynamic",2);class vr extends X{}mt(vr,"MeshRenderer");class Xa extends vr{awake(){super.awake(),this.allowOcclusionWhenDynamic=!1}}mt(Xa,"SkinnedMeshRenderer");var wr;(function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.TwoSided=2]="TwoSided",i[i.ShadowsOnly=3]="ShadowsOnly"})(wr||(wr={}));const Ya="NEEDLE_NEED_UPDATE_INSTANCE";class ue{static markDirty(e,t=!0){if(!!e&&(p.isUsingInstancing(e)&&(e[Ya]=!0,e.matrixWorldNeedsUpdate=!0),t))for(const s of e.children)ue.markDirty(s,!0)}}mt(ue,"InstancingUtil");class Fd{constructor(){r(this,"objs",[])}setup(e,t,s,n,o=0){const a=this.tryCreateOrAddInstance(e,t,n);if(a)return s===null&&(s=[]),s.push(a),s;if(o<=0&&e.type!=="Mesh"){const l=o+1;for(const c of e.children)s=this.setup(c,t,s,n,l)}return s}tryCreateOrAddInstance(e,t,s){if(e.type==="Mesh"){const n=s.foundMeshes;if(s.foundMeshes+=1,!s.rend.enableInstancing||n>=s.rend.enableInstancing.length||!s.rend.enableInstancing[n])return null;const o=e,a=o.geometry,l=o.material;for(const h of this.objs)if(!h.isFull()&&h.geo===a&&h.material===l)return h.addInstance(o);const c=new Pr(e.name,a,l,200,t);return this.objs.push(c),c.addInstance(o)}return null}}mt(Fd,"InstancingHandler");const Eb=new Fd;class Bd{constructor(e,t,s){r(this,"instanceIndex",-1);r(this,"object");r(this,"instancer");this.instanceIndex=e,this.object=t,this.instancer=s,p.markAsInstancedRendered(t,!0)}get name(){return this.object.name}updateInstanceMatrix(e=!1){this.instanceIndex<0||(this.object.updateWorldMatrix(!0,e),this.instancer.updateInstance(this.object.matrixWorld,this.instanceIndex))}add(){this.instanceIndex>=0||this.instancer.add(this)}remove(){this.instanceIndex<0||this.instancer.remove(this)}}mt(Bd,"InstanceHandle");const lh=class{constructor(e,t,s,n,o){r(this,"name","");r(this,"geo");r(this,"material");r(this,"context");r(this,"inst");r(this,"handles",[]);r(this,"maxCount");this.name=e,this.geo=t,this.material=s,this.context=o,this.maxCount=n,this.inst=new Pg(t,s,n),this.inst.count=0,this.inst.layers.set(2),this.inst.visible=!0,this.context.scene.add(this.inst)}get currentCount(){return this.inst.count}isFull(){return this.currentCount>=this.maxCount}addInstance(e){if(this.currentCount>=this.maxCount)return console.error("TOO MANY INSTANCES - resize is not yet implemented!",this.inst.count),null;const t=new Bd(-1,e,this);return this.add(t),t}add(e){e.instanceIndex<0&&(e.instanceIndex=this.currentCount,e.instanceIndex>=this.handles.length?this.handles.push(e):this.handles[e.instanceIndex]=e),e.object.updateWorldMatrix(!0,!0),this.inst.setMatrixAt(e.instanceIndex,e.object.matrixWorld),this.inst.instanceMatrix.needsUpdate=!0,this.inst.count+=1,this.inst.count>0&&(this.inst.visible=!0)}remove(e){if(!e||e.instanceIndex<0||e.instanceIndex>=this.handles.length||this.inst.count<=0)return;if(this.handles[e.instanceIndex]!==e){console.error("instance handle is not part of renderer, was it removed before?",e.instanceIndex,this.name);const s=this.handles.indexOf(e);if(s<0)return;e.instanceIndex=s}if(this.handles[e.instanceIndex]=null,this.inst.setMatrixAt(e.instanceIndex,lh.nullMatrix),!(e.instanceIndex>=this.currentCount-1)&&this.currentCount>0){const s=this.handles[this.currentCount-1];s&&(s.instanceIndex=e.instanceIndex,s.updateInstanceMatrix(),this.handles[e.instanceIndex]=s,this.handles[this.currentCount-1]=null)}this.inst.count>0&&(this.inst.count-=1),e.instanceIndex=-1,this.inst.count<=0&&(this.inst.visible=!1),this.inst.instanceMatrix.needsUpdate=!0}updateInstance(e,t){this.inst.setMatrixAt(t,e),this.inst.instanceMatrix.needsUpdate=!0}};let Pr=lh;r(Pr,"nullMatrix",new Be);mt(Pr,"InstancedMeshRenderer");var Ab=Object.defineProperty,gt=(i,e)=>Ab(i,"name",{value:e,configurable:!0});const Ys=O("debugphysics");class Ja{constructor(){r(this,"mass",1);r(this,"kinematic",!1);r(this,"physicsEvents",!1);r(this,"drag",0);r(this,"angularDrag",.05);r(this,"sleepThreshold",.01)}}gt(Ja,"BodyOptions");class xr{constructor(e,t){r(this,"obj");r(this,"parent");r(this,"body");r(this,"shapes",[]);r(this,"collisonCallback",null);r(this,"_hasRigidbody",!1);r(this,"_didSleepLastStep",!1);this.obj=e,this.parent=e.parent,this.body=t}}gt(xr,"PhysicsObject");class Ud{constructor(e,t){r(this,"obj");r(this,"contact");r(this,"target");r(this,"type");this.contact=e,this.type=t,this.obj=null,this.target=null}}gt(Ud,"CollisionData");class Tb{constructor(e,t,s,n){r(this,"body");r(this,"contact");r(this,"target");r(this,"type");this.body=e,this.contact=t,this.target=s,this.type=n}}gt(Tb,"CannonCollision");class Xe{constructor(){r(this,"ray");r(this,"screenPoint");r(this,"raycaster");r(this,"results");r(this,"targets");r(this,"recursive",!0);r(this,"minDistance");r(this,"maxDistance");r(this,"lineThreshold");r(this,"layerMask");r(this,"ignore")}screenPointFromOffset(e,t){this.screenPoint===void 0&&(this.screenPoint=new Q),this.screenPoint.x=e/window.innerWidth*2-1,this.screenPoint.y=-(t/window.innerHeight)*2+1}setMask(e){this.layerMask||(this.layerMask=new ir);const t=this.layerMask;t?t.mask=e:this.layerMask=e}}r(Xe,"AllLayers",4294967295);gt(Xe,"RaycastOptions");class Nd{constructor(e,t,s){r(this,"distance");r(this,"point");r(this,"object");this.object=e,this.distance=t,this.point=s}}gt(Nd,"SphereIntersection");class $d{constructor(e){r(this,"raycaster",new ya);r(this,"defaultRaycastOptions",new Xe);r(this,"targetBuffer",new Array(1));r(this,"defaultThresholds",{Mesh:{},Line:{threshold:0},LOD:{},Points:{threshold:0},Sprite:{}});r(this,"sphereResults",new Array);r(this,"sphereMask",new ir);r(this,"tempBoundingBox",new zi);r(this,"context");r(this,"world",new Og);r(this,"objects",[]);r(this,"tempPosition",new y);r(this,"tempQuaternion",new P);if(this.context=e,this.world.gravity.set(0,-9.82,0),Ys){const t={};t.onInit=(s,n,o)=>{n.layers.set(-1)},Cg(e.scene,this.world.bodies,t)}}sphereOverlap(e,t){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const s=new xg(e,t),n=this.sphereMask;n.enableAll(),n.disable(2);for(const o of this.context.scene.children){const a=this.onSphereOverlap(o,s,n);a&&this.sphereResults.push(a)}return this.sphereResults.sort((o,a)=>o.distance-a.distance)}onSphereOverlap(e,t,s){if(e.type==="Mesh"){if(!e.layers.test(s))return null;const n=e,o=n.geometry;if(o.boundingBox||o.computeBoundingBox(),!o.boundingBox)return null;n.matrixWorldNeedsUpdate&&n.updateMatrixWorld();const a=this.tempBoundingBox.copy(o.boundingBox).applyMatrix4(n.matrixWorld);if(t.intersectsBox(a)){const c=R(e).distanceTo(t.center);return new Nd(e,c,t.center.clone())}}else if(e.children)for(const n of e.children){const o=this.onSphereOverlap(n,t,s);if(o)return o}return null}raycastFromRay(e,t=null){const s=t!=null?t:this.defaultRaycastOptions;return s.ray=e,this.raycast(s)}raycast(e=null){var l,c,h,d,u;e||(e=this.defaultRaycastOptions);const t=(l=e.screenPoint)!=null?l:this.context.input.mousePositionRC,s=(c=e.raycaster)!=null?c:this.raycaster;if(s.near=(h=e.minDistance)!=null?h:0,s.far=(d=e.maxDistance)!=null?d:1/0,s.params=this.defaultThresholds,e.lineThreshold?s.params.Line={threshold:e.lineThreshold}:s.params.Line={threshold:0},e.ray)s.ray.copy(e.ray);else{const _=this.context.mainCamera;if(!_)return console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),(u=this.defaultRaycastOptions.results)!=null?u:[];s.setFromCamera(t,_)}let n=e.targets;n||(n=this.targetBuffer,n[0]=this.context.scene);let o=e.results;o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),e.layerMask!==void 0?e.layerMask instanceof ir?s.layers.mask=e.layerMask.mask:s.layers.mask=e.layerMask:(s.layers.enableAll(),s.layers.disable(2)),o.length=0,s.intersectObjects(n,e.recursive,o);const a=e.ignore;return a!==void 0&&a.length>0&&(o=o.filter(_=>!a.includes(_.object))),o}addPreStepListener(e){this.world.addEventListener("preStep",e)}addPostStepListener(e){this.world.addEventListener("postStep",e)}addConstraint(e){this.world.addConstraint(e)}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}multiplyGravity(e){this.world.gravity.x*=e.x,this.world.gravity.y*=e.y,this.world.gravity.z*=e.z}addBody(e,t){for(let s=0;s<this.objects.length;s++){const n=this.objects[s];if(n.obj===e){n._hasRigidbody=!0;break}}this.world.addBody(t)}removeBody(e,t,s=!0){this.world.removeBody(t);for(let n=0;n<this.objects.length;n++){const o=this.objects[n];if(o.obj===e){o._hasRigidbody=!1,s&&this.objects.splice(n,1);break}}}removeShape(e,t){for(const s of this.objects)if(s.obj===e){s.body&&(s.body.removeShape(t),s.body.updateMassProperties());return}}createBody(e,t){const s=this.internalCreateBody(e,null);t.mass&&(s.mass=t.mass),t.kinematic?s.type=_e.KINEMATIC:s.type=_e.DYNAMIC,t.drag&&(s.linearDamping=t.drag),t.angularDrag&&(s.angularDamping=t.angularDrag),t.sleepThreshold&&(s.sleepSpeedLimit=t.sleepThreshold),s.name=e.name,this.world.addBody(s);const n=new xr(e,s);return n._hasRigidbody=!0,this.objects.push(n),Ys&&console.log("created new body",s),t.physicsEvents&&this.registerCollisionEvents(n),s}addBoxCollider(e,t,s,n,o){const a=this.tempPosition;e.getWorldScale(a);const l=new si(.5*a.x*n.x,.5*a.y*n.y,.5*a.z*n.z),c=new Sg(l);c.collisionResponse=!t,s=s.clone(),s.multiply(a);const h=this.addShape(e,c,s,o);if(h!==null){if(this.isAlreadyRegistered(h))return c;const d=new xr(e,h);this.objects.push(d)}return c}addSphereCollider(e,t,s,n){const o=this.tempPosition;e.getWorldScale(o);const a=Math.max(o.x,o.y,o.z),l=new Rg(s*a);t=t.clone(),t.multiply(o);const c=this.addShape(e,l,t,n);if(c!==null){if(this.isAlreadyRegistered(c))return l;const h=new xr(e,c);this.objects.push(h)}return l}addMeshCollider(e){Ys&&console.warn("TODO mesh collider not yet supported")}isAlreadyRegistered(e){for(const t of this.objects)if(t.body===e)return!0;return!1}addShape(e,t,s,n){let o=null;if(n?(n.initialize(),console.assert(!!n.body,"rigidbody didn't initialize / produce a physics body",n),o=n.body):(o=this.internalCreateBody(e,null),o.type=_e.KINEMATIC,this.world.addBody(o)),o){s.x*=-1;const a=re(e),l=R(e);l.add(s);const c=new P(o.quaternion.x,o.quaternion.y,o.quaternion.z,o.quaternion.w);a.multiply(c.invert());const h=o.position,d=new si(l.x-h.x,l.y-h.y,l.z-h.z),u=new Ph(a.x,a.y,a.z,a.w);o.addShape(t,d,u),o.updateMassProperties()}return o}step(e){e=Math.min(e,1/30),this.world.step(e)}postStep(){for(let e=0;e<this.objects.length;e++){const t=this.objects[e],s=t.body;if(!s||!s.world)continue;s.sleepTick(this.context.time.time),Ys&&(!t._didSleepLastStep&&s.sleepState===_e.SLEEPING?console.log("BODY SLEEPING",s):t._didSleepLastStep&&s.sleepState!==_e.SLEEPING&&console.log("BODY WOKE UP",s)),t._didSleepLastStep=s.sleepState===_e.SLEEPING;const n=t.obj;if(s.type===_e.KINEMATIC){const o=R(n,null);s.position.set(o.x,o.y,o.z);const a=re(n);s.quaternion.set(a.x,a.y,a.z,a.w);continue}if(t.parent&&n.parent===t.parent){ad(n,s.quaternion.x,s.quaternion.y,s.quaternion.z,s.quaternion.w);const o=s.position;ar(n,o.x,o.y,o.z),s.velocity.length()>s.sleepSpeedLimit&&ue.markDirty(n)}}}internalCreateBody(e,t){const s=new _e;e.getWorldPosition(this.tempPosition);const n=this.tempPosition;s.position=new si(n.x,n.y,n.z);const o=this.tempQuaternion;return e.getWorldQuaternion(o),s.quaternion=new Ph(o.x,o.y,o.z,o.w),s.type=_e.KINEMATIC,t&&(s.addShape(t),s.updateMassProperties()),s}registerCollisionEvents(e){if(e.collisonCallback&&this.unregisterCollisionEvents(e),!e.body)return;const t=gt(s=>this.raiseCollisionEvents(e.obj,s),"evt");e.collisonCallback=t.bind(this),e.body.addEventListener("collide",e.collisonCallback)}unregisterCollisionEvents(e){!e.collisonCallback||!e.body||e.body.removeEventListener("collide",e.collisonCallback)}raiseCollisionEvents(e,t){var l,c;const s=new Ud(t.contact,t.type);let n=0;const o=this.objects;function a(){if(!(n>0))for(let h=0;h<o.length;h++){if(n==2)return;const d=o[h];d.body==t.body?(s.obj=d.obj,++n):d.body==t.target&&(s.target=d.obj,++n)}}gt(a,"requestData"),Ys&&console.log("collision between",t.contact.bi,t.contact.bj,e,t);for(let h=0;h<((c=(l=e.userData)==null?void 0:l.components)==null?void 0:c.length);h++){const d=e.userData.components[h];d.onCollision&&(a(),d.onCollision(s))}}}gt($d,"Physics");var Lb=Object.defineProperty,Db=(i,e)=>Lb(i,"name",{value:e,configurable:!0});class Wd{constructor(){r(this,"deltaTime",0);r(this,"time",0);r(this,"frame",0);r(this,"clock",new Eg);r(this,"_smoothedFps",0);r(this,"_fpsSamples",[]);r(this,"_fpsSampleIndex",0)}get realtimeSinceStartup(){return this.clock.elapsedTime}get frameCount(){return this.frame}get smoothedFps(){return this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<30?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%30]=this.deltaTime;let e=0;for(let t=0;t<this._fpsSamples.length;t++)e+=this._fpsSamples[t];this._smoothedFps=1/(e/this._fpsSamples.length)}}Db(Wd,"Time");var kb=Object.defineProperty,Ib=(i,e)=>kb(i,"name",{value:e,configurable:!0});class It extends v{constructor(){super(...arguments);r(this,"url",null);r(this,"urlParameterName",null);r(this,"localhost",null)}getWebsocketUrl(){let e=this.url?It.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const o=O(this.urlParameterName);o&&typeof o=="string"&&(e=o)}if(!e)return null;const s=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(e);return(s==null?void 0:s.groups)?(s==null?void 0:s.groups.socket_prefix)?e:"wss://"+(s==null?void 0:s.groups.url):null}static GetUrl(e,t){let s=e;const n=It.IsLocalNetwork()&&t;return n&&(s=t),(e==null?void 0:e.startsWith("/"))&&(s=(n?s:window.location.origin)+e),s}static IsLocalNetwork(e=window.location.hostname){return new RegExp(".{3}..{2,3}..{2,3}..{2,3}|localhost","gm").test(e)===!0?!0:["localhost","127.0.0.1","","::1","marcel-pfc-domain.de"].includes(e)||e.startsWith("192.168.")||e.startsWith("10.0.")||e.endsWith(".local")}}Ib(It,"Networking");var Mb=Object.defineProperty,Za=(i,e)=>Mb(i,"name",{value:e,configurable:!0});const Hd={};function Or(i,e){Hd[i]=e}Za(Or,"registerType");function zd(i){const e=i.getBufferIdentifier();return Hd[e](i)}Za(zd,"tryCast");function Gd(i){return typeof i.guid=="function"?i.guid():null}Za(Gd,"tryGetGuid");var jb=Object.defineProperty,Cr=(i,e)=>jb(i,"name",{value:e,configurable:!0}),Ka;(function(i){i.ConnectionList="connection-list"})(Ka||(Ka={}));class Vd{constructor(){r(this,"_host");r(this,"_client");r(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const e="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(e)}trySetupHost(e){let t=new va(e);t.on("error",s=>{console.error(s),this._host=void 0,this.trySetupClient(e)}),t.on("open",s=>{this._host=new qd(t)})}trySetupClient(e){this._client=new va,this._client.on("error",t=>{console.error("Client error",t)}),this._client.on("open",t=>{console.log("client connected",t),this._clientData=this._client.connect(e,{metadata:{id:t}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",s=>{console.log("<<",s)})})}}Cr(Vd,"PeerNetworking");class el{constructor(e){r(this,"_peer");this._peer=e}}Cr(el,"AbstractPeerHandler");class Fb extends el{get isHost(){return!1}onConnection(e){}}Cr(Fb,"PeerClient");class qd extends el{constructor(e){super(e);r(this,"_connections",[]);var t;console.log("I AM THE HOST"),(t=this._peer)==null||t.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(e){console.log("host connection",e),e.on("open",()=>{this._connections.push(e),this.broadcastConnection(e)})}broadcastConnection(e){const t=this._connections.map(s=>{var n;return(n=s.metadata)==null?void 0:n.id}).filter(s=>s!==void 0);this.broadcast({type:Ka.ConnectionList,connections:t})}broadcast(e){if(e!=null){console.log(">>",e);for(const t in this._peer.connections){const s=this._peer.connections[t];if(!!s)if(Array.isArray(s))for(const n of s)!n||n.send(e);else console.warn(s)}}}}Cr(qd,"PeerHost");var Bb=Object.defineProperty,Xi=(i,e)=>Bb(i,"name",{value:e,configurable:!0});let tl="wss://needle-tiny-starter.glitch.me/socket";const be=!!O("debugnet"),Sr=!!(be||O("debugowner"));var il;(function(i){i.ConnectionInfo="connection-start-info"})(il||(il={}));var G;(function(i){i.Join="join-room",i.Leave="leave-room",i.JoinedRoom="joined-room",i.LeftRoom="left-room",i.UserJoinedRoom="user-joined-room",i.UserLeftRoom="user-left-room"})(G||(G={}));class Ub{constructor(){r(this,"room");r(this,"viewId");r(this,"allowEditing");r(this,"inRoom")}}Xi(Ub,"JoinedRoomResponse");class Nb{constructor(){r(this,"room")}}Xi(Nb,"LeftRoomResponse");class $b{constructor(){r(this,"userId")}}Xi($b,"UserJoinedOrLeftRoomModel");var Z;(function(i){i.RequestHasOwner="request-has-owner",i.ResponseHasOwner="response-has-owner",i.RequestIsOwner="request-is-owner",i.ResponseIsOwner="response-is-owner",i.RequestOwnership="request-ownership",i.GainedOwnership="gained-ownership",i.RemoveOwnership="remove-ownership",i.LostOwnership="lost-ownership",i.GainedOwnershipBroadcast="gained-ownership-broadcast",i.LostOwnershipBroadcast="lost-ownership-broadcast"})(Z||(Z={}));class Rr{constructor(e,t){r(this,"guid");r(this,"connection");r(this,"_hasOwnership",!1);r(this,"_isOwned");r(this,"_gainSubscription");r(this,"_lostSubscription");r(this,"_hasOwnerResponse");r(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=e,this.guid=t,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),e.beginListen(Z.LostOwnership,this._lostSubscription),e.beginListen(Z.GainedOwnershipBroadcast,this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),e.beginListen(Z.ResponseHasOwner,this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send(Z.RequestHasOwner,{guid:this.guid})}onHasOwnerResponse(e){e.guid===this.guid&&(this._isOwned=e.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen(Z.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this.connection.send(Z.RequestHasOwner,{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(e){e.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Z.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=e.value,e.value||(Sr&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((e,t)=>{this.requestOwnership();let s=0;const n=Xi(()=>{if(s++>10)return t("Timeout");setTimeout(()=>{this.hasOwnership?e(this):n()},100)},"waitForOwnership");n()})}requestOwnership(){return Sr&&console.log("Request ownership",this.guid),this.connection.send(Z.RequestOwnership,{guid:this.guid}),this}freeOwnership(){return this.connection.send(Z.RemoveOwnership,{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Z.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListening(Z.GainedOwnership,this._gainSubscription),this.connection.stopListening(Z.LostOwnership,this._lostSubscription),this.connection.stopListening(Z.ResponseHasOwner,this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Z.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(e){e.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===e.owner?(Sr&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(e){e===this.guid&&(Sr&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}Xi(Rr,"OwnershipModel");var Js;(function(i){i[i.OnConnection=0]="OnConnection",i[i.OnRoomJoin=1]="OnRoomJoin",i[i.Queued=2]="Queued",i[i.Immediate=3]="Immediate"})(Js||(Js={}));class Qd{constructor(e){r(this,"context");r(this,"_peer",null);r(this,"_usersInRoomCopy",[]);r(this,"_defaultMessagesBuffer",[]);r(this,"_defaultMessagesBufferArray",[]);r(this,"_listeners",{});r(this,"_listenersBinary",{});r(this,"connected",!1);r(this,"channelId");r(this,"_connectionId",null);r(this,"_isConnectingToWebsocket",!1);r(this,"_ws");r(this,"_waitingForSocket",{});r(this,"_isInRoom",!1);r(this,"_currentRoomName",null);r(this,"_currentRoomViewId",null);r(this,"_currentRoomAllowEditing",!0);r(this,"_currentInRoom",[]);r(this,"_state",{});r(this,"_currentDelay",-1);this.context=e}get peer(){return this._peer||(this._peer=new Vd),this._peer}tryGetState(e){return e==="invalid"?null:this._state[e]}get connectionId(){return this._connectionId}get isDebugEnabled(){return be}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}userIsInRoom(e){return this._currentInRoom.indexOf(e)!==-1}usersInRoom(e=null){e||(e=this._usersInRoomCopy),e.length=0;for(const t of this._currentInRoom)e.push(t);return e}joinRoom(e,t=!1){this.connect(),be&&console.log("join: "+e),this.send(G.Join,{room:e,viewOnly:t},0)}leaveRoom(e=null){if(e||(e=this.currentRoomName),!e){console.error("Can not leave unknown room");return}this.send(G.Leave,{room:e})}send(e,t=null,s=2){if(t===null&&(t={}),s===2){this._defaultMessagesBuffer.push({key:e,value:t});return}return this.sendWithWebsocket(e,t,s)}sendDeleteRemoteState(e){this.send("delete-state",{guid:e,dontSave:!0}),delete this._state[e]}sendBinary(e){var t;be&&console.log("<< bin",e.length),(t=this._ws)==null||t.send(e)}sendBufferedMessagesNow(){var s;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const e=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(e<=1){this.sendWithWebsocket(o.key,o.value,3);break}const a=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(a)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&be&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const t=JSON.stringify(this._defaultMessagesBufferArray);(s=this._ws)==null||s.send(t)}beginListen(e,t){return this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t),t}stopListening(e,t){if(!t||!this._listeners[e])return;const s=this._listeners[e].indexOf(t);s>=0&&this._listeners[e].splice(s,1)}beginListenBinrary(e,t){return this._listenersBinary[e]||(this._listenersBinary[e]=[]),this._listenersBinary[e].push(t),t}stopListenBinary(e,t){if(!this._listenersBinary[e])return;const s=this._listenersBinary[e].indexOf(t);s>=0&&this._listenersBinary[e].splice(s,1)}connect(){if(this.connected)return;be&&console.log("connecting");const e=p.findObjectOfType(It,this.context,!1),t=e==null?void 0:e.getWebsocketUrl();t&&(tl=t),this.connectWebsocket()}connectWebsocket(){if(this._isConnectingToWebsocket)return;this._isConnectingToWebsocket=!0,console.log("Connecting to "+tl);const e=new Ag.WebsocketBuilder(tl).onOpen(()=>{this._ws=e,this._isConnectingToWebsocket=!1,this.connected=!0,console.log("Connected to websocket"),this.onSendQueued(0)}).onClose(t=>{this.connected=!1,this._isInRoom=!1}).onError((t,s)=>{console.error(t,s)}).onMessage(this.onMessage.bind(this)).onRetry(()=>{console.log("websocket connection retry")}).build()}onMessage(e,t){const s=t.data;try{if(typeof s!="string"){s.size&&this.handleIncomingBinaryMessage(s);return}const n=JSON.parse(s);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch{be&&s==="pong"&&console.log("<<",s)}}async handleIncomingBinaryMessage(e){const t=await e.arrayBuffer();var s=new Uint8Array(t);const n=new Tg(s),o=n.getBufferIdentifier(),a=this._listenersBinary[o],l=zd(n),c=Gd(l);if(c&&typeof c=="string"&&(this._state[c]=l),!a)return;const h=l!=null?l:n;for(const d of a)d(h)}handleIncomingStringMessage(e){var n,o,a,l,c,h,d;if(be&&console.log("<<",(n=e.key)!=null?n:e),e.key)switch(e.key){case il.ConnectionInfo:if(e.data){const b=e.data;b&&(console.assert(b.id!==void 0&&b.id!==null&&b.id.length>0,"server did not send connection id",b.id),console.log("Your id is: "+b.id,(o=this.context.alias)!=null?o:""),this._connectionId=b.id)}else console.warn("Expected connection id in "+e.key);break;case G.JoinedRoom:if(be&&console.log(e),e){this._isInRoom=!0;const b=e;this._currentRoomName=b.room,this._currentRoomViewId=b.viewId,this._currentRoomAllowEditing=(a=b.allowEditing)!=null?a:!0,console.log("Room view id",this._currentRoomViewId),this._currentInRoom.length=0,this._currentInRoom.push(...b.inRoom),be&&console.log("joined room with",this._currentInRoom,(l=this.context.alias)!=null?l:"")}this.onSendQueued(1);break;case G.LeftRoom:e.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentInRoom.length=0);break;case G.UserJoinedRoom:if(e.data){const b=e.data;this._currentInRoom.push(b.userId),be&&console.log(b.userId+" joined","now in room:",this._currentInRoom)}break;case G.UserLeftRoom:if(e.data){const b=e.data,w=this._currentInRoom.indexOf(b.userId);w>=0&&(console.log(b.userId+" left",(c=this.context.alias)!=null?c:""),this._currentInRoom.splice(w,1)),b.userId===this.connectionId&&console.log("you left the room")}break;case"ping":case"pong":const _=(h=e.data)==null?void 0:h.time;_&&(this._currentDelay=this.context.time.time-_),be&&console.log("Current latency: "+this._currentDelay.toFixed(1)+" sec","Clients in room: "+((d=this._currentInRoom)==null?void 0:d.length));break}const t=this._listeners[e.key];if(t)for(const u of t)u(e.data);const s=e.data;s&&(this._state[s.guid]=s)}toMessage(e,t){return{key:e,data:t}}sendWithWebsocket(e,t,s=1){if(!this._ws){const o=this._waitingForSocket[s]||[];o.push(()=>this.sendWithWebsocket(e,t,s)),this._waitingForSocket[s]=o;return}const n=JSON.stringify(this.toMessage(e,t));be&&console.log(">>",e),this._ws.send(n)}onSendQueued(e){const t=this._waitingForSocket[e];if(t){for(const s of t)s();t.length=0}}}Xi(Qd,"NetworkConnection");var Xd=Object.defineProperty,Wb=Object.getOwnPropertyDescriptor,Hb=(i,e)=>Xd(i,"name",{value:e,configurable:!0}),zb=(i,e,t,s)=>{for(var n=s>1?void 0:s?Wb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Xd(e,t,n),n};class Zs extends v{constructor(){super(...arguments);r(this,"constraintActive",!0);r(this,"locked",!1);r(this,"sources",[])}}Hb(Zs,"LookAtConstraint");zb([f(x)],Zs.prototype,"sources",2);var Yd=Object.defineProperty,Gb=Object.getOwnPropertyDescriptor,Vb=(i,e)=>Yd(i,"name",{value:e,configurable:!0}),qb=(i,e,t,s)=>{for(var n=s>1?void 0:s?Gb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Yd(e,t,n),n};class Mt extends v{constructor(){super(...arguments);r(this,"autoRotate",!1);r(this,"autoRotateSpeed",1);r(this,"enableKeys",!0);r(this,"enableDamping",!0);r(this,"dampingFactor",.1);r(this,"enableZoom",!0);r(this,"minZoom",0);r(this,"maxZoom",1/0);r(this,"enablePan",!0);r(this,"lookAtConstraint",null);r(this,"lookAtConstraint01",1);r(this,"middleClickToFocus",!0);r(this,"doubleClickToFocus",!0);r(this,"useSlerp",!1);r(this,"debugLog",!1);r(this,"targetLerpSpeed",5);r(this,"_lookTargetPosition");r(this,"_controls",null);r(this,"_cameraObject",null);r(this,"_lerpToTargetPosition",!1);r(this,"_lerpCameraToTarget",!1);r(this,"_cameraTargetPosition",null);r(this,"_inputs",0);r(this,"_enableTime",0)}get controls(){return this._controls}get controllerObject(){return this._cameraObject}onStartInteraction(e){var t;(t=this.controls)==null||t.addEventListener("start",e)}awake(){this._lookTargetPosition=new y}onEnable(){this._enableTime=this.context.time.time;const e=p.getComponent(this.gameObject,W),t=e==null?void 0:e.cam;this._controls||(console.assert(t!=null,"Missing camera",this),t&&(this._cameraObject=t),this._controls=new xh(t,this.context.renderer.domElement)),this._controls&&(this._controls.enableDamping=this.enableDamping,this._controls.enableKeys=this.enableKeys,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,(t==null?void 0:t.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom):(this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom),this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan)}onDisable(){this._controls&&(this._controls.enabled=!1,this._controls.autoRotate=!1)}start(){if(this._controls){const e=p.getComponent(this.gameObject,W);if(e&&!this.setFromTargetPosition()){console.log("NO TARGET");const t=new y(0,0,-1).applyMatrix4(e.cam.matrixWorld);this.setTarget(t)}}this.startCoroutine(this.startRaycastDelayed())}*startRaycastDelayed(){if(yield,!this.setFromTargetPosition()){const e=new Xe;e.screenPoint=new Q(0,0),e.lineThreshold=.1;const t=this.context.physics.raycast(e);t.length>0&&this.setTarget(t[0].point)}}onBeforeRender(){var t,s,n,o;if(!this._controls)return;(this.context.input.getPointerDown(0)||this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2))&&(this._inputs+=1),this._inputs>0&&(this._controls.autoRotate=!1,this._lerpCameraToTarget=!1,this._lerpToTargetPosition=!1),this._inputs=0;let e=this.middleClickToFocus&&this.context.input.getPointerClicked(1);if(e||(e=this.doubleClickToFocus&&this.context.input.getPointerDoubleClicked(0)&&this.context.time.time-this._enableTime>.3),e?this.setTargetFromRaycast():(this.context.input.getPointerDown(0)||this.context.input.mouseWheelChanged)&&(this._lerpToTargetPosition=!1,this._lerpCameraToTarget=!1),this._lerpToTargetPosition||this._lerpCameraToTarget){const a=this.context.time.deltaTime*this.targetLerpSpeed;this._lerpCameraToTarget&&this._cameraTargetPosition&&this._cameraObject&&(this.useSlerp&&typeof((t=this._cameraObject)==null?void 0:t.position.slerp)=="function"?((s=this._cameraObject)==null?void 0:s.position).slerp(this._cameraTargetPosition,a):(n=this._cameraObject)==null||n.position.lerp(this._cameraTargetPosition,a),this._cameraObject.position.distanceTo(this._cameraTargetPosition)<.01&&(this._lerpCameraToTarget=!1)),this._lerpToTargetPosition&&(this.lerpTarget(this._lookTargetPosition,a),this._lookTargetPosition.distanceTo(this._controls.target)<.005&&(this._lerpToTargetPosition=!1))}((o=this.lookAtConstraint)==null?void 0:o.locked)&&this.setFromTargetPosition(0,this.lookAtConstraint01),this._controls&&(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!0,this._controls.update())}setCameraTarget(e,t=!1){var s;e?(this._lerpCameraToTarget=!0,this._cameraTargetPosition=e.clone(),t&&this._cameraTargetPosition&&((s=this.controllerObject)==null||s.position.copy(this._cameraTargetPosition))):this._lerpCameraToTarget=!1}setFromTargetPosition(e=0,t=1){var n;if(!this._controls)return!1;const s=(n=this.lookAtConstraint)==null?void 0:n.sources;if(s&&s.length>0){const o=s[e];if(o)return o.getWorldPosition(this._lookTargetPosition),this.lerpTarget(this._lookTargetPosition,t),!0}return!1}setTarget(e=null,t=!1){!this._controls||(e!==null&&this._lookTargetPosition.copy(e),t?this._controls.target.copy(this._lookTargetPosition):this._lerpToTargetPosition=!0)}lerpTarget(e,t){!this._controls||this._controls.target.lerp(e,t)}distanceToTarget(e){return this._controls?this._controls.target.distanceTo(e):-1}setTargetFromRaycast(){if(!this.controls)return;const e=this.context.physics.raycast();for(const t of e)if(t.distance>0&&p.isActiveInHierarchy(t.object)){if(this._lookTargetPosition.copy(t.point),this._lerpToTargetPosition=!0,this._cameraTargetPosition=null,this.context.mainCamera){this._lerpCameraToTarget=!0;const s=R(this.context.mainCamera);this._cameraTargetPosition=s.clone().sub(this.controls.target).add(this._lookTargetPosition)}break}}}Vb(Mt,"OrbitControls");qb([f(Zs)],Mt.prototype,"lookAtConstraint",2);var Qb=Object.defineProperty,Xb=(i,e)=>Qb(i,"name",{value:e,configurable:!0});class fe extends g{constructor(e,t,s,n){super(e,t,s);r(this,"alpha",1);this.alpha=n}clone(){const e=super.clone();return e.alpha=this.alpha,e}copy(e){return super.copy(e),"alpha"in e&&typeof e.alpha=="number"&&(this.alpha=e.alpha),typeof e.a=="number"&&(this.alpha=e.a),this}lerp(e,t){const s=e;return s.alpha&&(this.alpha=L.lerp(this.alpha,s.alpha,t)),super.lerp(e,t)}multiply(e){const t=e;return t.alpha&&(this.alpha=this.alpha*t.alpha),super.multiply(e)}}Xb(fe,"RGBAColor");var Jd=Object.defineProperty,Yb=Object.getOwnPropertyDescriptor,sl=(i,e)=>Jd(i,"name",{value:e,configurable:!0}),jt=(i,e,t,s)=>{for(var n=s>1?void 0:s?Yb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Jd(e,t,n),n},Zd;(function(i){i[i.Skybox=1]="Skybox",i[i.SolidColor=2]="SolidColor",i[i.Uninitialized=4]="Uninitialized"})(Zd||(Zd={}));const Kd=O("debugcam");class W extends v{constructor(){super(...arguments);r(this,"orthographic",!1);r(this,"orthographicSize",5);r(this,"ARBackgroundAlpha",0);r(this,"_nearClipPlane",.1);r(this,"_farClipPlane",1e3);r(this,"_backgroundColor");r(this,"_fov",60);r(this,"_cam",null);r(this,"_clearFlags",2);r(this,"_skybox")}get fieldOfView(){return this._fov}set fieldOfView(e){const t=this._fov!=e;this._fov=e,t&&this._cam&&this._cam instanceof ba&&(this._cam.fov=this._fov,this._cam.updateProjectionMatrix())}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(e){const t=this._nearClipPlane!=e;this._nearClipPlane=e,this._cam&&t&&(this._cam.near=e,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(e){const t=this._farClipPlane!=e;this._farClipPlane=e,this._cam&&t&&(this._cam.far=e,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(e){this._clearFlags=e,this.applyClearFlagsIfIsActiveCamera()}get backgroundColor(){var e;return(e=this._backgroundColor)!=null?e:null}set backgroundColor(e){if(!!e){if(this._backgroundColor)this._backgroundColor.copy(e);else{if(!e.clone)return;this._backgroundColor=e.clone()}this.applyClearFlagsIfIsActiveCamera()}}get cam(){return this.activeAndEnabled&&this.buildCamera(),this._cam}awake(){this.sourceId||console.warn("Camera has no source - the camera should be exported inside a gltf",this.name)}onEnable(){Kd&&console.log(this),this.buildCamera(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this),this.applyClearFlagsIfIsActiveCamera()}buildCamera(){if(this._cam)return;const e=this.gameObject.isCamera;let t=null;if(e?t=this.gameObject:t=this.gameObject.children[0],t&&t.isCamera)t.type==="PerspectiveCamera"&&(t.fov=this._fov,t.near=this._nearClipPlane,t.far=this._farClipPlane,t.updateProjectionMatrix());else if(!this.orthographic)t=new ba(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),t.fov=this.fieldOfView;else{const s=this.orthographicSize*100;t=new Lg(window.innerWidth/-s,window.innerWidth/s,window.innerHeight/s,window.innerHeight/-s,this._nearClipPlane,this._farClipPlane)}this._cam=t,this.layer===0&&this._cam.layers.enableAll(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(){var e;if(this._cam&&this.context.mainCameraComponent===this)switch(this._clearFlags){case 1:if(this.context.isInXR&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}this.enableSkybox();break;case 2:if(this.backgroundColor){let t=this.backgroundColor.alpha;this.context.isInXR&&(t=(e=this.ARBackgroundAlpha)!=null?e:0),this.context.scene.background=null,this.context.renderer.setClearColor(this.backgroundColor,t)}break;case 4:this.context.scene.background=null,this.context.renderer.setClearColor(0,0);break}}enableSkybox(){this._skybox||(this._skybox=new eu(this)),this._skybox.enable()}}sl(W,"Camera");jt([f()],W.prototype,"fieldOfView",1);jt([f()],W.prototype,"nearClipPlane",1);jt([f()],W.prototype,"farClipPlane",1);jt([f()],W.prototype,"clearFlags",1);jt([f()],W.prototype,"orthographic",2);jt([f()],W.prototype,"orthographicSize",2);jt([f()],W.prototype,"ARBackgroundAlpha",2);jt([f(fe)],W.prototype,"backgroundColor",1);class eu{constructor(e){r(this,"_camera");r(this,"_skybox");this._camera=e}get context(){var e;return(e=this._camera)==null?void 0:e.context}enable(){this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),this._skybox?(Kd&&console.log("Set skybox",this._camera),this._skybox.encoding=Gi,this._skybox.mapping=wa,this.context.scene.background=this._skybox):console.warn("Failed to load/find skybox texture",this)}}sl(eu,"CameraSkybox");function tu(i){const e="created/implictly",t=new x;i.add(t);const s=p.addNewComponent(t,W,!1);s.sourceId=e;const n=p.addNewComponent(t,Mt,!1);return n.sourceId=e,s}sl(tu,"createCameraWithOrbitControl");var Jb=Object.defineProperty,Zb=(i,e)=>Jb(i,"name",{value:e,configurable:!0});async function nl(i){}Zb(nl,"post_awake");var Kb=Object.defineProperty,iu=(i,e)=>Kb(i,"name",{value:e,configurable:!0});class ey{constructor(){r(this,"_context")}get context(){var e;return(e=this._context)!=null?e:k.Current}get isStateMachineBehaviour(){return!0}}iu(ey,"StateMachineBehaviour");class Er{constructor(e,t,s,n){r(this,"_name");r(this,"_nameHash");r(this,"_normalizedTime");r(this,"_length");r(this,"_speed");this._name=e.name,this._nameHash=e.hash,this._normalizedTime=t,this._length=s,this._speed=n}get name(){return this._name}get nameHash(){return this._nameHash}get normalizedTime(){return this._normalizedTime}get length(){return this._length}get speed(){return this._speed}}iu(Er,"AnimatorStateInfo");var Ft;(function(i){i[i.If=1]="If",i[i.IfNot=2]="IfNot",i[i.Greater=3]="Greater",i[i.Less=4]="Less",i[i.Equals=6]="Equals",i[i.NotEqual=7]="NotEqual"})(Ft||(Ft={}));var rl;(function(i){i[i.Float=1]="Float",i[i.Int=3]="Int",i[i.Bool=4]="Bool",i[i.Trigger=9]="Trigger"})(rl||(rl={}));var ty=Object.defineProperty,iy=(i,e)=>ty(i,"name",{value:e,configurable:!0});class su{constructor(){r(this,"_types",{})}add(e,t){const s=this._types[e];s===void 0?this._types[e]=t:s!==t&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",e)}get(e){return this._types[e]}}iy(su,"_TypeStore");const m=new su,Ks=O("gizmos"),ye=O("debugextension");var sy=Object.defineProperty,en=(i,e)=>sy(i,"name",{value:e,configurable:!0});const Ar=O("debugresolvedependencies"),ny=[{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function Tr(i,e){Ar&&console.log(i,e);const t=[];Lr(ny,i,e,t);const s=await Promise.all(t);return typeof e=="string"&&s.length===1?s[0]:s}en(Tr,"resolveReferences");function Lr(i,e,t,s){if(typeof t=="object"&&t!==void 0&&t!==null)for(const n of Object.keys(t)){const o=t[n];if(typeof o=="string"){const a=al(e,o);if(a!==null)typeof a.then=="function"?s.push(a.then(l=>t[n]=l)):t[n]=a;else for(const l of i){const c=Dr(l.prefix,o);if(c>=0){Ar&&console.log(l,c,l.dependencyName),s.push(e==null?void 0:e.getDependency(l.dependencyName,c).then(h=>(t[n]=h,h)));break}}}else if(Array.isArray(o))for(let a=0;a<o.length;a++){const l=o[a],c=al(e,l);if(c!==null){typeof c.then=="function"?s.push(c.then(h=>o[a]=h)):o[a]=c;continue}for(const h of i){const d=Dr(h.prefix,l);if(d>=0){Ar&&console.log(h,d,h.dependencyName),s.push(e==null?void 0:e.getDependency(h.dependencyName,d).then(u=>o[a]=u));break}}typeof l=="object"&&Lr(i,e,l,s)}else typeof o=="object"&&Lr(i,e,o,s)}else typeof t=="string"&&nu(i,e,t,s)}en(Lr,"internalResolve");const ol="extensions/";function al(i,e){if(i&&i.plugins&&typeof e=="string"&&e.startsWith(ol)){let t=e.substring(ol.length);const s=t.indexOf("/");s>=0&&(t=t.substring(0,s));const n=i.plugins[t];if(ye&&console.log(t,n),typeof(n==null?void 0:n.resolve)=="function"){const o=e.substring(ol.length+t.length+1);return n.resolve(i,o)}}return null}en(al,"resolveExtension");function nu(i,e,t,s){for(const n of i){const o=Dr(n.prefix,t);if(o>=0)return Ar&&console.log(n,o,n.dependencyName),s.push(e==null?void 0:e.getDependency(n.dependencyName,o).then(a=>a)),!0}return!1}en(nu,"tryResolveDependency");function Dr(i,e){if(typeof e=="string"&&e.startsWith(i)){const t=e.substring(i.length),s=Number.parseInt(t);if(s>=0)return s}return-1}en(Dr,"tryGetIndex");var ry=Object.defineProperty,ru=(i,e)=>ry(i,"name",{value:e,configurable:!0});const ll="NEEDLE_persistent_assets";function ou(i){return(i==null?void 0:i.___persistentAsset)===!0}ru(ou,"isPersistentAsset");class au{constructor(e){r(this,"parser");this.parser=e}get name(){return ll}async afterRoot(e){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)==null?void 0:o.extensions))return;const t=this.parser.json.extensions[ll];if(!t)return;ye&&console.log(t);const s=new Array;for(const a of t==null?void 0:t.assets){const l=Tr(this.parser,a);l&&s.push(l)}await Promise.all(s)}resolve(e,t){const s=Number.parseInt(t);if(s>=0){ye&&console.log(t);const n=e.json.extensions[ll];if(n){const o=n==null?void 0:n.assets[s];if(o&&typeof o=="object"){o.___persistentAsset=!0;const a=o.__type;a&&m.get(a)}return o}}return null}}ru(au,"NEEDLE_persistent_assets");var oy=Object.defineProperty,ve=(i,e)=>oy(i,"name",{value:e,configurable:!0});const ci=O("debugserializer");class lu{constructor(){r(this,"typeMap",{})}register(e,t){if(this.typeMap[e]!==void 0){if(this.typeMap[e]===t)return;console.warn("Type "+e+" is already registered",t,this.typeMap[e])}ci&&console.log("Register type serializer for "+e,t),this.typeMap[e]=t}getSerializer(e){if(!!e)return this.typeMap[e]}getSerializerForConstructor(e,t=0){var c,h,d,u;if(t>20)return;if(!e||!e.constructor){ci&&console.log("invalid type");return}const s=(h=e.name)!=null?h:(c=e.constructor)==null?void 0:c.name;if(!s){ci&&console.log("invalid name",s);return}const n=this.getSerializer(s);if(n!==void 0)return ci&&console.log("FOUND "+s,e.name,e.constructor.name,n,this.typeMap),n;let o=Object.getPrototypeOf(e);if(!(o.prototype||o.constructor)){ci&&console.warn("No prototype for "+s,e,e.name,e.prototype,e.constructor.name);return}const l=(d=o.prototype)!=null?d:o.constructor;if(l!==e){const _=this.getSerializerForConstructor(l,++t);if(_){ci&&console.log("FOUND "+l.constructor.name,l.name,l,_);const b=(u=l.name)!=null?u:l.constructor.name;b==="Function"?console.error("Registering Function is not allowed, something went wrong",e,l,_):this.register(b,_)}return _}}}ve(lu,"SerializationHelper");const kr=new lu;class Yi{constructor(e){if(Array.isArray(e))for(const t of e)kr.register(t.name,this);else kr.register(e.name,this)}}ve(Yi,"TypeSerializer");class cl{constructor(e){r(this,"root");r(this,"gltf");r(this,"gltfId");r(this,"object");r(this,"target");r(this,"nodeId");r(this,"nodeToObject");r(this,"objectToNode");r(this,"context");r(this,"path");this.root=e}}ve(cl,"SerializationContext");function cu(i,e){const t=i.$serializedTypes;if(t===void 0)return null;const s={};for(const n in t){let o=i[n];if(o!=null&&typeof o=="object"){const a=kr.getSerializerForConstructor(o);if(a){s[n]=a.onSerialize(o,e);continue}}s[n]=o}return s.name=i.constructor.name,typeof i.guid=="string"&&(s.guid=i.guid),s}ve(cu,"serializeObject");const Ir=[];function hl(i,e){if(!i)return e;typeof i.$serializedTypes=="object"&&(e||(e={}),Object.assign(e,i.$serializedTypes));const t=Object.getPrototypeOf(i);return hl(t,e)}ve(hl,"collectSerializedTypesInBaseTypes");function Mr(i,e,t){if(!i)return!1;if(t.target=i,i.onBeforeDeserialize!==void 0){const n=i.onBeforeDeserialize(e,t);if(typeof n=="boolean")return n}const s=hl(i);if(e){if(typeof e.guid=="string"&&(i.guid=e.guid),s)for(const n in s){const o=s[n],a=e[n];if(t.path=n,o===null)i[n]=a;else{let l=function(c){const d=c.type;return d?jr(a,d,t,void 0,i[n]):jr(a,c,t,void 0,i[n])};if(ve(l,"tryResolve"),i.onBeforeDeserializeMember!==void 0&&i.onBeforeDeserializeMember(n,a,t)===!0)continue;if(Array.isArray(o))for(let c=0;c<o.length;c++){const h=o[c],d=l(h);if(d!==void 0||c===o.length-1){i[n]=d;break}}else i[n]=l(o);Ir.length=0,i.onAfterDeserializeMember!==void 0&&i.onAfterDeserializeMember(n,a,t)}}hu(i,e)}return i.onAfterDeserialize!==void 0&&i.onAfterDeserialize(e,t),t.path=void 0,!0}ve(Mr,"deserializeObject");function hu(i,e){for(const s of Object.keys(e)){const n=e[s];if(typeof n=="object"&&n!==null&&n!==void 0){const o=i[s];if(!o){ci&&console.log(s,"is undefined on",i);continue}for(const a of Object.keys(n))o[a]===void 0&&t(n[a])&&!t(o)&&(o[a]=n[a])}}function t(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}ve(t,"isPrimitiveType")}ve(hu,"implictlyAssignPrimitiveTypes");function jr(i,e,t,s,n){let o=typeof e=="function"&&e.prototype===void 0,a=e;if(o)try{if(a=e==null?void 0:e.call(e,n),o=!1,a==null)return}catch(d){console.error("Error in callback",d,i)}if(!o&&n instanceof a)return n;if(n&&typeof n=="object"&&ou(n)){if(n.__concreteInstance)return n.__concreteInstance;const d=n;if(!d.$serializedTypes&&a.prototype.$serializedTypes&&(d.$serializedTypes=a.prototype.$serializedTypes),d.$serializedTypes&&Mr(d,i,t),n&&a!==void 0)try{const u=new a;ye&&console.log("Create concrete instance for persistent asset",n,"instance:",u),Fr(u,n),n.__concreteInstance=u,n=u}catch(u){console.error("Error creating instance or creating values on instance",u,n,a)}return n}if(s||(s={serializer:kr.getSerializerForConstructor(a)}),Array.isArray(i)){const d=[];for(let u=0;u<i.length;u++){const _=i[u],b=jr(_,e,t,s,_);d.push(b)}return d}const l=s.serializer;if(l)return l.onDeserialize(i,t);let c;i&&(i.isMaterial||i.isTexture||i.isObject3D)?c=i:c=new a(...du(i));const h=c;return h.$serializedTypes&&Mr(h,i,t),c}ve(jr,"deserializeObjectWithType");function du(i){if(Ir.length=0,typeof i=="object"&&i!==null&&i!==void 0)for(const e of Object.keys(i))Ir.push(i[e]);return Ir}ve(du,"setBuffer");function Fr(i,e){if(e!=null&&i!=null)for(const t of Object.keys(e)){const s=uu(i,t);(!s||s.writable===!0||(s==null?void 0:s.set)!==void 0)&&(i[t]=e[t])}}ve(Fr,"assign");function uu(i,e){let t;do t=Object.getOwnPropertyDescriptor(i,e);while(!t&&(i=Object.getPrototypeOf(i)));return t}ve(uu,"getPropertyDescriptor");var ay=Object.defineProperty,Br=(i,e)=>ay(i,"name",{value:e,configurable:!0});const Bt=O("debuganimatorcontroller"),dl=O("debugrootmotion");class hi{constructor(e){r(this,"normalizedStartOffset",0);r(this,"_speed",1);r(this,"animator");r(this,"model");r(this,"_mixer");r(this,"_activeState");r(this,"_activeStates",[]);r(this,"rootMotionHandler");this.model=e,Bt&&console.log(this)}Play(e,t=-1,s=Number.NEGATIVE_INFINITY,n=0){if(t<0)t=0;else if(t>=this.model.layers.length){console.warn("invalid layer");return}const a=this.model.layers[t].stateMachine;for(const l of a.states)if(l.name===e||l.hash===e){Bt&&console.log("transition to ",l),this.transitionTo(l,n,s);return}console.warn("Could not find "+e+" to play")}Reset(){this.setStartTransition()}SetBool(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetBool(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:!1}SetFloat(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetFloat(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:0}SetInteger(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetInteger(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:0}SetTrigger(e){var s;Bt&&console.log("SET TRIGGER",e);const t=typeof e=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[t]===e).forEach(n=>n.value=!0)}ResetTrigger(e){var s;const t=typeof e=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[t]===e).forEach(n=>n.value=!1)}IsInTransition(){return this._activeStates.length>1}SetSpeed(e){this._speed=e}FindState(e){if(!e)return null;for(const t of this.model.layers)for(const s of t.stateMachine.states)if(s.name===e)return s;return null}get context(){var e;return(e=this.animator)==null?void 0:e.context}bind(e){this.animator=e,this._mixer=new Pa(this.animator.gameObject),this.createActions(this.animator)}clone(){const e=or(this.model,(s,n,o)=>{var a;return o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||((a=o==null?void 0:o.constructor)==null?void 0:a.name)==="AnimationAction"||o.tracks!==void 0)});return console.assert(e!==this.model),new hi(e)}update(){var t,s;if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates();const e=this.animator.context.time.deltaTime;this.animator.applyRootMotion&&((t=this.rootMotionHandler)==null||t.onBeforeUpdate()),this._mixer.update(e),this.animator.applyRootMotion&&((s=this.rootMotionHandler)==null||s.onAfterUpdate())}updateActiveStates(){for(let e=0;e<this._activeStates.length;e++){const t=this._activeStates[e],s=t.motion;if(!s.action)this._activeStates.splice(e,1),e--;else{const n=s.action;n.getEffectiveWeight()<=0&&!n.isRunning()&&(Bt&&console.debug("REMOVE",t.name,n.getEffectiveWeight(),n.isRunning(),n.isScheduled()),this._activeStates.splice(e,1),e--)}}}setStartTransition(){for(const e of this.model.layers){const t=e.stateMachine,s=t.states[t.defaultState];this.transitionTo(s,0,this.normalizedStartOffset)}}evaluateTransitions(){var o;let e=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;e=!0}const t=this._activeState,s=t.motion.action;for(const a of t.transitions){if(!a.hasExitTime&&a.conditions.length<=0)continue;let l=!0;for(const c of a.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(!!l){Bt&&l&&console.log("All conditions are met",a.conditions,s);for(const c of a.conditions){const h=this.model.parameters.find(d=>d.name===c.parameter);(h==null?void 0:h.type)===rl.Trigger&&(h.value=!1)}if(s){const c=t.motion.clip.duration,h=c<=0?1:s.time/c;if(!a.hasExitTime||h>=a.exitTime&&s.time>=s.getClip().duration){s.clampWhenFinished=!0,Bt&&(console.log("transition to "+a.destinationState,a),console.log(s.time,a.exitTime)),this.transitionTo(a.destinationState,a.duration,a.offset);return}}else{this.transitionTo(a.destinationState,a.duration,a.offset);return}}}let n=!1;if(t.motion.isLooping&&s&&s.time>=s.getClip().duration&&(n=!0,s.reset(),s.time=0,s.play()),!n&&t&&!e&&s&&this.animator&&t.behaviours){const a=s==null?void 0:s.getClip().duration,l=s.time/a,c=new Er(this._activeState,l,a,this._speed);for(const h of t.behaviours)h.instance&&((o=h.instance.onStateUpdate)==null||o.call(h.instance,this.animator,c,0))}}transitionTo(e,t,s){var h,d,u,_,b,w,C,S;if(!this.animator)return;const n=0;if(typeof e=="number"&&(e==-1&&(e=this.model.layers[n].stateMachine.defaultState),e=this.model.layers[n].stateMachine.states[e]),!(e==null?void 0:e.motion)||!e.motion.clip)return;const o=this._activeState===e;if(o){const A=e.motion;!A.action_loopback&&A.clip&&(this._mixer.uncacheAction(A.clip,this.animator.gameObject),A.action_loopback=this.createAction(A.clip))}if(((h=this._activeState)==null?void 0:h.behaviours)&&this._activeState.motion.action){const A=(d=this._activeState)==null?void 0:d.motion.clip.duration,M=this._activeState.motion.action.time/A,E=new Er(this._activeState,M,A,this._speed);for(const T of this._activeState.behaviours)(_=(u=T.instance)==null?void 0:u.onStateExit)==null||_.call(T.instance,this.animator,E,n)}const a=(b=this._activeState)==null?void 0:b.motion.action;a&&a.fadeOut(t),o&&(e.motion.action=e.motion.action_loopback,e.motion.action_loopback=a);const l=this._activeState;this._activeState=e;const c=(w=e.motion)==null?void 0:w.action;if(c){s=Math.max(0,Math.min(1,s)),c.isRunning()&&c.stop(),c.reset(),c.timeScale=this._speed,c.enabled=!0;const A=e.motion.clip.duration;if(c.time=s*A,c.clampWhenFinished=!0,c.setLoop(Oh,0),t>0?c.fadeIn(t):c.setEffectiveWeight(1),c.play(),this.rootMotionHandler&&this.rootMotionHandler.onStart(c),this._activeStates.includes(e)||this._activeStates.push(e),this._activeState.behaviours){const M=new Er(e,s,A,this._speed);for(const E of this._activeState.behaviours)(S=(C=E.instance)==null?void 0:C.onStateEnter)==null||S.call(E.instance,this.animator,M,n)}}else console.warn("No action",e.motion,this);Bt&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+e.name,t,a,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}createAction(e){var t;if(this._mixer.uncacheClip(e),(t=this.animator)==null?void 0:t.applyRootMotion){this.rootMotionHandler||(this.rootMotionHandler=new fu(this));const s=this.animator.gameObject;return this.rootMotionHandler.createClip(this._mixer,s,e)}else return this._mixer.clipAction(e)}evaluateCondition(e){const t=this.model.parameters.find(s=>s.name===e.parameter);if(!t)return!1;switch(e.mode){case Ft.If:return t.value===!0;case Ft.IfNot:return t.value===!1;case Ft.Greater:return t.value>e.threshold;case Ft.Less:return t.value<e.threshold;case Ft.Equals:return t.value===e.threshold;case Ft.NotEqual:return t.value!==e.threshold}return!1}createActions(e){var t,s,n;for(const o of this.model.layers){const a=o.stateMachine;for(let l=0;l<a.states.length;l++){const c=a.states[l];if(!!c.motion){if(this.animator&&c.motion.clips){const h=(t=c.motion.clips)==null?void 0:t.find(d=>{var u,_;return d.node.name===((_=(u=this.animator)==null?void 0:u.gameObject)==null?void 0:_.name)});c.motion.clip=h==null?void 0:h.clip}if((s=c.motion)==null?void 0:s.clip){const h=c.motion.clip,d=this.createAction(h);c.motion.action=d}if(c.behaviours&&Array.isArray(c.behaviours))for(const h of c.behaviours){if(!(h==null?void 0:h.typeName))continue;const d=m.get(h.typeName),u=new d;u.isStateMachineBehaviour&&(u._context=(n=this.context)!=null?n:void 0,Fr(u,h.properties),h.instance=u),Bt&&console.log("Created animator controller behaviour",c.name,h.typeName,h.properties,u)}}}}}*enumerateActions(){for(const e of this.model.layers){const t=e.stateMachine;for(let s=0;s<t.states.length;s++){const n=t.states[s];(n==null?void 0:n.motion)&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}}Br(hi,"AnimatorController");class ul{constructor(e,t){r(this,"track");r(this,"createdInterpolant");r(this,"originalEvaluate");r(this,"customEvaluate");this.track=e;const s=e,n=s.createInterpolant.bind(e);s.createInterpolant=()=>(s.createInterpolant=n,this.createdInterpolant=n(),this.originalEvaluate=this.createdInterpolant.evaluate.bind(this.createdInterpolant),this.customEvaluate=o=>{if(!this.originalEvaluate)return;const a=this.originalEvaluate(o);return t(o,a)},this.createdInterpolant.evaluate=this.customEvaluate,this.createdInterpolant)}evaluate(e){this.customEvaluate&&this.customEvaluate(e)}dispose(){this.createdInterpolant&&this.originalEvaluate&&(this.createdInterpolant.evaluate=this.originalEvaluate),this.track=void 0,this.createdInterpolant=null,this.originalEvaluate=void 0,this.customEvaluate=void 0}}Br(ul,"TrackEvaluationWrapper");const N=class{constructor(e,t,s,n,o){r(this,"_action");r(this,"root");r(this,"clip");r(this,"positionWrapper",null);r(this,"rotationWrapper",null);r(this,"context");if(this.context=e,this.root=t,this.clip=s,N.firstKeyframeRotation[s.uuid]||(N.firstKeyframeRotation[s.uuid]=new P),o){const a=o.values;N.firstKeyframeRotation[s.uuid].set(a[0],a[1],a[2],a[3])}N.spaceRotation[s.uuid]||(N.spaceRotation[s.uuid]=new P),N.clipOffsetRotation[s.uuid]=new P,o&&N.clipOffsetRotation[s.uuid].set(o.values[0],o.values[1],o.values[2],o.values[3]).invert(),this.handlePosition(s,n),this.handleRotation(s,o)}set action(e){this._action=e}get action(){return this._action}onStart(e){if(e.getClip()!==this.clip)return;const t=N.lastObjRotation[this.root.uuid];if(N.spaceRotation[this.clip.uuid].copy(t),dl){const s=new he().setFromQuaternion(t);console.log("START",this.clip.name,L.toDegrees(s.y))}}getClipRotationOffset(){return N.clipOffsetRotation[this.clip.uuid]}handlePosition(e,t){if(t){const s=this.root;s.add(new sr),N.lastObjPosition[s.uuid]||(N.lastObjPosition[s.uuid]=new y);const n=new y,o=new y;let a=0;this.positionWrapper=new ul(t,(l,c)=>(s.position.copy(N.lastObjPosition[s.uuid]),dl&&s.position.length()>8&&s.position.set(0,0,0),l>a&&(n.set(c[0],c[1],c[2]),n.sub(o),n.applyQuaternion(this.getClipRotationOffset()),n.applyQuaternion(N.spaceRotation[e.uuid]),s.position.add(n)),N.lastObjPosition[s.uuid].copy(s.position),o.fromArray(c),a=l,c[0]=0,c[1]=0,c[2]=0,c))}}handleRotation(e,t){if(t){if(dl){const l=t.values,c=new he().setFromQuaternion(new P(l[0],l[1],l[2],l[3]));console.log(e.name,t.name,"FIRST ROTATION IN TRACK",L.toDegrees(c.y));const h=t.values.length-4,d=new P().set(l[h],l[h+1],l[h+2],l[h+3]),u=new he().setFromQuaternion(d);console.log(e.name,t.name,"LAST ROTATION IN TRACK",L.toDegrees(u.y))}const s=this.root;N.lastObjRotation[s.uuid]||(N.lastObjRotation[s.uuid]=new P);let n=0;const o=new P,a=new P;this.rotationWrapper=new ul(t,(l,c)=>(s.quaternion.copy(N.lastObjRotation[s.uuid]),l>n&&(a.set(c[0],c[1],c[2],c[3]),o.invert(),a.multiply(o),s.quaternion.multiply(a)),o.fromArray(c),n=l,c[0]=0,c[1]=0,c[2]=0,c[3]=1,c))}}onAfterUpdate(){if(this.action.getEffectiveWeight()>0){const e=this.root;N.lastObjRotation[e.uuid].copy(e.quaternion)}}};let Ut=N;r(Ut,"lastObjPosition",{}),r(Ut,"lastObjRotation",{}),r(Ut,"firstKeyframeRotation",{}),r(Ut,"spaceRotation",{}),r(Ut,"clipOffsetRotation",{});Br(Ut,"RootMotionAction");class fu{constructor(e){r(this,"controller");r(this,"handler",[]);this.controller=e}createClip(e,t,s){t&&"name"in t&&t.name;const n=this.findRootTrack(s,".position"),o=this.findRootTrack(s,".quaternion"),a=new Ut(this.controller.context,t,s,n,o);this.handler.push(a);const l=e.clipAction(s);return a.action=l,l}onStart(e){for(const t of this.handler)t.onStart(e)}onBeforeUpdate(){}onAfterUpdate(){for(const e of this.handler)e.onAfterUpdate()}findRootTrack(e,t){const s=e.tracks;for(const n of s)if(n.name.endsWith(t))return n;return null}}Br(fu,"RootMotionHandler");var pu=Object.defineProperty,ly=Object.getOwnPropertyDescriptor,cy=(i,e)=>pu(i,"name",{value:e,configurable:!0}),Ur=(i,e,t,s)=>{for(var n=s>1?void 0:s?ly(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&pu(e,t,n),n};const hy=O("debuganimator");class _t extends v{constructor(){super(...arguments);r(this,"applyRootMotion",!1);r(this,"hasRootMotion",!1);r(this,"keepAnimatorControllerStateOnDisable",!1);r(this,"speed",1);r(this,"normalizedStartOffset",0);r(this,"_animatorController",null)}set runtimeAnimatorController(e){this._animatorController&&this._animatorController.model===e||(e?e instanceof hi?this._animatorController=e:this._animatorController=new hi(e):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}Play(e,t=-1,s=Number.NEGATIVE_INFINITY,n=0){var o;(o=this.runtimeAnimatorController)==null||o.Play(e,t,s,n)}Reset(){var e;(e=this._animatorController)==null||e.Reset()}SetBool(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetBool(e,t)}GetBool(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetBool(e))!=null?s:!1}SetFloat(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetFloat(e,t)}GetFloat(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetFloat(e))!=null?s:-1}SetInteger(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetInteger(e,t)}GetInteger(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetInteger(e))!=null?s:-1}SetTrigger(e){var t;(t=this.runtimeAnimatorController)==null||t.SetTrigger(e)}ResetTrigger(e){var t;(t=this.runtimeAnimatorController)==null||t.ResetTrigger(e)}IsInTransition(){var e,t;return(t=(e=this.runtimeAnimatorController)==null?void 0:e.IsInTransition())!=null?t:!1}SetSpeed(e){var t;e!==this.speed&&(this.speed=e,(t=this._animatorController)==null||t.SetSpeed(e))}set minMaxSpeed(e){this.speed=L.lerp(e.x,e.y,Math.random())}set minMaxOffsetNormalized(e){this.normalizedStartOffset=L.lerp(e.x,e.y,Math.random()),this.runtimeAnimatorController&&(this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset)}awake(){if(!!this.gameObject){if(this.runtimeAnimatorController){const e=this.runtimeAnimatorController.clone();console.assert(this.runtimeAnimatorController!==e),this.runtimeAnimatorController=e,console.assert(this.runtimeAnimatorController===e),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.SetSpeed(this.speed),this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset}hy&&console.log("ANIMATOR",this.name,this)}}onDisable(){var e;this.keepAnimatorControllerStateOnDisable||(e=this._animatorController)==null||e.Reset()}onBeforeRender(){this._animatorController&&this._animatorController.update()}}cy(_t,"Animator");Ur([f()],_t.prototype,"applyRootMotion",2);Ur([f()],_t.prototype,"hasRootMotion",2);Ur([f()],_t.prototype,"keepAnimatorControllerStateOnDisable",2);Ur([f()],_t.prototype,"runtimeAnimatorController",1);var mu=Object.defineProperty,dy=Object.getOwnPropertyDescriptor,gu=(i,e)=>mu(i,"name",{value:e,configurable:!0}),_u=(i,e,t,s)=>{for(var n=s>1?void 0:s?dy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&mu(e,t,n),n};class Nt extends v{constructor(){super(...arguments);r(this,"playAutomatically",!0);r(this,"randomStartTime",!0);r(this,"_tempAnimationClipBeforeGameObjectExisted",null);r(this,"mixer");r(this,"_actions",[]);r(this,"_currentActions",[]);r(this,"_handles",[]);r(this,"_didInit",!1)}get clip(){var e;return((e=this.animations)==null?void 0:e.length)?this.animations[0]:null}set clip(e){if(!this.gameObject){this._tempAnimationClipBeforeGameObjectExisted=e;return}!e||(this.gameObject.animations||(this.gameObject.animations=[]),this.gameObject.animations.push(e))}set animations(e){this.gameObject.animations=e}get animations(){return this.gameObject.animations}get currentAction(){return this._currentActions[0]}get currentActions(){return this._currentActions}get actions(){return this._actions}set actions(e){this._actions=e}awake(){this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.playAutomatically&&this.init()}onEnable(){if(this.playAutomatically&&this.actions.length>0&&this.currentActions.length<=0){const e=Math.floor(Math.random()*this.actions.length);this.play(e)}}start(){this.randomStartTime&&this.currentAction&&(this.currentAction.time=Math.random()*this.currentAction.getClip().duration)}update(){var e;if(!!this.mixer){this.mixer.update(this.context.time.deltaTime);for(const t of this._handles)t._update();((e=this._handles)==null?void 0:e.length)>0&&ue.markDirty(this.gameObject)}}getAction(e){var t;return(t=this.actions)==null?void 0:t.find(s=>s.getClip().name===e)}play(e,t){if(this.init(),!this.mixer)return;let s=e;if(typeof e=="number"){if(e>=this.animations.length)return;s=this.animations[e]}else typeof e=="string"&&(s=this.animations.find(o=>o.name===e));if(!s){console.error("Could not find clip",e);return}for(const o of this.actions)if(o.getClip()===s)return this.internalOnPlay(o,t);const n=this.mixer.clipAction(s);return this.actions.push(n),this.internalOnPlay(n,t)}internalOnPlay(e,t){var a;var s=this.currentAction;if(s===e&&s.isRunning()&&s.time<s.getClip().duration){const l=this.tryFindHandle(e);if(l)return l.getPromise()}const n=(a=t==null?void 0:t.exclusive)!=null?a:!0;(t==null?void 0:t.fadeDuration)?(n&&(s==null||s.fadeOut(t.fadeDuration)),e.fadeIn(t.fadeDuration)):n&&(s==null||s.stop()),e.reset(),e.enabled=!0,e.time=0,e.timeScale=1,(t==null?void 0:t.clampWhenFinished)&&(e.clampWhenFinished=!0),(t==null?void 0:t.startTime)!==void 0&&(e.time=t.startTime),(t==null?void 0:t.loop)!==void 0&&(e.loop=t.loop?Dg:Oh),e.play();const o=new bu(e,this.mixer,t,l=>{this._handles.splice(this._handles.indexOf(o),1)});return this._handles.push(o),o.getPromise()}tryFindHandle(e){for(const t of this._handles)if(t.action===e)return t}init(){if(!this._didInit&&(this._didInit=!0,!!this.gameObject)){this.actions=[],this.mixer=new Pa(this.gameObject);for(let e=0;e<this.animations.length;e++){const t=this.mixer.clipAction(this.animations[e]);this.actions.push(t)}}}}gu(Nt,"Animation");_u([f()],Nt.prototype,"playAutomatically",2);_u([f()],Nt.prototype,"randomStartTime",2);class bu{constructor(e,t,s,n){r(this,"mixer");r(this,"action");r(this,"promise",null);r(this,"resolve",null);r(this,"reject",null);r(this,"_options");r(this,"_resolveCallback",null);r(this,"_rejectCallback",null);r(this,"_loopCallback");r(this,"_finishedCallback");r(this,"_resolvedOrRejectedCallback");this.action=e,this.mixer=t,this._resolvedOrRejectedCallback=n,this._options=s}getPromise(){return this.promise?this.promise:(this.promise=new Promise((e,t)=>{this._resolveCallback=e,this._rejectCallback=t,this.resolve=this.onResolve.bind(this),this.reject=this.onReject.bind(this)}),this._loopCallback=this.onLoop.bind(this),this._finishedCallback=this.onFinished.bind(this),this.mixer.addEventListener("loop",this._loopCallback),this.mixer.addEventListener("finished",this._finishedCallback),this.promise)}_update(){var e;!this._options||this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=(e=this._options.startTime)!=null?e:0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var e,t;this.dispose(),(e=this._resolvedOrRejectedCallback)==null||e.call(this,this),(t=this._resolveCallback)==null||t.call(this,this.action)}onReject(e){var t,s;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(s=this._rejectCallback)==null||s.call(this,e)}onLoop(e){}onFinished(e){e.action===this.action&&this.onResolve()}dispose(){this._loopCallback&&this.mixer.removeEventListener("loop",this._loopCallback),this._finishedCallback&&this.mixer.removeEventListener("finished",this._finishedCallback),this._loopCallback=void 0,this._finishedCallback=void 0}}gu(bu,"AnimationHandle");var uy=Object.defineProperty,fy=(i,e)=>uy(i,"name",{value:e,configurable:!0});class fl extends v{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"width",0);r(this,"centered",!0);r(this,"_centerPos")}awake(){this._centerPos=new y}update(){if(!this.from||!this.to)return;const e=R(this.from).clone(),t=R(this.to).clone(),s=e.distanceTo(t);this._centerPos.copy(e),this._centerPos.add(t),this._centerPos.multiplyScalar(.5),F(this.gameObject,this.centered?this._centerPos:e),this.gameObject.lookAt(R(this.to).clone()),this.gameObject.scale.set(this.width,this.width,s)}}fy(fl,"AlignmentConstraint");var yu=Object.defineProperty,py=Object.getOwnPropertyDescriptor,vu=(i,e)=>yu(i,"name",{value:e,configurable:!0}),$t=(i,e,t,s)=>{for(var n=s>1?void 0:s?py(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&yu(e,t,n),n};class bt{constructor(){r(this,"time");r(this,"value");r(this,"inTangent");r(this,"inWeight");r(this,"outTangent");r(this,"outWeight");r(this,"weightedMode")}}vu(bt,"Keyframe");$t([f()],bt.prototype,"time",2);$t([f()],bt.prototype,"value",2);$t([f()],bt.prototype,"inTangent",2);$t([f()],bt.prototype,"inWeight",2);$t([f()],bt.prototype,"outTangent",2);$t([f()],bt.prototype,"outWeight",2);$t([f()],bt.prototype,"weightedMode",2);class Nr{constructor(){r(this,"keys")}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(e){if(!this.keys||this.keys.length==0)return 0;let t=null;for(const s of this.keys){if(t&&s.time>e&&e>t.time)return L.lerp(t.value,s.value,(e-t.time)/(s.time-t.time));t=s}return this.keys[this.keys.length-1].value}}vu(Nr,"AnimationCurve");$t([f(bt)],Nr.prototype,"keys",2);var my=Object.defineProperty,gy=(i,e)=>my(i,"name",{value:e,configurable:!0}),Ji;(function(i){i.Visible="application-visible",i.Hidden="application-hidden"})(Ji||(Ji={}));class wu extends EventTarget{constructor(e){super();r(this,"context");r(this,"_isVisible",!0);this.context=e,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(e){switch(e.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event(Ji.Hidden));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event(Ji.Visible));break}}}gy(wu,"Application");var Pu=Object.defineProperty,_y=Object.getOwnPropertyDescriptor,xu=(i,e)=>Pu(i,"name",{value:e,configurable:!0}),Wt=(i,e,t,s)=>{for(var n=s>1?void 0:s?_y(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Pu(e,t,n),n};const Ye=O("debugaudio");var Ou;(function(i){i[i.Logarithmic=0]="Logarithmic",i[i.Linear=1]="Linear",i[i.Custom=2]="Custom"})(Ou||(Ou={}));var Zn;const K=(Zn=class extends v{constructor(){super(...arguments);r(this,"clip","");r(this,"playOnAwake",!1);r(this,"spatialBlend",0);r(this,"minDistance",1);r(this,"maxDistance",100);r(this,"volume",1);r(this,"rollOffMode",0);r(this,"_loop",!1);r(this,"sound",null);r(this,"helper",null);r(this,"wasPlaying",!1);r(this,"audioLoader",null);r(this,"shouldPlay",!1);r(this,"_lastClipStartedLoading",null);r(this,"_focusCallback");r(this,"lerp",(i,e,t)=>i*(1-t)+e*t);r(this,"_lastContextTime",0);r(this,"_hasEnded",!0)}static get userInteractionRegistered(){return K._didCallBeginWaitForUserInteraction||(K._didCallBeginWaitForUserInteraction=!0,K._beginWaitForUserInteraction()),K._userInteractionRegistered}static registerWaitForAllowAudio(i){if(i!==null){if(this._userInteractionRegistered){i();return}this.callbacks.indexOf(i)===-1&&this.callbacks.push(i),K._didCallBeginWaitForUserInteraction||(K._didCallBeginWaitForUserInteraction=!0,K._beginWaitForUserInteraction())}}static _beginWaitForUserInteraction(i=null){if(this._userInteractionRegistered){i&&i();return}i!==null&&this.registerWaitForAllowAudio(i);let t=xu(()=>{if(t!=null&&!K._userInteractionRegistered){K._userInteractionRegistered=!0,console.log("registered interaction, can play audio now"),document.removeEventListener("pointerdown",t),document.removeEventListener("click",t),document.removeEventListener("dragstart",t),document.removeEventListener("touchstart",t);for(const s of this.callbacks)s();this.callbacks.length=0}},"callback").bind(this);document.addEventListener("pointerdown",t),document.addEventListener("click",t),document.addEventListener("dragstart",t),document.addEventListener("touchstart",t)}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(i){this._loop=i,this.sound&&this.sound.setLoop(i)}get Sound(){var i;if(!this.sound&&K._userInteractionRegistered){const e=(i=p.getComponent(this.context.mainCamera,Zi))!=null?i:p.findObjectOfType(Zi,this.context);(e==null?void 0:e.listener)&&(this.sound=new kg(e.listener),this.gameObject.add(this.sound))}return this.sound}get ShouldPlay(){return this.shouldPlay}awake(){this.audioLoader=new xa,this.playOnAwake&&(this.shouldPlay=!0),window.addEventListener("visibilitychange",i=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this.isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}}),this._focusCallback=()=>{this.enabled&&this.playOnAwake&&!this.isPlaying&&K._userInteractionRegistered&&this.play()},this.context.application.addEventListener(Ji.Visible,this._focusCallback)}onDestroy(){this.context.application.removeEventListener(Ji.Visible,this._focusCallback)}onEnable(){K._userInteractionRegistered?this.playOnAwake&&this.context.application.isVisible&&this.play():K._beginWaitForUserInteraction(()=>{this.enabled&&!this.destroyed&&this.playOnAwake&&this.loadAndPlay(this.clip)})}onDisable(){this.stop()}onLoaded(i){Ye&&console.log("audio buffer loaded"),K.registerWaitForAllowAudio(()=>{Ye&&console.log("finished loading",i);const e=this.Sound;if(!e){console.warn("Failed getting sound",this.name);return}e.isPlaying&&e.stop(),e.setBuffer(i),e.loop=this.loop,e.setVolume(this.volume),e.autoplay=this.shouldPlay;const t=this.lerp(1e3,this.minDistance,this.spatialBlend);switch(Ye&&console.log("Ref distance= "+t),e.setRefDistance(t),e.setMaxDistance(this.maxDistance),this.rollOffMode){case 0:e.setDistanceModel("linear");break;case 1:e.setDistanceModel("exponential");break}e.isPlaying&&e.stop(),this.spatialBlend>0&&Ye&&!this.helper&&(console.log(this),this.helper=new Ig(e,e.getRefDistance()),e.add(this.helper)),this.shouldPlay&&K._userInteractionRegistered&&this.play()})}loadAndPlay(i){if(this.clip=i,this.clip&&(Ye&&console.log(this.clip),this.clip.endsWith(".mp3")||this.clip.endsWith(".wav"))){if(this.audioLoader||(this.audioLoader=new xa),this.shouldPlay=!0,this._lastClipStartedLoading===this.clip)return;this._lastClipStartedLoading=this.clip,Ye&&console.log("load audio",this.clip),this.audioLoader.load(this.clip,this.onLoaded.bind(this),()=>{},console.error)}}play(i=void 0){if(i&&i!==this.clip){this.loadAndPlay(i);return}this.shouldPlay=!0,this._hasEnded=!1,Ye&&console.log("play",this),this.sound&&!this.sound.isPlaying&&(Ye&&console.log("start playing",this.sound.getVolume(),this.sound),this.sound.play())}pause(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,this.sound.pause())}stop(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,Ye&&console.log(this._lastContextTime),this.sound.stop())}get isPlaying(){var i,e;return(e=(i=this.sound)==null?void 0:i.isPlaying)!=null?e:!1}set isPlaying(i){}get time(){var i,e;return((i=this.sound)==null?void 0:i.source)?((e=this.sound.source)==null?void 0:e.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(i){if(this.sound){if(i===this.sound.offset)return;const e=this.isPlaying;this.stop(),this.sound.offset=i,e&&this.play()}}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,Ye&&console.log("Audio clip ended",this.clip),this.sound.dispatchEvent({type:"ended",target:this}))}},r(Zn,"_didCallBeginWaitForUserInteraction",!1),r(Zn,"callbacks",[]),r(Zn,"_userInteractionRegistered",!1),Zn);let ae=K;xu(ae,"AudioSource");Wt([f()],ae.prototype,"clip",2);Wt([f()],ae.prototype,"playOnAwake",2);Wt([f()],ae.prototype,"loop",1);Wt([f()],ae.prototype,"spatialBlend",2);Wt([f()],ae.prototype,"minDistance",2);Wt([f()],ae.prototype,"maxDistance",2);Wt([f()],ae.prototype,"volume",2);Wt([f()],ae.prototype,"rollOffMode",2);var by=Object.defineProperty,yy=(i,e)=>by(i,"name",{value:e,configurable:!0});class Zi extends v{constructor(){super(...arguments);r(this,"_listener",null)}get listener(){return this._listener==null&&(this._listener=new Ch),this._listener}awake(){ae.registerWaitForAllowAudio(()=>{const e=this.listener;if(e==null||e.parent)return;const t=p.getComponentInParent(this.gameObject,W);t?t.cam.add(e):this.gameObject.add(e)})}}yy(Zi,"AudioListener");var vy=Object.defineProperty,wy=(i,e)=>vy(i,"name",{value:e,configurable:!0});let tn,sn;function $r(i,e){tn||(tn=new Mg,tn.setDecoderPath("./include/draco/"),tn.setDecoderConfig({type:"js"})),sn||(sn=new jg,sn.setTranscoderPath("./include/ktx2/"),e.renderer&&sn.detectSupport(e.renderer)),i.setDRACOLoader(tn),i.setKTX2Loader(sn)}wy($r,"addDracoAndKTX2Loaders");var Py=Object.defineProperty,nn=(i,e)=>Py(i,"name",{value:e,configurable:!0});class pl{constructor(e,t,s,n){r(this,"success");r(this,"filename");r(this,"hash");r(this,"size");r(this,"url");this.success=e,this.filename=t,this.hash=s,this.size=n}}nn(pl,"Upload_Result");async function Cu(i,e){const t=await i.arrayBuffer(),s=ml(t),n=i.name.split(".").pop(),o=s+"."+n,a=i.name.split(".").shift();console.assert(a!==void 0);const l={alias:a,filename:o},h=await(await fetch(e+"/exists",{method:"POST",body:JSON.stringify(l)})).json();if(h.success||console.warn("exists check did fail"),h.exists)return console.log("file already exists",s),new pl(!0,o,s,i.size);console.log("begin uploading file",a,i.size);const d=new FormData;d.append("file",i);const u={};u.filesize=i.size,a&&(u.alias=a);const b=await(await fetch(e+"/upload/file",{method:"POST",body:d,headers:u})).json();if((b==null?void 0:b.success)===!1)return b.message!==void 0?console.error("Upload failed:",b.message):console.error("Upload failed"),null;console.assert(b.hash_sum===s,"hash sum did not match","received:",b.hash_sum,"expected:",s),b.success&&console.log("successfully uploaded",s,b.id);const w=new pl(b.success,o,s,i.size);return w.url=e,w}nn(Cu,"upload_file");function ml(i){return Fg(new Uint8Array(i))}nn(ml,"hash");async function gl(i,e,t,s,n=!1){try{const o=await fetch(s+"/download/file",{method:"POST",body:i});if(o.status!==200)return console.error("download failed",o),null;const a=await o.blob(),l=await a.arrayBuffer();n||console.assert(a.size===t,"size mismatch","expected:",t,"got:",a.size);const c=ml(l);return n||console.assert(c===e,"hash mismatch, downloaded file is invalid"),a.arrayBuffer()}catch(o){console.error(o)}return null}nn(gl,"download_file");async function Su(i,e){var d;const t=await fetch(i),s=(d=t.body)==null?void 0:d.getReader(),n=t.headers.get("Content-Length"),o=n?parseInt(n):0;if(!s)return null;let a=0,l=[];for(;;){const{done:u,value:_}=await s.read();if(_&&(l.push(_),a+=_.length,e.call(null,new ProgressEvent("progress",{loaded:a,total:o}))),u)break}const c=new Uint8Array(a);let h=0;for(let u of l)c.set(u,h),h+=u.length;return c}nn(Su,"download");var xy=Object.defineProperty,_l=(i,e)=>xy(i,"name",{value:e,configurable:!0});const rn=O("debugavatar");class Wr{constructor(e,t,s,n){r(this,"root");r(this,"head");r(this,"leftHand");r(this,"rigthHand");var o;this.root=e,this.head=t,this.leftHand=s,this.rigthHand=n,(o=this.root)==null||o.traverse(a=>a.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}assignRandomColors(){on.assignRandomPlayerColors(this)}}_l(Wr,"AvatarModel");class on{constructor(){r(this,"avatarRegistryUrl",null);r(this,"avatarModelCache",new Map)}async getOrCreateNewAvatarInstance(e,t){if(!t)return console.error("Can not create avatar: failed to provide id or root object"),null;let s=null;if(typeof t=="string"){if(s=await this.loadAvatar(e,t),!s){const o=new Ae;s=p.instantiate(ri(t,e.scene),o)}}else s=t;if(!s)return null;const n=this.findAvatar(s);return n.assignRandomColors(),n.isValid?(rn&&console.log("[Custom Avatar] valid config",t,rn?n:""),n):(console.warn("[Custom Avatar] config isn't valid",t,rn?n:""),null)}async loadAvatar(e,t){var n;if(console.assert(t!=null&&typeof t=="string","Avatar id must not be null"),t.length<=0||!t)return null;if(rn&&console.log("[Custom Avatar] "+t+", loading..."),t.endsWith(".glb")||(t+=".glb"),this.avatarRegistryUrl===null){const o=await fetch("./"+t);let a=null;if(o.ok){const c=await o.blob();c&&(a=await c.arrayBuffer())}if(!a&&(a=await gl(t,t,0,"no url here go away",!0),!a))return null;const l=await Wn(e,a,null,0);return(n=l==null?void 0:l.scene)!=null?n:null}const s=new Oa;return $r(s,e),new Promise((o,a)=>{const l=this.avatarRegistryUrl+"/"+t;s.load(l,async c=>{await Ic(e,l,c),o(c.scene)},c=>{rn&&console.log("[Custom Avatar] "+c.loaded/c.total*100+"% loaded of "+c.total/1024+"kB")},c=>{console.error("[Custom Avatar] Error when loading: "+c),o(null)})})}cacheModel(e,t){}findAvatar(e){const t=e;let s=t;s.children.length==1&&(s=e.children[0]);let n=this.findAvatarPart(s,"head");const o=this.findAvatarPart(s,"left"),a=this.findAvatarPart(s,"right");if(!n){n=t;let c=new y;new zi().setFromObject(n).getSize(c);let h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&n.scale.multiplyScalar(1/h*.3)}return new Wr(t,n,o,a)}findAvatarPart(e,t){for(let s of e.children)if(s.name.toLowerCase().indexOf(t)>-1)return s;return null}handleCustomAvatarErrors(e){if(!e.ok)throw Error(e.statusText);return e}static assignRandomPlayerColors(e){const t=new Map;function s(n){if(n.type==="Mesh"){const o=n,a=o.material;if(a&&a.name){if(t.has(a.uuid)){const l=t.get(a.uuid);l&&(o.material=l);return}if(a.name.endsWith("_playercolor")||a.name.endsWith("_player_color2")){const l=a.uuid;o.material=a.clone(),o.material.color=new g(Math.random(),Math.random(),Math.random()),t.set(l,o.material)}}}}_l(s,"findPlayerColorMeshesAndAssignColors"),e.head&&e.head.traverse(s),e.leftHand&&e.leftHand.traverse(s),e.rigthHand&&e.rigthHand.traverse(s)}}_l(on,"AvatarLoader");var Ru=Object.defineProperty,Oy=Object.getOwnPropertyDescriptor,Cy=(i,e)=>Ru(i,"name",{value:e,configurable:!0}),bl=(i,e,t,s)=>{for(var n=s>1?void 0:s?Oy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Ru(e,t,n),n};class Ki extends v{constructor(){super(...arguments);r(this,"length",1);r(this,"depthTest",!0);r(this,"isGizmo",!0);r(this,"_axes",null)}onEnable(){if(this.isGizmo&&!Ks)return;this._axes||(this._axes=new sr(this.length)),this.gameObject.add(this._axes);const e=this._axes.material;e&&e.depthTest!==void 0&&(e.depthTest=this.depthTest)}onDisable(){!this._axes||this.gameObject.remove(this._axes)}}Cy(Ki,"AxesHelper");bl([f()],Ki.prototype,"length",2);bl([f()],Ki.prototype,"depthTest",2);bl([f()],Ki.prototype,"isGizmo",2);var Sy=Object.defineProperty,Ry=(i,e)=>Sy(i,"name",{value:e,configurable:!0});class yl extends v{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"hint");r(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;let e=R(this.to).clone(),t=R(this.from).clone(),s=e.distanceTo(t),n=e.clone();n.sub(t);let o=t.clone();o.add(e),o.multiplyScalar(.5);let a=R(this.hint).clone();a.sub(o);let l=new y;l.crossVectors(a,n),l.crossVectors(n,l),l.normalize();let c=s*.5,h=Math.max(this.desiredDistance,c),d=Math.sqrt(h*h-c*c),u=l.clone();u.multiplyScalar(d),u.add(o),F(this.gameObject,u);let _=o.clone();_.sub(l),this.gameObject.lookAt(_)}}Ry(yl,"BasicIKConstraint");var Ey=Object.defineProperty,Ay=(i,e)=>Ey(i,"name",{value:e,configurable:!0});const Is=class extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=R(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const e=new Ja;e.drag=this.drag,e.angularDrag=this.angularDrag,e.mass=this.mass,e.kinematic=this.isKinematic,e.physicsEvents=this.detectCollision,e.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,e),this.parent=this.gameObject.parent}wakeUp(){var e;(e=this.body)==null||e.wakeUp()}applyForce(e,t){var s;(s=this.body)==null||s.applyForce(new si(e.x,e.y,e.z),t?new si(t.x,t.y,t.z):void 0)}set kinematic(e){this.isKinematic=e,this.body&&(this.body.type=e?_e.KINEMATIC:_e.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var e,t,s;return this.body?Is.tempPosition.set((e=this.body)==null?void 0:e.velocity.x,(t=this.body)==null?void 0:t.velocity.y,(s=this.body)==null?void 0:s.velocity.z):Is.tempPosition.set(0,0,0)}setVelocity(e,t,s){!this.body||(this.body.velocity.x=e/this.context.time.deltaTime,this.body.velocity.y=t/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(e,t,s){!this.body||(this.body.angularVelocity.x=e/this.context.time.deltaTime,this.body.angularVelocity.y=t/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(e=null){if(this.body&&this.gameObject&&!this.destroyed){const t=this.worldPosition;this.body.position.set(t.x,t.y,t.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),e){Is.copyVector3.set(e.x,e.y,e.z),this.smoothedVelocity.lerp(Is.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const e=R(this.gameObject);this.currentVelocity.subVectors(e,this.lastWorldPosition),this.lastWorldPosition.copy(e),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let Ne=Is;r(Ne,"tempPosition",new y),r(Ne,"copyVector3",new y);Ay(Ne,"Rigidbody");var Ty=Object.defineProperty,Ly=(i,e)=>Ty(i,"name",{value:e,configurable:!0});class vl extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{attachedRigidbody:Ne,size:y,center:y,isTrigger:null});r(this,"attachedRigidbody");r(this,"size");r(this,"center");r(this,"isTrigger");r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addBoxCollider(this.gameObject,this.isTrigger,this.center,this.size,this.attachedRigidbody))}}Ly(vl,"BoxCollider");var Dy=Object.defineProperty,ky=(i,e)=>Dy(i,"name",{value:e,configurable:!0});const Iy=new Sh(1,1,1);function wl(i=null){const e=new g(i!=null?i:14540253),t=new Bg(Iy);return new Ug(t,new Ng({color:e}))}ky(wl,"CreateWireCube");var My=Object.defineProperty,jy=(i,e)=>My(i,"name",{value:e,configurable:!0});const Fy=O("gizmos");class es extends v{constructor(){super(...arguments);r(this,"box",null);r(this,"testBox",new zi);r(this,"_lastMatrixUpdateFrame",-1);r(this,"_helper",null);r(this,"_color",null)}isInBox(e){var t;if(!!e){if(this.box||(this.box=new zi),this.updateBox(!1),e.type==="Mesh")this.testBox.setFromObject(e);else{const s=R(e);this.testBox.set(s,s)}return(t=this.box)==null?void 0:t.intersectsBox(this.testBox)}}intersects(e){return e?this.updateBox(!1).intersectsBox(e):!1}updateBox(e=!1){return this.box||(this.box=new zi),(e||this.context.time.frameCount!=this._lastMatrixUpdateFrame)&&(this._lastMatrixUpdateFrame=this.context.time.frameCount,this.box.setFromCenterAndSize(new y(0,0,0),new y(1,1,1)),this.box.applyMatrix4(this.gameObject.matrixWorld)),this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(e=null,t=!1){var s;if(!(!Fy&&!t)){if(this._helper){e&&((s=this._color)==null||s.set(e)),this.gameObject.add(this._helper);return}this._helper=wl(e),this.gameObject.add(this._helper)}}}jy(es,"BoxHelperComponent");var By=Object.defineProperty,Uy=(i,e)=>By(i,"name",{value:e,configurable:!0});class Pl{}Uy(Pl,"UnityObject");var Ny=Object.defineProperty,Eu=(i,e)=>Ny(i,"name",{value:e,configurable:!0});class ts extends v{constructor(){super(...arguments);r(this,"canGrab",!0)}onPointerClick(e){}}Eu(ts,"Interactable");class is extends v{constructor(){super(...arguments);r(this,"isUsed",!0);r(this,"usedBy",null)}}Eu(is,"UsageMarker");var $y=Object.defineProperty,Au=(i,e)=>$y(i,"name",{value:e,configurable:!0});class Hr extends es{}Au(Hr,"DeleteBox");class xl extends v{constructor(){super(...arguments);r(this,"deleteBoxes",[])}awake(){this.deleteBoxes=p.findObjectsOfType(Hr,this.context)}update(){for(const e of this.deleteBoxes){const t=this.gameObject;e.isInBox(t)===!0&&(p.getComponentInParent(this.gameObject,is)||fr(this.gameObject,this.context.connection))}}}Au(xl,"Deletable");var Tu=Object.defineProperty,Wy=Object.getOwnPropertyDescriptor,Lu=(i,e)=>Tu(i,"name",{value:e,configurable:!0}),Hy=(i,e,t,s)=>{for(var n=s>1?void 0:s?Wy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Tu(e,t,n),n},Du;(function(i){i[i.Never=0]="Never",i[i.Desktop=1]="Desktop",i[i.Mobile=2]="Mobile"})(Du||(Du={}));class zr extends v{constructor(){super(...arguments);r(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||p.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:ku()?(this.visibleOn&2)!=0:(this.visibleOn&1)!=0}}Lu(zr,"DeviceFlag");Hy([f()],zr.prototype,"visibleOn",2);let Gr;function ku(){if(Gr===!0||Gr===!1)return Gr;let i=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(i=!0)}(navigator.userAgent||navigator.vendor||window.opera),Gr=i,i}Lu(ku,"isMobile");var zy=Object.defineProperty,Gy=(i,e)=>zy(i,"name",{value:e,configurable:!0});class pe{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(e,t,s,n){return e.prep(4,12),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}Gy(pe,"Vec3");var Vy=Object.defineProperty,qy=(i,e)=>Vy(i,"name",{value:e,configurable:!0});class Ol{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}position(e){return(e||new pe).__init(this.bb_pos,this.bb)}rotation(e){return(e||new pe).__init(this.bb_pos+12,this.bb)}scale(e){return(e||new pe).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(e,t,s,n,o,a,l,c,h,d){return e.prep(4,36),e.prep(4,12),e.writeFloat32(d),e.writeFloat32(h),e.writeFloat32(c),e.prep(4,12),e.writeFloat32(l),e.writeFloat32(a),e.writeFloat32(o),e.prep(4,12),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}qy(Ol,"Transform");var Qy=Object.defineProperty,Xy=(i,e)=>Qy(i,"name",{value:e,configurable:!0});class Je{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsSyncedTransformModel(e,t){return(t||new Je).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsSyncedTransformModel(e,t){return e.setPosition(e.position()+Ca),(t||new Je).__init(e.readInt32(e.position())+e.position(),e)}guid(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}fast(){const e=this.bb.__offset(this.bb_pos,6);return e?!!this.bb.readInt8(this.bb_pos+e):!1}transform(e){const t=this.bb.__offset(this.bb_pos,8);return t?(e||new Ol).__init(this.bb_pos+t,this.bb):null}dontSave(){const e=this.bb.__offset(this.bb_pos,10);return e?!!this.bb.readInt8(this.bb_pos+e):!1}static startSyncedTransformModel(e){e.startObject(4)}static addGuid(e,t){e.addFieldOffset(0,t,0)}static addFast(e,t){e.addFieldInt8(1,+t,0)}static addTransform(e,t){e.addFieldStruct(2,t,0)}static addDontSave(e,t){e.addFieldInt8(3,+t,0)}static endSyncedTransformModel(e){return e.endObject()}static finishSyncedTransformModelBuffer(e,t){e.finish(t)}static finishSizePrefixedSyncedTransformModelBuffer(e,t){e.finish(t,void 0,!0)}}Xy(Je,"SyncedTransformModel");var Yy=Object.defineProperty,Iu=(i,e)=>Yy(i,"name",{value:e,configurable:!0});const Ht=O("debugsync"),an="STRS";Or(an,Je.getRootAsSyncedTransformModel);const Ze=new nr;function Cl(i,e,t=!0){Ze.clear();const s=Ze.createString(i);Je.startSyncedTransformModel(Ze),Je.addGuid(Ze,s),Je.addFast(Ze,t);const n=e.worldPosition,o=e.worldEuler,a=e.gameObject.scale;Je.addTransform(Ze,Ol.createTransform(Ze,n.x,n.y,n.z,o.x,o.y,o.z,a.x,a.y,a.z));const l=Je.endSyncedTransformModel(Ze);return Ze.finish(l,an),Ze.asUint8Array()}Iu(Cl,"createTransformModel");class yt extends v{constructor(){super(...arguments);r(this,"overridePhysics",!0);r(this,"interpolatePosition",!0);r(this,"interpolateRotation",!0);r(this,"fastMode",!1);r(this,"syncDestroy",!1);r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"rb",null);r(this,"_wasKinematic",!1);r(this,"_receivedDataBefore",!1);r(this,"_targetPosition");r(this,"_targetRotation");r(this,"_receivedFastUpdate",!1);r(this,"_shouldRequestOwnership",!1);r(this,"joinedRoomCallback",null);r(this,"receivedDataCallback",null);r(this,"tempEuler",new he);r(this,"receivedUpdate",!1);r(this,"lastWorldPos");r(this,"lastWorldRotation")}requestOwnership(){Ht&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}hasOwnership(){var e,t;return(t=(e=this._model)==null?void 0:e.hasOwnership)!=null?t:void 0}isOwned(){var e;return(e=this._model)==null?void 0:e.isOwned}awake(){Ht&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new y,this._targetRotation=new P,this.lastWorldPos=new y,this.lastWorldRotation=new P,this.rb=p.getComponentInChildren(this.gameObject,Ne),this.rb&&(this._wasKinematic=this.rb.kinematic),this.receivedUpdate=!0,this._model=new Rr(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(G.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinrary(an,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&_d(this.guid,this.context.connection),this._model=null,this.context.connection.stopListening(G.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(an,this.receivedDataCallback)}tryGetLastState(){const e=this.context.connection.tryGetState(this.guid);e&&this.onReceivedData(e)}onReceivedData(e){var t;if(!this.destroyed&&typeof e.guid=="function"&&e.guid()===this.guid){Ht&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,e),this.receivedUpdate=!0,this._receivedFastUpdate=e.fast();const s=e.transform();if(s){ue.markDirty(this.gameObject,!0);const n=s.position();n&&(this.interpolatePosition&&((t=this._targetPosition)==null||t.set(n.x(),n.y(),n.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(n.x(),n.y(),n.z()));const o=s.rotation();o&&(this.tempEuler.set(o.x(),o.y(),o.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&ud(this.gameObject,this.tempEuler))}this._receivedDataBefore=!0}}onEnable(){this.lastWorldPos.copy(this.worldPosition),this.lastWorldRotation.copy(this.worldQuaternion),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){var o;if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){Ht&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());let e=this.worldPosition,t=this.worldQuaternion;if(this._model.isOwned&&!this.receivedUpdate){const a=e.distanceTo(this.lastWorldPos),l=t.angleTo(this.lastWorldRotation),c=this._model.hasOwnership||this.fastMode?1e-4:.001;(a>c||l>c)&&(this._model.hasOwnership?this._needsUpdate=!0:(Ht&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastWorldPos),this.worldPosition=this.lastWorldPos,e.copy(this.lastWorldPos),this.worldQuaternion=this.lastWorldRotation,t.copy(this.lastWorldRotation),ue.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&ue.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastWorldPos.copy(e),this.lastWorldRotation.copy(t),!this._model)return;if(!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership){this.rb&&(this.rb.kinematic=(o=this._model.isOwned)!=null?o:!1,this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject());return}this.rb&&(this._wasKinematic!==void 0&&(Ht&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.kinematic=this._wasKinematic),this.gameObject.position.distanceTo(new y(0,0,0))>1e3&&(Ht&&console.log("RESET",this.name),this.gameObject.position.set(0,1,0),this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject()));const s=10,n=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%s==0||n)){Ht&&console.log("send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this.overridePhysics&&this.rb&&this.rb.setBodyFromGameObject(),this._needsUpdate=!1;const a=Cl(this.guid,this,!!n);this.context.connection.sendBinary(a)}}}Iu(yt,"SyncedTransform");class Jy{static createButton(e,t={}){const s=document.createElement("button");function n(){if(t.domOverlay===void 0){var c=document.createElement("div");c.style.display="none",document.body.appendChild(c);var h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("width",38),h.setAttribute("height",38),h.style.position="absolute",h.style.right="20px",h.style.top="20px",h.addEventListener("click",function(){u.end()}),c.appendChild(h);var d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),d.setAttribute("stroke","#fff"),d.setAttribute("stroke-width",2),h.appendChild(d),t.optionalFeatures===void 0&&(t.optionalFeatures=[]),t.optionalFeatures.push("dom-overlay"),t.domOverlay={root:c}}t.optionalFeatures===void 0&&(t.optionalFeatures=[]),t.optionalFeatures.push("local-floor"),t.optionalFeatures.push("hand-tracking"),t.optionalFeatures.push("layers");let u=null;async function _(w){w.addEventListener("end",b),await e.xr.setSession(w),s.textContent="STOP AR",t.domOverlay.root.style.display="",u=w}function b(){u.removeEventListener("end",b),s.textContent="START AR",t.domOverlay.root.style.display="none",u=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="START AR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){u===null?navigator.xr.requestSession("immersive-ar",t).then(_):u.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="AR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="ARButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-ar").then(function(c){c?n():a()}).catch(a),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}}const ha=class{static createButton(e,t){t&&console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');const s=document.createElement("button");function n(){let c=null;async function h(u){u.addEventListener("end",d),await e.xr.setSession(u),s.textContent="EXIT VR",c=u}function d(){c.removeEventListener("end",d),s.textContent="ENTER VR",c=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="ENTER VR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){if(c===null){const u={optionalFeatures:["local-floor","bounded-floor","hand-tracking","high-fixed-foveation-level","layers"]};navigator.xr.requestSession("immersive-vr",u).then(h)}else c.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="VR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="VRButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-vr").then(function(c){c?n():a(),ha.xrSessionIsGranted&&(console.log("XR session is granted - will enter immersive web now"),s.click())}),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}static registerSessionGrantedListener(){if("xr"in navigator)try{navigator.xr.addEventListener("sessiongranted",()=>{console.log("Received session granted event"),ha.xrSessionIsGranted=!0})}catch(e){console.error(e)}}};let Vr=ha;r(Vr,"xrSessionIsGranted",!1);Vr.registerSessionGrantedListener();var Zy=Object.defineProperty,qr=(i,e)=>Zy(i,"name",{value:e,configurable:!0});const Qr="noVoip",me=O("debugvoip"),Ky=O("voip");var Xr;(function(i){i.Update_ID="peer-update-id"})(Xr||(Xr={}));class Mu{constructor(e){r(this,"id");this.id=e}}qr(Mu,"PeerModel");var ju;(function(i){i[i.None=0]="None",i[i.Errors=1]="Errors",i[i.ErrorsAndWarnings=2]="ErrorsAndWarnings",i[i.All=3]="All"})(ju||(ju={}));class Fu{constructor(e,t,s,n){r(this,"peer");r(this,"voip");r(this,"userId");r(this,"peerId");r(this,"call",null);r(this,"callErrorListener",null);r(this,"stream",null);this.voip=e,this.peer=t,this.userId=s,this.peerId=n}close(){var e;me&&console.log("close voip call"),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.open&&this.call.close(),(e=this.stream)==null||e.getTracks().forEach(function(t){t.stop()})}updateMute(e){var s;if(!this.stream)return;const t=(s=this.stream)==null?void 0:s.getAudioTracks();for(const n of t)n.enabled=!e}async startVoipCall(){if(!await vt.HasMicrophonePermissions()){console.warn("no permission to use microphone, can not start call");return}me&&console.log("start voip call"),this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),this.updateMute(this.voip.muteOutput),me&&console.log(this.stream),this.call=this.peer.call(this.peerId,this.stream,{metadata:{userId:this.userId}}),this.call.on("error",t=>{console.error(t)}),this.call.on("stream",t=>{me&&console.log("received stream from remote again",t)}),this.peer.on("close",this.onCallClose.bind(this)),this.callErrorListener=t=>{var s;t.message.includes(this.peerId)?(console.log("Could not connect to "+this.peerId),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.close(),(s=this.stream)==null||s.getTracks().forEach(function(n){n.stop()}),this.stream=null):console.error(t)},this.peer.on("error",this.callErrorListener)}onCallClose(e){me&&console.log("call closed",e)}}qr(Fu,"PeerConnection");class Bu{constructor(e,t,s){r(this,"voip");r(this,"call");r(this,"audio",null);r(this,"stream",null);r(this,"obj");r(this,"analyzer",null);r(this,"waitingForStart",!1);r(this,"closed",!1);r(this,"audioElement",null);this.voip=e,this.obj=t,this.call=s}get currentStream(){return this.stream}get currentAudio(){return this.audio}get currentAnalyzer(){return this.analyzer}openAudioStream(e){const t=e.getAudioTracks();for(const s of t)if(s.kind==="audio"&&s.readyState==="live"){this.open(s);return}console.warn("failed finding valid audio stream to begin call")}open(e){console.assert(e.kind==="audio","invalid track kind, expected audio but received "+e.kind),!this.waitingForStart&&(this.waitingForStart=!0,ae.userInteractionRegistered||me&&console.log("Incoming call, waiting for user interaction before opening audio"),ae.registerWaitForAllowAudio(async()=>{if(this.call.open&&!this.closed){me&&console.log("Setup audio and begin listening"),this.stream=new MediaStream([e]);const t=new Ch;this.audio=new Rh(t),this.audio.setVolume(this.voip.muteInput?0:1),this.audio.setMediaStreamSource(this.stream);const s=document.createElement("audio");this.audioElement=s,s.style.display="none",document.body.appendChild(s),s.srcObject=this.stream,s.sinkId!==void 0&&navigator.mediaDevices.enumerateDevices().then(n=>{if(!!s){console.log(n);for(const o of n)if(o.label==="Speakerphone"){s.sinkId=o.deviceId;break}}}),me&&console.log("call is setup, you should hear something now"),this.analyzer=new $g(this.audio,32)}}))}close(){var e,t,s;this.closed=!0,((e=this.call)==null?void 0:e.open)&&this.call.close(),(t=this.audio)==null||t.disconnect(),(s=this.stream)==null||s.getTracks().forEach(n=>{n.stop()}),this.stream=null,this.audioElement&&this.audioElement.remove()}}qr(Bu,"AudioConnection");class vt extends v{constructor(){super(...arguments);r(this,"requireParam",!1);r(this,"peer",null);r(this,"model",null);r(this,"connections",{});r(this,"currentIncomingCalls",{});r(this,"_inputMuted",!1);r(this,"_outputMuted",!1)}set muteInput(e){var s;if(e===this._inputMuted||(this._inputMuted=e,!this.currentIncomingCalls))return;const t=this._inputMuted?0:1;for(const n in this.currentIncomingCalls){const o=this.currentIncomingCalls[n];(s=o==null?void 0:o.currentAudio)==null||s.setVolume(t)}}get muteInput(){return this._inputMuted}set muteOutput(e){if(e!==this._outputMuted&&(this._outputMuted=e,!!this.connections))for(const t in this.connections){const s=this.connections[t];s==null||s.updateMute(e)}}get muteOutput(){return this._outputMuted}getFrequency(e){if(e===null){for(const s in this.currentIncomingCalls){const n=this.currentIncomingCalls[s];if(n&&n.currentAnalyzer)return n.currentAnalyzer.getAverageFrequency()}return null}const t=this.currentIncomingCalls[e];return t&&t.currentAnalyzer?t.currentAnalyzer.getAverageFrequency():null}awake(){if(O(Qr)){console.log("VOIP is disabled by url parameter: "+Qr);return}if(this.requireParam&&!Ky){console.debug("VOIP must be enabled explicitly by url parameter");return}this.peer=new va,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,this.context.connection.beginListen(G.JoinedRoom,e=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}),this.context.connection.beginListen(Xr.Update_ID,e=>{if(e.id!==this.context.connection.connectionId){const t=this.connections[e.id];if(t&&t.close(),this.peer&&this.context.connection.connectionId){const s=new Fu(this,this.peer,this.context.connection.connectionId,e.peerId);this.connections[e.id]=s,s.startVoipCall()}}}),this.context.connection.beginListen(G.UserLeftRoom,e=>{const{userId:t}=e,s=this.connections[t];this.connections[t]=null,s&&s.close();const n=this.currentIncomingCalls[t];me&&console.log("UserLeftRoom",e,t,n),n&&(n.close(),this.currentIncomingCalls[t]=null)}),this.peer.on("open",this.onOpenPeerConnection.bind(this))}onEnable(){}onDisable(){console.log("TODO: close all");for(const e in this.currentIncomingCalls){const t=this.currentIncomingCalls[e];t==null||t.close();const s=this.connections[e];s==null||s.close()}}async onOpenPeerConnection(e){me&&console.log("Peer connection established and received id"),this.model=new Mu(e),this.context.connection.send(Xr.Update_ID,this.model,Js.OnRoomJoin),this.peer&&(this.peer.on("call",this.onReceiveCall.bind(this)),this.peer.on("connection",function(t){me&&console.log("CONNECTION",t),t.on("data",function(s){me&&console.log("Received",s)})}))}async onReceiveCall(e){const{metadata:t}=e;console.assert(t.userId);const{userId:s}=t,n=this.currentIncomingCalls[s];if(n&&n.close(),me&&console.log("received call"),await vt.HasMicrophonePermissions()){const o=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});e.answer(o)}else e.answer(null);this.currentIncomingCalls[s]=new Bu(this,this.gameObject,e),e.on("stream",o=>{var a;me&&console.log("receive caller stream, will setup audio now"),(a=this.currentIncomingCalls[s])==null||a.openAudioStream(o)}),e.on("error",console.error)}static async HasMicrophonePermissions(){return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}}qr(vt,"Voip");var ev=Object.defineProperty,Uu=(i,e)=>ev(i,"name",{value:e,configurable:!0});const ss=O("debugflags");var ee;(function(i){i[i.Never=0]="Never",i[i.Browser=1]="Browser",i[i.AR=2]="AR",i[i.VR=4]="VR",i[i.FirstPerson=8]="FirstPerson",i[i.ThirdPerson=16]="ThirdPerson"})(ee||(ee={}));const ch=class{constructor(){r(this,"Mask",1|16)}Has(e){const t=this.Mask&e;return ss&&console.log("HAS",e,this.Mask,"Result="+t),t!==0}Set(e){this.Mask=e,te.Apply()}Enable(e){this.Mask|=e,te.Apply()}Disable(e){this.Mask&=~e,te.Apply()}Toggle(e){this.Mask^=e,te.Apply()}EnableAll(){this.Mask=4294967295|0,te.Apply()}DisableAll(){this.Mask=0,te.Apply()}};let Ke=ch;r(Ke,"Global",new ch);Uu(Ke,"XRState");const lt=class extends v{constructor(){super(...arguments);r(this,"visibleIn")}static Apply(){for(const e of this.registry)e.UpdateVisible(Ke.Global)}awake(){lt.registry.push(this)}onEnable(){lt.firstApply||(lt.firstApply=!0,lt.Apply())}onDestroy(){const e=lt.registry.indexOf(this);e>=0&&lt.registry.splice(e,1)}get isOn(){return this.gameObject.visible}UpdateVisible(e=null){if(!this.enabled)return;let t;const s=e;s&&typeof s=="number"&&(console.assert(typeof s=="number","XRFlag.UpdateVisible: state must be a number",s),ss&&console.log(s),lt.buffer.Mask=s,e=lt.buffer);const n=e;if(n?(ss&&console.log("use passed in mask"),t=n.Has(this.visibleIn)):(ss&&console.log("use global mask"),Ke.Global.Has(this.visibleIn)),t!==void 0)if(t)ss&&console.trace("is visible",this.name,this.gameObject.uuid),p.setActive(this.gameObject,!0);else{if(ss&&console.trace("is not visible",this.name,this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}};let te=lt;r(te,"registry",[]),r(te,"firstApply"),r(te,"buffer",new Ke);Uu(te,"XRFlag");var tv=Object.defineProperty,Nu=(i,e)=>tv(i,"name",{value:e,configurable:!0});const zt=O("debugavatar"),Dt=class extends v{constructor(){super(...arguments);r(this,"connectionId");r(this,"avatar")}static onAvatarMarkerCreated(e){return Dt._onNewAvatarMarkerAdded.push(e),e}static onAvatarMarkerDestroyed(e){return Dt._onAvatarMarkerDestroyed.push(e),e}awake(){Dt.instances.push(this),zt&&console.log(this);for(const e of Dt._onNewAvatarMarkerAdded)e({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){Dt.instances.splice(Dt.instances.indexOf(this),1);for(const e of Dt._onAvatarMarkerDestroyed)e({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}setVisible(e){this.avatar&&("setVisible"in this.avatar?this.avatar.setVisible(e):p.setActive(this.avatar,e))}};let ie=Dt;r(ie,"instances",[]),r(ie,"_onNewAvatarMarkerAdded",[]),r(ie,"_onAvatarMarkerDestroyed",[]);Nu(ie,"AvatarMarker");const Kn=class{constructor(e,t,s){r(this,"_isVisible",!0);r(this,"guid");r(this,"root",null);r(this,"head",null);r(this,"handLeft",null);r(this,"handRight",null);r(this,"lastUpdate",-1);r(this,"isLocalAvatar",!1);r(this,"flags",null);r(this,"headScale",new y(1,1,1));r(this,"handLeftScale",new y(1,1,1));r(this,"handRightScale",new y(1,1,1));r(this,"webxr");r(this,"lastAvatarId",null);r(this,"hasAvatarOverride",!1);r(this,"context");r(this,"avatarMarker",null);r(this,"_headTarget",new x);r(this,"_handLeftTarget",new x);r(this,"_handRightTarget",new x);r(this,"_canInterpolate",!1);this.context=e,this.guid=t,this.webxr=s,this.setupCustomAvatar(this.webxr.defaultAvatar)}setVisible(e){this._isVisible=e,this.updateVisibility()}updateFlags(){if(!this.flags)return;let e=this.isLocalAvatar?ee.FirstPerson:ee.ThirdPerson;for(const t of this.flags)t.gameObject.visible=!0,t.UpdateVisible(e)}async setAvatarOverride(e){return this.hasAvatarOverride=e!==null,this.hasAvatarOverride&&this.lastAvatarId!==e&&(this.lastAvatarId=e,e!=null&&e.length>0)?await this.setupCustomAvatar(e):null}tryUpdate(e,t){if(e.guid===this.guid&&(this.lastAvatarId!==e.avatarId&&e.avatarId&&e.avatarId.length>0&&(this.lastAvatarId=e.avatarId,this.setupCustomAvatar(e.avatarId)),this.lastUpdate=e.time,this.head)){this._canInterpolate=!0;const s=this.isLocalAvatar?this.head:this._headTarget;if(s.position.set(e.position.x,e.position.y,e.position.z),s.quaternion.set(e.rotation.x,e.rotation.y,e.rotation.z,e.rotation.w),s.scale.set(e.scale,e.scale,e.scale),s.scale.multiply(this.headScale),this.handLeft){const n=this.isLocalAvatar?this.handLeft:this._handLeftTarget;n.position.set(e.posLeftHand.x,e.posLeftHand.y,e.posLeftHand.z),n.quaternion.set(e.rotLeftHand._x,e.rotLeftHand._y,e.rotLeftHand._z,e.rotLeftHand._w),n.quaternion.multiply(Kn.invertRotation),n.scale.set(e.scale,e.scale,e.scale),n.scale.multiply(this.handLeftScale)}if(this.handRight){const n=this.isLocalAvatar?this.handRight:this._handRightTarget;n.position.set(e.posRightHand.x,e.posRightHand.y,e.posRightHand.z),n.quaternion.set(e.rotRightHand._x,e.rotRightHand._y,e.rotRightHand._z,e.rotRightHand._w),n.quaternion.multiply(Kn.invertRotation),n.scale.set(e.scale,e.scale,e.scale),n.scale.multiply(this.handRightScale)}}}update(){if(this.isLocalAvatar||!this._canInterpolate)return;const e=this.context.time.deltaTime/.1;this.head&&(this.head.position.lerp(this._headTarget.position,e),this.head.quaternion.slerp(this._headTarget.quaternion,e),this.head.scale.lerp(this._headTarget.scale,e)),this.handLeft&&this._handLeftTarget&&(this.handLeft.position.lerp(this._handLeftTarget.position,e),this.handLeft.quaternion.slerp(this._handLeftTarget.quaternion,e),this.handLeft.scale.lerp(this._handLeftTarget.scale,e)),this.handRight&&this._handRightTarget&&(this.handRight.position.lerp(this._handRightTarget.position,e),this.handRight.quaternion.slerp(this._handRightTarget.quaternion,e),this.handRight.scale.lerp(this._handRightTarget.scale,e))}destroy(){var e,t;zt&&console.log("Destroy avatar",this.guid),(e=this.root)==null||e.removeFromParent(),(t=this.avatarMarker)==null||t.destroy(),this.lastAvatarId=null,this.head&&le.Remove(this.context,this.head)}updateVisibility(){const e=this.root;e&&p.setActive(e,this._isVisible)}async setupCustomAvatar(e){var n,o,a,l,c;if(zt&&console.log("LOAD",e,this),!e||typeof e=="string"&&e.length<=0)return!1;this.head&&le.Remove(this.context,this.head);const t=e;if((t==null?void 0:t.loadAssetAsync)!==void 0){await t.loadAssetAsync();const h=t.asset;p.setActive(h,!1),e=p.instantiate(h),p.setActive(e,!0)}zt&&console.log(e);const s=await Kn.loader.getOrCreateNewAvatarInstance(this.context,e);if(zt&&console.log(s,s==null?void 0:s.isValid,this.lastAvatarId,e),s==null?void 0:s.isValid){if(this.root=s.root,this.avatarMarker=p.addNewComponent(this.root,ie),this.avatarMarker.connectionId=this.guid,this.avatarMarker.avatar=this,this.head&&this.head!==s.head&&((n=this.head)==null||n.removeFromParent()),this.head=s.head,this.headScale.copy(this.head.scale),this.head&&!this.isLocalAvatar&&le.Add(this.context,this.head,this.avatarMarker),s.leftHand&&((o=this.handLeft)==null||o.removeFromParent()),this.handLeft=(a=s.leftHand)!=null?a:this.handLeft,this.handLeft?this.handLeftScale.copy(this.handLeft.scale):this.handLeftScale.set(1,1,1),s.rigthHand&&((l=this.handRight)==null||l.removeFromParent()),this.handRight=(c=s.rigthHand)!=null?c:this.handRight,this.handRight?this.handRightScale.copy(this.handRight.scale):this.handRightScale.set(1,1,1),this.context.scene.add(this.root),this.flags==null&&(this.flags=[]),this.flags.length=0,this.flags.push(...p.getComponentsInChildren(this.root,te)),this.flags.length<=0&&this.head){const h=p.addNewComponent(this.head,te);h.visibleIn=ee.ThirdPerson|ee.VR,this.flags.push(h),zt&&console.log("Added flag to head: "+h.visibleIn,this.head.name)}return zt&&console.log("[Avatar], is Local? ",this.isLocalAvatar,this.root),this.updateFlags(),this.updateVisibility(),!0}else return zt&&console.warn("build avatar failed"),!1}};let wt=Kn;r(wt,"loader",new on),r(wt,"invertRotation",new P().setFromAxisAngle(new y(0,1,0),Math.PI));Nu(wt,"WebXRAvatar");var iv=Object.defineProperty,Sl=(i,e)=>iv(i,"name",{value:e,configurable:!0});class le{static Add(e,t,s=null){if(!!t){for(const n of this.Pois)if(n.obj===t)return;this.Pois.push({obj:t,avatar:s}),this.LastChangeTime=e.time.time}}static Remove(e,t){var s,n;if(!!t){for(const o of this.Pois)if(o.obj===t){this.Pois.splice(this.Pois.indexOf(o),1),this.LastChangeTime=(n=e==null?void 0:e.time.time)!=null?n:(s=k.Current)==null?void 0:s.time.time;return}}}}r(le,"Pois",[]),r(le,"LastChangeTime",0);Sl(le,"Avatar_POI");var Yr;(function(i){i.TargetChanged="avatar-look-target-changed"})(Yr||(Yr={}));class $u{constructor(){r(this,"guid");r(this,"position",new y)}}Sl($u,"TargetModel");class ln extends v{constructor(){super(...arguments);r(this,"target",null);r(this,"avatar",null);r(this,"_model",null);r(this,"_targetModel",new $u);r(this,"_currentTargetObject",null);r(this,"_lastUpdateTime",0);r(this,"_lookDuration",0);r(this,"_lastPoiChangedTime",0)}set controlledTarget(e){this.target=e;const t=m.get("MoveRandom");if(t&&this.target){const s=p.getComponent(this.target,t);s&&s.destroy()}}awake(){if(this.avatar=p.getComponentInParent(this.gameObject,ie),this.avatar){const e=p.getComponentInParent(this.gameObject,ie);this._model=new Rr(this.context.connection,this.guid),(e==null?void 0:e.isLocalAvatar)&&this._model.requestOwnership()}this.context.connection.beginListen(Yr.TargetChanged,e=>{var t;this.target&&e&&e.guid===((t=this.avatar)==null?void 0:t.guid)&&F(this.target,e.position)})}update(){var t;if((!this.context.connection.isConnected||((t=this._model)==null?void 0:t.hasOwnership))&&(le.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=le.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10==0&&this.target)){const s=R(this._currentTargetObject);F(this.target,s),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send(Yr.TargetChanged,this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(s))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const t=le.Pois;if(t.length>0){const s=t[Math.floor(Math.random()*t.length)];if(s&&s.obj){if(s.avatar&&s.avatar===this.avatar)return;this._currentTargetObject=s.obj}}}}}Sl(ln,"Avatar_Brain_LookAt");var sv=Object.defineProperty,Jr=(i,e)=>sv(i,"name",{value:e,configurable:!0}),Zr;(function(i){i[i.PhysicalDevice=0]="PhysicalDevice",i[i.Touch=1]="Touch"})(Zr||(Zr={}));var we;(function(i){i.SelectStart="select-start",i.SelectEnd="select-end",i.Update="update"})(we||(we={}));class Kr extends v{}Jr(Kr,"TeleportTarget");const q=class extends v{constructor(){super(...arguments);r(this,"webXR");r(this,"index",-1);r(this,"controllerModel");r(this,"controller");r(this,"controllerGrip");r(this,"hand");r(this,"handPointerModel");r(this,"grabbed",null);r(this,"input",null);r(this,"type",0);r(this,"_wristQuaternion",null);r(this,"movementVector",new y);r(this,"worldRot",new P);r(this,"joystick",new Q);r(this,"didRotate",!1);r(this,"didTeleport",!1);r(this,"didChangeScale",!1);r(this,"lastHit",null);r(this,"raycastLine",null);r(this,"_raycastHitPoint",null);r(this,"_connnectedCallback",null);r(this,"_disconnectedCallback",null);r(this,"_selectStartEvt",null);r(this,"_selectEndEvt",null);r(this,"_selectionPressed",!1);r(this,"_selectionPressedLastFrame",!1);r(this,"_selectionStartTime",0);r(this,"_selectionEndTime",0);r(this,"_useSmoothing",!0);r(this,"_isConnected",!1);r(this,"rayRotation",new P);r(this,"_pinchStartTime");r(this,"selectStartCallback",null);r(this,"lastSelectStartObject",null);r(this,"_didNotEndSelection",!1)}static CreateRaycastLine(){const e=new Eh(this.geometry),t=e.material;return t.color=this.raycastColor,e.layers.set(1),e.name="line",e.scale.z=1,e}static CreateRaycastHitPoint(){const e=new Ah(.5,22,22),t=new $s({color:this.raycastColor}),s=new ii(e,t);return s.visible=!1,s.layers.set(1),s}static Create(e,t,s,n){const o=s?p.addNewComponent(s,q,!1):new q;o.webXR=e,o.index=t,o.type=n;const a=e.context;return o.controller=a.renderer.xr.getController(t),o.controllerGrip=a.renderer.xr.getControllerGrip(t),o.controllerModel=this.Factory.createControllerModel(o.controller),o.controllerGrip.add(o.controllerModel),o.hand=a.renderer.xr.getHand(t),o.hand.add(new Hg(o.hand)),o.hand.traverse(l=>l.layers.set(2)),o.handPointerModel=new zg(o.hand,o.controller),o.controller.addEventListener("connected",l=>{o.setControllerLayers(o.controllerModel,2),o.setControllerLayers(o.controllerGrip,2),setTimeout(()=>{o.setControllerLayers(o.controllerGrip,2)},1e3)}),o.hand.addEventListener("connected",l=>{var h;if(l.data.hand){e.Rig&&e.Rig.add(o.hand),o.type=0,o.handPointerModel.traverse(u=>u.layers.set(2)),(h=o.handPointerModel.pointerObject)==null||h.traverse(u=>u.layers.set(2));const d=o.hand.joints;if(d)for(const u of Object.keys(d)){const _=d[u];_.parent||o.hand.add(_)}}}),o}static addEventListener(e,t){var n;const s=(n=this.eventSubs[e])!=null?n:[];s.push(t),this.eventSubs[e]=s}get isUsingHands(){var t;const e=(t=this.input)==null?void 0:t.hand;return e!=null}get wrist(){if(!this.hand)return null;const e=this.hand.joints;return e?e.wrist:null}getWristQuaternion(){const e=this.wrist;return e?(this._wristQuaternion||(this._wristQuaternion=new P),re(e).multiply(this._wristQuaternion.setFromEuler(new he(-Math.PI/4,0,0)))):null}get selectionDown(){return this._selectionPressed&&!this._selectionPressedLastFrame}get selectionUp(){return!this._selectionPressed&&this._selectionPressedLastFrame}get selectionPressed(){return this._selectionPressed}get selectionClick(){return this._selectionEndTime-this._selectionStartTime<.3}get raycastHitPoint(){return this._raycastHitPoint}get useSmoothing(){return this._useSmoothing}awake(){if(!this.controller){console.warn("Missing Controller!!!",this);return}this._connnectedCallback=this.onSourceConnected.bind(this),this._disconnectedCallback=this.onSourceDisconnected.bind(this),this._selectStartEvt=this.onSelectStart.bind(this),this._selectEndEvt=this.onSelectEnd.bind(this),this.type===1&&(this.controllerGrip.addEventListener("connected",this._connnectedCallback),this.controllerGrip.addEventListener("disconnected",this._disconnectedCallback),this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt))}onDestroy(){var e,t,s;this.type===1&&(this.controllerGrip.removeEventListener("connected",this._connnectedCallback),this.controllerGrip.removeEventListener("disconnected",this._disconnectedCallback),this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),(e=this.hand)==null||e.clear(),(t=this.controllerGrip)==null||t.clear(),(s=this.controller)==null||s.clear()}onEnable(){var e,t,s,n,o;this.hand&&(this.hand.name="Hand"),this.controllerGrip&&(this.controllerGrip.name="ControllerGrip"),this.controller&&(this.controller.name="Controller"),this.raycastLine&&(this.raycastLine.name="RaycastLine;"),this.webXR.Controllers.indexOf(this)<0&&this.webXR.Controllers.push(this),this.raycastLine||(this.raycastLine=q.CreateRaycastLine()),this._raycastHitPoint||(this._raycastHitPoint=q.CreateRaycastHitPoint()),(e=this.webXR.Rig)==null||e.add(this.hand),(t=this.webXR.Rig)==null||t.add(this.controllerGrip),(s=this.webXR.Rig)==null||s.add(this.controller),(n=this.webXR.Rig)==null||n.add(this.raycastLine),(o=this.raycastLine)==null||o.add(this._raycastHitPoint),this.hand.add(this.handPointerModel),console.log("ADDED TO RIG",this.webXR.Rig)}onDisable(){var t,s,n,o,a;(t=this.hand)==null||t.removeFromParent(),(s=this.controllerGrip)==null||s.removeFromParent(),(n=this.controller)==null||n.removeFromParent(),(o=this.raycastLine)==null||o.removeFromParent(),(a=this._raycastHitPoint)==null||a.removeFromParent();const e=this.webXR.Controllers.indexOf(this);e>=0&&this.webXR.Controllers.splice(e,1)}onSourceConnected(e){if(this._isConnected){console.warn("Received connected event for controller that is already connected",this.index,e);return}this._isConnected=!0,this.input=e.data,this.type===1&&(this.onSelectStart(),this.createPointerEvent("down"))}onSourceDisconnected(e){if(!this._isConnected){console.warn("Received discnnected event for controller that is not connected",e);return}this._isConnected=!1,this.type===1&&(this.onSelectEnd(),this.createPointerEvent("up")),this.input=null}createPointerEvent(e){switch(e){case"down":this.context.input.createPointerDown({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break;case"move":break;case"up":this.context.input.createPointerUp({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break}}update(){this.context.time.frameCount%60==0&&(this.setControllerLayers(this.controller,2),this.setControllerLayers(this.controllerGrip,2),this.setControllerLayers(this.hand,2));const e=q.eventSubs[we.Update];if(e&&e.length>0)for(const n of e)n(this);let t=1;this.type===0?t=this.context.time.deltaTime/.1:this.isUsingHands&&this.handPointerModel.pinched&&(t=this.context.time.deltaTime/.3),this.rayRotation.slerp(re(this.controller),this.useSmoothing?t:1);const s=R(this.controller);if(this.raycastLine)if(this.type===1)this.raycastLine.visible=!1;else if(this.isUsingHands){this.raycastLine.visible=!this.grabbed,F(this.raycastLine,s);const n=this.hand.joints;if(n&&n.wrist&&this.grabbed&&this.grabbed.isCloseGrab){const a=this.getWristQuaternion();a&&this.rayRotation.copy(a)}oe(this.raycastLine,this.rayRotation)}else this.raycastLine.visible=!0,oe(this.raycastLine,this.rayRotation),F(this.raycastLine,s);this.lastHit=this.updateLastHit(),this.grabbed&&this.grabbed.update(),this._selectionPressedLastFrame=this._selectionPressed,this.selectStartCallback&&this.selectStartCallback()}onUpdate(e){var n,o;if(this.lastHit=null,!e||e.inputSources.length<=this.index){this.input=null;return}if(this.type===0&&(this.input=e.inputSources[this.index]),!this.input)return;const t=this.webXR.Rig;if(!t)return;this._didNotEndSelection&&!this.handPointerModel.pinched&&(this._didNotEndSelection=!1,this.onSelectEnd()),this.updateStick(this.input);const s=(o=(n=this.input)==null?void 0:n.gamepad)==null?void 0:o.buttons;switch(this.input.handedness){case"left":const a=3*q.MovementSpeedFactor,l=2,c=L.clamp01(this.joystick.length()*2),h=this.joystick.x>0?1:-1;let d=Math.pow(this.joystick.x,l);d*=h,d*=c;const u=this.joystick.y>0?1:-1;let _=Math.pow(this.joystick.y,l);_*=u,d*=c,t.getWorldQuaternion(this.worldRot),this.movementVector.set(d,0,_),this.movementVector.applyQuaternion(this.webXR.TransformOrientation),this.movementVector.y=0,this.movementVector.applyQuaternion(this.worldRot),t.position.add(this.movementVector.multiplyScalar(a*this.context.time.deltaTime)),this.isUsingHands&&this.runTeleport(t,s);break;case"right":const b=this.joystick.x,w=Math.abs(b);if(w<.4)this.didRotate=!1;else if(w>.5&&!this.didRotate){const C=b>0?-1:1;t.rotateY(L.toRadians(30*C)),this.didRotate=!0}this.runTeleport(t,s);break}}runTeleport(e,t){var l,c,h;let s=-this.joystick.y;if(((l=this.hand)==null?void 0:l.visible)&&!this.grabbed){const d=this.handPointerModel.isPinched();d&&this._pinchStartTime===void 0&&(this._pinchStartTime=this.context.time.time),d&&this._pinchStartTime&&this.context.time.time-this._pinchStartTime>.8&&(s=this.handPointerModel.isPinched()?1:0),d||(this._pinchStartTime=void 0)}else this._pinchStartTime=void 0;let n=s>.5,o=this.webXR.Rig?((h=(c=this.webXR.Rig)==null?void 0:c.scale)==null?void 0:h.x)<.999:!1,a=null;if(t&&this.input&&!this.input.hand)for(let d=0;d<t.length;d++){const u=t[d];if(d===4)if(u.pressed&&!this.didChangeScale){this.didChangeScale=!0;const _=this.webXR.Rig;if(_)if(o){o=!1,_.scale.set(1,1,1),a=1,q.MovementSpeedFactor=1;const b=this.context.mainCamera;q.PreviousCameraFarDistance&&(b.far=q.PreviousCameraFarDistance)}else{o=!0,n=!0,a=.1,q.MovementSpeedFactor=a*2;const b=this.context.mainCamera;q.PreviousCameraFarDistance=b.far,b.far/=a}}else u.pressed||(this.didChangeScale=!1)}if(n){if(!this.didTeleport){const d=this.raycast();if(this.didTeleport=!0,d&&d.length>0){const u=d[0];if(o||this.isValidTeleportTarget(u.object)){const _=u.point;F(e,_)}}}}else s<.1&&(this.didTeleport=!1);a!==null&&(e.scale.set(a,a,a),e.updateMatrixWorld())}isValidTeleportTarget(e){return p.getComponentInParent(e,Kr)!=null}updateStick(e){var t;!e||!e.gamepad||((t=e.gamepad.axes)==null?void 0:t.length)<4||(this.joystick.x=e.gamepad.axes[2],this.joystick.y=e.gamepad.axes[3])}updateLastHit(){var n,o;const e=this.raycast(),t=e?e[0]:null;this.lastHit=t;let s=1;if(this.webXR.Rig&&(s/=this.webXR.Rig.scale.x),this.raycastLine){this.raycastLine.scale.z=s*((o=(n=this.lastHit)==null?void 0:n.distance)!=null?o:9999);const a=this.raycastLine.material;t!=null?a.color=q.raycastColor:a.color=q.raycastNoHitColor}if(this._raycastHitPoint){if(this.lastHit!=null){this._raycastHitPoint.position.z=-1;const a=L.clamp(this.lastHit.distance*.01*s,.015,.1);this._raycastHitPoint.scale.set(a,a,a)}this._raycastHitPoint.visible=this.lastHit!==null}return t}onSelectStart(){!this.context.connection.allowEditing||(this.selectStartCallback=()=>this.onHandleSelectStart())}onHandleSelectStart(){this.selectStartCallback=null,this._selectionPressed=!0,this._selectionStartTime=this.context.time.time,this._selectionEndTime=1e3;let e=null,t=!1;if(this.isUsingHands?(e=this.overlap(),e.length<=0?(e=this.raycast(),t=!1):t=!0):e=this.raycast(),e&&e.length>0)for(const s of e){const n=s.object;if(!this.testIsVisible(n)){console.log("not visible");continue}this.lastSelectStartObject=n;const o={selected:n,grab:n},a=q.eventSubs[we.SelectStart];if(a&&a.length>0)for(const l of a)l(this,o);o.grab!==n&&console.log("Grabbed object changed","original",n,"new",o.grab),o.grab&&(this.grabbed=$e.TryTake(this,o.grab,s,t));break}else{const s=q.eventSubs[we.SelectStart],n={selected:null,grab:null};if(s&&s.length>0)for(const o of s)o(this,n)}}onSelectEnd(){var s,n;if(this.isUsingHands&&this.handPointerModel.pinched){this._didNotEndSelection=!0;return}if(!this._selectionPressed)return;this.selectStartCallback=null,this._selectionPressed=!1,this._selectionEndTime=this.context.time.time;const e={grab:(n=(s=this.grabbed)==null?void 0:s.selected)!=null?n:this.lastSelectStartObject},t=q.eventSubs[we.SelectEnd];if(t&&t.length>0)for(const o of t)o(this,e);this.grabbed&&(this.grabbed.free(),this.grabbed=null)}testIsVisible(e){return e?p.isActiveInHierarchy(e):!0}setControllerLayers(e,t){var s,n;if(!!e&&(e.layers.set(t),e.children))for(const o of e.children)((s=this.grabbed)==null?void 0:s.selected)===o||((n=this.grabbed)==null?void 0:n.selectedMesh)===o||this.setControllerLayers(o,t)}getRay(){const e=new Th;return e.origin.copy(R(this.controller)),e.direction.set(0,0,-1).applyQuaternion(this.rayRotation),e}overlap(){const e=this.isUsingHands&&this.handPointerModel?this.handPointerModel.pointerObject:this.controllerGrip;if(!e)return new Array;const t=R(e).clone();return this.context.physics.sphereOverlap(t,.02)}raycast(){const e=new Xe;return e.layerMask=new ir,e.layerMask.set(0),e.ray=this.getRay(),this.context.physics.raycast(e)}};let U=q;r(U,"Factory",new Wg),r(U,"raycastColor",new g(.9,.3,.3)),r(U,"raycastNoHitColor",new g(.6,.6,.6)),r(U,"geometry",new rr().setFromPoints([new y(0,0,0),new y(0,0,-1)])),r(U,"handModels",{}),r(U,"eventSubs",{}),r(U,"PreviousCameraFarDistance"),r(U,"MovementSpeedFactor",1);Jr(U,"WebXRController");var eo;(function(i){i.WillTake="WillTake",i.DidTake="DidTake",i.WillFree="WillFree",i.DidFree="DidFree"})(eo||(eo={}));const ce=class{constructor(){r(this,"sync",null);r(this,"selected",null);r(this,"selectedParent",null);r(this,"selectedMesh",null);r(this,"controller",null);r(this,"grabTime",0);r(this,"grabUUID","");r(this,"isCloseGrab",!1);r(this,"originalMaterial",null);r(this,"usageMarker",null);r(this,"rigidbodies",null);r(this,"didReparent",!1);r(this,"grabDistance",0);r(this,"interactable",null);r(this,"positionSource",null);r(this,"grabPoint",new y);r(this,"localPositionOffsetToGrab",null);r(this,"localPositionOffsetToGrab_worldSpace",new y);r(this,"localQuaternionToGrab",new P(0,0,0,1));r(this,"targetDir",null);r(this,"quaternionLerp",null);r(this,"controllerDir",new y);r(this,"controllerWorldPos",new y);r(this,"lastControllerWorldPos",new y);r(this,"controllerPosDelta",new y);r(this,"totalChangeAlongDirection",0);r(this,"rigPositionLastFrame",new y)}static AddEventListener(e,t){return ce.Events[e]||(ce.Events[e]=[]),ce.Events[e].push(t),t}static RemoveEventListener(e,t){if(!t||!ce.Events[e])return;const s=ce.Events[e].indexOf(t);s>=0&&ce.Events[e].splice(s,1)}static Register(e){this.Current.find(t=>t===e)||this.Current.push(e)}static Remove(e){const t=this.Current.indexOf(e);t>=0&&this.Current.splice(t,1)}static TryTake(e,t,s,n){const o=p.getComponentInParent(t,ts);if(!o)return console.warn("Prevented taking object that is not interactable",t),null;let a=t;const l=p.getComponentInParent(t,yt);l&&(l.requestOwnership(),a=l.gameObject);for(const h of this.Current)if(h.selected===a)return h.controller===e||(h.free(),h.Take(e,a,t,l,o,s,n)),h;const c=new ce;return c.Take(e,a,t,l,o,s,n),c}Take(e,t,s,n,o,a,l){var b,w;if(console.assert(t!==null,"Expected object to be taken but was",t),e.isUsingHands?this.positionSource=l?e.wrist:e.controller:this.positionSource=e.controller,!this.positionSource)return console.warn("No position source"),this;const c={controller:e,take:t,hit:s,sync:n,interactable:o};(b=ce.Events.WillTake)==null||b.forEach(C=>C(this,c));const h=s;(h==null?void 0:h.material)&&(this.originalMaterial=h.material,Array.isArray(h.material)||(h.material=h.material.clone(),h.material&&h.material.emissive&&(h.material.emissive.b=.2))),this.selected=t,this.selectedParent||(this.selectedParent=t.parent),this.selectedMesh=h,this.controller=e,this.interactable=o,this.isCloseGrab=l,this.didReparent=!1,this.sync=n,this.grabTime=e.context.time.time,this.grabUUID=Date.now().toString(),this.usageMarker=p.addNewComponent(this.selected,is),this.rigidbodies=p.getComponentsInChildren(this.selected,Ne),R(this.positionSource,this.lastControllerWorldPos);const d=Jr(()=>l?this.lastControllerWorldPos.clone():a.point.clone(),"getGrabPoint");this.grabDistance=d().distanceTo(this.lastControllerWorldPos),this.totalChangeAlongDirection=0,this.localPositionOffsetToGrab=this.selected.worldToLocal(d());const u=e.isUsingHands&&l?this.controller.getWristQuaternion().clone():e.rayRotation.clone();re(this.selected,this.localQuaternionToGrab).premultiply(u.invert());const _=this.controller.webXR.Rig;return _&&this.rigPositionLastFrame.copy(R(_)),le.Add(e.context,this.selected),ce.Register(this),this.sync&&(this.sync.fastMode=!0),(w=ce.Events.DidTake)==null||w.forEach(C=>C(this,c)),this}free(){var n,o,a,l;if(!this.selected)return;const e={controller:this.controller,take:this.selected,hit:this.selected,sync:this.sync,interactable:null};(n=ce.Events.WillFree)==null||n.forEach(c=>c(this,e)),le.Remove(this.controller.context,this.selected),ce.Remove(this),this.sync&&(this.sync.fastMode=!1);const t=this.selectedMesh;t&&this.originalMaterial&&t.material&&(t.material=this.originalMaterial);const s=this.selected;if(this.didReparent&&s.parent){const c=this.selectedParent;c?c.attach(s):(o=this.controller)==null||o.context.scene.attach(s)}if((a=this.usageMarker)==null||a.destroy(),this.controller&&(this.controller.grabbed=null),this.selected=null,this.selectedParent=null,this.selectedMesh=null,this.sync=null,this.rigidbodies)for(const c of this.rigidbodies)c.wakeUp(),!!c.smoothedVelocity&&c.setVelocity(c.smoothedVelocity.x,c.smoothedVelocity.y,c.smoothedVelocity.z);this.rigidbodies=null,this.localPositionOffsetToGrab=null,this.quaternionLerp=null,(l=ce.Events.DidFree)==null||l.forEach(c=>c(this,e))}controllerMovementSinceLastFrame(){if(!this.positionSource||!this.controller)return 0;this.controllerDir.set(0,0,-1),this.controllerDir.applyQuaternion(this.controller.rayRotation),R(this.positionSource,this.controllerWorldPos),this.controllerPosDelta.copy(this.controllerWorldPos),this.controllerPosDelta.sub(this.lastControllerWorldPos),this.lastControllerWorldPos.copy(this.controllerWorldPos);const e=this.controller.webXR.Rig;if(e){const s=R(e),n=this.rigPositionLastFrame.sub(s);this.controllerPosDelta.add(n),this.rigPositionLastFrame.copy(s)}return this.controllerDir.dot(this.controllerPosDelta)}update(){var e,t;if(this.sync&&this.controller&&this.controller.context.connection.isInRoom&&this.controller.context.time.time-this.grabTime>3&&this.sync.hasOwnership()===!1&&(console.log("no ownership, will leave",this.sync.guid),this.free()),!(this.interactable&&!this.interactable.canGrab)){if(!this.didReparent&&this.selected&&this.controller){const s=(t=(e=this.controller.webXR.Rig)==null?void 0:e.scale.x)!=null?t:1;this.totalChangeAlongDirection+=this.controllerMovementSinceLastFrame();let n=1;this.controller.type===0&&(n=Math.max(0,1+this.totalChangeAlongDirection*2/s),n=n*n*n),this.grabDistance/s<.8&&(n=1),this.targetDir||(this.targetDir=new y),this.targetDir.set(0,0,-this.grabDistance*n);const o=this.targetDir.applyQuaternion(this.controller.rayRotation).add(this.controllerWorldPos),a=this.controller.rayRotation.clone().multiplyQuaternions(this.controller.rayRotation,this.localQuaternionToGrab);this.quaternionLerp||(this.quaternionLerp=a.clone()),this.quaternionLerp.slerp(a,this.controller.useSmoothing?this.controller.context.time.deltaTime/.03:1),oe(this.selected,this.quaternionLerp),this.selected.updateWorldMatrix(!1,!1),this.grabPoint.copy(o),this.localPositionOffsetToGrab&&(this.localPositionOffsetToGrab_worldSpace.copy(this.localPositionOffsetToGrab),this.selected.localToWorld(this.localPositionOffsetToGrab_worldSpace).sub(R(this.selected)),o.sub(this.localPositionOffsetToGrab_worldSpace)),F(this.selected,o)}if(this.rigidbodies!=null)for(const s of this.rigidbodies)s.wakeUp(),s.setBodyFromGameObject({x:0,y:0,z:0});ue.markDirty(this.selected,!0)}}};let $e=ce;r($e,"Events",{}),r($e,"Current",[]);Jr($e,"AttachedObject");var Wu=Object.defineProperty,nv=Object.getOwnPropertyDescriptor,rv=(i,e)=>Wu(i,"name",{value:e,configurable:!0}),ov=(i,e,t,s)=>{for(var n=s>1?void 0:s?nv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Wu(e,t,n),n};class cn extends v{constructor(){super(...arguments);r(this,"webAR",null);r(this,"invertForward",!1);r(this,"_arScale",5);r(this,"_rig",null);r(this,"_startPose",null);r(this,"_placementPose",null);r(this,"_isTouching",!1)}get arScale(){return this._arScale}set arScale(e){e!==this._arScale&&(this._arScale=e,this.setScale(e))}onBegin(e){this._placementPose=null,this.gameObject.visible=!1,this.gameObject.matrixAutoUpdate=!1,this._startPose=this.gameObject.matrix.clone(),e.addEventListener("selectstart",this.onSelectStart.bind(this)),e.addEventListener("selectend",this.onSelectEnd.bind(this)),setTimeout(()=>this.gameObject.visible=!1,1e3)}onUpdate(e,t,s){if(s&&!this._placementPose&&this._isTouching){if(this.webAR&&this.webAR.setReticleActive(!1),this._placementPose=new Be().fromArray(s.transform.matrix).invert(),e){if(this.invertForward){const n=new Be().makeRotationY(Math.PI);this._placementPose.premultiply(n)}this._rig=e,this.setScale(this.arScale)}else this._rig=null;this.gameObject.visible=!0}}onEnd(e,t){this._placementPose=null,this.gameObject.visible=!1,this._startPose&&this.gameObject.matrix.copy(this._startPose),this.gameObject.matrixAutoUpdate=!0,e&&(e.matrixAutoUpdate=!0),ue.markDirty(this.gameObject,!0),setTimeout(()=>this.gameObject.visible=!0,100)}onSelectStart(){this._isTouching=!0}onSelectEnd(){this._isTouching=!1}setScale(e){const t=this._rig;!t||!this._placementPose||(t.matrixAutoUpdate=!1,t.matrix.multiplyMatrices(new Be().makeScale(e,e,e),this._placementPose),t.matrix.decompose(t.position,t.quaternion,t.scale),t.updateMatrixWorld())}}rv(cn,"WebARSessionRoot");ov([f()],cn.prototype,"arScale",1);var av=Object.defineProperty,lv=(i,e)=>av(i,"name",{value:e,configurable:!0});class to extends v{awake(){}}lv(to,"XRRig");var cv=Object.defineProperty,Rl=(i,e)=>cv(i,"name",{value:e,configurable:!0});const ns=O("debugaddressables");class Hu{constructor(e){r(this,"_context");r(this,"_assetReferences",{});this._context=e,this._context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){}findAssetReference(e){return this._assetReferences[e]||null}registerAssetReference(e){!e.uri||(this._assetReferences[e.uri]?console.warn("Asset reference already registered",e):this._assetReferences[e.uri]=e)}}Rl(Hu,"Addressables");class Te{constructor(e){r(this,"_loading");r(this,"_asset");r(this,"_glbRoot");r(this,"_uri");r(this,"_progressListeners",[]);r(this,"_isLoadingRawBinary",!1);r(this,"_rawBinary");this._uri=e,xd(this._uri,this.onResolvePrefab.bind(this))}static getOrCreate(e,t){const s=t.addressables,n=s.findAssetReference(e);if(n)return n;const o=new Te(e);return s.registerAssetReference(o),o}get asset(){var e;return(e=this._glbRoot)!=null?e:this._asset}set asset(e){this._asset=e}get uri(){return this._uri}get rawAsset(){return this._asset}async onResolvePrefab(e){return e===this.uri&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(ns&&console.log("Unload",this.asset),this.asset.scene?p.destroy(this.asset.scene):p.destroy(this.asset)),this.asset=null}async preload(){var t;if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,ns&&console.log("Preload",this.uri);const e=await Su(this.uri,s=>{this.raiseProgressEvent(s)});return this._rawBinary=(t=e==null?void 0:e.buffer)!=null?t:null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(e){if(!this.mustLoad)return;if(e&&this._progressListeners.push(e),this._loading!==void 0)return this._loading;const t=k.Current;this._rawBinary?(this._loading=Wn(t,this._rawBinary,this.uri,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))):(ns&&console.log("Load async",this.uri),this._loading=Cs(t,this.uri,null,!0,n=>{this.raiseProgressEvent(n)}));const s=await this._loading;if(this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(s),this._loading=void 0,s)return qi(t),s.scene!==void 0&&(this.asset=s),this.asset}async instantiate(e){return this.onInstantiate(e,!1)}async instantiateSynced(e,t=!0){return this.onInstantiate(e,!0,t)}beginListenDownload(e){this._progressListeners.indexOf(e)<0&&this._progressListeners.push(e)}endListenDownload(e){const t=this._progressListeners.indexOf(e);t>=0&&this._progressListeners.splice(t,1)}raiseProgressEvent(e){for(const t of this._progressListeners)t(this,e)}async onInstantiate(e,t=!1,s){const n=k.Current;if(e||(e=n.scene),this.mustLoad&&await this.loadAssetAsync(),ns&&console.log("Instantiate",this.uri,"parent:",e),this.asset){ns&&console.log("Add to scene",this.asset);let o=e instanceof Ae?e:null;if(o||(o=new Ae),typeof e=="object"&&(e instanceof x?o.parent=e:Object.assign(o,e)),t){o.context=n;const a=this.asset;a.guid=this.uri;const l=za(a,o,void 0,s);if(l)return l}else{const a=p.instantiate(this.asset,o);if(a)return a}}else ns&&console.warn("Failed to load asset",this.uri);return null}tryGetActualGameObjectRoot(e){if(e&&e.scene){const t=e.scene;return t.isGroup&&t.children.length===1&&t.children[0].name+"glb"===t.name?t.children[0]:t}return null}}Rl(Te,"AssetReference");class zu extends Yi{constructor(){super([Te])}onSerialize(e,t){if(e&&e.uri!==void 0&&typeof e.uri=="string")return e.uri}onDeserialize(e,t){return typeof e=="string"?t.context?Te.getOrCreate(e,t.context):(console.error("Missing context"),null):null}}Rl(zu,"AddressableSerializer");new zu;var hv=Object.defineProperty,dv=(i,e)=>hv(i,"name",{value:e,configurable:!0});class di{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}w(){return this.bb.readFloat32(this.bb_pos+12)}static sizeOf(){return 16}static createVec4(e,t,s,n,o){return e.prep(4,16),e.writeFloat32(o),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}dv(di,"Vec4");var uv=Object.defineProperty,fv=(i,e)=>uv(i,"name",{value:e,configurable:!0});class Y{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsVrUserStateBuffer(e,t){return(t||new Y).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsVrUserStateBuffer(e,t){return e.setPosition(e.position()+Ca),(t||new Y).__init(e.readInt32(e.position())+e.position(),e)}guid(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}time(){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt64(this.bb_pos+e):this.bb.createLong(0,0)}avatarId(e){const t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}position(e){const t=this.bb.__offset(this.bb_pos,10);return t?(e||new pe).__init(this.bb_pos+t,this.bb):null}rotation(e){const t=this.bb.__offset(this.bb_pos,12);return t?(e||new di).__init(this.bb_pos+t,this.bb):null}scale(){const e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readFloat32(this.bb_pos+e):0}posLeftHand(e){const t=this.bb.__offset(this.bb_pos,16);return t?(e||new pe).__init(this.bb_pos+t,this.bb):null}posRightHand(e){const t=this.bb.__offset(this.bb_pos,18);return t?(e||new pe).__init(this.bb_pos+t,this.bb):null}rotLeftHand(e){const t=this.bb.__offset(this.bb_pos,20);return t?(e||new di).__init(this.bb_pos+t,this.bb):null}rotRightHand(e){const t=this.bb.__offset(this.bb_pos,22);return t?(e||new di).__init(this.bb_pos+t,this.bb):null}static startVrUserStateBuffer(e){e.startObject(10)}static addGuid(e,t){e.addFieldOffset(0,t,0)}static addTime(e,t){e.addFieldInt64(1,t,e.createLong(0,0))}static addAvatarId(e,t){e.addFieldOffset(2,t,0)}static addPosition(e,t){e.addFieldStruct(3,t,0)}static addRotation(e,t){e.addFieldStruct(4,t,0)}static addScale(e,t){e.addFieldFloat32(5,t,0)}static addPosLeftHand(e,t){e.addFieldStruct(6,t,0)}static addPosRightHand(e,t){e.addFieldStruct(7,t,0)}static addRotLeftHand(e,t){e.addFieldStruct(8,t,0)}static addRotRightHand(e,t){e.addFieldStruct(9,t,0)}static endVrUserStateBuffer(e){return e.endObject()}static finishVrUserStateBufferBuffer(e,t){e.finish(t)}static finishSizePrefixedVrUserStateBufferBuffer(e,t){e.finish(t,void 0,!0)}}fv(Y,"VrUserStateBuffer");var pv=Object.defineProperty,io=(i,e)=>pv(i,"name",{value:e,configurable:!0});const Gu=O("debugxr"),hn=O("debugavatar");O("debugavatarvoip");var ui;(function(i){i.WebXR_UserJoined="webxr-user-joined",i.WebXR_UserLeft="webxr-user-left",i.VRSessionStart="vr-session-started",i.VRSessionEnd="vr-session-ended",i.VRSessionUpdate="vr-session-update"})(ui||(ui={}));var so;(function(i){i.VR="vr",i.AR="ar"})(so||(so={}));const El="VRUS";Or(El,Y.getRootAsVrUserStateBuffer);function no(){return new Date().getTime()}io(no,"getTimeStampNow");function Vu(i){let e=i&4294967295,t=i/Math.pow(2,32)&1048575;return Gg.create(e,t)}io(Vu,"flatbuffers_long_from_number");const er=class{constructor(e){r(this,"guid");r(this,"time");r(this,"avatarId");r(this,"position",new y);r(this,"rotation",new $);r(this,"scale",1);r(this,"posLeftHand",new y);r(this,"posRightHand",new y);r(this,"rotLeftHand",new P);r(this,"rotRightHand",new P);this.guid=e}update(e,t,s,n,o){var d,u,_,b,w,C;this.time=no(),this.avatarId=o,this.position.set(t.x,t.y,t.z),e&&this.position.applyMatrix4(e.matrixWorld);let a=er.quat0;const l=er.quat1;a.set(s.x,s.y,s.z,s.w),a=a.multiplyQuaternions(a,er.invertRotation),e&&(e.getWorldQuaternion(l),a.multiplyQuaternions(l,a)),this.rotation.set(a.x,a.y,a.z,a.w),this.scale=e.scale.x;const c=(d=n.LeftController)==null?void 0:d.controllerGrip;c&&(c.getWorldPosition(this.posLeftHand),c.getWorldQuaternion(this.rotLeftHand));const h=(u=n.RightController)==null?void 0:u.controllerGrip;if(h&&(h.getWorldPosition(this.posRightHand),h.getWorldQuaternion(this.rotRightHand)),(b=(_=n.LeftController)==null?void 0:_.hand)==null?void 0:b.visible){const S=n.LeftController.wrist;S&&(S.getWorldPosition(this.posLeftHand),S.getWorldQuaternion(this.rotLeftHand))}if((C=(w=n.RightController)==null?void 0:w.hand)==null?void 0:C.visible){const S=n.RightController.wrist;S&&(S.getWorldPosition(this.posRightHand),S.getWorldQuaternion(this.rotRightHand))}}sendAsBuffer(e,t){e.clear();const s=e.createString(this.guid),n=e.createString(this.avatarId);Y.startVrUserStateBuffer(e),Y.addGuid(e,s),Y.addTime(e,Vu(this.time)),Y.addAvatarId(e,n),Y.addPosition(e,pe.createVec3(e,this.position.x,this.position.y,this.position.z)),Y.addRotation(e,di.createVec4(e,this.rotation.x,this.rotation.y,this.rotation.z,this.rotation.w)),Y.addScale(e,this.scale),Y.addPosLeftHand(e,pe.createVec3(e,this.posLeftHand.x,this.posLeftHand.y,this.posLeftHand.z)),Y.addPosRightHand(e,pe.createVec3(e,this.posRightHand.x,this.posRightHand.y,this.posRightHand.z)),Y.addRotLeftHand(e,di.createVec4(e,this.rotLeftHand.x,this.rotLeftHand.y,this.rotLeftHand.z,this.rotLeftHand.w)),Y.addRotRightHand(e,di.createVec4(e,this.rotRightHand.x,this.rotRightHand.y,this.rotRightHand.z,this.rotRightHand.w));const o=Y.endVrUserStateBuffer(e);e.finish(o,El);const a=e.asUint8Array();t.sendBinary(a)}setFromBuffer(e,t){if(!e)return;this.guid=e,this.time=t.time().toFloat64();const s=t.avatarId();s&&(this.avatarId=s);const n=t.position();n&&this.position.set(n.x(),n.y(),n.z());const o=t.rotation();o&&this.rotation.set(o.x(),o.y(),o.z(),o.w());const a=t.posLeftHand();a&&this.posLeftHand.set(a.x(),a.y(),a.z());const l=t.posRightHand();l&&this.posRightHand.set(l.x(),l.y(),l.z());const c=t.rotLeftHand();c&&this.rotLeftHand.set(c.x(),c.y(),c.z(),c.w());const h=t.rotRightHand();h&&this.rotRightHand.set(h.x(),h.y(),h.z(),h.w()),this.scale=t.scale()}};let et=er;r(et,"invertRotation",new P().setFromAxisAngle(new y(0,1,0),Math.PI)),r(et,"quat0",new P),r(et,"quat1",new P);io(et,"VRUserState");class dn extends v{constructor(){super(...arguments);r(this,"webXR",null);r(this,"debugAvatarUser",null);r(this,"voip",null);r(this,"tempState",new et(""));r(this,"_removeAvatarsList",[]);r(this,"eventSub_ConnectionEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"eventSub_WebXRUpdateEvent",null);r(this,"avatars",{});r(this,"localAvatar",null);r(this,"k_LocalAvatarNoNetworkingGuid","local");r(this,"ownership",null);r(this,"xrState",null);r(this,"builder",new nr(1024))}async awake(){if(this.webXR||(this.webXR=this.gameObject.getComponent(D)),this.webXR||(this.webXR=p.findObjectOfType(D,this.context)),!this.webXR&&(console.log("Missing webxr component"),this.webXR=p.findObjectOfType(D,this.context),!this.webXR)){console.error("Could not find webxr component");return}if(this.voip||(this.voip=p.findObjectOfType(vt,this.context)),hn){const e="debug-avatar-"+hn,t=new wt(this.context,e,this.webXR);if(this.debugAvatarUser=t,typeof hn=="string"&&hn.length>0)if(await t.setAvatarOverride(hn)){const s=new et(e);s.position.y+=1;const n=.5;s.posLeftHand.y+=n,s.posLeftHand.x+=n,s.posRightHand.y+=n,s.posRightHand.x-=n,t.tryUpdate(s,0)}else t.destroy()}}onEnable(){if(!this.webXR&&(this.webXR=p.getComponent(this.gameObject,D),!this.webXR)){console.warn("Missing webxr component on "+this.gameObject.name);return}this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),D.addEventListener(V.XRStarted,this.eventSub_WebXRStartEvent),this.eventSub_WebXRUpdateEvent=this.onXRSessionUpdate.bind(this),D.addEventListener(V.XRUpdate,this.eventSub_WebXRUpdateEvent),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),D.addEventListener(V.XRStopped,this.eventSub_WebXREndEvent),this.eventSub_ConnectionEvent=this.onConnected.bind(this),this.context.connection.beginListen(G.JoinedRoom,this.eventSub_ConnectionEvent),this.context.connection.beginListen(ui.WebXR_UserJoined,e=>{console.log("webxr user joined evt")}),this.context.connection.beginListen(ui.WebXR_UserLeft,e=>{const t=e.id!==null&&e.id!==void 0;if(!!t&&(console.log("webxr user left evt"),t)){const s=this.avatars[e.id];s==null||s.destroy(),this.avatars[e.id]=void 0}}),this.context.connection.beginListenBinrary(El,e=>{const t=e.guid();if(!t)return;const s=e.time().toFloat64(),n=this.tempState;n.setFromBuffer(t,e);const o=this.onTryGetAvatar(t,s);o==null||o.tryUpdate(n,s)}),this.context.connection.beginListen(ui.VRSessionUpdate,e=>{const t=e.guid,s=e.time,n=this.onTryGetAvatar(t,s);n==null||n.tryUpdate(e,s)})}onTryGetAvatar(e,t){if(e===this.context.connection.connectionId)return null;const s=new Date().getTime()-t;if(s>5e3)return Gu&&console.log("old data",s,e),null;let n=this.avatars[e];if(n===void 0)try{console.log("create new avatar");const o=new wt(this.context,e,this.webXR);n=o,this.avatars[e]=o}catch(o){this.avatars[e]=null,console.error(o)}return n}onDisable(){this.eventSub_ConnectionEvent&&this.context.connection.stopListening(G.JoinedRoom,this.eventSub_ConnectionEvent),D.removeEventListener(V.XRStarted,this.eventSub_WebXRStartEvent),D.removeEventListener(V.XRUpdate,this.eventSub_WebXRUpdateEvent),D.removeEventListener(V.XRStopped,this.eventSub_WebXREndEvent)}update(){const e=no();this.debugAvatarUser&&(this.debugAvatarUser.lastUpdate=e),this.detectPotentiallyDisconnectedAvatarsAndRemove();for(const t in this.avatars){const s=this.avatars[t];!s||s.update()}}detectPotentiallyDisconnectedAvatarsAndRemove(){const e=no();for(const t in this.avatars){const s=this.avatars[t];if(!s){this._removeAvatarsList.push(t);continue}e-s.lastUpdate>1e4&&(console.log("avatar timed out (didnt receive any updates in  a while) - destroying it now"),s.destroy(),this.avatars[t]=void 0)}for(const t of this._removeAvatarsList)delete this.avatars[t];this._removeAvatarsList.length=0}buildLocalAvatar(){var t,s;if(this.localAvatar)return;const e=(s=(t=this.context.connection)==null?void 0:t.connectionId)!=null?s:this.k_LocalAvatarNoNetworkingGuid;this.localAvatar=new wt(this.context,e,this.webXR),this.localAvatar.isLocalAvatar=!0,this.localAvatar.setAvatarOverride(this.getAvatarId()),this.avatars[this.localAvatar.guid]=this.localAvatar}onConnected(){var e,t,s;Gu&&console.log("Hey you are connected as "+this.context.connection.connectionId),((e=this.localAvatar)==null?void 0:e.guid)===this.k_LocalAvatarNoNetworkingGuid&&(this.localAvatar&&((t=this.localAvatar)==null||t.destroy(),this.avatars[this.localAvatar.guid]=void 0),this.localAvatar=null,this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null)}onXRSessionStart(e){var t,s,n;if(console.log("XR session started"),this.context.connection.send(ui.WebXR_UserJoined,{id:this.context.connection.connectionId,mode:so.VR}),this.localAvatar&&((t=this.localAvatar)==null||t.destroy(),this.avatars[this.localAvatar.guid]=void 0,this.localAvatar=null),this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null,this.avatars)for(const o in this.avatars)(n=this.avatars[o])==null||n.updateFlags()}onXRSessionEnded(e){console.log("XR session ended"),this.context.connection.send(ui.WebXR_UserLeft,{id:this.context.connection.connectionId,mode:so.VR})}onXRSessionUpdate(e){var h,d,u,_,b;(d=this.xrState)!=null||(this.xrState=new et((h=this.context.connection.connectionId)!=null?h:this.k_LocalAvatarNoNetworkingGuid)),(_=this.ownership)!=null||(this.ownership=new Rr(this.context.connection,(u=this.context.connection.connectionId)!=null?u:this.k_LocalAvatarNoNetworkingGuid)),this.ownership.guid=(b=this.context.connection.connectionId)!=null?b:this.k_LocalAvatarNoNetworkingGuid,this.buildLocalAvatar();const{frame:t,xr:s,rig:n}=e,o=t.getViewerPose(s.getReferenceSpace());if(!o)return;const a=o==null?void 0:o.transform,l=a.position,c=a.orientation;this.xrState.update(n,l,c,this.webXR,this.getAvatarId()),this.localAvatar&&(this.context.connection.connectionId&&(this.localAvatar.guid=this.context.connection.connectionId),this.localAvatar.tryUpdate(this.xrState,0)),!(this.ownership&&!this.ownership.hasOwnership&&this.context.connection.isConnected&&(this.context.time.frameCount%120==0&&this.ownership.requestOwnership(),!this.ownership.hasOwnership))&&(!this.context.connection.isConnected||!this.context.connection.connectionId||this.xrState.sendAsBuffer(this.builder,this.context.connection))}getAvatarId(){return O("avatar")}}io(dn,"WebXRSync");var qu=Object.defineProperty,mv=Object.getOwnPropertyDescriptor,Qu=(i,e)=>qu(i,"name",{value:e,configurable:!0}),gv=(i,e,t,s)=>{for(var n=s>1?void 0:s?mv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&qu(e,t,n),n},V;(function(i){i.XRStarted="xrStarted",i.XRStopped="xrStopped",i.XRUpdate="xrUpdate",i.RequestVRSession="requestVRSession"})(V||(V={}));var da;const J=(da=class extends v{constructor(){super(...arguments);r(this,"enableVR",!0);r(this,"enableAR",!0);r(this,"defaultAvatar");r(this,"createVRButton",!0);r(this,"createARButton",!0);r(this,"controllers",[]);r(this,"rig");r(this,"isInit",!1);r(this,"_requestedAR",!1);r(this,"_requestedVR",!1);r(this,"_isInAR",!1);r(this,"_isInVR",!1);r(this,"_arButton");r(this,"_vrButton");r(this,"webAR",null);r(this,"_transformOrientation",new P);r(this,"_currentHeadPose",null);r(this,"_originalCameraParent",null);r(this,"_originalCameraPosition",new y);r(this,"_originalCameraRotation",new P);r(this,"xrMirrorWindow",null)}static get XRSupported(){return"xr"in navigator}static get IsInWebXR(){return this._isInXr}static addEventListener(i,e){this.events.addEventListener(i,e)}static removeEventListener(i,e){this.events.removeEventListener(i,e)}static createVRButton(i,e){var s;J.XRSupported||console.warn("WebXR is not supported on this device");const t=Vr.createButton(i.context.renderer);return t.classList.add("webxr-ar-button"),t.classList.add("webxr-button"),this.resetButtonStyles(t),((s=e==null?void 0:e.registerClick)!=null?s:!0)&&t.addEventListener("click",i.onClickedVRButton.bind(i)),t}static createARButton(i,e){var o,a;const t=(o=i.webAR)==null?void 0:o.trySetupOverlay(),s={requiredFeatures:["hit-test"]};t&&(s.domOverlay={root:t},s.optionalFeatures=["dom-overlay"]);const n=Jy.createButton(i.context.renderer,s);return n.classList.add("webxr-ar-button"),n.classList.add("webxr-button"),J.resetButtonStyles(n),((a=e==null?void 0:e.registerClick)!=null?a:!0)&&n.addEventListener("click",i.onClickedARButton.bind(i)),n}static resetButtonStyles(i){!i||(i.style.position="",i.style.bottom="",i.style.left="")}endSession(){const i=this.context.renderer.xr.getSession();i&&i.end()}get Rig(){return this.rig}get Controllers(){return this.controllers}get LeftController(){var i,e;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="left"?this.controllers[0]:this.controllers.length>1&&((e=this.controllers[1].input)==null?void 0:e.handedness)==="left"?this.controllers[1]:null}get RightController(){var i,e;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="right"?this.controllers[0]:this.controllers.length>1&&((e=this.controllers[1].input)==null?void 0:e.handedness)==="right"?this.controllers[1]:null}awake(){if(this.defaultAvatar&&typeof this.defaultAvatar=="string"&&(this.defaultAvatar=Te.getOrCreate(this.defaultAvatar,this.context)),!p.findObjectOfType(dn,this.context)){const i=p.addNewComponent(this.gameObject,dn,!1);i.webXR=this}}onEnable(){if(this.isInit||!this.enableAR&&!this.enableVR)return;this.isInit=!0,this.context.renderer.xr.enabled=!0,this.webAR=new rs(this);const i=J.XRSupported;let e,t;const s=document.createElement("div");s.classList.add("webxr-buttons"),this.context.domElement.append(s),this.enableAR&&this.createARButton&&(e=J.createARButton(this),this._arButton=e,s.appendChild(e)),this.createVRButton&&this.enableVR&&(i||!this.enableAR)&&(t=J.createVRButton(this),this._vrButton=t,s.appendChild(t)),setTimeout(()=>{J.resetButtonStyles(t),J.resetButtonStyles(e)},1e3)}get TransformOrientation(){return this._transformOrientation}get HeadPose(){return this._currentHeadPose}onBeforeRender(i){var t;if(!i)return;const e=this.context.renderer.xr.getSession();if(e){const s=i.getViewerPose(this.context.renderer.xr.getReferenceSpace());if(this._currentHeadPose=s,!s)return;const n=s==null?void 0:s.transform;n&&this._transformOrientation.set(n.orientation.x,n.orientation.y,n.orientation.z,n.orientation.w);for(const o of this.controllers)o.onUpdate(e);this._isInAR&&((t=this.webAR)==null||t.onUpdate(e,i))}J._isInXr===!1&&e&&this.onEnterXR(e,i),J.events.dispatchEvent({type:V.XRUpdate,frame:i,xr:this.context.renderer.xr,rig:this.rig})}onClickedARButton(){this._isInAR||(this._requestedAR=!0,this._requestedVR=!1,this.captureCameraState())}onClickedVRButton(){if(!this._isInVR){if(this._requestedVR){this.onExitXR(null);return}this._requestedAR=!1,this._requestedVR=!0,this.captureCameraState(),this.ensureRig();for(let i=0;i<2;i++)U.Create(this,i,this.gameObject,Zr.PhysicalDevice);J.events.dispatchEvent({type:V.RequestVRSession})}}captureCameraState(){this.context.mainCamera&&(this._originalCameraPosition.copy(R(this.context.mainCamera)),this._originalCameraRotation.copy(re(this.context.mainCamera)),this._originalCameraParent=this.context.mainCamera.parent)}ensureRig(){if(!this.rig){const i=p.findObjectOfType(to,this.context);i?(this.rig=i.gameObject,this.rig.rotateY(Math.PI)):(this.rig=new Qg,this.rig.name="XRRig",this.context.scene.add(this.rig))}}onEnterXR(i,e){var o;console.log("[XR] session begin",i),J._isInXr=!0,this.ensureRig();const t=this.context.renderer.xr.getReferenceSpace();if(t&&this.rig){const a=e.getViewerPose(t),l=a==null?void 0:a.transform.orientation;if(l){const c=new P(l.x,l.y,l.z,l.w),h=new he().setFromQuaternion(c);this.rig.rotateY(h.y)}}const s=this.context.renderer.xr;if(this.context.mainCamera){const a=s.getCamera(this.context.mainCamera);for(const l of a.cameras)l.layers.enableAll();this.rig.add(this.context.mainCamera)}const n=this._requestedAR?ee.AR:ee.VR;switch(Ke.Global.Set(n),n){case ee.AR:this._isInAR=!0,(o=this.webAR)==null||o.onBegin(i);break;case ee.VR:this._isInVR=!0,this.onEnterVR(i);break}i.addEventListener("end",()=>{console.log("[XR] session end"),J._isInXr=!1,this.onExitXR(i)}),this.onEnterXR_HandleMirrorWindow(i),J.events.dispatchEvent({type:V.XRStarted,session:i})}onExitXR(i){var e,t;this._isInAR&&i&&((e=this.webAR)==null||e.onEnd(i)),this._isInAR=!1,this._isInVR=!1,this._requestedAR=!1,this._requestedVR=!1,this.xrMirrorWindow&&(this.xrMirrorWindow.close(),this.xrMirrorWindow=null),this.destroyControllers(),this.context.mainCamera&&((t=this._originalCameraParent)==null||t.add(this.context.mainCamera),F(this.context.mainCamera,this._originalCameraPosition),oe(this.context.mainCamera,this._originalCameraRotation),this.context.mainCamera.scale.set(1,1,1)),Ke.Global.Set(ee.Browser|ee.ThirdPerson),J.events.dispatchEvent({type:V.XRStopped,session:i})}onEnterVR(i){}destroyControllers(){var i;for(let e=this.controllers.length-1;e>=0;e-=1)(i=this.controllers[e])==null||i.destroy();this.controllers.length=0}onEnterXR_HandleMirrorWindow(i){!O("mirror")||setTimeout(()=>{if(!J.IsInWebXR)return;const e=new URL(window.location.href);Vs(e.searchParams,Qr,1),Vs(e.searchParams,"isMirror",1);const t=e.toString();this.xrMirrorWindow=window.open(t,"webxr sync","popup=yes"),this.xrMirrorWindow&&(this.xrMirrorWindow.onload=()=>{this.xrMirrorWindow&&(this.xrMirrorWindow.onbeforeunload=()=>{J.IsInWebXR&&i.end()})})},1e3)}},r(da,"_isInXr",!1),r(da,"events",new qg),da);let D=J;Qu(D,"WebXR");gv([f(Te)],D.prototype,"defaultAvatar",2);const Ms=class{constructor(e){r(this,"webxr");r(this,"reticle",null);r(this,"hitTestSource",null);r(this,"reticleActive",!0);r(this,"previousBackground",null);r(this,"previousEnvironment",null);r(this,"sessionRoot",null);r(this,"_previousParent",null);r(this,"arDomOverlay",null);r(this,"arOverlayElement",null);this.webxr=e}get context(){return this.webxr.context}trySetupOverlay(){return this.arDomOverlay=this.webxr.context.domElement,"getAROverlayContainer"in this.arDomOverlay&&(this.arOverlayElement=this.arDomOverlay.getAROverlayContainer()),this.arOverlayElement}setReticleActive(e){this.reticleActive=e}onBegin(e){var s,n;const t=this.webxr.context;this.reticleActive=!0;for(let o=0;o<4;o++)U.Create(this.webxr,o,this.webxr.gameObject,Zr.Touch);(!this.sessionRoot||this.sessionRoot.destroyed||!this.sessionRoot.activeAndEnabled)&&(this.sessionRoot=p.findObjectOfType(cn,t)),this.previousBackground=t.scene.background,this.previousEnvironment=t.scene.environment,t.scene.background=null,e.requestReferenceSpace("viewer").then(o=>{e.requestHitTestSource({space:o}).then(a=>{this.hitTestSource=a})}),!this.reticle&&this.sessionRoot&&(this.reticle=new ii(new Vg(.07,.09,32).rotateX(-Math.PI/2),new $s),this.reticle.name="AR Placement reticle",this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.webxr.scene?(this.webxr.scene.add(this.reticle),this.webxr.scene.visible=!0):console.warn("Could not found WebXR Rig")),this._previousParent=this.webxr.gameObject,Ms.tempWebXRObject||(Ms.tempWebXRObject=new x),this.context.scene.add(Ms.tempWebXRObject),p.addComponent(Ms.tempWebXRObject,this.webxr),this.sessionRoot?(this.sessionRoot.webAR=this,(s=this.sessionRoot)==null||s.onBegin(e)):console.warn("No WebARSessionRoot found in scene"),this.arDomOverlay&&this.arOverlayElement&&this.arDomOverlay.onEnterAR(e,this.arOverlayElement),(n=this.context.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}onEnd(e){var s;this._previousParent&&(console.log("ADD",this._previousParent),p.addComponent(this._previousParent,this.webxr),this._previousParent=null),this.hitTestSource=null;const t=this.webxr.context;t.scene.background=this.previousBackground,t.scene.environment=this.previousEnvironment,this.sessionRoot&&this.sessionRoot.onEnd(this.webxr.Rig,e),this.arDomOverlay&&this.arDomOverlay.onExitAR(e),(s=this.context.mainCameraComponent)==null||s.applyClearFlagsIfIsActiveCamera()}onUpdate(e,t){var n,o;if(!this.hitTestSource)return;const s=t.getHitTestResults(this.hitTestSource);if(s.length){const a=s[0],l=this.webxr.context.renderer.xr.getReferenceSpace();if(l){const c=a.getPose(l);if((n=this.sessionRoot)==null||n.onUpdate(this.webxr.Rig,e,c),this.reticle&&(this.reticle.visible=this.reticleActive,this.reticleActive&&c)){const h=c.transform.matrix;this.reticle.matrix.fromArray(h),this.webxr.Rig&&this.reticle.matrix.premultiply(this.webxr.Rig.matrix)}}}else(o=this.sessionRoot)==null||o.onUpdate(this.webxr.Rig,e,null),this.reticle&&(this.reticle.visible=!1)}};let rs=Ms;r(rs,"tempWebXRObject");Qu(rs,"WebAR");var _v=Object.defineProperty,Xu=(i,e)=>_v(i,"name",{value:e,configurable:!0}),un;(function(i){i.SelectStart="selectstart",i.SelectEnd="selectend"})(un||(un={}));const js=class extends ts{constructor(){super();r(this,"transformSelf",!0);r(this,"selectStartEventListener",[]);r(this,"selectEndEventListener",[]);r(this,"_dragHelper",null);r(this,"_draggingRigidbodies",[]);r(this,"_waitingForDragStart",null);r(this,"_isDragging",!1);r(this,"_marker",null);r(this,"_dragDelta");r(this,"_didDrag",!1);this.selectStartEventListener=[],this.selectEndEventListener=[],this._dragDelta=new Q}static get HasAnySelected(){return this._active!==null}addEventListener(e,t){switch(e){case un.SelectStart:this.selectStartEventListener.push(t);break;case un.SelectEnd:this.selectEndEventListener.push(t);break}}start(){}allowEdit(e=null){return this.context.connection.allowEditing}onPointerEnter(e){if(!this.allowEdit(this.gameObject)||D.IsInWebXR)return;const t=p.getComponentInParent(e.object,js);!t||t!==this||(js.lastHovered=e.object,this.context.domElement.style.cursor="pointer")}onPointerExit(e){!this.allowEdit(this.gameObject)||D.IsInWebXR||js.lastHovered===e.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(e){!this.allowEdit(this.gameObject)||D.IsInWebXR||(this._dragDelta.set(0,0),this._didDrag=!1,this._waitingForDragStart=e,e.StopPropagation())}onPointerUp(e){this._waitingForDragStart=null,!!this.allowEdit(this.gameObject)&&(D.IsInWebXR||(this.onDragEnd(e),e.StopPropagation()))}update(){var e;if(!D.IsInWebXR){if(this._waitingForDragStart){if(!this._didDrag){const s=this.context.input.getPointerPositionDelta(0);if(s&&this._dragDelta.add(s),this._dragDelta.length()>2)this._didDrag=!0;else return}const t=this._waitingForDragStart;this._waitingForDragStart=null,this.onDragStart(t)}this._dragHelper&&this._dragHelper.hasSelected&&this.onUpdateDrag(),this._isDragging&&!((e=this._dragHelper)==null?void 0:e.hasSelected)&&this.onDragEnd(null)}}onDragStart(e){if(!this._dragHelper)if(this.context.mainCamera)this._dragHelper=new ro(this.context.mainCamera);else return;if(!e||!e.object)return;const t=p.getComponentInParent(e.object,js);if(!t||t!==this)return;let s=e.object;this.transformSelf&&(s=this.gameObject);const n={selected:s,attached:s};for(const c of this.selectStartEventListener)c(this,n);if(!n.attached)return;n.attached!==s,s=n.attached,this._isDragging=!0,this._dragHelper.setSelected(s,this.context);const o=p.getComponentInChildren(s,yt);o&&(o.fastMode=!0,o==null||o.requestOwnership()),this._marker=p.addNewComponent(s,is),this._draggingRigidbodies.length=0;const a=p.getComponentsInChildren(s,Ne);a&&this._draggingRigidbodies.push(...a);const l=Aa();p.invokeOnChildren(this._dragHelper.selected,l("onDragStart"))}onUpdateDrag(){if(!!this._dragHelper){this._dragHelper.onUpdate(this.context);for(const e of this._draggingRigidbodies)e.wakeUp(),e.setBodyFromGameObject()}}onDragEnd(e){if(!this||!this._isDragging||(this._isDragging=!1,!this._dragHelper))return;this._draggingRigidbodies.length=0;const t=this._dragHelper.selected;if(this._dragHelper.setSelected(null,this.context),e==null?void 0:e.object){const n=p.getComponentInChildren(e.object,yt);n&&(n.fastMode=!1),this._marker&&this._marker.destroy()}for(const n of this.selectEndEventListener)n(this);const s=Aa();p.invokeOnChildren(t,s("onDragEnd"))}};let Pt=js;r(Pt,"_active",null),r(Pt,"lastHovered");Xu(Pt,"DragControls");const hh=class{constructor(e){r(this,"_selected",null);r(this,"_context",null);r(this,"_camera");r(this,"_cameraPlane",new Lh);r(this,"_hasGroundPlane",!1);r(this,"_groundPlane",new Lh);r(this,"_groundOffset",new y);r(this,"_groundOffsetFactor",0);r(this,"_groundDistance",0);r(this,"_groundPlanePoint",new y);r(this,"_raycaster",new ya);r(this,"_cameraPlaneOffset",new y);r(this,"_intersection",new y);r(this,"_worldPosition",new y);r(this,"_inverseMatrix",new Be);r(this,"_rbs",[]);r(this,"_groundLine");r(this,"_groundMarker");r(this,"_groundOffsetVector",new y(0,1,0));r(this,"_requireUpdateGroundPlane",!0);r(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=e;const t=new Eh(hh.geometry),s=t.material;s.color=new g(.4,.4,.4),t.layers.set(2),t.name="line",t.scale.y=1,this._groundLine=t;const n=new Ah(.5,22,22),o=new $s({color:s.color}),a=new ii(n,o);a.visible=!1,a.layers.set(2),this._groundMarker=a}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(e,t){if(this._selected&&t)for(const s of this._rbs)s.wakeUp(),!!s.smoothedVelocity&&s.setVelocity(s.smoothedVelocity.x,s.smoothedVelocity.y,s.smoothedVelocity.z);if(this._selected&&le.Remove(t,this._selected),this._selected=e,this._context=t,this._rbs.length=0,e?(t.scene.add(this._groundLine),t.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!t){console.error("DragHelper: no context");return}le.Add(t,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this._rbs=p.getComponentsInChildren(this._selected,Ne),this.onUpdateScreenSpacePlane()}}onUpdate(e){var l,c,h,d,u;if(!this._context)return;const t=pt.SPACE,s=pt.KEY_D;pt.KEY_S;const n=((l=this._context)==null?void 0:l.input.isKeyPressed(t))||((c=this._context)==null?void 0:c.input.isKeyPressed(s)),o=this._context.input.getTouchesPressedCount()>=2||n;if(o){const _=this._context.input.getPointerPositionDelta(0);_&&(this._groundOffsetVector.set(0,1,0),(h=this._selected)==null||h.rotateOnWorldAxis(this._groundOffsetVector,_.x*this._context.time.deltaTime))}const a=this._context.input.getPointerPositionRC(0);if(!!a&&(this._raycaster.setFromCamera(a,this._camera),this._selected)){this._groundOffsetVector.set(0,1,0);const _=R(this._camera).clone().sub(R(this._selected)).normalize(),b=Math.abs(_.dot(this._groundOffsetVector)),w=((d=this._context)==null?void 0:d.input.isKeyPressed(t))||((u=this._context)==null?void 0:u.input.isKeyPressed(s)),C=!o&&b>.2&&!w&&this._context.input.getPointerPressedCount()<=1,S=this._didDragOnGroundPlaneLastFrame!==C;if(this._didDragOnGroundPlaneLastFrame=C,this._hasGroundPlane||(this._requireUpdateGroundPlane=!0),(this._requireUpdateGroundPlane||!C||S)&&this.onUpdateGroundPlane(),this._requireUpdateGroundPlane=!1,this._hasGroundPlane)if(this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection)){const A=this._intersection.y;if(this._groundPlanePoint.copy(this._intersection).sub(this._groundOffset),this._groundPlanePoint.y=A,C){this._groundOffsetVector.set(0,1,0);const M=this._intersection.sub(this._groundOffset).add(this._groundOffsetVector.multiplyScalar(this._groundOffsetFactor));this.onUpdateWorldPosition(M,this._groundPlanePoint,!1),this.onDidUpdate();return}}else this._groundPlanePoint.set(0,99999,0);S&&this.onUpdateScreenSpacePlane(),this._requireUpdateGroundPlane=!0,this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&(this.onUpdateWorldPosition(this._intersection.sub(this._cameraPlaneOffset),this._groundPlanePoint,!0),this.onDidUpdate())}}onUpdateWorldPosition(e,t,s){if(!!this._selected){if(s){const n=R(this._selected);n.y=e.y,e=n}if(F(this._selected,e),F(this._groundLine,e),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundMarker.visible=t!==null,t){const n=R(this._camera).distanceTo(t)*.01;this._groundMarker.scale.set(n,n,n),F(this._groundMarker,t)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const e=this._context.input.getPointerPositionRC(0);!e||(this._raycaster.setFromCamera(e,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const e=R(this._selected),t=new Th(new y(0,.1,0).add(e),new y(0,-1,0)),s=new Xe;s.ignore=[this._selected];const n=this._context.physics.raycastFromRay(t,s);for(let o=0;o<n.length;o++){const a=n[o];if(!a.face||this.contains(this._selected,a.object))continue;const l=new y(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,a.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(t.direction.multiplyScalar(-1),t.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(e),this._groundOffset.copy(this._intersection).sub(e)}onDidUpdate(){ue.markDirty(this._selected);for(const e of this._rbs)e.wakeUp(),e.setBodyFromGameObject({x:0,y:0,z:0}),e.setAngularVelocity(0,0,0)}contains(e,t){if(e===t)return!0;if(e.children){for(const s of e.children)if(this.contains(s,t))return!0}return!1}};let ro=hh;r(ro,"geometry",new rr().setFromPoints([new y(0,0,0),new y(0,-1,0)]));Xu(ro,"DragHelper");var Yu=Object.defineProperty,bv=Object.getOwnPropertyDescriptor,Ju=(i,e)=>Yu(i,"name",{value:e,configurable:!0}),Zu=(i,e,t,s)=>{for(var n=s>1?void 0:s?bv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Yu(e,t,n),n},Al;(function(i){i.ObjectAdded="object-added"})(Al||(Al={}));class Ku extends v{constructor(){super(...arguments);r(this,"_listeners",{})}addEventListener(e,t,s){!t||(this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(t))}dispatchEvent(e){if(!e||!this._listeners[e.type])return!1;for(const t of this._listeners[e.type])"handleEvent"in t?t.handleEvent(e):t(e);return!0}removeEventListener(e,t,s){!t||!this._listeners[e]||(this._listeners[e]=this._listeners[e].filter(n=>n!==t))}}Ju(Ku,"EventTargetBehaviour");class fn extends Ku{constructor(){super(...arguments);r(this,"filesBackendUrl");r(this,"localhost");r(this,"_dragOver");r(this,"_drop")}onEnable(){this.filesBackendUrl=this.filesBackendUrl?It.GetUrl(this.filesBackendUrl,this.localhost):void 0,this._dragOver=this.onDrag.bind(this),this._drop=this.onDrop.bind(this),this.context.domElement.addEventListener("dragover",this._dragOver),this.context.domElement.addEventListener("drop",this._drop)}onDisable(){this.context.domElement.removeEventListener("dragover",this._dragOver),this.context.domElement.removeEventListener("drop",this._drop)}onDrag(e){e.preventDefault()}async onDrop(e){if(console.log(e),!e.dataTransfer)return;e.preventDefault();const t=e.dataTransfer.items;if(!!t)for(const s in t){const n=t[s];if(n.kind==="file"){const o=n.getAsFile();if(!o)continue;console.log("Register file "+o.name+" to",this.filesBackendUrl);const a=await Pm(o,this.context,this.filesBackendUrl);a&&this.addObject(e,a)}else n.kind==="string"&&n.type=="text/plain"&&n.getAsString(async o=>{console.log("dropped url",o);try{const a=new URL(o);if(!a)return;const l=await xm(a,this.context);l&&this.addObject(e,l)}catch{console.log("dropped string is not a valid URL!",o)}})}}async addObject(e,t){const s=new Xe;s.setMask(16777215),s.screenPointFromOffset(e.offsetX,e.offsetY);const n=this.context.physics.raycast(s);if(n&&n.length>0)for(const o of n){t.position.copy(o.point);break}this.gameObject.add(t),this.dispatchEvent(new CustomEvent(Al.ObjectAdded,{detail:t}))}}Ju(fn,"DropListener");Zu([f()],fn.prototype,"filesBackendUrl",2);Zu([f()],fn.prototype,"localhost",2);var ef=Object.defineProperty,yv=Object.getOwnPropertyDescriptor,vv=(i,e)=>ef(i,"name",{value:e,configurable:!0}),oo=(i,e,t,s)=>{for(var n=s>1?void 0:s?yv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&ef(e,t,n),n};class fi extends ts{constructor(){super(...arguments);r(this,"parent",null);r(this,"object",null);r(this,"limitCount",10);r(this,"limitInterval",60);r(this,"_currentCount",0);r(this,"_startPosition",null);r(this,"_startQuaternion",null)}awake(){var t,s,n,o;if(this.object){if(this.object===this.gameObject){console.error("Can not duplicate self");return}this.object.visible=!1,this._startPosition=(s=(t=this.object.position)==null?void 0:t.clone())!=null?s:new y(0,0,0),this._startQuaternion=(o=(n=this.object.quaternion)==null?void 0:n.clone())!=null?o:new P(0,0,0,1)}const e=p.getComponentInParent(this.gameObject,Pt);e?e.addEventListener(un.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.attached=null;return}const c=this.handleDuplication(l.selected);c&&(console.assert(c!==l.selected,"Duplicated object is original"),l.attached=c)}):console.warn("Could no find drag controls in parent",this.name),U.addEventListener(we.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.grab=null;return}const c=this.handleDuplication(l.selected);c&&(l.grab=c)}),this.cloneLimitIntervalFn()}cloneLimitIntervalFn(){this.destroyed||(this._currentCount>0&&(this._currentCount-=1),setTimeout(()=>{this.cloneLimitIntervalFn()},this.limitInterval/this.limitCount*1e3))}handleDuplication(e){var t,s;if(this._currentCount>=this.limitCount||!this.object)return null;if(e===this.gameObject||this.handleMultiObject(e)){if(this.object===this.gameObject)return null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const n=new Ae;this.parent||(this.parent=this.gameObject.parent),this.parent&&(n.parent=(s=this.parent.guid)!=null?s:(t=this.parent.userData)==null?void 0:t.guid,n.keepWorldPosition=!0),n.position=this.worldPosition,n.rotation=this.worldQuaternion,n.context=this.context,this._currentCount+=1;const o=p.instantiateSynced(this.object,n);return console.assert(o!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),o}return null}handleMultiObject(e){return this.gameObject.type==="Group"||this.gameObject.type==="Object3D"?this.isInChildren(this.gameObject,e):!1}isInChildren(e,t){if(!e)return!1;if(e===t)return!0;if(e.children){for(let s of e.children)if(this.isInChildren(s,t))return!0}return!1}}vv(fi,"Duplicatable");oo([f(x)],fi.prototype,"parent",2);oo([f(x)],fi.prototype,"object",2);oo([f()],fi.prototype,"limitCount",2);oo([f()],fi.prototype,"limitInterval",2);var wv=Object.defineProperty,tf=(i,e)=>wv(i,"name",{value:e,configurable:!0});class os{constructor(e,t){r(this,"method");r(this,"enabled");this.method=e,this.enabled=t!==void 0?t:!0}invoke(...e){if(this.enabled!==!1){if(!this.method){console.warn("No function. Please check you assigned a method to invoke on export",this);return}this.method(...e)}}}tf(os,"CallInfo");class tt{constructor(e){r(this,"methods",[]);this.methods=e!=null?e:[]}invoke(...e){for(const t of this.methods)t.invoke(...e)}addEventListener(e){return this.methods.push(new os(e,!0)),e}removeEventListener(e){if(!!e)for(let t=this.methods.length-1;t>=0;t--)this.methods[t].method===e&&(this.methods[t].enabled=!1,this.methods.splice(t,1))}removeAllEventListeners(){this.methods.length=0}}tf(tt,"EventList");var Pv=Object.defineProperty,xv=(i,e)=>Pv(i,"name",{value:e,configurable:!0});class Tl extends v{}xv(Tl,"EventTrigger");var Ov=Object.defineProperty,Cv=(i,e)=>Ov(i,"name",{value:e,configurable:!0});class Ll extends v{constructor(){super(...arguments);r(this,"_controls",null)}onEnable(){var t;const e=(t=p.getComponent(this.gameObject,W))==null?void 0:t.cam;this._controls=new Xg(e,this.context.renderer.domElement),this._controls.rollSpeed=.5,this._controls.movementSpeed=3,this._controls.dragToLook=!0}onDisable(){var e;(e=this._controls)==null||e.dispose(),this._controls=null}update(){this._controls&&this._controls.update(this.context.time.deltaTime)}}Cv(Ll,"FlyControls");var sf=Object.defineProperty,Sv=Object.getOwnPropertyDescriptor,Rv=(i,e)=>sf(i,"name",{value:e,configurable:!0}),nf=(i,e,t,s)=>{for(var n=s>1?void 0:s?Sv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&sf(e,t,n),n};class pn extends v{constructor(){super(...arguments);r(this,"objectBounds",!1);r(this,"color");r(this,"_gizmoObject",null);r(this,"_boxHelper",null)}onEnable(){var e,t;!Ks||(this._gizmoObject||(this.objectBounds&&this.gameObject.isMesh===!0?this._gizmoObject=new Dh(this.gameObject,(e=this.color)!=null?e:16776960):(this.objectBounds=!1,this._gizmoObject=wl((t=this.color)!=null?t:16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),Ce.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var e;for(;this._boxHelper;)(e=this._boxHelper)==null||e.update(),yield}}Rv(pn,"BoxGizmo");nf([f()],pn.prototype,"objectBounds",2);nf([f(g)],pn.prototype,"color",2);class Ev{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(e.constructor.name!=="InstancedMesh")return;const s=this.writer,n=s.extensionsUsed,o={};t.extensions=t.extensions||{},t.extensions[this.name]=o;let a=new Be;const l=new Array,c=new Array,h=new Array;for(let b=0;b<e.count;b++){e.getMatrixAt(b,a);let w=new y,C=new P,S=new y;a.decompose(w,C,S),l.push(w.x,w.y,w.z),c.push(C.x,C.y,C.z,C.w),h.push(S.x,S.y,S.z)}const d=new Float32Array(l),u=new Float32Array(c),_=new Float32Array(h);o.attributes={TRANSLATION:s.processAccessor(new Ws(d,3)),ROTATION:s.processAccessor(new Ws(u,4)),SCALE:s.processAccessor(new Ws(_,3))},n[this.name]=!0}}var Av=Object.defineProperty,Dl=(i,e)=>Av(i,"name",{value:e,configurable:!0});const Gt=ye,ao="$___Export_Components",Tv="NEEDLE_components";var XP;class rf{constructor(){r(this,XP)}}XP=Vi;Dl(rf,"ExtensionData");class of{constructor(e,t,s){r(this,"node");r(this,"nodeIndex");r(this,"nodeDef");this.node=e,this.nodeIndex=t,this.nodeDef=s}}Dl(of,"ExportData");class kl{constructor(){r(this,"parser");r(this,"nodeToObjectMap",{});r(this,"exportContext");r(this,"objectToNodeMap",{});r(this,"context");r(this,"writer")}get name(){return Tv}registerExport(e){e.register(t=>{const s=t.serializeUserData.bind(t);return this.writer=t,t.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o),s(n,o)}finally{this.afterSerializeUserData(n,o)}},this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(e,t){var n;const s=(n=e.userData)==null?void 0:n.components;!s||s.length<=0||(delete e.userData.components,e[ao]=s)}afterSerializeUserData(e,t){if(e.type==="Scene"&&Gt&&console.log("DONE",JSON.stringify(t)),e[ao]===void 0)return;const s=e[ao];delete e[ao],s!==null&&(e.userData.components=s)}writeNode(e,t){let s=this.writer.json.nodes.length;console.log(e.name,s,e.uuid);const n=new of(e,s,t);this.exportContext[s]=n,this.objectToNodeMap[e.uuid]=s}afterParse(e){var t;Gt&&console.log("AFTER",e);for(const s in this.exportContext){const n=this.exportContext[s],o=n.node,a=n.nodeDef,l=n.nodeIndex,c=(t=o.userData)==null?void 0:t.components;if(!c||c.length<=0)continue;const h=new rf;a.extensions=a.extensions||{},a.extensions[this.name]=h,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const d=[];for(const u of c){this.context.target=u;const _=Wp(u,this.context);_!==null&&d.push(_)}d.length>0&&(h[Vi]=d,Gt&&console.log("DID WRITE",o,"nodeIndex",l,d))}}beforeRoot(){return Gt&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(e){const t=e.parser,s=t==null?void 0:t.extensions;if(!s)return;const n=s[this.name];Gt&&console.log("After root",e,this.parser,s);const o=[];if(n===!0){const a=t.json.nodes;for(let l=0;l<a.length;l++){const c=await t.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<a.length;l++){const c=a[l],h=l,d=c.extensions;if(!d)continue;const u=d[this.name];if(!u)continue;Gt&&console.log("NODE",c);const _=this.nodeToObjectMap[h];if(!_){console.error("Could not find object for node index: "+h,c,t);continue}o.push(this.createComponents(_,u))}}await Promise.all(o)}async createComponents(e,t){if(!t)return;const s=t[Vi];if(s){Gt&&console.log(e.name,s);for(const n in s){const o=s[n];Gt&&console.log("Serialized data",JSON.parse(JSON.stringify(o))),o&&this.parser&&await Tr(this.parser,o),e.userData=e.userData||{},e.userData[Vi]=e.userData[Vi]||[],e.userData[Vi].push(o)}}}}Dl(kl,"NEEDLE_components");var Lv=Object.defineProperty,af=(i,e)=>Lv(i,"name",{value:e,configurable:!0});class Il extends es{constructor(){super(...arguments);r(this,"sceneRoot")}start(){this.startCoroutine(this.updateGltfBox())}*updateGltfBox(){for(;;)for(let e=0;e<10;e++)yield}}af(Il,"GltfExportBox");class xt extends v{constructor(){super(...arguments);r(this,"binary",!0);r(this,"objects",[]);r(this,"exporter");r(this,"ext")}async exportNow(e){console.log("DO EXPORT",this.objects);const t={binary:this.binary,pivot:xt.calculateCenter(this.objects)},s=await this.export(this.objects,t);this.binary?e.endsWith(".glb")||(e+=".glb"):e.endsWith(".gltf")||(e+=".gltf"),this.binary?xt.saveArrayBuffer(s,e):xt.saveJson(s,e)}async export(e,t){var l;if(e===null||e.length<=0){console.log("no objects set to export");return}this.exporter||(this.exporter=new Yg,this.exporter.register(c=>new Ev(c)),this.ext=new kl,this.ext.registerExport(this.exporter)),xt.filterTopmostParent(e);const s={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:(l=t==null?void 0:t.binary)!=null?l:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:xt.collectAnimations(e)},n=new x;(t==null?void 0:t.pivot)&&n.position.sub(t.pivot),console.log("EXPORT",e),e.forEach(c=>{c&&(n.children.push(c),c.matrixAutoUpdate=!1,c.matrix.copy(c.matrixWorld),p.getComponentsInChildren(c,X).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))});const o=new cl(n);return this.ext.context=o,new Promise((c,h)=>{var d;try{(d=this.exporter)==null||d.parse(n,u=>{a(),c(u)},u=>{a(),h(u)},s)}catch(u){console.error(u),h(u)}finally{console.log("FINALLY")}});function a(){e.forEach(c=>{!c||(c.matrixAutoUpdate=!0,p.getComponentsInChildren(c,X).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(e,t){this.save(new Blob([e],{type:"application/octet-stream"}),t)}static saveJson(e,t){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),t)}static save(e,t){const s=document.createElement("a");s.style.display="none",document.body.appendChild(s),typeof e=="string"?s.href=e:s.href=URL.createObjectURL(e),s.download=t,s.click(),s.remove()}static collectAnimations(e,t){t=t||[];for(const s of e)!s||s.traverseVisible(n=>{n.animations&&n.animations.length>0&&t.push(...n.animations)});return t}static calculateCenter(e,t){const s=t||new y;return s.set(0,0,0),e.forEach(n=>{s.add(R(n))}),console.log(s),s.divideScalar(e.length),s}static filterTopmostParent(e){if(!(e.length<=0))for(let t=0;t<e.length;t++){let s=e[t];if(!s){e.splice(t,1),t--;continue}for(;s.parent;){if(e.includes(s.parent)){e.splice(t,1),t--;break}s=s.parent}}}}af(xt,"GltfExport");var lf=Object.defineProperty,Dv=Object.getOwnPropertyDescriptor,kv=(i,e)=>lf(i,"name",{value:e,configurable:!0}),Ml=(i,e,t,s)=>{for(var n=s>1?void 0:s?Dv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&lf(e,t,n),n};class as extends v{constructor(){super(...arguments);r(this,"isGizmo",!1);r(this,"color0");r(this,"color1");r(this,"gridHelper");r(this,"size");r(this,"divisions");r(this,"offset")}onEnable(){var s,n;if(this.isGizmo&&!Ks)return;const e=this.size,t=this.divisions;this.gridHelper||(this.gridHelper=new Jg(e,t,(s=this.color0)!=null?s:new g(.4,.4,.4),(n=this.color1)!=null?n:new g(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset),this.gameObject.add(this.gridHelper))}}kv(as,"GridHelper");Ml([f()],as.prototype,"isGizmo",2);Ml([f(g)],as.prototype,"color0",2);Ml([f(g)],as.prototype,"color1",2);var cf=Object.defineProperty,Iv=Object.getOwnPropertyDescriptor,jl=(i,e)=>cf(i,"name",{value:e,configurable:!0}),ls=(i,e,t,s)=>{for(var n=s>1?void 0:s?Iv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&cf(e,t,n),n};function Mv(i){return i*180/Math.PI}jl(Mv,"toDegrees");function lo(i){return i*Math.PI/180}jl(lo,"toRadians");const hf=300,df=O("debuglights");var uf;(function(i){i[i.Realtime=4]="Realtime",i[i.Baked=2]="Baked",i[i.Mixed=1]="Mixed"})(uf||(uf={}));class Ot extends v{constructor(){super(...arguments);r(this,"type",0);r(this,"intensity",1);r(this,"range",1);r(this,"spotAngle",1);r(this,"innerSpotAngle",1);r(this,"color",new g(16777215));r(this,"shadowNearPlane",.1);r(this,"shadowBias",0);r(this,"shadowNormalBias",1);r(this,"shadows",co.None);r(this,"lightmapBakeType",4);r(this,"light")}get isBaked(){return this.lightmapBakeType===2}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(e){return this.light?this.type===Ct.Directional?this.light.getWorldPosition(e).multiplyScalar(1):this.light.getWorldPosition(e):e}onEnable(){this.createLight(),!this.isBaked&&(this.light&&(this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===Ct.Directional&&this.startCoroutine(this.updateMainLightRoutine(),Ce.LateUpdate))}createLight(){if(this.light)return;let e=this.selfIsLight;if(e)switch(this.light=this.gameObject,this.type){case Ct.Directional:this.setDirectionalLight(this.light);break}else switch(this.type){case Ct.Directional:const t=new e_(this.color,this.intensity*Math.PI);if(t.position.set(0,0,-hf*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(t.target),ar(t.target,0,0,0),this.light=t,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),df){const a=new t_(this.light,.2,this.color);this.context.scene.add(a)}break;case Ct.Spot:const s=new Kg(this.color,this.intensity*Math.PI,this.range,lo(this.spotAngle/2),1-lo(this.innerSpotAngle/2)/lo(this.spotAngle/2),2);s.position.set(0,0,0),s.rotation.set(0,0,0),this.light=s;const n=s.target;s.add(n),n.position.set(0,0,this.range),n.rotation.set(0,0,0);break;case Ct.Point:const o=new Zg(this.color,this.intensity*Math.PI,this.range);this.light=o;break}if(this.light!==void 0){this.shadows!=co.None?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048,this.light.shadow.bias=this.shadowBias*-3e-5,this.light.shadow.normalBias=this.shadowNormalBias*-3e-5;const t=this.light.shadow.camera;t.near=this.shadowNearPlane,t.far=hf;const s=this.gameObject.scale.x,n=this.gameObject.scale.y;this.gameObject.scale.set(1,1,1),t.left*=s,t.right*=s,t.top*=n,t.bottom*=n,this.light.shadow.needsUpdate=!0,df&&this.context.scene.add(new i_(t)),this.isBaked?this.light.removeFromParent():e||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===Ct.Directional&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}setDirectionalLight(e){e.add(e.target),e.target.position.set(0,0,-1)}}jl(Ot,"Light");ls([f()],Ot.prototype,"type",2);ls([f(g)],Ot.prototype,"color",2);ls([f()],Ot.prototype,"shadowBias",2);ls([f()],Ot.prototype,"shadowNormalBias",2);ls([f()],Ot.prototype,"shadows",2);ls([f()],Ot.prototype,"lightmapBakeType",2);new y(0,0,0);var Ct;(function(i){i[i.Spot=0]="Spot",i[i.Directional=1]="Directional",i[i.Point=2]="Point",i[i.Area=3]="Area",i[i.Rectangle=3]="Rectangle",i[i.Disc=4]="Disc"})(Ct||(Ct={}));var co;(function(i){i[i.None=0]="None",i[i.Hard=1]="Hard",i[i.Soft=2]="Soft"})(co||(co={}));var ff=Object.defineProperty,jv=Object.getOwnPropertyDescriptor,Fl=(i,e)=>ff(i,"name",{value:e,configurable:!0}),mn=(i,e,t,s)=>{for(var n=s>1?void 0:s?jv(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&ff(e,t,n),n};const cs=O("debugLODs"),Fv=O("noLODs");var pf;(function(i){i[i.None=0]="None",i[i.CrossFade=1]="CrossFade",i[i.SpeedTree=2]="SpeedTree"})(pf||(pf={}));class pi{constructor(){r(this,"screenRelativeTransitionHeight");r(this,"distance");r(this,"renderers")}}Fl(pi,"LODModel");mn([f()],pi.prototype,"screenRelativeTransitionHeight",2);mn([f()],pi.prototype,"distance",2);mn([f()],pi.prototype,"renderers",2);class mf{constructor(e,t){r(this,"model");r(this,"renderers");this.model=t,this.renderers=[];for(const s of t.renderers){const n=this.findRenderer(s,e.gameObject);n&&n.gameObject?this.renderers.push(n):cs&&console.warn("Renderer not found: "+s,e.gameObject)}}findRenderer(e,t){const s=p.foreachComponent(t,n=>{var a;return n.guid===e||((a=Object.getPrototypeOf(n))==null?void 0:a.guid)===e?n:null});if(s)return s;for(const n of t.children){const o=this.findRenderer(e,n);if(o)return o}return null}}Fl(mf,"LOD");class gn extends v{constructor(){super(...arguments);r(this,"fadeMode",0);r(this,"localReferencePoint");r(this,"lodCount",0);r(this,"size",0);r(this,"animateCrossFading",!1);r(this,"lodModels");r(this,"_lods",[]);r(this,"_settings",[]);r(this,"_lodsHandler");r(this,"_distanceFactor",1)}start(){if(!Fv&&!this._lodsHandler&&!!this.gameObject&&(cs&&console.log(this),this.lodModels&&Array.isArray(this.lodModels))){let e=0,t=[];for(const n of this.lodModels){e=Math.max(n.distance,e);const o=new mf(this,n);this._lods.push(o);for(const a of o.renderers)t.includes(a)||t.push(a)}this._lodsHandler=new Array;for(let n=0;n<t.length;n++){const o=new s_;this._lodsHandler.push(o),this.gameObject.add(o)}const s=new x;cs&&console.log(t);for(let n=0;n<t.length;n++){const o=t[n],a=this._lodsHandler[n],l=o.gameObject;let c=0,h=0;cs&&console.log(n,l.name);for(const u of this._lods){let _=null;u.renderers.includes(o)?_=l:_=s,cs&&console.log("add",u.model.distance,_.name);const b=u.model.distance;h=b-c,c=Math.max(b,c),this.onAddLodLevel(a,_,b)}const d=c+h;cs&&console.log("cull",d),this.onAddLodLevel(a,s,d)}}}update(){if(!this.gameObject||!this._lodsHandler)return;const e=this.context.mainCamera;if(!!e)for(const t of this._lodsHandler)t.update(e)}onAddLodLevel(e,t,s){e.addLevel(t,s*this._distanceFactor);const n={lod:e,levelIndex:e.levels.length-1,distance:s};this._settings.push(n)}distanceFactor(e){if(e!==this._distanceFactor){this._distanceFactor=e;for(const t of this._settings){const s=t.lod.levels[t.levelIndex];s.distance=t.distance*e}}}}Fl(gn,"LODGroup");mn([f(y)],gn.prototype,"localReferencePoint",2);mn([f(pi)],gn.prototype,"lodModels",2);var Bv=Object.defineProperty,Uv=(i,e)=>Bv(i,"name",{value:e,configurable:!0});class Bl extends v{onEnable(){this.enabled&&this.context.physics.addMeshCollider(this.gameObject)}}Uv(Bl,"MeshCollider");var Nv=Object.defineProperty,gf=(i,e)=>Nv(i,"name",{value:e,configurable:!0});class Ul extends v{}gf(Ul,"NavMesh");class Nl extends v{}gf(Nl,"NavMeshAgent");var _f=Object.defineProperty,$v=Object.getOwnPropertyDescriptor,Wv=(i,e)=>_f(i,"name",{value:e,configurable:!0}),Hv=(i,e,t,s)=>{for(var n=s>1?void 0:s?$v(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&_f(e,t,n),n};const $l=O("debugnestedgltf");class ho extends v{constructor(){super(...arguments);r(this,"filePath");r(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(e){var t;(t=this.filePath)==null||t.beginListenDownload(e)}preload(){var e;(e=this.filePath)==null||e.preload()}async start(){var t,s,n,o,a,l;if(this._isLoadingOrDoneLoading)return;$l&&console.log(this,this.guid);const e=this.gameObject.parent;if(e){this._isLoadingOrDoneLoading=!0;const c=new Ae;c.idProvider=new Ee(this.hash(this.guid)),c.parent=e,this.gameObject.updateMatrix();const h=this.gameObject.matrix;$l&&console.log("Load nested:",(s=(t=this.filePath)==null?void 0:t.uri)!=null?s:this.filePath,this.gameObject.position);const d=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));d&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0),this.destroy(),$l&&console.log("Nested loading done:",(l=(a=this.filePath)==null?void 0:a.uri)!=null?l:this.filePath,d)}}hash(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}Wv(ho,"NestedGltf");Hv([f(Te)],ho.prototype,"filePath",2);var zv=Object.defineProperty,Gv=(i,e)=>zv(i,"name",{value:e,configurable:!0});class Wl extends v{constructor(){super(...arguments);r(this,"from");r(this,"affectPosition");r(this,"affectRotation");r(this,"alignLookDirection");r(this,"levelLookDirection");r(this,"positionOffset");r(this,"rotationOffset")}update(){if(!this.from)return;var e=R(this.from),t=re(this.from);this.affectPosition&&F(this.gameObject,e.add(this.positionOffset));const s=new he(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),n=new P().setFromEuler(s);this.affectRotation&&oe(this.gameObject,t.multiply(n));let o=new y;this.from.getWorldDirection(o).multiplyScalar(50),this.levelLookDirection&&(o.y=0),this.alignLookDirection&&this.gameObject.lookAt(o)}}Gv(Wl,"OffsetConstraint");var Vv=Object.defineProperty,Hl=(i,e)=>Vv(i,"name",{value:e,configurable:!0});class zl{constructor(){r(this,"randomizeRotationDirection",0);r(this,"duration",5);r(this,"loop",!0);r(this,"prewarm",!1);r(this,"startDelay");r(this,"startDelayMultiplier",0);r(this,"startLifetime");r(this,"startLifetimeMultiplier",5);r(this,"startSpeed");r(this,"startSpeedMultiplier",5);r(this,"startSize3D",!1);r(this,"startSize");r(this,"startSizeMultiplier",1);r(this,"startSizeX");r(this,"startSizeXMultiplier",1);r(this,"startSizeY");r(this,"startSizeYMultiplier",1);r(this,"startSizeZ");r(this,"startSizeZMultiplier",1);r(this,"startRotation3D",!1);r(this,"startRotation");r(this,"startRotationMultiplier",0);r(this,"startRotationX");r(this,"startRotationXMultiplier",0);r(this,"startRotationY");r(this,"startRotationYMultiplier",0);r(this,"startRotationZ");r(this,"startRotationZMultiplier",0);r(this,"flipRotation",0);r(this,"startColor",new g(1,1,1));r(this,"startColor1",new g(0,0,0));r(this,"gravityModifier");r(this,"gravityModifierMultiplier",0);r(this,"simulationSpace",0);r(this,"customSimulationSpace",null);r(this,"simulationSpeed",1);r(this,"useUnscaledTime",!1);r(this,"scalingMode",1);r(this,"playOnAwake",!0);r(this,"maxParticles",1e3);r(this,"emitterVelocityMode",1);r(this,"stopAction",0);r(this,"ringBufferMode",0);r(this,"ringBufferLoopRange",new Q(0,1));r(this,"cullingMode",0)}}Hl(zl,"MainModule");class Gl{constructor(){r(this,"burstCount",0);r(this,"enabled",!0);r(this,"rate",10);r(this,"rateMutliplier",1);r(this,"rateOverDistance",0);r(this,"rateOverDistanceMultiplier",0);r(this,"rateOverTime",0);r(this,"rateOverTimeMultiplier",0)}}Hl(Gl,"EmissionModule");class Vl{constructor(){r(this,"shapeType",it.Box);r(this,"enabled",!0);r(this,"alignToDirection",!1);r(this,"angle",0);r(this,"arc",360);r(this,"arcmode",0);r(this,"box",new y(1,1,1));r(this,"boxThickness",new y(0,0,0));r(this,"position",new y(0,0,0));r(this,"rotation",new y(0,0,0));r(this,"scale",new y(1,1,1));r(this,"radius",1);r(this,"sphericalDirectionAmount",0)}}Hl(Vl,"ShapeModule");var it;(function(i){i[i.Sphere=0]="Sphere",i[i.SphereShell=1]="SphereShell",i[i.Hemisphere=2]="Hemisphere",i[i.HemisphereShell=3]="HemisphereShell",i[i.Cone=4]="Cone",i[i.Box=5]="Box",i[i.Mesh=6]="Mesh",i[i.ConeVolume=7]="ConeVolume",i[i.Circle=10]="Circle",i[i.SingleSidedEdge=11]="SingleSidedEdge",i[i.MeshRenderer=12]="MeshRenderer",i[i.SkinnedMeshRenderer=13]="SkinnedMeshRenderer",i[i.BoxShell=14]="BoxShell",i[i.BoxEdge=15]="BoxEdge",i[i.Donut=16]="Donut",i[i.Rectangle=17]="Rectangle",i[i.Sprite=18]="Sprite",i[i.SpriteRenderer=19]="SpriteRenderer"})(it||(it={}));var qv=Object.defineProperty,ql=(i,e)=>qv(i,"name",{value:e,configurable:!0});const bf=O("debugparticles");class yf{constructor(){r(this,"age",0);r(this,"lifetime",0);r(this,"position");r(this,"velocity");r(this,"color")}}ql(yf,"ParticleState");class uo extends v{constructor(){super(...arguments);r(this,"sharedMaterial");r(this,"mesh")}get mainTexture(){if(this.sharedMaterial){const e=this.context.assets.findTexture(this.sharedMaterial);if(e)return e}return null}getMesh(e){return this.mesh?this.context.assets.findMesh(this.mesh):null}awake(){bf&&console.log(this)}}ql(uo,"ParticleSystemRenderer");class Ql extends v{constructor(){super(...arguments);r(this,"main");r(this,"emission");r(this,"shape");r(this,"renderer");r(this,"geometry");r(this,"material");r(this,"particlesMesh");r(this,"positions");r(this,"positionsArray");r(this,"particleStates",[]);r(this,"activeCount",0);r(this,"shapeRotation",new P);r(this,"tempVec3",new y);r(this,"tempQuat",new P)}awake(){this.renderer=p.getComponent(this.gameObject,uo),bf&&console.log(this)}onEnable(){if(this.geometry)return;this.particleStates=[],this.shapeRotation.setFromEuler(new he(this.shape.rotation.x,this.shape.rotation.y,this.shape.rotation.z)),this.geometry=new rr,this.positionsArray=new Float32Array(this.main.maxParticles*3),this.positions=new kh(this.positionsArray,3),this.geometry.setAttribute("position",this.positions);const e=new Float32Array(this.main.maxParticles*3);for(let s=0;s<e.length;s++)e[s*3]=1,e[s*3+1]=1,e[s*3+2]=1;const t=new kh(e,3);this.geometry.setAttribute("color",t),this.material=new n_({size:this.main.startSize,color:16777215,vertexColors:!0}),this.material.map=this.renderer.mainTexture,this.particlesMesh=new r_(this.geometry,this.material),this.particlesMesh.layers.enable(2),this.gameObject.add(this.particlesMesh),this.activeCount=this.main.prewarm?this.main.maxParticles:0}update(){if(!this.geometry)return;const e=this.context.time.deltaTime;this.emit(e);for(let t=0;t<this.activeCount;t+=1){const s=this.particleStates[t];if(!s)continue;const n=s.velocity.x*e,o=s.velocity.y*e,a=s.velocity.z*e;s.position.x+=n,s.position.y+=o,s.position.z+=a,this.updateOverLifetime(t,s),this.geometry.attributes.position.setXYZ(t,s.position.x,s.position.y,s.position.z),this.geometry.attributes.color.setXYZ(t,s.color.r,s.color.g,s.color.b)}this.geometry&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.setDrawRange(0,this.activeCount))}emit(e){var s;const t=this.activeCount;for(let n=0;n<t;n+=1){if(n>=this.particleStates.length){const a=new yf;a.lifetime=(s=this.main.startLifetime)!=null?s:1,a.position=new y,a.velocity=new y,a.color=new g(1,0,0),this.particleStates.push(a),this.initializeParticle(n,a),a.age=a.lifetime*Math.random()}const o=this.particleStates[n];if(o.age>o.lifetime){this.activeCount-=1,this.activeCount=Math.max(0,this.activeCount),this.initializeParticle(n,o);continue}o.age+=e,this.particleStates[n]=o}this.activeCount+=e*this.emission.rate,this.activeCount=Math.min(this.main.maxParticles,this.activeCount)}initializeParticle(e,t){if(!this.geometry)return;t.age=0,t.color.set(this.main.startColor),this.main.startColor1&&t.color.lerp(this.main.startColor1,Math.random()),this.geometry.attributes.color.needsUpdate=!0,this.assignPosition(t.position),this.assignVelocity(t.position,t.velocity);const s=t.position;s.multiply(this.shape.scale),s.applyQuaternion(this.shapeRotation),s.add(this.shape.position),this.particleStates.splice(e,1),this.particleStates.push(t)}updateOverLifetime(e,t){}assignPosition(e){switch(this.shape.shapeType){case it.Sphere:e.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).multiplyScalar(this.shape.radius);break;case it.Box:e.set(Math.random()-.5,Math.random()-.5,Math.random()-.5);break;default:e.set(0,0,0);break}}assignVelocity(e,t){switch(this.shape.shapeType){case it.Sphere:t.set(e.x,e.y,e.z);break;case it.Box:t.set(0,0,1),this.shape.sphericalDirectionAmount>0&&(this.tempVec3.set(e.x,e.y,e.z).multiply(this.shape.scale).normalize(),t.lerp(this.tempVec3,this.shape.sphericalDirectionAmount));break;case it.Cone:const s=new y(0,1,0);t.copy(s);break;case it.Circle:this.tempQuat.setFromAxisAngle(this.tempVec3.set(0,0,1),Math.random()*L.toRadians(this.shape.arc)),t.copy(this.tempVec3.set(1,0,0).applyQuaternion(this.tempQuat));break;default:t.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1);break}switch(t.normalize(),this.shape.shapeType){case it.Circle:e.add(t).multiplyScalar(this.shape.radius);break}t.multiplyScalar(this.main.startSpeedMultiplier)}}ql(Ql,"ParticleSystem");var Qv=Object.defineProperty,vf=(i,e)=>Qv(i,"name",{value:e,configurable:!0});function*wf(i,e=null){const t=e?e.time:k.Current.time,s=t.time;for(;t.time-s<i;)yield}vf(wf,"WaitForSeconds");function*Xv(i){for(let e=0;e<i;e++)yield}vf(Xv,"WaitForFrames");var Yv=Object.defineProperty,Jv=(i,e)=>Yv(i,"name",{value:e,configurable:!0});class St extends v{constructor(){super(...arguments);r(this,"_didAssignPlayerColor",!1)}awake(){this.context.connection.beginListen(G.JoinedRoom,this.tryAssignColor.bind(this))}onEnable(){this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}*waitForConnection(){for(;!this.destroyed&&this.enabled&&(yield wf(.2),!this.tryAssignColor()););}tryAssignColor(){const e=p.getComponentInParent(this.gameObject,ie);return e&&e.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(e.connectionId),!0):!1}assignUserColor(e){const t=St.hashCode(e),s=St.colorFromHashCode(t);if(this.gameObject.type==="Mesh"){const n=this.gameObject;this.assignColor(s,e,n)}else if(this.gameObject.children)for(const n of this.gameObject.children){const o=n;o.material&&o.material.color&&this.assignColor(s,e,o)}}assignColor(e,t,s){let n=s.material;!n||(n._playerMaterial!==t?(n=n.clone(),n._playerMaterial=t,s.material=n):console.log("DONT CLONE",n),n.color=e)}static hashCode(e){var t=0,s,n;if(e.length===0)return t;for(s=0;s<e.length;s++)n=e.charCodeAt(s),t=(t<<5)-t+n,t|=0;return t}static colorFromHashCode(e){const t=(e&16711680)>>16,s=(e&65280)>>8,n=e&255;return new g(t/255,s/255,n/255)}}Jv(St,"PlayerColor");var Zv=Object.defineProperty,Kv=(i,e)=>Zv(i,"name",{value:e,configurable:!0});const Fs=class extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=R(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const e=new Ja;e.drag=this.drag,e.angularDrag=this.angularDrag,e.mass=this.mass,e.kinematic=this.isKinematic,e.physicsEvents=this.detectCollision,e.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,e),this.parent=this.gameObject.parent}wakeUp(){var e;(e=this.body)==null||e.wakeUp()}applyForce(e,t){var s;(s=this.body)==null||s.applyForce(new si(e.x,e.y,e.z),t?new si(t.x,t.y,t.z):void 0)}set kinematic(e){this.isKinematic=e,this.body&&(this.body.type=e?_e.KINEMATIC:_e.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var e,t,s;return this.body?Fs.tempPosition.set((e=this.body)==null?void 0:e.velocity.x,(t=this.body)==null?void 0:t.velocity.y,(s=this.body)==null?void 0:s.velocity.z):Fs.tempPosition.set(0,0,0)}setVelocity(e,t,s){!this.body||(this.body.velocity.x=e/this.context.time.deltaTime,this.body.velocity.y=t/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(e,t,s){!this.body||(this.body.angularVelocity.x=e/this.context.time.deltaTime,this.body.angularVelocity.y=t/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(e=null){if(this.body&&this.gameObject&&!this.destroyed){const t=this.worldPosition;this.body.position.set(t.x,t.y,t.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),e){Fs.copyVector3.set(e.x,e.y,e.z),this.smoothedVelocity.lerp(Fs.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const e=R(this.gameObject);this.currentVelocity.subVectors(e,this.lastWorldPosition),this.lastWorldPosition.copy(e),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let hs=Fs;r(hs,"tempPosition",new y),r(hs,"copyVector3",new y);Kv(hs,"Rigidbody");var ew=Object.defineProperty,tw=(i,e)=>ew(i,"name",{value:e,configurable:!0});class Xl extends v{async start(){this.gameObject.visible=!1}}tw(Xl,"SceneSettings");var iw=Object.defineProperty,Yl=(i,e)=>iw(i,"name",{value:e,configurable:!0});function Pf(){return new Promise((i,e)=>{let s=Yl(()=>{s!=null&&(document.removeEventListener("pointerdown",s),document.removeEventListener("click",s),document.removeEventListener("dragstart",s),document.removeEventListener("touchstart",s),i())},"callback");document.addEventListener("pointerdown",s),document.addEventListener("click",s),document.addEventListener("dragstart",s),document.addEventListener("touchstart",s)})}Yl(Pf,"awaitInputAsync");async function xf(i){await Pf(),i()}Yl(xf,"awaitInput");var Of=Object.defineProperty,sw=Object.getOwnPropertyDescriptor,nw=(i,e)=>Of(i,"name",{value:e,configurable:!0}),mi=(i,e,t,s)=>{for(var n=s>1?void 0:s?sw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Of(e,t,n),n},Cf;(function(i){i[i.VideoClip=0]="VideoClip",i[i.Url=1]="Url"})(Cf||(Cf={}));var Sf;(function(i){i[i.None=0]="None",i[i.AudioSource=1]="AudioSource",i[i.Direct=2]="Direct",i[i.APIOnly=3]="APIOnly"})(Sf||(Sf={}));class We extends v{constructor(){super();r(this,"renderer",null);r(this,"playOnAwake",!0);r(this,"playOnEnable");r(this,"targetMaterialProperty");r(this,"time",0);r(this,"_playbackSpeed",1);r(this,"_isLooping",!1);r(this,"audioOutputMode",1);r(this,"source");r(this,"clip",null);r(this,"url",null);r(this,"videoElement",null);r(this,"videoTexture",null);r(this,"videoMaterial",null);r(this,"_isPlaying",!1);r(this,"wasPlaying",!1);r(this,"_receivedInput",!1);xf(()=>{this._receivedInput=!0,this.updateVideoElementSettings()})}get playbackSpeed(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.playbackRate)!=null?t:this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this.videoElement&&(this.videoElement.playbackRate=e)}get isLooping(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.loop)!=null?t:this._isLooping}set isLooping(e){this._isLooping=e,this.videoElement&&(this.videoElement.loop=e)}get currentTime(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.currentTime)!=null?t:this.time}set currentTime(e){this.videoElement?this.videoElement.currentTime=e:this.time=e}get isPlaying(){const e=this.videoElement;return e?e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>e.HAVE_CURRENT_DATA:!1}setClipURL(e){this.url!==e&&(this.url=e,this.source=1,this.videoElement&&(this.videoElement.src=e,this._isPlaying&&this.videoElement.play()))}awake(){this.create(this.playOnAwake),window.addEventListener("visibilitychange",e=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this._isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}})}onEnable(){this.playOnEnable===!0&&this.handleBeginPlaying(!0)}onDisable(){this.pause()}onDestroy(){var e;this.videoElement&&((e=this.videoElement.parentElement)==null||e.removeChild(this.videoElement),this.videoElement=null),this.videoTexture&&(this.videoTexture.dispose(),this.videoTexture=null)}play(){var e,t,s;!this.videoElement||this._isPlaying&&!((e=this.videoElement)==null?void 0:e.ended)&&!((t=this.videoElement)==null?void 0:t.paused)||(this._isPlaying=!0,this._receivedInput||(this.videoElement.muted=!0),this.updateVideoElementSettings(),(s=this.videoElement)==null||s.play().catch(n=>{console.warn(n)}))}stop(){this._isPlaying=!1,!!this.videoElement&&(this.videoElement.currentTime=0,this.videoElement.pause())}pause(){var e;this._isPlaying=!1,(e=this.videoElement)==null||e.pause()}create(e){var s;let t;switch(this.source){case 0:t=this.clip;break;case 1:t=this.url;break}!t||(this.videoElement||(this.videoElement=document.createElement("video"),(s=this.context.domElement)==null||s.prepend(this.videoElement),this.updateVideoElementStyles()),typeof t=="string"?this.videoElement.src=t:this.videoElement.srcObject=t,this.videoTexture||(this.videoTexture=new o_(this.videoElement)),this.videoTexture.flipY=!1,this.videoTexture.encoding=Gi,this.handleBeginPlaying(e))}handleBeginPlaying(e){if(!this.enabled||!this.videoElement)return;const t=this.gameObject.material;if(t)if(t!==this.videoMaterial&&(this.videoMaterial=t.clone(),this.gameObject.material=this.videoMaterial),!this.targetMaterialProperty)this.videoMaterial.map=this.videoTexture;else switch(this.targetMaterialProperty){default:this.videoMaterial.map=this.videoTexture;break}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),e&&this.play()}updateVideoElementSettings(){!this.videoElement||(this.videoElement.loop=this._isLooping,this.videoElement.currentTime=this.currentTime,this.videoElement.playbackRate=this._playbackSpeed,this.videoElement.playsInline=!0,this.videoElement.muted=!this._receivedInput&&this.audioOutputMode!==0,(this.playOnAwake||this.playOnEnable)&&(this.videoElement.autoplay=!0))}updateVideoElementStyles(){!this.videoElement||(this.videoElement.style.userSelect="none",this.videoElement.style.visibility="hidden",this.videoElement.style.display="none")}}nw(We,"VideoPlayer");mi([f(x)],We.prototype,"renderer",2);mi([f()],We.prototype,"playOnAwake",2);mi([f()],We.prototype,"playOnEnable",2);mi([f()],We.prototype,"targetMaterialProperty",2);mi([f()],We.prototype,"time",2);mi([f()],We.prototype,"playbackSpeed",1);mi([f()],We.prototype,"isLooping",1);var rw=Object.defineProperty,ow=(i,e)=>rw(i,"name",{value:e,configurable:!0});class Jl extends v{constructor(){super(...arguments);r(this,"streamOnAwake",!0);r(this,"requestOpen",!1);r(this,"captureStream",null)}start(){this.streamOnAwake&&this.open()}async open(e=!1){if(!(this.captureStream&&!e)){this.close(),this.requestOpen=!0;try{const t=p.getComponentInChildren(this.gameObject,We);if(t){const s={video:!0,audio:!1};this.captureStream=await navigator.mediaDevices.getDisplayMedia(s),this.captureStream&&this.requestOpen&&(t.clip=this.captureStream,t.create(!0))}}catch(t){console.error("Error: "+t)}}}close(){if(this.requestOpen=!1,this.captureStream){for(const e of this.captureStream.getTracks())e.stop();this.captureStream=null}}}ow(Jl,"ScreenCapture");var Rf=Object.defineProperty,aw=Object.getOwnPropertyDescriptor,lw=(i,e)=>Rf(i,"name",{value:e,configurable:!0}),Ef=(i,e,t,s)=>{for(var n=s>1?void 0:s?aw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Rf(e,t,n),n},Af;(function(i){i[i.ShadowMask=0]="ShadowMask",i[i.Additive=1]="Additive"})(Af||(Af={}));class _n extends v{constructor(){super(...arguments);r(this,"mode",0);r(this,"shadowColor",new fe(0,0,0,1))}awake(){switch(this.mode){case 0:this.applyShadowMaterial();break;case 1:this.applyLightBlendMaterial();break}}applyLightBlendMaterial(){const e=this.gameObject.getComponent(X);if(e){const t=e.material;t.blending=a_,t.onBeforeCompile=s=>{s.fragmentShader=s.fragmentShader.replace("vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;",`vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;

                // diffuse-only lighting with overdrive to somewhat compensate
                // for the loss of indirect lighting and to make it more visible.
                vec3 direct = reflectedLight.directDiffuse * 3.;
                float max = max(direct.r, max(direct.g, direct.b));

                // early out - we're simply returning direct lighting and some alpha based on it so it can
                // be blended onto the scene.
                gl_FragColor = vec4(direct, max);
                return;
                `)}}}applyShadowMaterial(){var t;const e=this.gameObject.getComponent(X);if(e)if(((t=e.material)==null?void 0:t.type)!=="ShadowMaterial"){const s=new l_;s.color=this.shadowColor,s.opacity=this.shadowColor.alpha,e.material=s}else{const s=e.material;s.color=this.shadowColor,s.opacity=this.shadowColor.alpha}}}lw(_n,"ShadowCatcher");Ef([f()],_n.prototype,"mode",2);Ef([f(fe)],_n.prototype,"shadowColor",2);var Tf=Object.defineProperty,cw=Object.getOwnPropertyDescriptor,hw=(i,e)=>Tf(i,"name",{value:e,configurable:!0}),dw=(i,e,t,s)=>{for(var n=s>1?void 0:s?cw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Tf(e,t,n),n},dh;const Lf=(dh=class extends v{constructor(){super(...arguments);r(this,"target",null);r(this,"followFactor",.1);r(this,"rotateFactor",.1);r(this,"flipForward",!1);r(this,"_firstUpdate",!0)}onEnable(){const i=p.getComponentInChildren(this.gameObject,W);i&&i.cam&&(i.gameObject.position.set(0,0,0),i.cam.position.set(0,0,0),i.gameObject.quaternion.identity(),i.cam.quaternion.setFromEuler(new he(0,Math.PI,0)))}onBeforeRender(){this.followFactor<=0||this.updateNow(!1)}updateNow(i){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const e=R(this.target),t=this._firstUpdate||i?1:L.clamp01(this.context.time.deltaTime*this.followFactor);this.worldPosition=this.worldPosition.lerp(e,t)}if(this.rotateFactor>0){const e=re(this.target);this.flipForward&&e.multiply(Lf._invertForward);const t=this._firstUpdate||i?1:L.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(e,t)}this._firstUpdate=!1}}},r(dh,"_invertForward",new P().setFromAxisAngle(new y(0,1,0),Math.PI)),dh);let bn=Lf;hw(bn,"SmoothFollow");dw([f(x)],bn.prototype,"target",2);var Df=Object.defineProperty,uw=Object.getOwnPropertyDescriptor,Zl=(i,e)=>Df(i,"name",{value:e,configurable:!0}),fo=(i,e,t,s)=>{for(var n=s>1?void 0:s?uw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Df(e,t,n),n};class ds extends v{constructor(){super(...arguments);r(this,"triggerMask",0);r(this,"onEnter");r(this,"onStay");r(this,"onExit");r(this,"currentIntersected",[]);r(this,"lastIntersected",[])}update(){this.currentIntersected.length=0;for(const e of yn.triggers)e.triggerMask===this.triggerMask&&e.test(this.gameObject)&&this.currentIntersected.push(e);for(let e=this.lastIntersected.length-1;e>=0;e--){const t=this.lastIntersected[e];this.currentIntersected.indexOf(t)<0&&(this.onExitTrigger(t),this.lastIntersected.splice(e,1))}for(const e of this.currentIntersected)this.lastIntersected.indexOf(e)<0&&this.onEnterTrigger(e),this.onTrigger(e);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(e){var t;e.raiseOnEnterEvent(this),(t=this.onEnter)==null||t.invoke(this,e)}onExitTrigger(e){var t;e.raiseOnExitEvent(this),(t=this.onExit)==null||t.invoke(this,e)}onTrigger(e){var t;e.raiseOnStayEvent(this),(t=this.onStay)==null||t.invoke(this,e)}}Zl(ds,"SpatialTriggerReceiver");fo([f(tt)],ds.prototype,"onEnter",2);fo([f(tt)],ds.prototype,"onStay",2);fo([f(tt)],ds.prototype,"onExit",2);var uh;const po=(uh=class extends v{constructor(){super(...arguments);r(this,"triggerMask");r(this,"boxHelper");r(this,"args",new mo)}start(){console.log(this)}onEnable(){var i;po.triggers.push(this),this.boxHelper||(this.boxHelper=p.addNewComponent(this.gameObject,es),(i=this.boxHelper)==null||i.showHelper())}onDisable(){po.triggers.splice(po.triggers.indexOf(this),1)}test(i){var e;return this.boxHelper&&(e=this.boxHelper.isInBox(i))!=null?e:!1}raiseOnEnterEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onEnterTrigger",!1,i,this)}raiseOnStayEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onStayTrigger",!1,i,this)}raiseOnExitEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onExitTrigger",!1,i,this)}},r(uh,"triggers",[]),uh);let yn=po;Zl(yn,"SpatialTrigger");fo([f()],yn.prototype,"triggerMask",2);class mo{constructor(){r(this,"source");r(this,"trigger")}}Zl(mo,"SpatialTriggerEventArgs");var fw=Object.defineProperty,pw=(i,e)=>fw(i,"name",{value:e,configurable:!0});class Kl extends v{constructor(){super(...arguments);r(this,"cam",null);r(this,"_firstPersonMode",!1);r(this,"orbit",null);r(this,"firstPersonFollow",null);r(this,"spectatorUIDomElement",null);r(this,"_avatar",null);r(this,"eventSub_WebXRRequestStartEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"_sessionHasStarted",!1);r(this,"_isFirstStart",!0);r(this,"_firstPersonIsSetup",!1);r(this,"_orbitStartPos",new y);r(this,"_orbitStartRot",new P);r(this,"_orbitStartPos2",new y);r(this,"_orbitStartRot2",new P)}get firstPersonMode(){return!0}set firstPersonMode(e){}enableFirstPersonMode(){this._firstPersonMode=!0,this.updateUI(),this.cam&&(this.firstPersonFollow&&(this.firstPersonFollow.enabled=!0,this.firstPersonFollow.updateNow(!0)),this.orbit&&(this.orbit.enabled=!1))}enableThirdPersonMode(){this._firstPersonMode=!1,this.updateUI(),this.firstPersonFollow&&(this.firstPersonFollow.enabled=!1),!!this.cam&&(F(this.cam.cam,this._orbitStartPos),oe(this.cam.cam,this._orbitStartRot),F(this.cam.gameObject,this._orbitStartPos2),oe(this.cam.gameObject,this._orbitStartRot2),this.orbit&&(this.orbit.enabled=!0,this.orbit.setFromTargetPosition()))}awake(){var t,s;p.setActive(this.gameObject,!1);const e="#spectator-camera-ui";if(this.spectatorUIDomElement=this.context.domElement.querySelector(e),this.spectatorUIDomElement||console.warn("Could not find spectator camera UI element",e),(t=this.spectatorUIDomElement)==null||t.classList.add("hidden"),!this.isSupportedPlatform()){console.log("Disable spectator cam",window.navigator.userAgent,this);return}if(this.cam=p.getComponent(this.gameObject,W),!this.cam){console.error("Spectator camera needs camera component",this);return}this.cam&&(this.cam.enabled=!0,this._orbitStartPos.copy(R(this.cam.cam)),this._orbitStartRot.copy(re(this.cam.cam)),this._orbitStartPos2.copy(R(this.cam.gameObject)),this._orbitStartRot2.copy(re(this.cam.gameObject))),this.eventSub_WebXRRequestStartEvent=this.onXRSessionRequestStart.bind(this),this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),D.addEventListener(V.RequestVRSession,this.eventSub_WebXRRequestStartEvent),D.addEventListener(V.XRStarted,this.eventSub_WebXRStartEvent),D.addEventListener(V.XRStopped,this.eventSub_WebXREndEvent),(s=this.context.domElement.querySelector("button#toggle-spectator-view"))==null||s.addEventListener("click",this.toggleView.bind(this)),this.updateUI()}onDestroy(){D.removeEventListener(V.RequestVRSession,this.eventSub_WebXRStartEvent),D.removeEventListener(V.XRStarted,this.eventSub_WebXRStartEvent),D.removeEventListener(V.XRStopped,this.eventSub_WebXREndEvent)}toggleView(){this.firstPersonMode=!this.firstPersonMode}updateUI(){var t;const e=this.context.domElement.querySelector("button#toggle-spectator-view");if(!!e&&(e.disabled=!0,e.firstChild&&(this._sessionHasStarted?e.firstChild.textContent=this.firstPersonMode?"\u{1F441}\uFE0F":"\u{1F4F7}":e.firstChild.textContent="Waiting for VR session"),((t=e.children)==null?void 0:t.length)>1)){const s=e.children[1];s.style.display=this._sessionHasStarted?"block":"none",this.firstPersonMode?s.textContent="First-Person View. See what the person in VR sees":s.textContent="Third-Person View. Freely move the camera around"}}isSupportedPlatform(){const e=window.navigator.userAgent,t=/Windows|MacOS/.test(e),s=/Windows NT/.test(e)&&/Edg/.test(e)&&!/Win64/.test(e);return t&&!s}onXRSessionRequestStart(e){var t;this._sessionHasStarted=!1,(t=this.spectatorUIDomElement)==null||t.classList.remove("hidden"),p.setActive(this.gameObject,!0),this.cam&&this.cam.cam&&(F(this.cam.cam,this._orbitStartPos),oe(this.cam.cam,this._orbitStartRot),F(this.cam.gameObject,this._orbitStartPos2),oe(this.cam.gameObject,this._orbitStartRot2)),this.firstPersonMode?this.enableFirstPersonMode():this.enableThirdPersonMode()}onXRSessionStart(e){this._sessionHasStarted=!0,this.updateUI()}onXRSessionEnded(e){var t;this._sessionHasStarted=!1,(t=this.spectatorUIDomElement)==null||t.classList.add("hidden"),p.setActive(this.gameObject,!1)}onAfterRender(){var l,c,h;if(!this.cam)return;if(this.firstPersonMode&&!this._firstPersonIsSetup&&(!this._avatar||((l=this._avatar)==null?void 0:l.destroyed))){for(const d of ie.instances)if(d.avatar&&"isLocalAvatar"in d.avatar&&((c=d.avatar)==null?void 0:c.isLocalAvatar)){this._avatar=d;const u=d.avatar.head;if(!u)continue;this.setupFollowMode(u)}}const e=this.context.renderer,t=e.xr.enabled;if(!e.xr.isPresenting)return;const s=e.getRenderTarget();let n=null;if(!s){if(!e.state.bindFramebuffer||!e.state.bindXRFramebuffer)return;n=e._framebuffer,e.state.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender(),e.setClearColor(new g(1,1,1)),e.setRenderTarget(null),e.xr.enabled=!1;const o=(h=this.cam)==null?void 0:h.cam;this.context.updateAspect(o);const a=e.xr.isPresenting;e.xr.isPresenting=!1,e.setSize(this.context.domWidth,this.context.domHeight),e.render(this.context.scene,o),e.xr.isPresenting=a,e.xr.enabled=t,s?e.setRenderTarget(s):e.state.bindXRFramebuffer(n),this.resetAvatarFlags()}setupFollowMode(e,t=!0){if(!e||!this.cam||this._firstPersonIsSetup)return;this._firstPersonIsSetup=!0;const s=e.add(new x);s.add(new sr),this.firstPersonFollow=p.addNewComponent(this.cam.gameObject,bn),this.firstPersonFollow.target=s,this.firstPersonFollow.followFactor=12,this.firstPersonFollow.rotateFactor=5,t&&(this.firstPersonFollow.flipForward=!0);const n=this.context.mainCamera;n&&(this.cam.cam.near=n.near,this.cam.cam.far=n.far,this.cam.cam.updateProjectionMatrix()),this.orbit&&(this.orbit.enabled=!1)}setAvatarFlagsBeforeRender(){for(const e of ie.instances)if(e.avatar&&"isLocalAvatar"in e.avatar){const t=this.firstPersonMode&&this._firstPersonIsSetup&&e.avatar.isLocalAvatar?ee.FirstPerson:ee.ThirdPerson,s=e.avatar.flags;if(!s)continue;for(const n of s)n.UpdateVisible(t)}}resetAvatarFlags(){var e;for(const t of ie.instances)if(t.avatar&&"flags"in t.avatar){const s=t.avatar.flags;if(!s)continue;for(const n of s)((e=t.avatar)==null?void 0:e.isLocalAvatar)?n.UpdateVisible(ee.FirstPerson):n.UpdateVisible(ee.ThirdPerson)}}}pw(Kl,"SpectatorCamera");var kf=Object.defineProperty,mw=Object.getOwnPropertyDescriptor,gw=(i,e)=>kf(i,"name",{value:e,configurable:!0}),If=(i,e,t,s)=>{for(var n=s>1?void 0:s?mw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&kf(e,t,n),n};class vn extends v{constructor(){super(...arguments);r(this,"attachedRigidbody",null);r(this,"isTrigger",!1);r(this,"radius",.5);r(this,"center",new y(0,0,0));r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addSphereCollider(this.gameObject,this.center,this.radius,this.attachedRigidbody))}}gw(vn,"SphereCollider");If([f(Ne)],vn.prototype,"attachedRigidbody",2);If([f(y)],vn.prototype,"center",2);var _w=Object.defineProperty,bw=(i,e)=>_w(i,"name",{value:e,configurable:!0});class ec extends v{constructor(){super(...arguments);r(this,"anchor",null);r(this,"connectedBody",null);r(this,"connectedAnchor",null);r(this,"spring",10);r(this,"damper",.2);r(this,"rb",null)}awake(){if(this.rb=p.getComponent(this.gameObject,Ne),!this.connectedBody||!this.connectedBody.body||!this.rb||!this.rb.body)return;this.connectedBody.body.mass=Math.min(this.rb.body.mass*.99,this.connectedBody.body.mass);const e=new c_(this.rb.body,this.connectedBody.body,{restLength:.01,stiffness:this.spring*.5,damping:this.damper});this.context.physics.addPostStepListener(t=>{e.applyForce()})}update(){}}bw(ec,"SpringJoint");var Mf=Object.defineProperty,yw=Object.getOwnPropertyDescriptor,go=(i,e)=>Mf(i,"name",{value:e,configurable:!0}),_o=(i,e,t,s)=>{for(var n=s>1?void 0:s?yw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Mf(e,t,n),n},jf;(function(i){i[i.Simple=0]="Simple",i[i.Sliced=1]="Sliced",i[i.Tiled=2]="Tiled"})(jf||(jf={}));class vw{constructor(){r(this,"x");r(this,"y")}}go(vw,"Vec2");class bo{constructor(){r(this,"texture");r(this,"triangles");r(this,"uv");r(this,"vertices");r(this,"_geometry")}}go(bo,"Sprite");_o([f(Hi)],bo.prototype,"texture",2);class tc{static getOrCreateGeometry(e){if(e._geometry)return e._geometry;const t=new rr;e._geometry=t;const s=new Float32Array(e.triangles.length*3),n=new Float32Array(e.triangles.length*2);for(let o=0;o<e.triangles.length;o+=1){const a=e.triangles[o];s[o*3]=-e.vertices[a].x,s[o*3+1]=e.vertices[a].y,s[o*3+2]=0;const l=e.uv[a];n[o*2]=l.x,n[o*2+1]=1-l.y}return t.setAttribute("position",new Ws(s,3)),t.setAttribute("uv",new Ws(n,2)),t}}go(tc,"SpriteUtils");class us extends v{constructor(){super(...arguments);r(this,"drawMode",0);r(this,"size",{x:1,y:1});r(this,"color");r(this,"sharedMaterial");r(this,"_sprite");r(this,"_currentSprite")}get sprite(){return this._sprite}set sprite(e){e!==this._sprite&&(this._sprite=e,this.updateSprite())}awake(){this._currentSprite=void 0}start(){this.drawMode===2&&console.warn("Tiled draw mode is not supported yet",this),this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(){if(!!this.__didAwake&&!!this.sprite&&!!this.sharedMaterial){if(this._currentSprite)this._currentSprite.geometry=tc.getOrCreateGeometry(this.sprite),this._currentSprite.material.map=this.sprite.texture;else{const e=new $s({color:16777215,side:Sa});if(!e)return;if(this.color&&(e.color||(e.color=new g),e.color.copy(this.color),e.opacity=this.color.alpha),e.alphaTest=.5,this.sprite.texture&&!e.wireframe){const t=this.sprite.texture;e.map=t}this._currentSprite=new ii(tc.getOrCreateGeometry(this.sprite),e)}this._currentSprite.parent!==this.gameObject&&(this.drawMode===2&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite))}}}go(us,"SpriteRenderer");_o([f()],us.prototype,"drawMode",2);_o([f(fe)],us.prototype,"color",2);_o([f(Ih)],us.prototype,"sharedMaterial",2);var ww=Object.defineProperty,Pw=(i,e)=>ww(i,"name",{value:e,configurable:!0});class He{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsSyncedCameraModel(e,t){return(t||new He).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsSyncedCameraModel(e,t){return e.setPosition(e.position()+Ca),(t||new He).__init(e.readInt32(e.position())+e.position(),e)}userId(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}guid(e){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.__string(this.bb_pos+t,e):null}dontSave(){const e=this.bb.__offset(this.bb_pos,8);return e?!!this.bb.readInt8(this.bb_pos+e):!1}pos(e){const t=this.bb.__offset(this.bb_pos,10);return t?(e||new pe).__init(this.bb_pos+t,this.bb):null}rot(e){const t=this.bb.__offset(this.bb_pos,12);return t?(e||new pe).__init(this.bb_pos+t,this.bb):null}static startSyncedCameraModel(e){e.startObject(5)}static addUserId(e,t){e.addFieldOffset(0,t,0)}static addGuid(e,t){e.addFieldOffset(1,t,0)}static addDontSave(e,t){e.addFieldInt8(2,+t,0)}static addPos(e,t){e.addFieldStruct(3,t,0)}static addRot(e,t){e.addFieldStruct(4,t,0)}static endSyncedCameraModel(e){return e.endObject()}static finishSyncedCameraModelBuffer(e,t){e.finish(t)}static finishSizePrefixedSyncedCameraModelBuffer(e,t){e.finish(t,void 0,!0)}}Pw(He,"SyncedCameraModel");var Ff=Object.defineProperty,xw=Object.getOwnPropertyDescriptor,Bf=(i,e)=>Ff(i,"name",{value:e,configurable:!0}),Uf=(i,e,t,s)=>{for(var n=s>1?void 0:s?xw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Ff(e,t,n),n};const yo="SCAM";Or(yo,He.getRootAsSyncedCameraModel);const Pe=new nr;class Nf{constructor(e,t){r(this,"userId");r(this,"guid");this.guid=t,this.userId=e}send(e,t){var n;const s=(n=e.cam)==null?void 0:n.cam;if(s){Pe.clear();const o=Pe.createString(this.guid),a=Pe.createString(this.userId);He.startSyncedCameraModel(Pe),He.addGuid(Pe,o),He.addUserId(Pe,a);const l=R(s),c=$a(s);He.addPos(Pe,pe.createVec3(Pe,l.x,l.y,l.z)),He.addRot(Pe,pe.createVec3(Pe,c.x,c.y,c.z));const h=He.endSyncedCameraModel(Pe);Pe.finish(h,yo),t.sendBinary(Pe.asUint8Array())}}}Bf(Nf,"CameraModel");class wn extends v{constructor(){super(...arguments);r(this,"cam",null);r(this,"cameraPrefab",null);r(this,"_lastWorldPosition");r(this,"_lastWorldQuaternion");r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"_lastUpdateTime",0);r(this,"remoteCams",{});r(this,"userToCamMap",{});r(this,"_camTimeoutInSeconds",10);r(this,"_receiveCallback",null)}getUserCamera(e){const t=this.userToCamMap[e];return t?this.remoteCams[t].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}start(){var e;this.cam||(console.warn("Missing camera, fallback to main camera",this),this.cam=(e=this.context.mainCameraComponent)!=null?e:null)}onEnable(){this._receiveCallback=this.context.connection.beginListenBinrary(yo,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(yo,this._receiveCallback)}update(){for(const s in this.remoteCams){const n=this.remoteCams[s],o=this.context.time.realtimeSinceStartup-n.lastUpdate;if(!n||o>this._camTimeoutInSeconds){console.log("Remote cam timeout",n,o),(n==null?void 0:n.obj)&&p.destroy(n.obj),delete this.remoteCams[s],n&&delete this.userToCamMap[n.userId];continue}}if(D.IsInWebXR)return;if(this.cam===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new Nf(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const e=R(this.cam.cam),t=re(this.cam.cam);(e.distanceTo(this._lastWorldPosition)>.001||t.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(e),this._lastWorldQuaternion.copy(t),!((!this._needsUpdate||this.context.time.frameCount%2!=0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(this,this.context.connection))}onReceivedRemoteCameraInfoBin(e){const t=e.guid();if(!t)return;const s=e.userId();if(!s||!this.context.connection.userIsInRoom(s)||!this.cameraPrefab)return;let n=this.remoteCams[t];if(!n)if("isObject3D"in this.cameraPrefab){const c=new Ae;c.context=this.context;const h=p.instantiate(this.cameraPrefab,c);n=this.remoteCams[t]={obj:h,lastUpdate:this.context.time.realtimeSinceStartup,userId:s},n.obj.visible=!0,this.gameObject.add(h),this.userToCamMap[s]=t;const d=p.getOrAddComponent(h,ie);d.connectionId=s,d.avatar=h}else return;const o=n.obj;n.lastUpdate=this.context.time.realtimeSinceStartup,ue.markDirty(o);const a=e.pos();a&&ar(o,a.x(),a.y(),a.z());const l=e.rot();l&&cr(o,l.x(),l.y(),l.z())}}Bf(wn,"SyncedCamera");Uf([f(W)],wn.prototype,"cam",2);Uf([f([x,Te])],wn.prototype,"cameraPrefab",2);var $f=Object.defineProperty,Ow=Object.getOwnPropertyDescriptor,Cw=(i,e)=>$f(i,"name",{value:e,configurable:!0}),Pn=(i,e,t,s)=>{for(var n=s>1?void 0:s?Ow(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&$f(e,t,n),n};const ic="view",Wf=O("debugsyncedroom");class Vt extends v{constructor(){super(...arguments);r(this,"roomName");r(this,"urlParameterName");r(this,"joinRandomRoom",!0);r(this,"requireRoomParameter",!1);r(this,"autoRejoin",!0);r(this,"_roomPrefix");r(this,"_lastPingTime",0);r(this,"_lastRoomTime",-1)}awake(){this._roomPrefix===void 0&&(this._roomPrefix=this.roomName,this.roomName="")}onEnable(){const e=O(ic);if(e&&typeof e=="string"&&e.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(e,!0);return}this.tryJoinRoom()}onDisable(){this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}tryJoinRoom(e=0){let t=!1;if(this.urlParameterName){const s=O(this.urlParameterName);if(s&&typeof s=="string"){t=!0;const n=Vh(s);this.roomName=n}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),e<1))return this.tryJoinRoom(e+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(console.log("generate room name"),this.roomName=this.generateRoomName());return this.requireRoomParameter&&!t?(Wf&&console.log('No required room parameter "'+this.urlParameterName+'" in url - will not connect to networking backend.'),!1):!this.roomName||this.roomName.length<=0?(Wf&&console.error('Missing room name on "'+this.name+'". Make sure this is correctly configured in Unity',this.context.connection.isDebugEnabled?this:""),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.context.connection.joinRoom(this.roomName),!0)}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.send("ping",{time:this.context.time.time})),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you)"))}get currentRoomName(){const e=O(ic);return e||O(this.urlParameterName)}setRandomRoomUrlParameter(){const e=Gs(),t=this.generateRoomName();O(this.urlParameterName)?e.set(this.urlParameterName,t):e.append(this.urlParameterName,t),Da(t,e)}generateRoomName(){return Gh()+"_"+Wh(100,999)}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const e=window.location.search,t=new URLSearchParams(e);return t.has(this.urlParameterName)&&t.delete(this.urlParameterName),t.set(ic,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+t.toString()}return null}}Cw(Vt,"SyncedRoom");Pn([f()],Vt.prototype,"roomName",2);Pn([f()],Vt.prototype,"urlParameterName",2);Pn([f()],Vt.prototype,"joinRandomRoom",2);Pn([f()],Vt.prototype,"requireRoomParameter",2);Pn([f()],Vt.prototype,"autoRejoin",2);var Sw=Object.defineProperty,Hf=(i,e)=>Sw(i,"name",{value:e,configurable:!0});function zf(){const i=O("testwindowcount")||0;i&&i>0&&Gf(i)}Hf(zf,"detect_run_tests");function Gf(i){if(O("testwindow"))return null;const e=new URL(window.location.href);Vs(e.searchParams,Qr,1),Vs(e.searchParams,"testwindow",1);const t=e.toString(),s=[];window.onbeforeunload=()=>{for(const c of s)c.close()};const n=.05,o=128;let a=0,l=0;for(let c=0;c<i;c++){a*o+o*.01>=window.innerWidth&&(l+=1,a=0);const h=a*(o*(1+n))+window.screenLeft,d=l*(o*(1+n))+window.screenTop+90+60*l;a+=1;const u=window.open(t,"test window "+c,`popup=yes width=${o} height=${o} top=${d} left=${h}`);if(!u){console.warn("Failed to open window");continue}s.push(u),u.onload=()=>{u.onbeforeunload=()=>{for(let _=0;_<s.length;_++){const b=s[_];b!==u&&b.close()}s.length=0}}}return s}Hf(Gf,"spawnWindows");var Rw=Object.defineProperty,sc=(i,e)=>Rw(i,"name",{value:e,configurable:!0});class nc extends v{awake(){zf()}}sc(nc,"TestRunner");class rc extends v{constructor(){super(...arguments);r(this,"transformsPerFrame",10);r(this,"interval",0);r(this,"useFlatbuffers",!0);r(this,"builder",null);r(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinrary(an,e=>{});else{this.models=[];for(let e=0;e<this.transformsPerFrame;e++)this.models.push(new oc(this.context.connection.connectionId+"_simulatedTransform_"+e,this))}}update(){if(!!this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!=0)return;this.builder===null&&(this.builder=new nr(1024));const e=this.builder;for(let t=0;t<this.transformsPerFrame;t++){e.clear();const s=Cl(this.context.connection.connectionId,this);this.context.connection.sendBinary(s)}}else if(this.models)for(let e=0;e<this.models.length;e++){const t=this.models[e];t.dontSave=!0,t.update(this,null),this.context.connection.send("TestSimulateUserData-"+e,t)}}}}sc(rc,"TestSimulateUserData");class oc{constructor(e,t){r(this,"guid");r(this,"fast",!1);r(this,"position");r(this,"rotation");r(this,"velocity");r(this,"dontSave");this.guid=e,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(t,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(e,t){const s=e.worldPosition;this.position.x=s.x,this.position.y=s.y,this.position.z=s.z;const n=e.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,t){const o=t.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}r(oc,"temp",new y);sc(oc,"TransformModel");var Vf=Object.defineProperty,Ew=Object.getOwnPropertyDescriptor,Aw=(i,e)=>Vf(i,"name",{value:e,configurable:!0}),Tw=(i,e,t,s)=>{for(var n=s>1?void 0:s?Ew(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Vf(e,t,n),n};class vo extends v{constructor(){super(...arguments);r(this,"isGizmo",!0);r(this,"control");r(this,"orbit");r(this,"changeEventListener");r(this,"windowKeyDownListener");r(this,"windowKeyUpListener")}awake(){this.isGizmo&&!Ks||!this.context.mainCamera||(this.control=new h_(this.context.mainCamera,this.context.renderer.domElement),this.control.visible=!0,this.control.enabled=!0,this.control.getRaycaster().layers.set(2),this.control.size=.6,this.control.traverse(e=>{const t=e;if(t.layers.set(2),t){const s=t.material;s&&(s.opacity=.3)}}))}start(){var e;if(this.context.mainCamera){const t=(e=p.getComponentInParent(this.context.mainCamera,xh))!=null?e:void 0;this.orbit=t}}onEnable(){var e;this.control&&(this.context.scene.add(this.control),this.control.attach(this.gameObject)),this.changeEventListener=this.onControlChangedEvent.bind(this),(e=this.control)==null||e.addEventListener("dragging-changed",this.changeEventListener),this.attachWindowEvents()}onDisable(){var e,t;(e=this.control)==null||e.removeFromParent(),this.changeEventListener&&((t=this.control)==null||t.removeEventListener("dragging-changed",this.changeEventListener))}onControlChangedEvent(e){const t=this.orbit;if(t&&(t.enabled=!e.value),e.value){const s=p.getComponentInParent(this.gameObject,yt);s&&s.requestOwnership()}}attachWindowEvents(){const e=this.control;!e||(this.windowKeyDownListener||(this.windowKeyDownListener=t=>{switch(t.keyCode){case 81:e.setSpace(e.space==="local"?"world":"local");break;case 16:e.setTranslationSnap(100),e.setRotationSnap(d_.degToRad(15)),e.setScaleSnap(.25);break;case 87:e.setMode("translate");break;case 69:e.setMode("rotate");break;case 82:e.setMode("scale");break;case 187:case 107:e.setSize(e.size+.1);break;case 189:case 109:e.setSize(Math.max(e.size-.1,.1));break;case 88:e.showX=!e.showX;break;case 89:e.showY=!e.showY;break;case 90:e.showZ=!e.showZ;break;case 32:e.enabled=!e.enabled;break}}),this.windowKeyUpListener||(this.windowKeyUpListener=t=>{switch(t.keyCode){case 16:e.setTranslationSnap(null),e.setRotationSnap(null),e.setScaleSnap(null);break}}),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener))}}Aw(vo,"TransformGizmo");Tw([f()],vo.prototype,"isGizmo",2);var qf=Object.defineProperty,Lw=Object.getOwnPropertyDescriptor,gi=(i,e)=>qf(i,"name",{value:e,configurable:!0}),Qf=(i,e,t,s)=>{for(var n=s>1?void 0:s?Lw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&qf(e,t,n),n},Xf;(function(i){i[i.None=0]="None",i[i.Neutral=1]="Neutral",i[i.ACES=2]="ACES"})(Xf||(Xf={}));class ac{constructor(){r(this,"overrideState",!1);r(this,"value",0)}}gi(ac,"VolumeParameter");class _i{constructor(){r(this,"active",!1);r(this,"parameters")}}gi(_i,"VolumeComponent");class xn extends _i{constructor(){super(...arguments);r(this,"mode")}get isToneMapping(){return!0}}gi(xn,"ToneMapping");class On extends _i{constructor(){super(...arguments);r(this,"postExposure")}}gi(On,"ColorAdjustments");function Yf(i){return"mode"in i?xn:"postExposure"in i?On:_i}gi(Yf,"resolveComponentType");class Cn{constructor(){r(this,"components")}apply(e){var t,s,n,o,a;if(!!this.components){for(const l of this.components)if(l instanceof xn){const c=l;if(!l.active){e.renderer.toneMapping=Mh;continue}switch((s=(t=c.mode)==null?void 0:t.value)!=null?s:0){case 0:e.renderer.toneMapping=Mh;break;case 1:e.renderer.toneMapping=f_;break;case 2:e.renderer.toneMapping=u_;break}}else if(l instanceof On){const c=l;console.log(c.postExposure);const h=Math.pow(2,(o=(n=c.postExposure)==null?void 0:n.value)!=null?o:0);e.renderer.toneMappingExposure=((a=c.postExposure)==null?void 0:a.overrideState)?h:1}}}}gi(Cn,"VolumeProfile");Qf([f([i=>Yf(i),_i])],Cn.prototype,"components",2);class wo extends v{constructor(){super(...arguments);r(this,"sharedProfile")}onEnable(){var e;(e=this.sharedProfile)==null||e.apply(this.context)}}gi(wo,"Volume");Qf([f(Cn)],wo.prototype,"sharedProfile",2);var Dw=Object.defineProperty,Jf=(i,e)=>Dw(i,"name",{value:e,configurable:!0}),qt;(function(i){i.StartOrUpdate="xr-grab-visual-start-or-update",i.End="xr-grab-visual-end"})(qt||(qt={}));class Po{constructor(){r(this,"guid");r(this,"dontSave",!0);r(this,"userId");r(this,"point",{x:0,y:0,z:0});r(this,"source",{x:0,y:0,z:0});r(this,"target")}update(e,t,s,n=void 0){this.userId=e.connection.connectionId,this.point.x=t.x,this.point.y=t.y,this.point.z=t.z,this.source.x=s.x,this.source.y=s.y,this.source.z=s.z,this.target=n}}Jf(Po,"XRGrabModel");class lc extends v{constructor(){super(...arguments);r(this,"prefab",null);r(this,"_grabModels",[]);r(this,"_grabModelsUpdateTime",[]);r(this,"_addOrUpdateSub",null);r(this,"_endSub",null);r(this,"_freeSub",null);r(this,"_instances",{});r(this,"temp",new y)}awake(){this.prefab&&(this.prefab.visible=!1)}onEnable(){this._addOrUpdateSub=this.context.connection.beginListen(qt.StartOrUpdate,this.onRemoteGrabStartOrUpdate.bind(this)),this._endSub=this.context.connection.beginListen(qt.End,this.onRemoteGrabEnd.bind(this)),this._freeSub=$e.AddEventListener(eo.WillFree,this.onAttachedObjectFree.bind(this))}onDisable(){this.context.connection.stopListening(qt.StartOrUpdate,this._addOrUpdateSub),this.context.connection.stopListening(qt.End,this._endSub),$e.RemoveEventListener(eo.WillFree,this._freeSub)}addOrUpdateGrab(e){this.context.connection.send(qt.StartOrUpdate,e,Js.Queued)}endGrab(e){this.context.connection.send(qt.End,e,Js.Queued)}onRemoteGrabStartOrUpdate(e){if(!this.prefab)return;const t=this._instances[e.guid];if(!t){const s=p.instantiate(this.prefab);if(s.visible=!0,this._instances[e.guid]={instance:s,model:e},e.userId){const n=p.getComponentsInChildren(s,St);if((n==null?void 0:n.length)>0)for(const o of n)o.assignUserColor(e.userId)}return}t.model=e}onRemoteGrabEnd(e){if(!e)return;const t=e.guid;this._instances[t]&&(p.destroy(this._instances[t].instance),delete this._instances[t])}onAttachedObjectFree(e){if(this._grabModels.length<=0)return;const t=this._grabModels[0];this.updateModel(t,e),this.endGrab(t)}onBeforeRender(){if(this.updateRendering(),!!this.prefab&&(this.prefab.visible=!1,this.context.time.frameCount%10==0))for(let e=0;e<$e.Current.length;e++){const t=$e.Current[e];if(!t.controller||!t.selected)continue;this._grabModels.length<=e&&(this._grabModels.push(new Po),this._grabModelsUpdateTime.push(0)),this._grabModelsUpdateTime[e]=this.context.time.time;const s=this._grabModels[e];this.updateModel(s,t),this.addOrUpdateGrab(s)}}updateModel(e,t){if(!t.controller||!t.selected)return;e.guid=t.grabUUID;const s=t.selected.guid;e.update(this.context,t.grabPoint,t.controller.worldPosition,s)}updateRendering(){const e=this.context.time.deltaTime/.5;for(const t in this._instances){const{instance:s,model:n}=this._instances[t];if(!s||!n)continue;const{point:o}=n,a=R(s);this.temp.set(o.x,o.y,o.z),a.lerp(this.temp,e),F(s,a)}}}Jf(lc,"XRGrabRendering");var Zf=Object.defineProperty,kw=Object.getOwnPropertyDescriptor,Iw=(i,e)=>Zf(i,"name",{value:e,configurable:!0}),xo=(i,e,t,s)=>{for(var n=s>1?void 0:s?kw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Zf(e,t,n),n};class bi extends v{constructor(){super(...arguments);r(this,"eyes",[]);r(this,"lastBlinkTime",0);r(this,"blinkLength",0);r(this,"eyesOpen",!0);r(this,"state",null)}awake(){this.state=p.getComponentInParent(this.gameObject,te)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const t of this.eyes)t&&(t.visible=this.eyesOpen)}}}Iw(bi,"AvatarBlink_Simple");xo([f(x)],bi.prototype,"eyes",2);xo([f()],bi.prototype,"lastBlinkTime",2);xo([f()],bi.prototype,"blinkLength",2);xo([f()],bi.prototype,"eyesOpen",2);var Kf=Object.defineProperty,Mw=Object.getOwnPropertyDescriptor,jw=(i,e)=>Kf(i,"name",{value:e,configurable:!0}),cc=(i,e,t,s)=>{for(var n=s>1?void 0:s?Mw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Kf(e,t,n),n},fh;const ep=(fh=class extends v{constructor(){super(...arguments);r(this,"head",null);r(this,"eyes",null);r(this,"target",null);r(this,"brain",null);r(this,"vec",new y);r(this,"currentTargetPoint",new y)}awake(){this.brain||(this.brain=p.getComponentInParent(this.gameObject,ln)),this.brain||(console.log("No look at brain found, adding it now"),this.brain=p.addNewComponent(this.gameObject,ln)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const i=this.target;if(i&&this.head){const e=this.eyes;if(e){const t=R(i);this.currentTargetPoint.lerp(t,this.context.time.deltaTime/.1);const s=R(this.head),n=this.vec.copy(this.currentTargetPoint).sub(s).normalize();if(n.length()<.1)return;const o=ep.forward;if(o.set(0,0,1),o.applyQuaternion(re(this.head)),o.dot(n)>.45)for(let l=0;l<e.length;l++)e[l].lookAt(this.currentTargetPoint)}}}},r(fh,"forward",new y(0,0,1)),fh);let fs=ep;jw(fs,"AvatarEyeLook_Rotation");cc([f(x)],fs.prototype,"head",2);cc([f(x)],fs.prototype,"eyes",2);cc([f(x)],fs.prototype,"target",2);var tp=Object.defineProperty,Fw=Object.getOwnPropertyDescriptor,Bw=(i,e)=>tp(i,"name",{value:e,configurable:!0}),ip=(i,e,t,s)=>{for(var n=s>1?void 0:s?Fw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&tp(e,t,n),n};const Uw=O("debugmouth");class Sn extends v{constructor(){super(...arguments);r(this,"idle",[]);r(this,"talking",[]);r(this,"marker",null);r(this,"voip",null);r(this,"lastMouthChangeTime",0);r(this,"mouthChangeLength",0)}awake(){this.voip=p.findObjectOfType(vt,this.context),console.log(this)}update(){var s,n;if(!this.voip||this.context.time.frameCount%10!=0)return;let e=(n=(s=this.marker)==null?void 0:s.connectionId)!=null?n:null;e||Uw&&(e=null);const t=this.voip.getFrequency(e);t!=null&&this.updateLips(t)}updateLips(e){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&e>50){this.lastMouthChangeTime=this.context.time.time;const t=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,t)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const t=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,t)}}}setMouthShapeActive(e,t){if(!!e){e!=this.idle?this.idle.map(s=>s.visible=!1):this.talking.map(s=>s.visible=!1);for(let s=0;s<e.length;s++){const n=e[s];n&&(n.visible=s===t,n.scale.set(1,1,1))}}}}Bw(Sn,"Avatar_MouthShapes");ip([f(x)],Sn.prototype,"idle",2);ip([f(x)],Sn.prototype,"talking",2);var Nw=Object.defineProperty,$w=(i,e)=>Nw(i,"name",{value:e,configurable:!0});class hc extends v{constructor(){super(...arguments);r(this,"voip",null);r(this,"marker",null);r(this,"_startPosition",null)}awake(){this.voip=p.findObjectOfType(vt,this.context),this.marker=p.getComponentInParent(this.gameObject,ie)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!=0)return;const e=this.marker.connectionId,t=this.voip.getFrequency(e);if(t==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());let s=t/100;this.gameObject.position.y=this._startPosition.y+s*.07}}$w(hc,"Avatar_MustacheShake");var Ww=Object.defineProperty,Hw=(i,e)=>Ww(i,"name",{value:e,configurable:!0});const zw=O("logstats");class dc extends v{onEnable(){console.log(this),zw&&this.startCoroutine(this.run(),Ce.OnAfterRender)}*run(){for(;this.enabled;){const e=this.context.renderer.info;console.log(e.memory,e.render,e.programs),yield}}}Hw(dc,"LogStats");var sp=Object.defineProperty,Gw=Object.getOwnPropertyDescriptor,uc=(i,e)=>sp(i,"name",{value:e,configurable:!0}),Vw=(i,e,t,s)=>{for(var n=s>1?void 0:s?Gw(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&sp(e,t,n),n};class Oo{constructor(){r(this,"guid")}}uc(Oo,"SignalAsset");class Co{constructor(){r(this,"signal");r(this,"reaction");r(this,"$serializedTypes",{signal:Oo,reaction:tt})}}uc(Co,"SignalReceiverEvent");class Rn extends v{constructor(){super(...arguments);r(this,"events")}start(){console.log(this)}invoke(e){if(!this.events||!Array.isArray(this.events))return;let t=typeof e=="object"?e.guid:e;for(const s of this.events)if(s.signal.guid===t)try{if(s.reaction){if(!s.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",s,this);continue}}else{console.warn("Missing reaction for signal",s,this);continue}s.reaction.invoke()}catch(n){console.error(n)}}}uc(Rn,"SignalReceiver");Vw([f(Co)],Rn.prototype,"events",2);var ze;(function(i){i.Activation="ActivationTrack",i.Animation="AnimationTrack",i.Audio="AudioTrack",i.Control="ControlTrack",i.Marker="MarkerTrack",i.Signal="SignalTrack"})(ze||(ze={}));var En;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(En||(En={}));var fc;(function(i){i.Signal="SignalEmitter"})(fc||(fc={}));var qw=Object.defineProperty,ps=(i,e)=>qw(i,"name",{value:e,configurable:!0});const So=O("debugtimeline");class An{constructor(){r(this,"director");r(this,"track")}get muted(){return this.track.muted}set muted(e){var t;e!==this.track.muted&&(this.track.muted=e,(t=this.onMuteChanged)==null||t.call(this))}*forEachClip(e=!1){var t;if(!!((t=this.track)==null?void 0:t.clips))if(e)for(let s=this.track.clips.length-1;s>=0;s--)yield this.track.clips[s];else for(const s of this.track.clips)yield s}getClipTime(e,t){return t.clipIn+(e-t.start)*t.timeScale}getClipTimeNormalized(e,t){return(e-t.start)/t.duration}evaluateWeight(e,t,s,n=!0){if(t<0||t>=s.length)return 0;const o=s[t];if(n||e>=o.start&&e<=o.end){let a=1,l=!1;return o.easeInDuration>0&&(a*=Math.min((e-o.start)/o.easeInDuration,1)),o.easeOutDuration>0&&!l&&(a*=Math.min((o.end-e)/o.easeOutDuration,1)),a}return 0}}ps(An,"TrackHandler");class np{constructor(e){r(this,"clip");r(this,"rootPositionOffset");r(this,"rootQuaternionOffset");r(this,"rootStartPosition");r(this,"rootEndPosition");r(this,"rootStartQuaternion");r(this,"rootEndQuaternion");const t=e.getClip();this.clip=t;const s=e.getRoot(),n=s.name+".position",o=s.name+".quaternion";So&&console.log(t.name,t.tracks,n);for(const a of t.tracks)if(!(a.times.length<=0)){if(a.name.endsWith(n))this.rootStartPosition=new y().fromArray(a.values,0),this.rootEndPosition=new y().fromArray(a.values,a.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),So&&console.log(this.rootPositionOffset);else if(a.name.endsWith(o)&&(this.rootStartQuaternion=new P().fromArray(a.values,0),this.rootEndQuaternion=new P().fromArray(a.values,a.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),So)){const l=new he().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}ps(np,"AnimationClipOffsetData");class Ro extends An{constructor(){super(...arguments);r(this,"models",[]);r(this,"trackOffset");r(this,"target");r(this,"mixer");r(this,"clips",[]);r(this,"actions",[]);r(this,"_actionOffsets",[]);r(this,"_didBind",!1);r(this,"_useclipOffsets",!0);r(this,"_totalOffsetPosition",new y);r(this,"_totalOffsetRotation",new P);r(this,"_totalOffsetPosition2",new y);r(this,"_totalOffsetRotation2",new P);r(this,"_summedPos",new y);r(this,"_tempPos",new y);r(this,"_summedRot",new P);r(this,"_tempRot",new P)}createHooks(e,t){var h;if(((h=t.tracks)==null?void 0:h.length)<=0){console.warn("No tracks in AnimationClip",t);return}const s=t.tracks[0].name.split("."),n=s[s.length-2],o=n+".position",a=n+".quaternion";let l=!1,c=!1;for(const d of t.tracks)d.name.endsWith(o)?(l=!0,this.createPositionInterpolant(t,e,d)):d.name.endsWith(a)&&(c=!0,this.createRotationInterpolant(t,e,d));if(!l){const d=t.tracks[0].name.lastIndexOf("."),u=t.tracks[0].name.substring(0,d)+".position",_=new p_(u,[0,t.duration],[0,0,0,0,0,0]);t.tracks.push(_),this.createPositionInterpolant(t,e,_)}if(!c){const d=t.tracks[0].name.lastIndexOf("."),u=t.tracks[0].name.substring(0,d)+".quaternion",_=new m_(u,[0,t.duration],[0,0,0,1,0,0,0,1]);t.tracks.push(_),this.createRotationInterpolant(t,e,_)}}bind(){if(!this._didBind){this._didBind=!0,So&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const e of this.actions){const t=new np(e);this._actionOffsets.push(t)}for(const e of this.models){const t=e.asset,s=t.position,n=t.rotation;s.x!==void 0&&(s.isVector3||(t.position=new y(s.x,s.y,s.z)),n.isQuaternion||(t.rotation=new P(n.x,n.y,n.z,n.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const e=this.trackOffset.position;e&&(e.isVector3||(this.trackOffset.position=new y(e.x,e.y,e.z)));const t=this.trackOffset.rotation;t&&(t.isQuaternion||(this.trackOffset.rotation=new P(t.x,t.y,t.z,t.w)))}}evaluate(e){if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let t=0,s=0,n=!1;for(let o=0;o<this.clips.length;o++){const a=this.models[o],l=this.actions[o],c=a.asset;l.weight=0;const h=e>=a.start&&e<=a.end,d=a.postExtrapolationMode;let u=h;if(!u&&!n&&a.end<e&&a.postExtrapolationMode!==En.None){const _=o<this.clips.length-1?this.models[o+1]:null;(!_||_.start>e)&&(u=!0,n=!0)}if(u){let _=1;_*=this.evaluateWeight(e,o,this.models,u);let b=this.getClipTime(e,a),w=0;const C=c.duration;if(h){if(c.loop)for(w+=Math.floor(b/(C+1e-6));b>C;)b-=C}else if(!h)switch(d){case En.Loop:b%=C;break;case En.PingPong:const M=Math.floor(b/C)%2!=0;b%=C,M&&(b=C-b);break}l.time=b,l.timeScale=0;const S=_*this.director.weight;if(l.weight=S,l.clampWhenFinished=!0,l.isRunning()||l.play(),this._useclipOffsets){const A=t==0?this._totalOffsetPosition:this._totalOffsetPosition2,M=t==0?this._totalOffsetRotation:this._totalOffsetRotation2;t<1&&(s=1-_),t+=1;const E=this._summedPos.set(0,0,0),T=this._tempPos.set(0,0,0),I=this._summedRot.identity(),ke=this._tempRot.identity(),Ie=c.rotation,se=new P;se.slerp(Ie,_);const Re=this._actionOffsets[o];if(Re.hasOffsets)for(let ht=0;ht<w;ht++)Re.rootPositionOffset?T.copy(Re.rootPositionOffset):T.set(0,0,0),T.applyQuaternion(I).applyQuaternion(se),Re.rootQuaternionOffset&&(ke.copy(Re.rootQuaternionOffset),I.multiply(ke)),E.add(T);M.multiply(se),M.multiply(I),E.add(c.position),A.add(E)}}}this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,s),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,s)),this.mixer.update(e)}createRotationInterpolant(e,t,s){var l;const n=s.createInterpolant.bind(s),o=new P;this.ensureTrackOffsets();const a=(l=this.trackOffset)==null?void 0:l.rotation;s.createInterpolant=()=>{const c=n(),h=c.evaluate.bind(c);return c.evaluate=d=>{const u=h(d);return o.set(u[0],u[1],u[2],u[3]),o.premultiply(this._totalOffsetRotation),a&&o.premultiply(a),u[0]=o.x,u[1]=o.y,u[2]=o.z,u[3]=o.w,u},c}}createPositionInterpolant(e,t,s){var h,d;const n=s.createInterpolant.bind(s),o=new y;this.ensureTrackOffsets();const a=(h=this.trackOffset)==null?void 0:h.rotation,l=(d=this.trackOffset)==null?void 0:d.position;let c;s.createInterpolant=()=>{const u=n(),_=u.evaluate.bind(u);return u.evaluate=b=>{var C,S;const w=_(b);return o.set(w[0],w[1],w[2]),t.removeStartOffset&&(c===void 0?(c=null,c=(S=(C=this._actionOffsets.find(A=>A.clip===e))==null?void 0:C.rootStartPosition)==null?void 0:S.clone()):(c==null?void 0:c.isVector3)&&o.sub(c)),o.applyQuaternion(this._totalOffsetRotation),o.add(this._totalOffsetPosition),a&&o.applyQuaternion(a),l&&(o.x-=l.x,o.y+=l.y,o.z+=l.z),w[0]=o.x,w[1]=o.y,w[2]=o.z,w},u}}}ps(Ro,"AnimationTrackHandler");class Eo extends An{constructor(){super(...arguments);r(this,"models",[]);r(this,"listener");r(this,"audio",[]);r(this,"audioContextTimeOffset",[]);r(this,"lastTime",0)}getAudioFilePath(e){const t=this.director.sourceId;return Qh(t,e)}onAllowAudioChanged(e){for(let t=0;t<this.models.length;t++){const s=this.models[t];this.audio[t].setVolume(e?s.asset.volume:0)}}addModel(e){const t=this.getAudioFilePath(e.asset.clip),s=new Rh(this.listener);s.setVolume(e.asset.volume);const n=new xa;console.log(t,this.director.sourceId),n.load(t,o=>{s.setBuffer(o),s.loop=e.asset.loop,this.audio.push(s),this.models.push(e)})}onDisable(){for(const e of this.audio)e.isPlaying&&e.stop()}onMuteChanged(){if(this.muted)for(let e=0;e<this.audio.length;e++){const t=this.audio[e];(t==null?void 0:t.isPlaying)&&t.stop()}}evaluate(e){if(!this.track.muted){for(let t=0;t<this.models.length;t++){const s=this.models[t],n=this.audio[t];if(e>=s.start&&e<=s.end){if(this.director.isPaused&&(n.isPlaying&&n.stop(),this.lastTime===e))continue;n.isPlaying||(n.offset=s.clipIn+(e-s.start)*s.timeScale,n.play());let o=s.asset.volume;s.easeInDuration>0&&(o*=Math.min((e-s.start)/s.easeInDuration,1)),s.easeOutDuration>0&&(o*=Math.min((s.end-e)/s.easeOutDuration,1)),n.setVolume(o*this.director.weight)}else n.isPlaying&&n.stop()}this.lastTime=e}}}ps(Eo,"AudioTrackHandler");class Tn extends An{constructor(){super(...arguments);r(this,"models",[]);r(this,"didTrigger",[]);r(this,"receivers",[])}evaluate(e){if(!(this.receivers.length<=0)&&!this.track.muted)for(let t=0;t<this.models.length;t++){const s=this.models[t],n=this.didTrigger[t],o=s.time-e;if(s.retroActive?o<0:o<0&&Math.abs(o)<.1){if(!n){this.didTrigger[t]=!0;for(const l of this.receivers)!l||l.invoke(s.asset)}}else s.emitOnce||(this.didTrigger[t]=!1)}}}ps(Tn,"SignalTrackHandler");const tr=class extends An{constructor(){super(...arguments);r(this,"models",[]);r(this,"timelines",[]);r(this,"_previousActiveModel",null)}resolveSourceObjects(e){for(let t=this.models.length-1;t>=0;t--){const n=this.models[t].asset;if(typeof n.sourceObject=="string"){const o=n.sourceObject;tr.resolved[o]?n.sourceObject=tr.resolved[o]:(n.sourceObject=p.findByGuid(o,e.scene),tr.resolved[o]=n.sourceObject)}if(n.sourceObject){const o=p.getComponent(n.sourceObject,gs);this.timelines.push(o),o&&n.updateDirector&&(o.playOnAwake=!1)}else{this.models.splice(t,1);continue}}}evaluate(e){var t;this._previousActiveModel=null;for(let s=0;s<this.models.length;s++){const n=this.models[s],o=n.asset;if(e>=n.start&&e<=n.end){this._previousActiveModel=n;const a=this.getClipTime(e,n);if(o.controlActivation){const l=o.sourceObject;l.visible=!0}if(o.updateDirector){const l=this.timelines[s];l&&(l.isPlaying&&l.pause(),l.time=a,l.evaluate())}}else{const a=(t=this._previousActiveModel)==null?void 0:t.asset;if(o.controlActivation){const l=o.sourceObject;(a==null?void 0:a.sourceObject)!==l&&(l.visible=!1)}}}}};let ms=tr;r(ms,"resolved",{});ps(ms,"ControlTrackHandler");var Qw=Object.defineProperty,Xw=(i,e)=>Qw(i,"name",{value:e,configurable:!0});const rp=O("debugtimeline");var op;(function(i){i[i.Hold=0]="Hold",i[i.Loop=1]="Loop",i[i.None=2]="None"})(op||(op={}));var ap;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(ap||(ap={}));const ua=class extends v{constructor(){super(...arguments);r(this,"playableAsset");r(this,"playOnAwake");r(this,"extrapolationMode",1);r(this,"_visibilityChangeEvt");r(this,"_clonedPlayableAsset",!1);r(this,"_guidsMap");r(this,"_isPlaying",!1);r(this,"_internalUpdateRoutine");r(this,"_isPaused",!1);r(this,"_time",0);r(this,"_duration",0);r(this,"_weight",1);r(this,"_animationTracks",[]);r(this,"_audioTracks",[]);r(this,"_signalTracks",[]);r(this,"_controlTracks",[]);r(this,"_customTracks",[]);r(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks])}static registerCreateTrack(e,t){this.createTrackFunctions[e]=t}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(e){this._time=e}get duration(){return this._duration}set duration(e){this._duration=e}get weight(){return this._weight}set weight(e){this._weight=e}awake(){var e,t,s;rp&&console.log(this,(e=this.playableAsset)==null?void 0:e.tracks),this.rebuildGraph(),this.playOnAwake?this.play():this.evaluate(),this.isValid()||console.warn("PlayableDirector is not valid",this.playableAsset,(t=this.playableAsset)==null?void 0:t.tracks,Array.isArray((s=this.playableAsset)==null?void 0:s.tracks),this)}onEnable(){var e,t;for(const s of this._audioTracks)(e=s.onEnable)==null||e.call(s);for(const s of this._customTracks)(t=s.onEnable)==null||t.call(s);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var e,t;this.stop();for(const s of this._audioTracks)(e=s.onDisable)==null||e.call(s);for(const s of this._customTracks)(t=s.onDisable)==null||t.call(s);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var e;for(const t of this._audioTracks)(e=t.onDestroy)==null||e.call(t)}rebuildGraph(){!this.isValid()||(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}play(){!this.isValid()||(this._isPaused=!1,!this._isPlaying&&(this._isPlaying=!0,this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate())))}pause(){this._isPaused=!0}stop(){this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.evaluate()),this._isPlaying=!1,this._isPaused=!1,this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null}evaluate(){if(!this.isValid())return;let e=this._time;switch(this.extrapolationMode){case 0:e=Math.min(e,this._duration);break;case 1:e%=this._duration;break;case 2:if(e>this._duration){this.stop();return}break}this.internalEvaluate(e)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const e of this._allTracks)for(const t of e)yield t}get audioTracks(){return this._audioTracks}resolveGuids(e){this._guidsMap=e}*internalUpdate(){for(;this._isPlaying;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime,this.evaluate()),yield}internalEvaluate(e){for(const t of this.playableAsset.tracks)if(!t.muted)switch(t.type){case ze.Activation:for(let s=0;s<t.outputs.length;s++){const n=t.outputs[s];if(typeof n=="object"){let o=!1;for(const l of t.clips)l.start<=e&&e<=l.end&&(o=!0);const a=n;a.visible!==void 0&&(a.visible=o)}}break}for(const t of this._animationTracks)t.evaluate(e);for(const t of this._audioTracks)t.evaluate(e);for(const t of this._signalTracks)t.evaluate(e);for(const t of this._controlTracks)t.evaluate(e);for(const t of this._customTracks)t.evaluate(e)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=or(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const e=this.findRoot(this.gameObject);for(const t of this.playableAsset.tracks)for(let s=t.outputs.length-1;s>=0;s--){let n=t.outputs[s];if(typeof n=="string"){this._guidsMap&&this._guidsMap[n]&&(n=this._guidsMap[n]);const o=p.findByGuid(n,e);o===null||typeof o!="object"?(t.outputs.splice(s,1),console.warn("Failed to resolve binding",n,t.name,t.type)):(rp&&console.log("Resolved binding",n,"to",o),t.outputs[s]=o)}else if(n===null){if(t.outputs.splice(s,1),ua.createTrackFunctions[t.type])continue;t.type!==ze.Audio&&t.type!==ze.Control&&t.type!==ze.Marker&&console.warn("Missing binding",n,t.name,t.type,this.name,this.playableAsset.name)}}}findRoot(e){return e.parent?this.findRoot(e.parent):e}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const e of this.playableAsset.tracks)if(e.muted!==!0)for(const t of e.clips)t.end>this._duration&&(this._duration=t.end)}}setupAndCreateTrackHandlers(){var t,s;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;const e=[];for(const n of this.playableAsset.tracks){const o=n.type,a=ua.createTrackFunctions[o];if(a!=null){const l=a(this,n);if(typeof l.evaluate=="function"){l.director=this,l.track=n,this._customTracks.push(l);continue}}if(n.type===ze.Animation){if(n.clips.length<=0)continue;for(let l=n.outputs.length-1;l>=0;l--){const c=n.outputs[l];typeof c.enabled=="boolean"&&(c.enabled=!1);const h=(t=c==null?void 0:c.gameObject)==null?void 0:t.animations;if(h){const d=new Ro;d.trackOffset=n.trackOffset,d.director=this,d.track=n;for(let u=0;u<n.clips.length;u++){const _=n.clips[u],b=_.asset;if(!b){console.error("MISSING anim model?","clip#"+u,_,n,this.playableAsset,this.name);continue}const w=b.clip;let C=w;if((typeof C=="string"||typeof C=="number")&&(C=h.find(A=>A.name===w)),!C){console.warn("Could not find animationClip for model",_,n.name,this.name,(s=this.playableAsset)==null?void 0:s.name);continue}d.mixer||(d.mixer=new Pa(c.gameObject)),d.clips.push(C),d.mixer.uncacheAction(C),d.createHooks(_.asset,C);const S=d.mixer.clipAction(C);d.actions.push(S),d.models.push(_)}this._animationTracks.push(d)}}}else if(n.type===ze.Audio){if(n.clips.length<=0)continue;e.push(n)}else if(n.type===ze.Marker){const l=new Tn;l.director=this,l.track=n;for(const c of n.markers)switch(c.type){case fc.Signal:l.models.push(c),l.didTrigger.push(!1);break}if(l!==null&&l.models.length>0){const c=p.getComponent(this.gameObject,Rn);c&&(l.receivers.push(c),this._signalTracks.push(l))}}else if(n.type===ze.Signal){const l=new Tn;l.director=this,l.track=n;for(const c of n.markers)l.models.push(c),l.didTrigger.push(!1);for(const c of n.outputs)l.receivers.push(c);this._signalTracks.push(l)}else if(n.type===ze.Control){const l=new ms;l.director=this,l.track=n;for(const c of n.clips)l.models.push(c);l.resolveSourceObjects(this.context),this._controlTracks.push(l)}}ae.registerWaitForAllowAudio(()=>{const n=p.findObjectOfType(Zi,this.context);if(!!n)for(const o of e){const a=new Eo;a.director=this,a.track=o,a.listener=n.listener;for(let l=0;l<o.clips.length;l++){const c=o.clips[l];a.addModel(c)}this._audioTracks.push(a)}})}setAudioTracksAllowPlaying(e){for(const t of this._audioTracks)t.onAllowAudioChanged(e)}};let gs=ua;r(gs,"createTrackFunctions",{});Xw(gs,"PlayableDirector");var Yw=Object.defineProperty,Jw=(i,e)=>Yw(i,"name",{value:e,configurable:!0});class yi{constructor(e){r(this,"used",!1);r(this,"inputSource");r(this,"object");r(this,"isDown");r(this,"isUp");r(this,"isPressed");r(this,"isClicked");r(this,"event");this.event=e}Use(){this.used=!0}StopPropagation(){var e;(e=this.event)==null||e.stopImmediatePropagation()}}Jw(yi,"PointerEventData");var Zw=Object.defineProperty,lp=(i,e)=>Zw(i,"name",{value:e,configurable:!0});const Kw=O("debugeventsystem"),ct=class extends v{constructor(){super();r(this,"orbitControl",null);r(this,"orbitControlWasEnabled",!1);r(this,"raycaster",[]);r(this,"lastPointerEvent",null);r(this,"objectsHoveredThisFrame",[]);r(this,"objectsHoveredLastFrame",[]);r(this,"raisedPointerDownEvents",[]);r(this,"_didMove",!1);r(this,"_tempComponentsArray",[]);r(this,"_sortedHits",[]);r(this,"_sortingBuffer",[]);r(this,"_noDepthTestingResults",[]);r(this,"handleEventsArray",[]);r(this,"currentActiveMeshUIComponents",[]);ct.systems.push(this)}static createIfNoneExists(e){this.didSearchEventSystem||(this.didSearchEventSystem=!0,ct.systems.length<=0&&ct.systems.push(...p.findObjectsOfType(ct,e)));for(const s of ct.systems)if(s.context===e)return;const t=new x;p.addNewComponent(t,ct),e.scene.add(t)}static ensureUpdateMeshUI(e,t){st.update(e,t)}static markUIDirty(e){st.markDirty()}static get instance(){return this.systems[0]}onDestroy(){ct.systems.splice(ct.systems.indexOf(this),1)}start(){}register(e){var t;e&&this.raycaster&&!this.raycaster.includes(e)&&((t=this.raycaster)==null||t.push(e))}unregister(e){var s,n;const t=(s=this.raycaster)==null?void 0:s.indexOf(e);t!==void 0&&t!==-1&&((n=this.raycaster)==null||n.splice(t,1))}onEnable(){U.addEventListener(we.SelectStart,(t,s)=>{if(!s.grab)return;st.resetLastSelected();const n=new yi;n.inputSource=t,n.isDown=t.selectionDown,n.isUp=t.selectionUp,n.isPressed=t.selectionPressed,n.isClicked=!1,s.grab&&!this.handleEvents(s.grab,n)&&(s.grab=null)});const e=new Xe;U.addEventListener(we.SelectEnd,(t,s)=>{if(!s.grab)return;const n=new yi;n.inputSource=t,n.isDown=t.selectionDown,n.isUp=t.selectionUp,n.isPressed=t.selectionPressed,n.isClicked=t.selectionClick,this.handleEvents(s.grab,n)}),U.addEventListener(we.Update,t=>{e.ray=t.getRay();const s=this.performRaycast(e);if(!s)return;const n=new yi;n.inputSource=t,this.handleIntersections(s,n)}),this.context.pre_update_callbacks.push(this.onBeforeUpdate.bind(this)),this.context.input.addEventListener(gr.PointerDown,this.onPointerDown.bind(this))}onDisable(){}onPointerDown(){this.onBeforeUpdate()}onBeforeUpdate(){var n,o;if(this.objectsHoveredThisFrame.length=0,this.resetMeshUIStates(),D.IsInWebXR||this.context.input.isKeyPressed(pt.ALT))return;if(!this._didMove){const a=this.context.input.getPointerPositionRC(0);if(a&&a.x===0&&a.y===0)return;this._didMove=!0}const e=this.performRaycast(null),t=new yi(this.context.input.getPointerEvent(0));if(t.inputSource=this.context.input,t.isClicked=this.context.input.mouseClick,t.isDown=this.context.input.mouseDown,t.isUp=this.context.input.mouseUp,t.isPressed=this.context.input.mousePressed,this.lastPointerEvent=t,!e)return;let s=null;this.context.input.mouseDown&&this.currentActiveMeshUIComponents.length>0&&this.context.mainCameraComponent&&(s=(n=p.getComponent(this.context.mainCameraComponent.gameObject,Mt))!=null?n:null,s&&(s.enabled,s.enabled=!1)),this.handleIntersections(e,t),s&&(this.orbitControl=s,((o=this.orbitControl)==null?void 0:o.enabled)?(this.orbitControlWasEnabled=this.orbitControl.enabled,this.orbitControl.enabled=!1):this.orbitControl&&!this.context.input.mousePressed&&(this.orbitControl.enabled=this.orbitControlWasEnabled,this.orbitControl=null))}onBeforeRender(){if(this.lastPointerEvent)this.lastPointerEvent.used=!1;else return;if(this.lastPointerEvent.isUp){for(const t of this.raisedPointerDownEvents)t.onPointerUp&&t.onPointerUp(this.lastPointerEvent);this.raisedPointerDownEvents.length=0}for(const t of this.objectsHoveredLastFrame)if(this.objectsHoveredThisFrame.indexOf(t)<0){this._tempComponentsArray.length=0;const s=p.getComponentsInParent(t,v,this._tempComponentsArray);this.lastPointerEvent.object=t;for(let n=0;n<s.length;n++){const o=s[n];if(!o.gameObject||o.destroyed)continue;const a=o;a.onPointerExit&&a.onPointerExit(this.lastPointerEvent)}}const e=this.objectsHoveredLastFrame;this.objectsHoveredLastFrame=this.objectsHoveredThisFrame,this.objectsHoveredThisFrame=e}performRaycast(e){if(!this.raycaster)return null;this._sortedHits.length=0;for(const t of this.raycaster){if(!t.activeAndEnabled)continue;const s=t.performRaycast(e);s&&s.length>0&&this._sortedHits.push(...s)}return this._sortedHits.sort((t,s)=>t.distance-s.distance),this._sortedHits}handleIntersections(e,t){if(!e||e.length<=0)return!1;e=this.sortCandidates(e);for(const s of e){const{object:n}=s;if(this.handleEvents(n,t))return!0}return!1}sortCandidates(e){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let t=0;t<e.length;t++){const s=e[t],n=s.object;if(n.material&&n.material.depthTest===!1){this._noDepthTestingResults.push(s);continue}this._sortingBuffer.push(s)}for(const t of this._sortingBuffer)this._noDepthTestingResults.push(t);return this._noDepthTestingResults}handleEvents(e,t){var a,l;if(!this.testIsVisible(e))return t.isClicked&&Kw&&console.log("not allowed",e),!1;t.object=e,this.lastPointerEvent=t;const s=e.parent;let n=!1;(a=t.isClicked)!=null;let o=null;if(s&&s.isUI){const c=(l=t.isPressed||t.isClicked)!=null?l:!1;if(s.shadowComponentOwner){const h=s.shadowComponentOwner.gameObject;if(h){if(o=this.tryFindCanvasGroup(h),(o==null?void 0:o.blocksRaycasts)===!1)return!1;if((o==null?void 0:o.interactable)===!1)return!0;this.handleMeshUIIntersection(e,c),e=h,n=!0}}if(!n&&this.handleMeshUiObjectWithoutShadowDom(s,c))return!0}if(this.objectsHoveredThisFrame.push(e),o===null||o.interactable){const c=this.objectsHoveredLastFrame.indexOf(e)>=0;this.handleEventsArray.length=0;const h=p.getComponentsInParent(e,v,this.handleEventsArray);for(let d=0;d<h.length;d++){if(t.used)return!0;if(h[d].destroyed)continue;const u=h[d];u.interactable!==!1&&(u.onPointerEnter&&(c||u.onPointerEnter(t)),t.isDown&&u.onPointerDown&&!this.raisedPointerDownEvents.includes(u)&&(u.onPointerDown(t),this.raisedPointerDownEvents.push(u)),t.isUp&&u.onPointerUp&&u.onPointerUp(t),t.isClicked&&u.onPointerClick&&u.onPointerClick(t))}}return!0}handleMeshUiObjectWithoutShadowDom(e,t){return!e||!e.isUI?!0:this.handleMeshUIIntersection(e,t)}handleMeshUIIntersection(e,t){const s=st.updateState(e,t);return s&&this.currentActiveMeshUIComponents.push(s),s!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&st.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let e=0;e<this.currentActiveMeshUIComponents.length;e++){const t=this.currentActiveMeshUIComponents[e];st.resetState(t)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(e){return e?p.isActiveSelf(e)?this.testIsVisible(e.parent):!1:!0}tryFindCanvasGroup(e){if(!e)return null;const t=p.foreachComponent(e,s=>{const n=s;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n},!1);return t!==void 0?t:this.tryFindCanvasGroup(e.parent)}};let Ge=ct;r(Ge,"didSearchEventSystem",!1),r(Ge,"systems",[]);lp(Ge,"EventSystem");class st{static markDirty(){this.needsUpdate=!0}static update(e,t){for(const s of this.lastUpdateFrame)if(s.context===t){if(t.time.frameCount===s.frame)return;s.frame=t.time.frameCount,(this.needsUpdate||t.time.frameCount<30)&&(this.needsUpdate=!1,e.update());return}this.lastUpdateFrame=[{context:t,frame:t.time.frameCount}],e.update()}static updateState(e,t){let s=null;if(e&&(s=this.findBlockInParent(e),s&&s!==this.lastSelected)){if(s.interactable===!1)return null;t?(this.lastSelected=s,s.states.pressed&&s.setState("pressed")):s.states.hovered&&s.setState("hovered"),this.needsUpdate=!0}return s}static resetLastSelected(){const e=this.lastSelected;!e||(this.lastSelected=null,this.resetState(e))}static resetState(e){if(!e)return;e.interactable===!1?e.states.disabled&&e.setState("disabled"):e===this.lastSelected&&e.states.selected?e.setState("selected"):e.setState("normal"),this.needsUpdate=!0}static findBlockInParent(e){return e?e.isBlock&&Object.keys(e.states).length>0?e:this.findBlockInParent(e.parent):null}}r(st,"lastSelected",null),r(st,"lastUpdateFrame",[]),r(st,"needsUpdate",!1);lp(st,"MeshUIHelper");var e0=Object.defineProperty,cp=(i,e)=>e0(i,"name",{value:e,configurable:!0});const vi="./include";jh.prototype.interactable={get(){return this.interactive},set(i){this.interactable=i}};class nt extends v{constructor(){super(...arguments);r(this,"shadowComponent",null);r(this,"_controlsChildLayout",!0);r(this,"_root");r(this,"_parentComponent")}isRoot(){var e;return((e=this.Root)==null?void 0:e.gameObject)===this.gameObject}markDirty(){Ge.markUIDirty(this.context)}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(e){this._controlsChildLayout=e,this.shadowComponent&&(this.shadowComponent.autoLayout=e)}get Root(){return this._root===void 0&&(this._root=p.getComponentInParent(this.gameObject,Ln)),this._root}onEnable(){super.onEnable()}addShadowComponent(e,t){var o;this.removeShadowComponent();const s=this.isRoot()?this.gameObject:this.gameObject.parent;if(this._parentComponent=p.getComponentInParent(s,nt),!this._parentComponent){console.warn(`Component "${this.name}" doesn't have a UI parent anywhere. Do you have a UI element outside a Canvas?`,this);return}e.name=this.name+" (UI)",e.autoLayout=this._parentComponent.controlsChildLayout,e.shadowComponentOwner=this;const n=this.raycastTarget;if(e.traverse(a=>{a.shadowComponentOwner||(a.shadowComponentOwner=this),n===!1&&a.layers.set(2)}),((o=this.Root)==null?void 0:o.gameObject)===this.gameObject)this.gameObject.add(e);else{let a=this._parentComponent.shadowComponent;a&&(a==null||a.add(e))}this.shadowComponent=e,t&&t.shadowComponent&&this.shadowComponent&&t.shadowComponent.add(this.shadowComponent),Ks&&e.add(new sr(.5)),this.onAfterAddedToScene()}traverseOwnedShadowComponents(e,t,s){if(!!e&&e.shadowComponentOwner===t){console.log(e),s(e);for(const n of e.children)this.traverseOwnedShadowComponents(n,t,s)}}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}setInteractable(e){this.shadowComponent&&(this.shadowComponent.interactable=e)}}cp(nt,"BaseUIComponent");class Ln extends nt{awake(){super.awake()}}cp(Ln,"UIRootComponent");var t0=Object.defineProperty,Ao=(i,e)=>t0(i,"name",{value:e,configurable:!0});function Dn(i,e){var s,n;if(!i)return;const t=i.material;(t==null?void 0:t.isMaterial)===!0&&(t.depthTest=!e.renderOnTop,t.side=((s=e.doubleSided)!=null?s:!0)?Sa:Ra,t.depthWrite=(n=e.depthWrite)!=null?n:!1);for(const o of i.children)Dn(o,e)}Ao(Dn,"updateRenderSettings");function pc(i,e,t){i[e]===void 0&&console.warn("Field",e,"is undefined on",i),i[e]=new Proxy(i[e],{set(s,n,o,a){const l=s[n],c=Reflect.set(s,n,o,a);return t(o,l),c}})}Ao(pc,"onChange");function hp(i,e,t=Ce.OnBeforeRender){let s=i.__scheduledActions;s||(s=i.__scheduledActions={});const n=e.name;s[t]||(s[t]={});const o=s[t];if(o[n])return;function*l(){e==null||e.call(i),o[n]=null}Ao(l,"gen");const c=i.startCoroutine(l(),t);o[n]=c}Ao(hp,"scheduleAction");var dp=Object.defineProperty,i0=Object.getOwnPropertyDescriptor,mc=(i,e)=>dp(i,"name",{value:e,configurable:!0}),To=(i,e,t,s)=>{for(var n=s>1?void 0:s?i0(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&dp(e,t,n),n};const up=O("debugui");class gc{constructor(){r(this,"width");r(this,"height")}}mc(gc,"Size");class Lo{constructor(){r(this,"x");r(this,"y");r(this,"width");r(this,"height")}}mc(Lo,"Rect");class Rt extends nt{constructor(){super(...arguments);r(this,"offset",.01);r(this,"_anchoredPosition");r(this,"rect");r(this,"sizeDelta");r(this,"anchoredPosition3D");r(this,"pivot");r(this,"lastMatrix");r(this,"rectBlock");r(this,"_transformNeedsUpdate",!1)}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get anchoredPosition(){return this._anchoredPosition||(this._anchoredPosition=new y),this._anchoredPosition}awake(){super.awake(),this.lastMatrix=new Be,this.rectBlock=new x,this.rectBlock.position.z=.1,this.rectBlock.name=this.name,this._anchoredPosition||(this._anchoredPosition=new y),pc(this,"_anchoredPosition",()=>{this._transformNeedsUpdate=!0})}onEnable(){super.onEnable(),this.addShadowComponent(this.rectBlock),this.applyTransform()}onDisable(){super.onDisable(),this.removeShadowComponent()}applyTransform(){const e=this.shadowComponent;!e||(this._transformNeedsUpdate=!1,this.isRoot()?e.rotation.y=Math.PI:(e.position.copy(this.gameObject.position),e.position.x*=-1,e.position.z*=-1,e.position.z-=this.offset,e.quaternion.copy(this.gameObject.quaternion),e.rotation.x*=-1,e.rotation.z*=-1,e.scale.copy(this.gameObject.scale)),this.applyAnchoring(e.position),this.lastMatrix.copy(this.gameObject.matrix))}onBeforeRender(){(this._transformNeedsUpdate||this.lastMatrix.equals(this.gameObject.matrix)===!1)&&(up&&console.log("updating",this.name),this.applyTransform()),Ge.ensureUpdateMeshUI(g_,this.context)}applyAnchoring(e){if(this.pivot&&this.sizeDelta){let t=this.pivot.x*2-1,s=this.pivot.y*2-1;s-=this.anchoredPosition.y*.05;const n=this.sizeDelta.x*t,o=this.sizeDelta.y*s;e.x-=n*.5,e.y-=o*.5}}getBasicOptions(){const e={width:this.rect.width,height:this.rect.height,offset:this.offset,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0};return this.ensureValidSize(e),e}ensureValidSize(e,t=1e-4){return e.width<=0&&(e.width=t),e.height<=0&&(e.height=1e-4),e}createNewBlock(e){return e=dt(dt({},this.getBasicOptions()),e),up&&console.log(this.name,e),new jh(e)}}mc(Rt,"RectTransform");To([f(Lo)],Rt.prototype,"rect",2);To([f(Q)],Rt.prototype,"sizeDelta",2);To([f(y)],Rt.prototype,"anchoredPosition3D",2);To([f(Q)],Rt.prototype,"pivot",2);var fp=Object.defineProperty,s0=Object.getOwnPropertyDescriptor,pp=(i,e)=>fp(i,"name",{value:e,configurable:!0}),mp=(i,e,t,s)=>{for(var n=s>1?void 0:s?s0(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&fp(e,t,n),n};class Qt extends nt{constructor(){super(...arguments);r(this,"raycastTarget",!0);r(this,"uiObject",null);r(this,"_color",null);r(this,"_rect",null);r(this,"_currentlyCreatingPanel",!1)}get color(){return this._color||(this._color=new fe(1,1,1,1)),this._color}set color(e){(!this._color||this._color.r!==e.r||this._color.g!==e.g||this._color.b!==e.b||this._color.alpha!==e.alpha)&&(this._color||(this._color=new fe(1,1,1,1)),this._color.copy(e))}onColorChanged(){const e=this.color;this.setOptions({backgroundColor:e,backgroundOpacity:e.alpha,borderOpacity:e.alpha})}get m_Color(){return this._color}get rectTransform(){return this._rect||(this._rect=this.gameObject.getComponent(Rt)),this._rect}setState(e){this.makePanel(),this.uiObject&&this.uiObject.setState(e)}setupState(e){this.makePanel(),this.uiObject&&this.uiObject.setupState(e)}setOptions(e){var t;this.makePanel(),this.uiObject&&(this.uiObject.set(e),(e.backgroundColor!==void 0||e.backgroundOpacity!==void 0)&&((t=this.uiObject.updateBackgroundMaterial)==null||t.call(this.uiObject)))}awake(){super.awake(),this.makePanel(),pc(this,"_color",()=>hp(this,this.onColorChanged))}onEnable(){super.onEnable(),this.uiObject&&this.addShadowComponent(this.uiObject,this.rectTransform)}onDisable(){super.onDisable(),this.uiObject&&this.removeShadowComponent()}makePanel(){if(this.uiObject||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const e={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:1};this.onBeforeCreate(e),this.onCreate(e),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated()}onBeforeCreate(e){}onCreate(e){this.uiObject=this.rectTransform.createNewBlock(e),this.uiObject.name=this.name}onAfterCreated(){}async setTexture(e){!e||(this.setOptions({backgroundOpacity:0}),e&&this.setOptions({backgroundTexture:e,borderRadius:0,backgroundOpacity:this.color.alpha,backgroundSize:"stretch"}))}onAfterAddedToScene(){this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}}pp(Qt,"Graphic");mp([f(fe)],Qt.prototype,"color",1);mp([f()],Qt.prototype,"raycastTarget",2);class kn extends Qt{onAfterCreated(){this.uiObject&&(this.uiObject.scale.y*=-1)}}pp(kn,"MaskableGraphic");var gp=Object.defineProperty,n0=Object.getOwnPropertyDescriptor,_c=(i,e)=>gp(i,"name",{value:e,configurable:!0}),bc=(i,e,t,s)=>{for(var n=s>1?void 0:s?n0(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&gp(e,t,n),n};class yc{constructor(){r(this,"texture");r(this,"rect")}}_c(yc,"Sprite");bc([f(Hi)],yc.prototype,"texture",2);class In extends kn{constructor(){super(...arguments);r(this,"sprite")}onBeforeCreate(e){var t,s;((s=(t=this.sprite)==null?void 0:t.texture)==null?void 0:s.name)=="UISprite"&&(e.borderRadius=5,e.borderColor=new g(.4,.4,.4),e.borderOpacity=this.color.alpha,e.borderWidth=.3)}onAfterCreated(){var e,t,s;super.onAfterCreated(),((t=(e=this.sprite)==null?void 0:e.texture)==null?void 0:t.name)!="UISprite"&&this.setTexture((s=this.sprite)==null?void 0:s.texture)}}_c(In,"Image");bc([f(yc)],In.prototype,"sprite",2);class Do extends kn{constructor(){super(...arguments);r(this,"mainTexture")}onAfterCreated(){super.onAfterCreated(),this.setTexture(this.mainTexture)}}_c(Do,"RawImage");bc([f(Hi)],Do.prototype,"mainTexture",2);var _p=Object.defineProperty,r0=Object.getOwnPropertyDescriptor,o0=(i,e)=>_p(i,"name",{value:e,configurable:!0}),_s=(i,e,t,s)=>{for(var n=s>1?void 0:s?r0(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&_p(e,t,n),n};const bs=O("debugbutton");var bp;(function(i){i[i.None=0]="None",i[i.ColorTint=1]="ColorTint",i[i.SpriteSwap=2]="SpriteSwap",i[i.Animation=3]="Animation"})(bp||(bp={}));class Et extends v{constructor(){super(...arguments);r(this,"onClick");r(this,"_isHovered",!1);r(this,"colors");r(this,"transition");r(this,"animationTriggers");r(this,"animator");r(this,"_interactable",!0);r(this,"_requestedAnimatorTrigger");r(this,"_isInit",!1);r(this,"_image")}onPointerEnter(e){var t,s;bs&&console.log("Button Enter",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this._isHovered=!0,this.transition==3&&this.animationTriggers&&this.animator?this.animator.SetTrigger(this.animationTriggers.highlightedTrigger):this.transition===1&&this.colors&&((s=this._image)==null||s.setState("hovered"))}onPointerExit(){var e,t;bs&&console.log("Button Exit",(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this._isHovered=!1,this.transition==3&&this.animationTriggers&&this.animator?this.animator.SetTrigger(this.animationTriggers.normalTrigger):this.transition===1&&this.colors&&((t=this._image)==null||t.setState("normal"))}onPointerDown(e){var t,s;bs&&console.log("Button Down",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator?this.animator.SetTrigger(this.animationTriggers.pressedTrigger):this.transition===1&&this.colors&&((s=this._image)==null||s.setState("pressed"))}onPointerUp(e){var t,s;bs&&console.log("Button Down",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator?this.animator.SetTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger):this.transition===1&&this.colors&&((s=this._image)==null||s.setState(this._isHovered?"hovered":"normal"))}onPointerClick(e){var t;bs&&console.trace("Button Click",this.onClick),(t=this.onClick)==null||t.invoke()}set interactable(e){this._interactable=e,this._image&&(this._image.setInteractable(e),e?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(e){this.interactable=e}awake(){super.awake(),bs&&console.log(this),this.init()}start(){var e;(e=this._image)==null||e.setInteractable(this.interactable)}onEnable(){super.onEnable()}*setAnimatorTriggerAtEndOfFrame(e){var t;this._requestedAnimatorTrigger=e,yield,yield,this._requestedAnimatorTrigger==e&&((t=this.animator)==null||t.SetTrigger(e))}init(){this._isInit||(this._isInit=!0,this._image=p.getComponent(this.gameObject,In),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(e){var _,b,w,C,S;e.setInteractable(this.interactable);const t=this.getFinalColor(e.color,(_=this.colors)==null?void 0:_.normalColor),s={state:"normal",attributes:{backgroundColor:t,backgroundOpacity:t.alpha}};e.setupState(s);const n=this.getFinalColor(e.color,(b=this.colors)==null?void 0:b.highlightedColor),o={state:"hovered",attributes:{backgroundColor:n,backgroundOpacity:n.alpha}};e.setupState(o);const a=this.getFinalColor(e.color,(w=this.colors)==null?void 0:w.pressedColor),l={state:"pressed",attributes:{backgroundColor:a,backgroundOpacity:a.alpha}};e.setupState(l);const c=this.getFinalColor(e.color,(C=this.colors)==null?void 0:C.selectedColor),h={state:"selected",attributes:{backgroundColor:c,backgroundOpacity:c.alpha}};e.setupState(h);const d=this.getFinalColor(e.color,(S=this.colors)==null?void 0:S.disabledColor),u={state:"disabled",attributes:{backgroundColor:d,backgroundOpacity:d.alpha}};e.setupState(u)}getFinalColor(e,t){return t?e.clone().multiply(t):e.clone()}}o0(Et,"Button");_s([f(tt)],Et.prototype,"onClick",2);_s([f()],Et.prototype,"colors",2);_s([f()],Et.prototype,"transition",2);_s([f()],Et.prototype,"animationTriggers",2);_s([f(_t)],Et.prototype,"animator",2);_s([f()],Et.prototype,"interactable",1);var yp=Object.defineProperty,a0=Object.getOwnPropertyDescriptor,l0=(i,e)=>yp(i,"name",{value:e,configurable:!0}),ko=(i,e,t,s)=>{for(var n=s>1?void 0:s?a0(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&yp(e,t,n),n};const vc=class extends Ln{constructor(){super(...arguments);r(this,"_renderOnTop",!1);r(this,"_depthWrite",!1);r(this,"_doubleSided",!0);r(this,"_rootCanvas");r(this,"_updateRenderSettingsRoutine")}set renderOnTop(i){i!==this._renderOnTop&&(this._renderOnTop=i,this.onRenderSettingsChanged())}get renderOnTop(){return this._renderOnTop}set depthWrite(i){this._depthWrite!==i&&(this._depthWrite=i,this.onRenderSettingsChanged())}get depthWrite(){return this._depthWrite}set doubleSided(i){this._doubleSided!==i&&(this._doubleSided=i,this.onRenderSettingsChanged())}get doubleSided(){return this._doubleSided}set rootCanvas(i){this._rootCanvas instanceof vc||(this._rootCanvas=i)}get rootCanvas(){return this._rootCanvas}awake(){this.shadowComponent=this.gameObject,super.awake()}onEnable(){super.onEnable(),this._updateRenderSettingsRoutine=void 0,this.onRenderSettingsChanged()}onRenderSettingsChanged(){this._updateRenderSettingsRoutine||(this._updateRenderSettingsRoutine=this.startCoroutine(this._updateRenderSettingsDelayed(),Ce.OnBeforeRender))}*_updateRenderSettingsDelayed(){if(yield,this._updateRenderSettingsRoutine=void 0,this.shadowComponent){Dn(this.shadowComponent,this);for(const i of this.gameObject.getComponentsInChildren(nt))Dn(i.shadowComponent,this)}}};let Xt=vc;l0(Xt,"Canvas");ko([f()],Xt.prototype,"renderOnTop",1);ko([f()],Xt.prototype,"depthWrite",1);ko([f()],Xt.prototype,"doubleSided",1);ko([f(vc)],Xt.prototype,"rootCanvas",1);var c0=Object.defineProperty,h0=(i,e)=>c0(i,"name",{value:e,configurable:!0});class wc extends v{constructor(){super(...arguments);r(this,"_alpha",1);r(this,"interactable",!0);r(this,"blocksRaycasts",!0);r(this,"_isDirty",!1);r(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(e){e!==this._alpha&&(this._alpha=e,this.markDirty())}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),Ce.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){for(const e of p.getComponentsInChildren(this.gameObject,Qt,this._buffer)){const t=e.color;t.alpha=this._alpha,e.color=t}}}h0(wc,"CanvasGroup");var d0=Object.defineProperty,u0=(i,e)=>d0(i,"name",{value:e,configurable:!0}),Pc;(function(i){i[i.fr=0]="fr",i[i.ru=1]="ru",i[i.de=2]="de",i[i.es=3]="es",i[i.el=4]="el",i[i.nord=5]="nord",i[i.eng=6]="eng"})(Pc||(Pc={}));class xc extends nt{constructor(){super(...arguments);r(this,"font");r(this,"text");r(this,"keymap");r(this,"padding");r(this,"margin");r(this,"fontSize");r(this,"borderRadius");r(this,"colors",{keyboardBack:8750469,panelBack:2500134,button:3552822,hovered:1842204,selected:1088605});r(this,"keyboard",null);r(this,"_lastKeyPressed");r(this,"_lastKeyPressedStartTime",0);r(this,"_lastKeyPressedTime",0)}awake(){super.awake();const e=Pc[this.keymap||6];this.makeKeyboard(e)}onEnable(){this.addShadowComponent(this.keyboard)}onDisable(){this.removeShadowComponent()}makeKeyboard(e){!e&&!navigator.language&&(e="en");const t=this.font?this.font:"arial",s=this.gameObject.getComponent(Rt);if(!s){console.error("Missing rect transform, please add this component inside a canvas");return}const n=_a(dt({},s.getBasicOptions()),{margin:this.margin||0,padding:this.padding||0,language:e,fontFamily:vi+"/"+t+"-msdf.json",fontTexture:vi+"/"+t+".png",fontSize:this.fontSize||6,backgroundColor:new g(this.colors.keyboardBack),backspaceTexture:vi+"/backspace.png",shiftTexture:vi+"/shift.png",enterTexture:vi+"/enter.png",borderRadius:this.borderRadius||0,autoLayout:!1}),o=this.gameObject.scale;n.width*=this.gameObject.scale.x,n.height*=this.gameObject.scale.y,n.fontSize*=Math.max(o.x,o.y),this.keyboard=new __(n),this.gameObject.scale.set(1,1,1),this.keyboard.keys.forEach(a=>{a.setupState({state:"normal",attributes:{offset:.003,backgroundColor:new g(this.colors.button),backgroundOpacity:1}}),a.setState("normal"),a.setupState({state:"hovered",attributes:{offset:.3,backgroundColor:new g(this.colors.hovered),backgroundOpacity:1}}),a.setupState({state:"pressed",attributes:{offset:.1,backgroundColor:new g(this.colors.selected),backgroundOpacity:1},onSet:()=>{var h,d,u;const l=a.info.input,c=a.info.command;if(this._lastKeyPressed!==l)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedTime>.05)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedStartTime<.5||c=="switch"||c=="shift"||c=="switch-set"){this._lastKeyPressedTime=this.context.time.time;return}if(this._lastKeyPressedTime=this.context.time.time,this._lastKeyPressed=l,c)switch(c){case"switch":this.keyboard.setNextPanel();break;case"switch-set":this.keyboard.setNextCharset();break;case"enter":this.tryAppend(`
`);break;case"space":this.tryAppend(" ");break;case"backspace":if(!((d=(h=this.text)==null?void 0:h.text)==null?void 0:d.length))break;((u=this.text)==null?void 0:u.text)&&(this.text.text=this.text.text.substring(0,this.text.text.length-1)||"");break;case"shift":this.keyboard.toggleCase();break}else a.info.input!==void 0&&this.tryAppend(a.info.input)}})})}tryAppend(e){this.text&&(this.text.text+=e,this.markDirty())}}u0(xc,"Keyboard");var f0=Object.defineProperty,Io=(i,e)=>f0(i,"name",{value:e,configurable:!0});class ys extends v{constructor(){super(...arguments);r(this,"reverseArrangement",!1)}}Io(ys,"LayoutGroup");class Oc extends ys{}Io(Oc,"VerticalLayoutGroup");class Cc extends ys{}Io(Cc,"HorizontalLayoutGroup");class Sc extends ys{}Io(Sc,"GridLayoutGroup");var p0=Object.defineProperty,Rc=(i,e)=>p0(i,"name",{value:e,configurable:!0});class Mo extends v{awake(){Ge.createIfNoneExists(this.context)}onEnable(){var e;(e=Ge.instance)==null||e.register(this)}onDisable(){var e;(e=Ge.instance)==null||e.unregister(this)}performRaycast(e=null){return null}}Rc(Mo,"Raycaster");class vs extends Mo{constructor(){super(...arguments);r(this,"targets",null);r(this,"raycastHits",[])}start(){this.targets=[this.gameObject]}performRaycast(e=null){return this.targets?(e!=null||(e=new Xe),e.targets=this.targets,e.results=this.raycastHits,this.context.physics.raycast(e)):null}}Rc(vs,"ObjectRaycaster");class Ec extends vs{constructor(){super(...arguments);r(this,"eventCamera",null);r(this,"ignoreReversedGraphics",!1);r(this,"rootRaycaster",null)}}Rc(Ec,"GraphicRaycaster");var m0=Object.defineProperty,g0=(i,e)=>m0(i,"name",{value:e,configurable:!0});class Ac extends v{constructor(){super(...arguments);r(this,"id",null);r(this,"keepAspect",!1)}start(){if(!this.id||!this.context.mainCamera)return;const e=document.getElementById(this.id);if(!e){console.warn('Could not find element with id "'+this.id+'"');return}e.style.display="block",e.style.visibility="hidden";const t=new b_(this.context.renderer,this.context.mainCamera);this.gameObject.add(t);const s=new y_(e);t.add(s),s.visible=!1,console.log(s);const n=s.material;n.transparent=!0,setTimeout(()=>{s.visible=!0;const o=$a(this.gameObject).clone();cr(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const a=new zi;a.setFromObject(t),this.setWorldRotation(o.x,o.y,o.z);const l=a.max.x-a.min.x,c=a.max.y-a.min.y;if(this.keepAspect){const d=l/c;l>c?s.scale.set(1/l,1/c/d,1):s.scale.set(1/l*d,1/c,1)}else s.scale.set(1/l,1/c,1);const h=this.gameObject.scale;s.scale.multiply(h)},1)}}g0(Ac,"SpatialHtml");var vp=Object.defineProperty,_0=Object.getOwnPropertyDescriptor,Tc=(i,e)=>vp(i,"name",{value:e,configurable:!0}),rt=(i,e,t,s)=>{for(var n=s>1?void 0:s?_0(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&vp(e,t,n),n},wp;(function(i){i[i.UpperLeft=0]="UpperLeft",i[i.UpperCenter=1]="UpperCenter",i[i.UpperRight=2]="UpperRight",i[i.MiddleLeft=3]="MiddleLeft",i[i.MiddleCenter=4]="MiddleCenter",i[i.MiddleRight=5]="MiddleRight",i[i.LowerLeft=6]="LowerLeft",i[i.LowerCenter=7]="LowerCenter",i[i.LowerRight=8]="LowerRight"})(wp||(wp={}));var Pp;(function(i){i[i.Truncate=0]="Truncate",i[i.Overflow=1]="Overflow"})(Pp||(Pp={}));var xp;(function(i){i[i.Wrap=0]="Wrap",i[i.Overflow=1]="Overflow"})(xp||(xp={}));var Op;(function(i){i[i.Normal=0]="Normal",i[i.Bold=1]="Bold",i[i.Italic=2]="Italic",i[i.BoldAndItalic=3]="BoldAndItalic"})(Op||(Op={}));class xe extends Qt{constructor(){super(...arguments);r(this,"canvas");r(this,"alignment",0);r(this,"verticalOverflow",0);r(this,"horizontalOverflow",0);r(this,"lineSpacing",1);r(this,"supportRichText",!1);r(this,"font");r(this,"fontStyle",0);r(this,"_isWaitingForRebuild",!1);r(this,"_text","");r(this,"_fontSize",12);r(this,"_textMeshUi",null);r(this,"_textContainer",null);r(this,"_didHandleTextRenderOnTop",!1)}get text(){return this._text}set text(e){if(this._text=e,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:e}),this.markDirty()}}set_text(e){this.text=e}get fontSize(){return this._fontSize}set fontSize(e){if(this._fontSize=e,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:e}),this.markDirty()}}onColorChanged(){if(this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}const e=this.color;this._textMeshUi[0].set({fontColor:e,fontOpacity:e.alpha}),this.markDirty()}}requestRebuild(){this._isWaitingForRebuild||(this._isWaitingForRebuild=!0,this.startCoroutine(this.rebuildDelayedRoutine(),Ce.EarlyUpdate))}*rebuildDelayedRoutine(){if(this._isWaitingForRebuild=!1,this._textMeshUi){for(const e of this._textMeshUi)e.removeFromParent();this._textMeshUi.length=0}this.createText(this.text,this.getTextOpts(),this.supportRichText),this.markDirty()}onCreate(e){const t=this.verticalOverflow==0&&this.horizontalOverflow==0;t&&(this.context.renderer.localClippingEnabled=!0);const s=this.rectTransform;this._textContainer=this.uiObject=this.createBlock(s,t,null,!0),this.createText(this.text,this.getTextOpts(),this.supportRichText),this.uiObject,this.uiObject=this.createBlock(s,t,this.uiObject,!1)}onAfterAddedToScene(){super.onAfterAddedToScene(),this.handleTextRenderOnTop()}getTextOpts(){var t;const e={content:this.text,fontColor:this.color,fontOpacity:this.color.alpha,fontSize:this.fontSize,fontKerning:"normal"};return this.font=(t=this.font)==null?void 0:t.toLocaleLowerCase(),this.setFont(e,this.fontStyle),e}onEnable(){super.onEnable(),this._didHandleTextRenderOnTop=!1,this.uiObject&&(this.uiObject.onAfterUpdate=this.updateWidth.bind(this))}createBlock(e,t,s,n=!1){const o={};o.hiddenOverflow=t,o.interLine=(this.lineSpacing-1)*this.fontSize*1.333,this.getAlignment(o,n);const a=e.createNewBlock(o);return s&&(Array.isArray(s)?a.add(...s):a.add(s)),a}getAlignment(e,t=!1){switch(t||(e.contentDirection="row"),this.alignment){default:case 0:case 1:case 2:e.justifyContent="start";break;case 3:case 4:case 5:e.justifyContent="center";break;case 6:case 7:case 8:e.justifyContent="end";break}switch(this.alignment){case 0:case 3:case 6:e.alignContent=t?"left":"top";break;case 1:case 4:case 7:e.alignContent="center";break;case 2:case 5:case 8:e.alignContent=t?"right":"bottom";break}return e}updateWidth(){this.horizontalOverflow===1&&setTimeout(()=>{if(!this._textMeshUi)return;const e=this._textMeshUi[0].parent;if(!!e&&e.lines){let t=e.lines.reduce((s,n)=>s+n.width,0);t+=e.getFontSize()*3,t+=e.padding*2||0,e.set({width:t})}},1)}createText(e,t,s){if(!(!e||e.length<=0))if(this._textMeshUi||(this._textMeshUi=[]),s){let n=this.getNextTag(e);if(n)n.startIndex>0&&this.createText(e.substring(0,n.startIndex),t,!1);else return this.createText(e,t,!1);const o=[];for(;n;){const a=this.getNextTag(e,n.endIndex);if(a){const l=this.getText(e,n,a);this.handleTag(n,t,o),this.createText(l,t,!1)}else{const l=e.substring(n.endIndex);this.handleTag(n,t,o),this.createText(l,t,!1)}n=a}}else{const n=dt({},t);n.content=e;const o=new v_(n);this._textMeshUi.push(o),this._textContainer&&this._textContainer.add(o)}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){if(!this.canvas)return;const e=[],t=this.canvas,s={renderOnTop:t.renderOnTop,depthWrite:t.depthWrite,doubleSided:t.doubleSided};for(;;){let n=!1;if(this._textMeshUi)for(let o=0;o<this._textMeshUi.length;o++){if(e[o]===!0)continue;n=!0;const a=this._textMeshUi[o];!a.textContent||(Dn(a,s),e[o]=!0)}if(!n)break;yield}}handleTag(e,t,s){if(e.isEndTag){if(s.length>0){const n=s.pop();if(n)for(const o in n.previousValues){const a=n.previousValues[o];t[o]=a}}}else if(e.type.includes("color")){const n=new jo(e,{fontColor:t.fontColor});if(s.push(n),e.type.length>6){const o=e.type.substring(6);t.fontColor=Cp(o)}else t.fontColor=new g(1,1,1)}else if(e.type=="b"){const n=new jo(e,{fontFamily:t.fontFamily,fontTexture:t.fontTexture});s.push(n),this.setFont(t,1)}else if(e.type=="i"){const n=new jo(e,{fontFamily:t.fontFamily,fontTexture:t.fontTexture});s.push(n),this.setFont(t,2)}}getText(e,t,s){return e.substring(t.endIndex,s.startIndex)}getNextTag(e,t=0){const s=e.indexOf("<",t),n=e.indexOf(">",s);if(s>=0&&n>=0){const o=e.substring(s+1,n);return{type:o,startIndex:s,endIndex:n+1,isEndTag:o.startsWith("/")}}return null}setFont(e,t){e.fontFamily=vi+"/"+this.getFontName(t)+"-msdf.json",e.fontTexture=vi+"/"+this.getFontName(t)+".png"}getFontName(e){if(!this.font)return null;switch(e){case 0:return this.font;case 1:return this.font+"-bold";case 2:return this.font+"-italic";case 3:return this.font+"-bold-italic"}return null}}Tc(xe,"Text");rt([f(Xt)],xe.prototype,"canvas",2);rt([f()],xe.prototype,"alignment",2);rt([f()],xe.prototype,"verticalOverflow",2);rt([f()],xe.prototype,"horizontalOverflow",2);rt([f()],xe.prototype,"lineSpacing",2);rt([f()],xe.prototype,"supportRichText",2);rt([f()],xe.prototype,"font",2);rt([f()],xe.prototype,"fontStyle",2);rt([f()],xe.prototype,"text",1);rt([f()],xe.prototype,"fontSize",1);class jo{constructor(e,t){r(this,"tag");r(this,"previousValues");this.tag=e,this.previousValues=t}}Tc(jo,"TagStackEntry");function Cp(i){if(i.startsWith("#")){const t=i.substring(1);var e=parseInt(t,16);const s=e>>16&255,n=e>>8&255,o=e&255;return new g(s/255,n/255,o/255)}switch(i){case"black":return new g(0,0,0);case"white":return new g(1,1,1);case"red":return new g(1,0,0);case"lime":return new g(0,1,0);case"blue":return new g(0,0,1);case"yellow":return new g(1,1,0);case"cyan":return new g(0,1,1);case"magenta":return new g(1,0,1);case"silver":return new g(.75,.75,.75);case"gray":return new g(.5,.5,.5);case"maroon":return new g(.5,0,0);case"olive":return new g(.5,.5,0);case"green":return new g(0,.5,0);case"purple":return new g(.5,0,.5);case"teal":return new g(0,.5,.5);case"navy":return new g(0,0,.5);case"darkred":return new g(.54,0,0);case"brown":return new g(.55,.27,0);case"firebrick":return new g(.69,.13,.13);case"crimson":return new g(.86,.08,.24);case"tomato":return new g(1,.39,.28);case"coral":return new g(1,.49,.31);case"indianred":return new g(.6,.31,.51);case"lightcoral":return new g(.94,.5,.5);case"darkorange":return new g(1,.55,0);case"orange":return new g(1,.65,0);case"gold":return new g(1,.84,0);case"darkgoldenrod":return new g(.72,.53,.04);case"goldenrod":return new g(.85,.65,.13);case"palegoldenrod":return new g(.93,.87,.67);case"darkkhaki":return new g(.74,.7,.42);case"khaki":return new g(.94,.9,.55);case"yellowgreen":return new g(.6,.8,.19);case"darkolivegreen":return new g(.33,.42,.18);case"olivedrab":return new g(.42,.56,.14);case"lawngreen":return new g(.49,.99,0);case"chartreuse":return new g(.5,1,0);case"greenyellow":return new g(.68,1,.18);case"darkgreen":return new g(0,.39,0);case"forestgreen":return new g(.13,.55,.13);case"limegreen":return new g(.19,.8,.19);case"lightgreen":return new g(.56,.93,.56);case"palegreen":return new g(.59,.98,.59);case"darkseagreen":return new g(.56,.74,.56);case"mediumspringgreen":return new g(0,.98,.6);case"springgreen":return new g(0,1,.5);case"seagreen":return new g(.18,.31,.31);case"mediumaquamarine":return new g(.4,.8,.66);case"mediumseagreen":return new g(.24,.7,.44);case"lightseagreen":return new g(.13,.7,.67);case"darkslategray":return new g(.18,.31,.31);case"darkcyan":return new g(0,.55,.55);case"aqua":return new g(0,1,1);case"lightcyan":return new g(.8,1,1);case"darkturquoise":return new g(0,.81,.82);case"turquoise":return new g(0,.82,.82);case"mediumturquoise":return new g(.28,.82,.8);case"paleturquoise":return new g(.68,1,.93);case"aquamarine":return new g(.5,1,.83);case"powderblue":return new g(.69,.88,.9);case"cadetblue":return new g(.37,.62,.63);case"steelblue":return new g(.27,.51,.71);case"cornflowerblue":return new g(.39,.58,.93);case"deepskyblue":return new g(0,.7,1);case"dodgerblue":return new g(.12,.56,1);case"lightblue":return new g(.68,.85,.9);case"skyblue":return new g(.53,.81,.92);case"lightskyblue":return new g(.53,.81,.98);case"midnightblue":return new g(.18,.18,.31);case"darkblue":return new g(0,0,.55);case"mediumblue":return new g(0,0,.82);case"royalblue":return new g(.25,.41,.88);case"blueviolet":return new g(.54,.17,.89);case"indigo":return new g(.29,0,.51);case"darkslateblue":return new g(.28,.24,.55);case"slateblue":return new g(.42,.35,.8);case"mediumslateblue":return new g(.48,.41,.9);case"mediumpurple":return new g(.58,.44,.86);case"darkmagenta":return new g(.55,0,.55);case"darkviolet":return new g(.58,0,.83);case"darkorchid":return new g(.6,.2,.8);case"mediumorchid":return new g(.73,.33,.83);case"thistle":return new g(.84,.75,.85);case"plum":return new g(.87,.63,.87);case"violet":return new g(.93,.51,.93);case"fuchsia":return new g(1,0,1);case"orchid":return new g(.85,.44,.84);case"mediumvioletred":return new g(.78,.08,.52);case"palevioletred":return new g(.86,.44,.58);case"hotpink":return new g(1,.4,.71);case"deeppink":return new g(1,.08,.58);case"lightpink":return new g(1,.71,.76);case"pink":return new g(1,.75,.78);case"antiquewhite":return new g(.98,.92,.84);case"beige":return new g(.96,.96,.86);case"bisque":return new g(1,.89,.77);case"blanchedalmond":return new g(1,.92,.82);case"wheat":return new g(.96,.87,.87);case"cornsilk":return new g(1,.97,.86);case"lemonchiffon":return new g(1,.98,.8);case"lightgoldenrodyellow":return new g(.98,.98,.82);case"lightyellow":return new g(1,1,.8);case"saddlebrown":return new g(.55,.27,.07);case"sienna":return new g(.63,.32,.18);case"chocolate":return new g(.82,.41,.12);case"peru":return new g(.82,.52,.25);case"sandybrown":return new g(.96,.64,.38);case"burlywood":return new g(.87,.72,.53);case"tan":return new g(.82,.71,.55);case"rosybrown":return new g(.74,.56,.56);case"moccasin":return new g(1,.89,.71);case"navajowhite":return new g(1,.87,.68);case"peachpuff":return new g(1,.85,.73);case"mistyrose":return new g(1,.89,.88);case"lavenderblush":return new g(1,.94,.93);case"linen":return new g(.98,.94,.9);case"oldlace":return new g(.99,.96,.9);case"papayawhip":return new g(1,.94,.84);case"seashell":return new g(1,.96,.93);case"mintcream":return new g(.98,1,.98);case"slategray":return new g(.44,.5,.56);case"lightslategray":return new g(.47,.53,.6);case"lightsteelblue":return new g(.69,.77,.87);case"lavender":return new g(.9,.9,.98);case"floralwhite":return new g(1,.98,.98);case"aliceblue":return new g(.94,.97,1);case"ghostwhite":return new g(.97,.97,1);case"honeydew":return new g(.94,1,.94);case"ivory":return new g(1,1,.94);case"azure":return new g(.94,1,1);case"snow":return new g(1,.98,.98);case"dimgray":return new g(.4,.4,.4);case"darkgray":return new g(.66,.66,.66);case"lightgray":return new g(.83,.83,.83);case"gainsboro":return new g(.86,.86,.86);case"whitesmoke":return new g(.96,.96,.96)}return new g(1,1,1)}Tc(Cp,"getColorFromString");var b0=Object.defineProperty,y0=(i,e)=>b0(i,"name",{value:e,configurable:!0});class Lc extends v{constructor(){super(...arguments);r(this,"toggleKey",pt.KEY_P)}update(){this.context.input.isKeyDown(pt.KEY_P)&&this.context.domElement.classList.toggle("presentation-mode")}}y0(Lc,"PresentationMode");var v0=Object.defineProperty,Sp=(i,e)=>v0(i,"name",{value:e,configurable:!0});const ph=class{constructor(e,t){r(this,"id",0);r(this,"points",[]);r(this,"line",new Ea.exports.MeshLine);r(this,"material");r(this,"mesh");r(this,"defaultLineMaterial",new Ea.exports.MeshLineMaterial({color:10066329,lineWidth:.01}));if(t&&(this.material=t.material),this.material||(this.material=this.defaultLineMaterial),t){const s=t.options;s&&Object.assign(this.material,s)}this.mesh=new ii(this.line,this.material),e.add(this.mesh)}appendPoint(e){var n;let t=ph.wp;t.set(e.x,e.y,e.z);const s=(n=this.mesh)==null?void 0:n.parent;return s&&(t=s.worldToLocal(t),e.x=t.x,e.y=t.y,e.z=t.z),this.points.push(e.x,e.y,e.z),this.line.setPoints(this.points),e}};let ws=ph;r(ws,"wp",new y);Sp(ws,"LineInstanceHandler");class Mn extends v{constructor(){super(...arguments);r(this,"finished",[]);r(this,"inFlight",[]);r(this,"buffer",{});r(this,"freeBuffer",new Array)}startLine(e,t){const s=Math.random()*Number.MAX_SAFE_INTEGER;return this.internalStartLine(e,s,!0,t)}updateLine(e,t){const s=this.inFlight[e.id];if(!s)return;t.point&&(t.point=s.appendPoint(t.point));const n=this.buffer[e.id];n&&(t.point&&n.push(t.point.x,t.point.y,t.point.z),n.length>5&&(this.sendLineUpdate(s,!1,void 0,n),n.length=0))}endLine(e,t=!0){const s=this.inFlight[e.id];if(!s)return;this.finished.push(s),delete this.inFlight[e.id],t&&this.sendLineUpdate(s,!0,0);const n=this.buffer[e.id];if(n){delete this.buffer[e.id];const o=n;o.length=0,this.freeBuffer.push(o)}return s}getLine(e){return this.inFlight[e.id]}awake(){this.context.connection.beginListen("line-start",e=>{this.onEnsureLine(e.id,e.parentGuid)}),this.context.connection.beginListen("line-update",e=>{let t=this.onEnsureLine(e.guid,e.parentGuid);t&&e.points&&(e.startIndex<=0?t.points=e.points:e.startIndex>=t.points.length&&t.points.push(...e.points),t.line.setPoints(t.points),t.material.lineWidth=e.width,t.material.color.fromArray(e.color),e.finished===!0&&this.endLine({id:t.id},!1))})}onEnsureLine(e,t){if(this.inFlight[e])return this.inFlight[e];let s=p.findByGuid(t,this.context.scene);if(!!s)return this.internalStartLine(s,e,!1),this.inFlight[e]}internalStartLine(e,t,s=!0,n){const o=new ws(e!=null?e:this.context.scene,n);o.id=t,this.inFlight[t]=o,s&&this.sendLineStart(o);let a;return this.freeBuffer.length<=0?a=new Array:a=this.freeBuffer.pop(),this.buffer[t]=a,{id:t}}sendLineStart(e){const t=e.mesh.parent;this.context.connection.send("line-start",{id:e.id,parentGuid:t?t.guid:void 0})}sendLineUpdate(e,t,s,n){if(e){const o={parentGuid:e.mesh.parent.guid,guid:e.id,points:n?[...n]:e.points,width:e.material.lineWidth,color:e.material.color.toArray(),startIndex:s!==void 0?s:e.points.length,finished:t};this.context.connection.send("line-update",o)}}}Sp(Mn,"LinesManager");var w0=Object.defineProperty,Rp=(i,e)=>w0(i,"name",{value:e,configurable:!0});class Dc{constructor(){r(this,"isDrawing");r(this,"lastHit");r(this,"currentHandle");r(this,"maxDistance");r(this,"prevDistance");r(this,"lastParent");this.isDrawing=!1,this.lastHit=new y,this.currentHandle=null,this.maxDistance=0,this.prevDistance=0,this.lastParent=null}}Rp(Dc,"LineState");const fa=class extends v{constructor(){super(...arguments);r(this,"lines");r(this,"colliders");r(this,"alignToSurface",!0);r(this,"addToPaintedObject",!0);r(this,"orbit");r(this,"_states",{});r(this,"_raycastOptions",new Xe)}start(){var t;this.lines||(this.lines=p.getComponent(this.gameObject,Mn),this.lines||(this.lines=p.addNewComponent(this.gameObject,Mn))),this.orbit=(t=p.findObjectOfType(Mt,this.context))!=null?t:void 0,this._states.mouse=new Dc;const e={};U.addEventListener(we.SelectStart,(s,n)=>{e[s.controller.uuid]=!0}),U.addEventListener(we.Update,(s,n)=>{if(e[s.controller.uuid]===!0){const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!1,!1)}}),U.addEventListener(we.SelectEnd,(s,n)=>{e[s.controller.uuid]=!1;const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!0,!1)})}update(){this.orbit&&this._states.mouse&&this.orbit&&(this.orbit.enabled=!this._states.mouse.isDrawing);const e=this.context.input.getPointerPressedCount()>1,t=this.context.input.getPointerPositionRC(0);fa._raycaster.setFromCamera(t,this.context.mainCamera);const s=fa._raycaster.ray;this.updateLine("mouse",s,this.context.input.getPointerPressed(0),this.context.input.getPointerUp(0),e||this.context.input.isKeyPressed(pt.ALT))}updateLine(e,t,s,n,o=!1){var l;let a=this._states[e];if(a||(this._states[e]=new Dc,a=this._states[e]),n)a.isDrawing=!1,a.currentHandle&&(this.lines.endLine(a.currentHandle),a.currentHandle=null);else if(s){if(o)return a;const c=this.getHit(t);let h=null,d=a.prevDistance;if(c)a.currentHandle||(a.maxDistance=c.distance),h=c.point,h.add(c.face.normal.multiplyScalar(.01)),a.prevDistance=c.distance;else if(a.maxDistance>0){if(a.maxDistance,!a.currentHandle&&a.lastHit){const u=R(this.context.mainCamera);a.lastHit.distanceTo(u)}h=t.origin.add(t.direction.multiplyScalar(a.maxDistance)),a.prevDistance=a.maxDistance}if(h){if(!a.currentHandle){let u=(l=a.lastParent)!=null?l:this.gameObject;this.addToPaintedObject&&c&&(u=c.object),a.lastParent=u,a.currentHandle=this.lines.startLine(u,{material:this.createRandomMaterial()})}if(this.alignToSurface&&(a.prevDistance>a.maxDistance||Math.abs(d-a.prevDistance)>.2)){const u=a.maxDistance;h=t.origin.add(t.direction.multiplyScalar(u)),a.prevDistance=u}if(a.lastHit&&a.lastHit.distanceTo(h)<a.prevDistance*.01)return a;this.lines.updateLine(a.currentHandle,{point:h}),a.lastHit.copy(h)}a.isDrawing=a.currentHandle!==null}return a}getHit(e){(!this.colliders||this.colliders.length===0)&&(this.colliders=[this.gameObject]),this._raycastOptions.targets=this.colliders,this._raycastOptions.ray=e;const t=this.context.physics.raycast(this._raycastOptions);if(t.length>0){for(const s of t)if(!!p.isActiveInHierarchy(s.object))return s}return null}createRandomMaterial(){let e;return this.context.connection.connectionId?e=St.colorFromHashCode(St.hashCode(this.context.connection.connectionId)):e=new g("hsl("+(Math.random()*100).toFixed(0)+", 80%, 30%)"),new Ea.exports.MeshLineMaterial({color:e,lineWidth:L.lerp(.005,.01,Math.random())})}};let jn=fa;r(jn,"_raycaster",new ya);Rp(jn,"LinesDrawer");var P0=Object.defineProperty,Fn=(i,e)=>P0(i,"name",{value:e,configurable:!0});const Ep=O("debugautosync");class Ap{constructor(){r(this,"_syncers",{})}getOrCreateSyncer(e){if(!e.guid)return null;if(this._syncers[e.guid])return this._syncers[e.guid];const t=new Lp(e);return this._syncers[e.guid]=t,t}}Fn(Ap,"ComponentsSyncerManager");const Tp=new Ap;class Lp{constructor(e){r(this,"comp");r(this,"hasChanges",!1);r(this,"changedProperties",{});r(this,"data",{});r(this,"_boundEvent");r(this,"_isReceiving",!1);r(this,"_isInit",!1);this.comp=e}get networkingKey(){return this.comp.constructor.name}init(e){if(this._isInit)return;this._isInit=!0,this.comp=e,this._boundEvent=this.onHandleSending.bind(this),this.comp.context.post_render_callbacks.push(this._boundEvent),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving.bind(this));const t=this.comp.context.connection.tryGetState(this.comp.guid);t&&this.onHandleReceiving(t)}notifyChanged(e,t){this._isReceiving||(this.hasChanges=!0,this.changedProperties[e]=t)}onHandleSending(){if(!this.hasChanges)return;this.hasChanges=!1;const e=this.comp.context.connection;if(!e||!e.isConnected){for(const t in this.changedProperties)delete this.changedProperties[t];return}for(const t in this.data)delete this.data[t];this.data.guid=this.comp.guid;for(const t in this.changedProperties){const s=this.changedProperties[t];delete this.changedProperties[t],this.data[t]=s}e.send(this.networkingKey,this.data)}onHandleReceiving(e){if(!this._isInit||!this.comp)return;const t=e.guid;if(!(t&&t!==this.comp.guid)){Ep&&console.log("RECEIVED",this.comp.name,this.comp.guid,e);try{this._isReceiving=!0;for(const s in e){if(s==="guid")continue;const n=e[s];this.comp[s]=n}}catch(s){console.error(s)}finally{this._isReceiving=!1}}}}Fn(Lp,"ComponentPropertiesSyncer");function Dp(i,e){let t=e!==i;if(!t&&i&&e){if(Array.isArray(i)&&Array.isArray(e))t=!0;else if(typeof i=="object"&&typeof e=="object"){for(const s of Object.keys(i))if(i[s]!==e[s]){t=!0;break}}}return t}Fn(Dp,"testValueChanged");function kp(i){if(i.__autoPropertySyncHandler)return i.__autoPropertySyncHandler;const e=Tp.getOrCreateSyncer(i);return e==null||e.init(i),i.__autoPropertySyncHandler=e,e}Fn(kp,"getSyncer");const x0=Fn(function(i){return function(e,t){let s=null;const n=i?e[i]:void 0,o=e,a=o.__internalAwake;Ep&&console.log(t);const l=t+"k__BackingField";o.__internalAwake=function(){if(this[l]!==void 0)return;this[l]=this[t],a.call(this),s=Tp.getOrCreateSyncer(this);const c=Object.getOwnPropertyDescriptor(this,t);(c==null?void 0:c.set)===void 0&&Object.defineProperty(this,t,{set:function(h){var u;const d=this[l];this[l]=h,Dp(h,d)&&(n==null?void 0:n.call(this,h,d))!==!1&&((u=kp(this))==null||u.notifyChanged(t,h))},get:function(){return this[l]},configurable:!0,enumerable:!0}),s==null||s.init(this)}}},"syncField");var Ip=Object.defineProperty,O0=Object.getOwnPropertyDescriptor,Mp=(i,e)=>Ip(i,"name",{value:e,configurable:!0}),jp=(i,e,t,s)=>{for(var n=s>1?void 0:s?O0(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Ip(e,t,n),n};class Fo extends v{constructor(){super(...arguments);r(this,"asset");r(this,"joinedRoomFunction")}awake(){this.watchTabVisible(),this.joinedRoomFunction=this.onUserJoined.bind(this)}onEnable(){this.context.connection.beginListen(G.JoinedRoom,this.joinedRoomFunction)}onDisable(){this.context.connection.stopListening(G.JoinedRoom,this.joinedRoomFunction)}async onUserJoined(e){var s;const t=await((s=this.asset)==null?void 0:s.instantiateSynced({parent:this.gameObject},!0));if(t){let n=p.getComponent(t,wi);n&&(n.owner=this.context.connection.connectionId)}}watchTabVisible(){window.addEventListener("visibilitychange",e=>{if(document.visibilityState==="visible")for(let t=wi.all.length-1;t>=0;t--){const s=wi.all[t];(!s.owner||!this.context.connection.userIsInRoom(s.owner))&&s.doDestroy()}})}}Mp(Fo,"PlayerSync");jp([f(Te)],Fo.prototype,"asset",2);var pa;const Ve=(pa=class extends v{constructor(){super(...arguments);r(this,"owner")}static get all(){return Ve._all}static get local(){return Ve._local}static isLocalPlayer(i){var e,t,s,n;return i instanceof x?(t=(e=p.getComponentInParent(i,Ve))==null?void 0:e.isLocalPlayer)!=null?t:!1:i instanceof Ue&&(n=(s=p.getComponentInParent(i.gameObject,Ve))==null?void 0:s.isLocalPlayer)!=null?n:!1}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}awake(){this.isLocalPlayer&&Ve.local.push(this),Ve.all.push(this),this.context.connection.beginListen(G.UserLeftRoom,i=>{if(i.userId===this.owner){this.doDestroy();return}})}start(){if(!this.owner||!this.context.connection.userIsInRoom(this.owner)){this.doDestroy();return}}doDestroy(){fr(this.gameObject,this.context.connection)}onDestroy(){if(Ve.all.splice(Ve.all.indexOf(this),1),this.isLocalPlayer){const i=Ve._local.indexOf(this);i>=0&&Ve._local.splice(i,1)}}},r(pa,"_all",[]),r(pa,"_local",[]),pa);let wi=Ve;Mp(wi,"PlayerState");jp([x0(),f()],wi.prototype,"owner",2);m.add("AlignmentConstraint",fl);m.add("Animation",Nt);m.add("AnimationCurve",Nr);m.add("Animator",_t);m.add("AnimatorController",hi);m.add("AudioListener",Zi);m.add("AudioSource",ae);m.add("AvatarModel",Wr);m.add("AvatarLoader",on);m.add("AxesHelper",Ki);m.add("BasicIKConstraint",yl);m.add("BoxCollider",vl);m.add("BoxHelperComponent",es);m.add("Camera",W);m.add("InstantiateOptions",Ae);m.add("UnityObject",Pl);m.add("DeleteBox",Hr);m.add("Deletable",xl);m.add("DeviceFlag",zr);m.add("DragControls",Pt);m.add("DropListener",fn);m.add("Duplicatable",fi);m.add("CallInfo",os);m.add("EventList",tt);m.add("EventTrigger",Tl);m.add("FlyControls",Ll);m.add("BoxGizmo",pn);m.add("GltfExportBox",Il);m.add("GltfExport",xt);m.add("GridHelper",as);m.add("Interactable",ts);m.add("UsageMarker",is);m.add("Light",Ot);m.add("LODModel",pi);m.add("LODGroup",gn);m.add("LookAtConstraint",Zs);m.add("MeshCollider",Bl);m.add("NavMesh",Ul);m.add("NavMeshAgent",Nl);m.add("NestedGltf",ho);m.add("Networking",It);m.add("OffsetConstraint",Wl);m.add("OrbitControls",Mt);m.add("ParticleSystemRenderer",uo);m.add("ParticleSystem",Ql);m.add("MainModule",zl);m.add("EmissionModule",Gl);m.add("ShapeModule",Vl);m.add("PlayerColor",St);m.add("FieldWithDefault",Qa);m.add("Renderer",X);m.add("MeshRenderer",vr);m.add("SkinnedMeshRenderer",Xa);m.add("InstancingUtil",ue);m.add("RendererLightmap",Qs);m.add("Rigidbody",hs);m.add("SceneSettings",Xl);m.add("ScreenCapture",Jl);m.add("ShadowCatcher",_n);m.add("SmoothFollow",bn);m.add("SpatialTriggerReceiver",ds);m.add("SpatialTrigger",yn);m.add("SpatialTriggerEventArgs",mo);m.add("SpectatorCamera",Kl);m.add("SphereCollider",vn);m.add("SpringJoint",ec);m.add("Sprite",bo);m.add("SpriteRenderer",us);m.add("SyncedCamera",wn);m.add("SyncedRoom",Vt);m.add("SyncedTransform",yt);m.add("TestRunner",nc);m.add("TestSimulateUserData",rc);m.add("TransformGizmo",vo);m.add("VideoPlayer",We);m.add("Voip",vt);m.add("VolumeParameter",ac);m.add("VolumeComponent",_i);m.add("ToneMapping",xn);m.add("ColorAdjustments",On);m.add("VolumeProfile",Cn);m.add("Volume",wo);m.add("WebARSessionRoot",cn);m.add("WebXR",D);m.add("WebAR",rs);m.add("AvatarMarker",ie);m.add("WebXRAvatar",wt);m.add("TeleportTarget",Kr);m.add("WebXRController",U);m.add("AttachedObject",$e);m.add("XRGrabModel",Po);m.add("XRGrabRendering",lc);m.add("XRRig",to);m.add("VRUserState",et);m.add("WebXRSync",dn);m.add("XRState",Ke);m.add("XRFlag",te);m.add("AvatarBlink_Simple",bi);m.add("AvatarEyeLook_Rotation",fs);m.add("Avatar_POI",le);m.add("Avatar_Brain_LookAt",ln);m.add("Avatar_MouthShapes",Sn);m.add("Avatar_MustacheShake",hc);m.add("LogStats",dc);m.add("RGBAColor",fe);m.add("PlayableDirector",gs);m.add("SignalAsset",Oo);m.add("SignalReceiverEvent",Co);m.add("SignalReceiver",Rn);m.add("AnimationTrackHandler",Ro);m.add("AudioTrackHandler",Eo);m.add("SignalTrackHandler",Tn);m.add("ControlTrackHandler",ms);m.add("BaseUIComponent",nt);m.add("UIRootComponent",Ln);m.add("Button",Et);m.add("Canvas",Xt);m.add("CanvasGroup",wc);m.add("EventSystem",Ge);m.add("Graphic",Qt);m.add("MaskableGraphic",kn);m.add("Image",In);m.add("RawImage",Do);m.add("Keyboard",xc);m.add("LayoutGroup",ys);m.add("VerticalLayoutGroup",Oc);m.add("HorizontalLayoutGroup",Cc);m.add("GridLayoutGroup",Sc);m.add("PointerEventData",yi);m.add("Raycaster",Mo);m.add("ObjectRaycaster",vs);m.add("GraphicRaycaster",Ec);m.add("Size",gc);m.add("Rect",Lo);m.add("RectTransform",Rt);m.add("SpatialHtml",Ac);m.add("Text",xe);m.add("PresentationMode",Lc);m.add("LinesDrawer",jn);m.add("LineInstanceHandler",ws);m.add("LinesManager",Mn);m.add("PlayerSync",Fo);m.add("PlayerState",wi);var C0=Object.defineProperty,Ps=(i,e)=>C0(i,"name",{value:e,configurable:!0});class Fp extends Yi{constructor(){super([g,fe])}onDeserialize(e){if(e!=null)return e.a!==void 0?new fe(e.r,e.g,e.b,e.a):e.alpha!==void 0?new fe(e.r,e.g,e.b,e.alpha):new g(e.r,e.g,e.b)}onSerialize(e){if(e!=null)return e.a!==void 0?{r:e.r,g:e.g,b:e.b,a:e.a}:{r:e.r,g:e.g,b:e.b}}}Ps(Fp,"ColorSerializer");new Fp;class Bp extends Yi{constructor(){super(x)}onSerialize(e,t){if(t.objectToNode!==void 0&&e.uuid){const s=t.objectToNode[e.uuid];return ye&&console.log(s,e.name,e.uuid),{node:s}}}onDeserialize(e,t){var s;if(e){if(e.node!==void 0&&t.nodeToObject){const n=t.nodeToObject[e.node];return ye&&console.log("Deserialized object reference?",e,n,t==null?void 0:t.nodeToObject),n||console.warn("Did not find node: "+e.node,t.nodeToObject,t.object),n}else if(e.guid){if(!t.context){console.error("Missing context");return}let n,o=(s=t.gltf)==null?void 0:s.scene;return o&&(n=p.findByGuid(e.guid,o)),n||(n=p.findByGuid(e.guid,t.context.scene)),n?ye&&console.log("Deserialized object reference?",e,n,t==null?void 0:t.nodeToObject):console.warn("could not resolve reference",e,t.target,t.path,t.context.scene),n}}}}Ps(Bp,"ObjectSerializer");const S0=new Bp;class Up extends Yi{constructor(){super([Ue,v])}onSerialize(e,t){if(e==null?void 0:e.guid)return{guid:e.guid}}onDeserialize(e,t){var s;if(e==null?void 0:e.guid){ye&&console.log(e.guid,t.root,t.object,t.target);const n=this.findObjectForGuid(e.guid,t.root);if(n)return n;if(t.context)return this.findObjectForGuid(e.guid,(s=t.context)==null?void 0:s.scene)}}findObjectForGuid(e,t){return p.foreachComponent(t,s=>{if(e===s.gameObject.guid)return s.gameObject;if(s.guid===e)return s})}}Ps(Up,"ComponentSerializer");const kc=new Up;class Np extends Yi{constructor(){super([tt])}onSerialize(e,t){console.log("TODO: SERIALIZE EVENT")}onDeserialize(e,t){var s,n,o,a;if(e&&e.type==="EventList"){ye&&console.log("DESERIALIZE EVENT",e);const l=new Array;for(const h of e.calls){ye&&console.log(h);let d=kc.findObjectForGuid(h.target,t.root);!d&&((s=t.context)==null?void 0:s.scene)&&(d=kc.findObjectForGuid(h.target,(n=t.context)==null?void 0:n.scene));const u=((o=h.method)==null?void 0:o.length)>0;if(d&&u){const C=Ps(()=>console.warn(`Could not find method ${h.method} on object ${d.name}`,d,typeof d[h.method]),"printWarningMethodNotFound");if(typeof d[h.method]!="function"){let S=!1;h.method.startsWith("set_")&&h.method.length>4&&(h.method=h.method.substring(4),d[h.method]!==void 0&&(S=!0)),S||C()}}let _,b=h.argument;h.argument!==void 0?(typeof b=="object"&&(b=S0.onDeserialize(h.argument,t),b||(b=kc.onDeserialize(h.argument,t))),_=new os(u?()=>w():void 0,h.enabled)):_=new os(u?()=>w():void 0,h.enabled);const w=Ps(()=>{const C=d[h.method];typeof C=="function"?C==null||C.call(d,b):d[h.method]=b},"invokeFunction");if(_.method||(_.__debuginfo=(a=t.object)==null?void 0:a.name),!d||!_.method){const C=t.object?"Current object: "+t.object.name+", "+t.object.guid:null;d?console.warn('EventList method not found: "'+h.method+'" on',d):console.warn("EventList is missing target - will be ignored",h.target,C,e)}else l.push(_)}const c=new tt(l);return ye&&console.log(c),c}}}Ps(Np,"EventListSerializer");new Np;var R0=Object.defineProperty,Bn=(i,e)=>R0(i,"name",{value:e,configurable:!0});const $p=ye;function Wp(i,e){const s=cu(i,e);return s!==void 0?s:null}Bn(Wp,"writeBuiltinComponentData");async function Ic(i,e,t,s=null,n){if(!t)return;let o=s;typeof o=="number"&&(o=new Ee(s));const a=new cl(t.scene);a.gltfId=e,a.context=i,a.gltf=t,a.nodeToObject=n==null?void 0:n.nodeToObjectMap;const l=[];if(t.scenes)for(const c of t.scenes)await Uo(a,c,l);if(t.children)for(const c of t.children)await Uo(a,c,l);i.new_scripts_pre_setup_callbacks.push(()=>{for(const c of l)Hp(c,a);if(o){Bo(t,o);for(const c of t.scenes)Bo(c,o)}})}Bn(Ic,"createBuiltinComponents");function Bo(i,e){if(e!==null&&!!i){if(i.guid=e.generateUUID(),i&&i.userData&&i.userData.components)for(const t of i.userData.components)t!==null&&(t.guid=e.generateUUID());if(i.children)for(const t of i.children)Bo(t,e)}}Bn(Bo,"recursiveCreateGuids");const Un=[];async function Uo(i,e,t,s){if(!e)return;const n=e.userData;if(n){const o=n.builtin_components;if(o&&o.length>0)for(const a of o)try{if(a===null)continue;const l=m.get(a.name);if(l!=null){const c=new l;c.sourceId=i.gltfId,Fr(c,a),td(c,e,!1),t.push({instance:c,compData:a,obj:e})}else $p&&console.debug("unknown component: "+a.name),Un.includes(a.name)||Un.push(a.name)}catch(l){console.error(a.name+" - "+l.message,l)}if(Un.length>0){const a=Un.join(", ");console.warn("unknown components: "+a),Un.length=0}}if(e.children)for(const o of e.children)await Uo(i,o,t)}Bn(Uo,"onCreateBuiltinComponents");function Hp(i,e){const{instance:t,compData:s,obj:n}=i;e.object=n,e.target=t,Mr(t,s,e),$p&&console.debug("add "+s.name,s,t)}Bn(Hp,"handleDeserialization");const E0=new Fh;async function zp(i){return new Promise((e,t)=>{E0.load(i,e,void 0,t)})}var A0=Object.defineProperty,At=(i,e)=>A0(i,"name",{value:e,configurable:!0});const Nn=new Uint8Array(4);Nn[0]=255;Nn[1]=255;Nn[2]=255;Nn[3]=255;const T0=new Bh(Nn,1,1,Uh);function Gp(i){const e="alpha"in i,t=e?4:3,s=new Uint8Array(t);return s[0]=i.r,s[1]=i.g,s[2]=i.b,e&&(s[3]=i.alpha),new Bh(s,1,1,Uh)}At(Gp,"createFlatTexture");var Vp;(function(i){i[i.Vertex=0]="Vertex",i[i.Fragment=1]="Fragment"})(Vp||(Vp={}));class qp{constructor(e,t){r(this,"stage");r(this,"code");this.stage=e,this.code=t}}At(qp,"UnityShaderStage");class L0{constructor(){r(this,"loaded",new Map)}async loadShader(e){const t=await zp(e);return JSON.parse(t)}async load(e,t){if(this.loaded.has(t))return new Promise((o,a)=>{const l=this.loaded.get(t);l?o(l):a("Shader not found")});const s=await zp(t),n=new qp(e,s);return this.loaded.set(t,n),n}}At(L0,"ShaderLib");function $n(i,e){const t=i.elements;e||(e=[]),e.length=0;for(let s=0;s<16;s+=4){const n=t[s],o=t[s+1],a=t[s+2],l=t[s+3],c=new $(n,o,a,l);e.push(c)}return e}At($n,"ToUnityMatrixArray");const Mc=[],Qp=[];function jc(i,e){if(Mc.length===0)for(let t=0;t<27;t++)Mc.push(0);e||(e=Mc);for(let t=0;t<27;t++)Qp[t]=e[t];e=Qp,i.unity_SHAr={value:new $(e[9],e[3],e[6],e[0])},i.unity_SHBr={value:new $(e[12],e[15],e[18],e[21])},i.unity_SHAg={value:new $(e[10],e[4],e[7],e[1])},i.unity_SHBg={value:new $(e[13],e[16],e[19],e[22])},i.unity_SHAb={value:new $(e[11],e[5],e[8],e[2])},i.unity_SHBb={value:new $(e[14],e[17],e[20],e[23])},i.unity_SHC={value:new $(e[24],e[25],e[26],1)}}At(jc,"SetUnitySphericalHarmonics");class Xp{constructor(e,t,s){r(this,"vertexShader");r(this,"fragmentShader");r(this,"technique");this.vertexShader=e,this.fragmentShader=t,this.technique=s}}At(Xp,"ShaderBundle");async function Yp(i,e){if(!i)return console.error("Can not find technique: no shader data"),null;const t=i.programs[e],s=t.vertexShader,n=t.fragmentShader;if(s!==void 0&&n!==void 0){const o=i.shaders[s],a=i.shaders[n];if(o.uri&&a.uri||o.code&&a.code){if(!o.code&&o.uri&&await Fc(o),!a.code&&a.uri&&await Fc(a),!o.code||!a.code)return null;const l=i.techniques[e];return new Xp(o.code,a.code,l)}}return console.error("Shader technique not found",e),null}At(Yp,"FindShaderTechniques");async function Fc(i){const e=i.uri;if(!!e)if(e.endsWith(".glsl")){const s=await new Fh().loadAsync(e);i.code=s.toString()}else i.code=Jp(i.uri)}At(Fc,"loadShaderCode");function Jp(i){return decodeURIComponent(Array.prototype.map.call(atob(i),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}At(Jp,"b64DecodeUnicode");var D0=Object.defineProperty,xs=(i,e)=>D0(i,"name",{value:e,configurable:!0});class k0{constructor(){r(this,"programs",[]);r(this,"shaders",[]);r(this,"techniques",[])}}xs(k0,"ShaderData");class I0{constructor(){r(this,"vertexShader");r(this,"fragmentShader")}}xs(I0,"ShaderProgram");var Zp;(function(i){i[i.Fragment=35632]="Fragment",i[i.Vertex=35633]="Vertex"})(Zp||(Zp={}));class M0{constructor(){r(this,"name");r(this,"type");r(this,"uri");r(this,"code")}}xs(M0,"Shader");class j0{constructor(){r(this,"program");r(this,"attributes",new Map);r(this,"uniforms",new Map)}}xs(j0,"Technique");class F0{constructor(){r(this,"semantic")}}xs(F0,"ShaderAttribute");class B0{constructor(){r(this,"name","");r(this,"type");r(this,"semantic");r(this,"count",0);r(this,"node",0)}}xs(B0,"ShaderUniform");var Bc;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(Bc||(Bc={}));var U0=Object.defineProperty,Uc=(i,e)=>U0(i,"name",{value:e,configurable:!0});const Tt=O("debugshaders"),Os="NEEDLE_techniques_webgl";var Kp;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(Kp||(Kp={}));class em{constructor(){r(this,"objectToWorldMatrix",new Be);r(this,"worldToObjectMatrix",new Be);r(this,"objectToWorld",new Array);r(this,"worldToObject",new Array)}updateFrom(e){this.objectToWorldMatrix.copy(e.matrixWorld),$n(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(e.matrixWorld.invert()),$n(this.worldToObjectMatrix,this.worldToObject)}}Uc(em,"ObjectRendererData");var tm;(function(i){i[i.Off=0]="Off",i[i.Front=1]="Front",i[i.Back=2]="Back"})(tm||(tm={}));const H=class extends w_{constructor(e,...t){super(...t);r(this,"identifier");r(this,"_sphericalHarmonicsName","unity_SpecCube0");r(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");r(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");r(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");r(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");r(this,"_rendererData",new em);r(this,"_lastFrame",-1);this.identifier=e,Tt&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName]&&this.waitForLighting()}async waitForLighting(){const e=k.Current;if(!e){console.error("Missing context");return}const t=await e.rendererData.getSceneLightingData(this.identifier);if(!t||!t.array){console.warn("Missing lighting data for custom shader, getSceneLightingData did not return anything");return}Tt&&console.log(t);const s=t.array,n=t.texture;this.uniforms.unity_SpecCube0={value:n},jc(this.uniforms,s);const o=Math.sqrt(Math.PI*.5);this.uniforms.unity_SpecCube0_HDR={value:new $(o,o,o,o)},Tt&&console.log("Set environment lighting",this.uniforms)}onBeforeRender(e,t,s,n,o,a){n.attributes.tangent||n.computeTangents(),this.internalUpdateUniforms(s,o)}internalUpdateUniforms(e,t){const s=k.Current;if(s.time.frame==this._lastFrame)return;this._lastFrame=s.time.frame,this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=s.rendererData.timeVec4);const n=s==null?void 0:s.mainLight;if(n){const o=n.getWorldPosition(H._mainLightPosition);this.uniforms._MainLightPosition={value:o.normalize()},H._mainLightColor.set(n.color.r,n.color.g,n.color.b,0),this.uniforms._MainLightColor={value:H._mainLightColor};const a=n.intensity;H._lightData.z=a,this.uniforms.unity_LightData={value:H._lightData}}if(e&&(H.viewProjection&&this.uniforms[this._viewProjectionName]&&(H.viewProjection.copy(e.projectionMatrix).multiply(e.matrixWorldInverse),this.uniforms[this._viewProjectionName].value=$n(H.viewProjection,H._viewProjectionValues)),H.viewMatrix&&this.uniforms[this._viewMatrixName]&&(H.viewMatrix.copy(e.matrixWorldInverse),this.uniforms[this._viewMatrixName].value=$n(H.viewMatrix,H._viewMatrixValues)),this.uniforms[H._worldSpaceCameraPosName]&&(H._worldSpaceCameraPos.setFromMatrixPosition(e.matrixWorld),this.uniforms[H._worldSpaceCameraPosName]={value:H._worldSpaceCameraPos})),t){const o=this._rendererData;o.updateFrom(t),this.uniforms[this._worldToObjectName].value=o.worldToObject,this.uniforms[this._objToWorldName].value=o.objectToWorld}this.uniformsNeedUpdate=!0}};let Le=H;r(Le,"viewProjection",new Be),r(Le,"_viewProjectionValues",[]),r(Le,"viewMatrix",new Be),r(Le,"_viewMatrixValues",[]),r(Le,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),r(Le,"_worldSpaceCameraPos",new y),r(Le,"_mainLightColor",new $),r(Le,"_mainLightPosition",new y),r(Le,"_lightData",new $);Uc(Le,"CustomShader");class im{constructor(e,t){r(this,"parser");r(this,"identifier");this.parser=e,this.identifier=t}get name(){return Os}loadMaterial(e){const t=this.parser.json.materials[e];if(!t)return Tt&&console.log(e,this.parser.json.materials),null;if(!t.extensions||!t.extensions[Os])return Tt&&console.log("material "+e+" does not use NEEDLE_techniques_webgl"),null;const s=t.extensions[Os].technique;if(s<0)return null;const n=this.parser.json.extensions[Os];if(!n)return null;Tt&&console.log(n);const o=n.techniques[s];return o?new Promise(async(a,l)=>{var S,A,M;const c=await Yp(n,o.program),h=c==null?void 0:c.fragmentShader,d=c==null?void 0:c.vertexShader;if(!h||!d)return l();Tt&&console.log("loadMaterial",t,c);const u={},_=o.uniforms;for(const E in _){const T=E;switch(T){case"_TimeParameters":const I=new $;u[T]={value:I};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":u[T]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":u[T]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":u[T]={value:null};break}}let b=!1;if(t.extensions&&t.extensions[Os]){const E=t.extensions[Os];if(E.technique===s){Tt&&console.log(t.name,"Material Properties",E);for(const T in E.values){const I=E.values[T];if(typeof I=="string"){if(I.startsWith("textures/")){const ke=I.substring(9),Ie=Number.parseInt(ke);if(Ie>=0){const se=await this.parser.getDependency("texture",Ie);se&&(se.encoding=P_,se.needsUpdate=!0),u[T]={value:se};continue}}switch(T){case"alphaMode":I==="BLEND"&&(b=!0);continue}}if(Array.isArray(I)&&I.length===4){u[T]={value:new $(I[0],I[1],I[2],I[3])};continue}u[T]={value:I}}}}const w=new Le(this.identifier,{name:(S=t.name)!=null?S:"",uniforms:u,vertexShader:d,fragmentShader:h,lights:!1});switch((A=u._Cull)==null?void 0:A.value){case 0:w.side=Sa;break;case 1:w.side=x_;break;case 2:w.side=Ra;break;default:w.side=Ra;break}w.transparent=b,b&&(w.depthWrite=!1),jc(u),w.internalUpdateUniforms();for(const E in _){const T=E,I=_[E].type;if(((M=u[T])==null?void 0:M.value)===void 0)switch(I){case Bc.SAMPLER_2D:u[T]={value:T0},console.warn("Missing/unassigned texture, fallback to white: "+T);break;default:console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+T,_[E]);break}}Tt&&console.log(w.uuid,u),a(w)}):null}}Uc(im,"NEEDLE_techniques_webgl");class N0{constructor(e){this.parser=e,this.name="EXT_texture_exr"}loadTexture(e){const t=this.name,s=this.parser,o=s.json.textures[e];if(!o.extensions||!o.extensions[t])return null;const a=o.extensions[t];let l=new O_(s.options.manager);return s.loadTextureImage(e,a.source,l)}}var $0=Object.defineProperty,W0=(i,e)=>$0(i,"name",{value:e,configurable:!0});const sm="NEEDLE_gameobject_data";class nm{constructor(e){r(this,"parser");this.parser=e}get name(){return sm}afterRoot(e){const t=[];for(let s=0;s<this.parser.json.nodes.length;s++){const n=this.parser.json.nodes[s];if(n&&n.extensions){const o=n.extensions[sm];if(o){const a=this.findAndApplyExtensionData(s,o);t.push(a)}}}return Promise.all(t).then(()=>{})}async findAndApplyExtensionData(e,t){const s=await this.parser.getDependency("node",e);s&&this.applyExtensionData(s,t)}applyExtensionData(e,t){e.userData.layer=t.layers,e.userData.tag=t.tag,e.userData.hideFlags=t.hideFlags,e.userData.static=t.static,e.visible=t.activeSelf,e.guid=t.guid}}W0(nm,"NEEDLE_gameobject_data");var H0=Object.defineProperty,z0=(i,e)=>H0(i,"name",{value:e,configurable:!0});const rm="NEEDLE_lightmaps",G0=O("debuglightmapsextension");var Lt;(function(i){i[i.Lightmap=0]="Lightmap",i[i.Skybox=1]="Skybox",i[i.Reflection=2]="Reflection"})(Lt||(Lt={}));class om{constructor(e,t,s){r(this,"parser");r(this,"registry");r(this,"source");this.parser=e,this.registry=t,this.source=s}get name(){return rm}afterRoot(e){const t=this.parser.json.extensions;if(t){const s=t[rm];if(s){const n=s.textures;return n.length?(G0&&console.log(s),new Promise(async(o,a)=>{const l=[];for(const c of n)if(c.pointer){const h=Tr(this.parser,c.pointer).then(d=>{const u=d;(u==null?void 0:u.isTexture)&&(this.registry?(c.type!==0&&(u.encoding=Gi),(u.type==C_||u.type==S_)&&(u.flipY=!0),this.registry.registerTexture(this.source,c.type,u,c.index)):console.log(Lt[c.type],c.pointer,u))});l.push(h)}await Promise.all(l),o()})):null}}return null}}z0(om,"NEEDLE_lightmaps");var V0=Object.defineProperty,am=(i,e)=>V0(i,"name",{value:e,configurable:!0});const lm=O("debugenvlight");var No;(function(i){i[i.Skybox=0]="Skybox",i[i.Trilight=1]="Trilight",i[i.Flat=3]="Flat",i[i.Custom=4]="Custom"})(No||(No={}));var $o;(function(i){i[i.Skybox=0]="Skybox",i[i.Custom=1]="Custom"})($o||($o={}));class cm{constructor(e){r(this,"context");r(this,"sceneLightSettings");r(this,"_timevec4",new $);r(this,"_waitPromise");r(this,"_lighting",{});this.context=e,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const e=this.context.time;this._timevec4.x=e.time,this._timevec4.y=Math.sin(e.time),this._timevec4.z=Math.cos(e.time),this._timevec4.w=e.deltaTime}get timeVec4(){return this._timevec4}registerSceneLightSettings(e){this.sceneLightSettings=e}registerReflection(e,t){const s=new hm(this.context,t,1);this._lighting[e]=s}getReflection(e){return this._lighting[e]}enableReflection(e){var s;switch((s=this.sceneLightSettings)==null?void 0:s.ambientMode){case 0:case 4:break;case 3:if(this.sceneLightSettings.ambientLight){const n=Gp(this.sceneLightSettings.ambientLight);this.context.scene.environment=n}return;default:return}const t=this.getReflection(e);if(t&&t.Source){const n=this.context.scene,o=t.Source;o.encoding=Gi,o.mapping=wa,n.environment=o}}disableReflection(){const e=this.context.scene;e.environment=null}async getSceneLightingData(e){return lm&&console.log("GET SCENE LIGHT DATA"),this._waitPromise?this._waitPromise:(this._waitPromise=new Promise((t,s)=>{let n=setInterval(async()=>{var a,l;const o=this.getReflection(e);o&&(clearInterval(n),t(o.getSphericalHarmonicsArray((l=(a=this.sceneLightSettings)==null?void 0:a.ambientIntensity)!=null?l:1)))},10)}),this._waitPromise)}}am(cm,"RendererData");class hm{constructor(e,t,s=1){r(this,"_context");r(this,"_source");r(this,"_sphericalHarmonics",null);r(this,"_sphericalHarmonicsArray");r(this,"_ambientScale",1);r(this,"_lightProbe");this._context=e,this._source=t,this._ambientScale=s,t.mapping=wa,t.encoding=Gi}get Source(){return this._source}get Array(){return this._sphericalHarmonicsArray}getSphericalHarmonicsArray(e=1){var t;if(((t=this._sphericalHarmonicsArray)==null?void 0:t.length)&&this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:this._lightProbe};try{const s=this._source;let n=null;if(s){lm&&console.log("GENERATING LIGHT PROBE",s);const o=Math.min(s.image.width,512);n=new R_(o).fromEquirectangularTexture(this._context.renderer,s),this._source=n.texture}if(this._sphericalHarmonicsArray=[],n){const o=E_.fromCubeRenderTarget(this._context.renderer,n);this._lightProbe=o;const a=this._ambientScale*(e*e*Math.PI*.5)-1;this._sphericalHarmonics=o.sh,this._sphericalHarmonicsArray=this._sphericalHarmonics.toArray();const l=e/(Math.PI*.5);for(let c=0;c<this._sphericalHarmonicsArray.length;c++)this._sphericalHarmonicsArray[c]*=l;if(o.sh.scale(a),this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:o}}}catch(s){console.error(s)}return null}}am(hm,"LightData");var q0=Object.defineProperty,dm=(i,e)=>q0(i,"name",{value:e,configurable:!0});const um="NEEDLE_lighting_settings",Wo=O("debugenvlight");class fm{constructor(e,t,s){r(this,"parser");r(this,"sourceId");r(this,"context");this.parser=e,this.sourceId=t,this.context=s}get name(){return um}afterRoot(e){const t=this.parser.json.extensions;if(t){const s=t[um];if(s){Wo&&console.log(s);const n=p.addNewComponent(e.scene,pm,!1);n.sourceId=this.sourceId,n.ambientIntensity=s.ambientIntensity,n.ambientLight=new g().fromArray(s.ambientLight),n.ambientMode=s.ambientMode,n.defaultReflectionMode=s.defaultReflectionMode,this.context&&this.context.rendererData.registerSceneLightSettings(n)}}return null}}dm(fm,"NEEDLE_lighting_settings");class pm extends v{constructor(){super(...arguments);r(this,"ambientMode",No.Skybox);r(this,"ambientLight");r(this,"ambientIntensity",1);r(this,"defaultReflectionMode",$o.Skybox);r(this,"_hasReflection",!1);r(this,"_ambientLightObj");r(this,"_lightProbeObj")}awake(){if(this.sourceId){const e=this.defaultReflectionMode===$o.Skybox?Lt.Skybox:Lt.Reflection,t=this.context.lightmaps.tryGet(this.sourceId,e,0);this._hasReflection=t!=null,t&&this.context.rendererData.registerReflection(this.sourceId,t)}Wo&&window.addEventListener("keydown",e=>{switch(e.key){case"l":this.enabled=!this.enabled;break}})}onEnable(){var t,s;const e=((t=this.context.mainCameraComponent)==null?void 0:t.sourceId)===this.sourceId;Wo&&console.log("enable",this.sourceId,e,this,(s=this.context.mainCameraComponent)==null?void 0:s.sourceId),this.ambientMode==No.Flat?(this.ambientLight&&(this._ambientLightObj=new A_(this.ambientLight,Math.PI*this.ambientIntensity)),this._ambientLightObj&&this.gameObject.add(this._ambientLightObj),this._lightProbeObj&&this._lightProbeObj.removeFromParent()):(this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._lightProbeObj?this.enabled&&this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj):this.sourceId&&this.context.rendererData.getSceneLightingData(this.sourceId).then(n=>{console.log(n),!!n&&(this._lightProbeObj=n.lightProbe,this.enabled&&!this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj))})),this.sourceId&&this._hasReflection&&this.context.rendererData.enableReflection(this.sourceId)}onDisable(){Wo&&console.log("disable",this.sourceId,this),this._lightProbeObj&&this._lightProbeObj.removeFromParent(),this.sourceId&&this._hasReflection&&this.context.rendererData.disableReflection()}}dm(pm,"SceneLightSettings");var Q0=Object.defineProperty,Nc=(i,e)=>Q0(i,"name",{value:e,configurable:!0});function $c(i){const e=new kl;return i.register(t=>(e.parser=t,e)),e}Nc($c,"registerComponentExtension");class mm{resolvePath(e){return e.includes("/extensions/builtin_components/")&&(e=e.replace("/extensions/builtin_components/","/userData/components/")),e}}Nc(mm,"PointerResolver");function Wc(i,e,t){i.register(n=>new nm(n)),i.register(n=>new au(n)),i.register(n=>new om(n,e.lightmaps,t)),i.register(n=>new fm(n,t,e)),i.register(n=>new im(n,t)),i.register(n=>new Xs(n,t)),i.register(n=>new N0(n));const s=i.setAnimationPointerResolver;typeof s=="function"&&s.bind(i)(new mm)}Nc(Wc,"registerExtensions");var X0=Object.defineProperty,Oe=(i,e)=>X0(i,"name",{value:e,configurable:!0});const Y0=O("printGltf");var Hc;(function(i){i[i.BeforeLoad=0]="BeforeLoad",i[i.AfterLoaded=1]="AfterLoaded",i[i.FinishedSetup=10]="FinishedSetup"})(Hc||(Hc={}));class Yt{constructor(e,t,s,n){r(this,"context");r(this,"loader");r(this,"path");r(this,"gltf");this.context=e,this.path=t,this.loader=s,this.gltf=n}}Oe(Yt,"GltfLoadEvent");const Jt={};function gm(i,e){Jt[i]=Jt[i]||[],Jt[i].push(e)}Oe(gm,"addGltfLoadEventListener");function _m(i,e){if(Jt[i]){const t=Jt[i].indexOf(e);t>=0&&Jt[i].splice(t,1)}}Oe(_m,"removeGltfLoadEventListener");function Pi(i,e){if(Jt[i])for(const t of Jt[i])t(e)}Oe(Pi,"invokeEvents");async function zc(i,e,t,s,n){Y0&&console.log(t),await i.assets.registerGltf(t),await Ic(i,e,t,s,n)}Oe(zc,"handleLoadedGltf");function Wn(i,e,t,s){typeof t!="string"&&console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",t,typeof t);const n=new Oa;Wc(n,i,t);const a=$c(n);return new Promise((l,c)=>{try{$r(n,i),Pi(0,new Yt(i,t,n)),n.parse(e,t,async h=>{Pi(1,new Yt(i,t,n,h)),await zc(i,t,h,s,a),Pi(10,new Yt(i,t,n,h)),l(h)},h=>{console.error("failed loading "+t,h),l(void 0)})}catch(h){console.error(h),c(h)}})}Oe(Wn,"parseSync");function Cs(i,e,t,s=!1,n){const o=new Oa;Wc(o,i,e);const l=$c(o);return new Promise((c,h)=>{try{$r(o,i),Pi(0,new Yt(i,e,o)),o.load(e,async d=>{Pi(1,new Yt(i,e,o,d)),await zc(i,e,d,t,l),Pi(10,new Yt(i,e,o,d)),c(d)},d=>{n==null||n.call(o,d)},d=>{console.error("failed loading "+e,d),c(void 0)})}catch(d){console.error(d),h(d)}})}Oe(Cs,"loadSync");function bm(i,e,t,s=!1){e&&e.animations&&e.animations.length>0&&t.push(()=>{Gc(e,s)})}Oe(bm,"findAnimationsLate");function Gc(i,e=!1){var s;if(!i||!i.animations||!i.scene||!e&&!p.getComponentInChildren(i.scene,Nt))return;for(let n=0;n<i.animations.length;n++){const o=i.animations[n];if(!(!o.tracks||o.tracks.length<=0))for(const a in o.tracks){const l=o.tracks[a],c=(s=l.__objectName)!=null?s:l.name.substring(0,l.name.indexOf(".")),h=i.scene.getObjectByName(c);if(!h)continue;let d=t(h);if(!d)if(e)d=p.addNewComponent(i.scene,Nt);else{console.warn("Failed finding animator for",l.name,c);continue}const u=d.animations=d.animations||[];o.name_animator=d.name,u.indexOf(o)<0&&u.push(o)}}function t(n){var a;if(!n)return;const o=(a=n.userData)==null?void 0:a.components;if(o&&o.length>0)for(let l=0;l<o.length;l++){const c=o[l];if(c instanceof _t||c instanceof Nt)return n}return t(n.parent)}Oe(t,"findAnimationGameObjectInParent")}Oe(Gc,"findAnimations");function Vc(i,e,t=!0){if(e.userData&&e.userData.name===i)return e;if(e.children&&e.children.length>0)for(let s=0;s<e.children.length;s++){const n=e.children[s],o=Vc(i,n,t);if(o)return o}}Oe(Vc,"tryFindObjectByName");function ym(i,e,t=!0){return ri(i,e,t)}Oe(ym,"tryFindObject");function vm(i,e=null){const t=e!=null?e:k.Current.scripts;for(const s in t){const n=t[s];if(n&&n.guid===i)return n}return null}Oe(vm,"tryFindScript");var J0=Object.freeze(Object.defineProperty({__proto__:null,get GltfLoadEventType(){return Hc},GltfLoadEvent:Yt,addGltfLoadEventListener:gm,removeGltfLoadEventListener:_m,parseSync:Wn,loadSync:Cs,findAnimationsLate:bm,findAnimations:Gc,tryFindObjectByName:Vc,tryFindObject:ym,tryFindScript:vm},Symbol.toStringTag,{value:"Module"})),Z0=Object.defineProperty,K0=(i,e)=>Z0(i,"name",{value:e,configurable:!0});function Ho(i,e){let t=p.getComponentInChildren(i,Pt);if(t||(t=p.addNewComponent(i,Pt,!1),t.guid=e.generateUUID()),t&&!p.getComponent(t.gameObject,yt)){const s=p.addNewComponent(t.gameObject,yt,!1);s.guid=e.generateUUID()}if(t&&!p.getComponentInParent(t.gameObject,vs)){const s=p.addNewComponent(t.gameObject,vs,!1);s.guid=e.generateUUID()}}K0(Ho,"onDynamicObjectAdded");var eP=Object.defineProperty,xi=(i,e)=>eP(i,"name",{value:e,configurable:!0}),zo;(function(i){i.File_Spawned="file-spawned"})(zo||(zo={}));class wm{constructor(e,t,s,n,o,a,l,c){r(this,"guid");r(this,"file_name");r(this,"file_hash");r(this,"file_size");r(this,"position");r(this,"seed");r(this,"sender");r(this,"serverUrl");r(this,"parentGuid");r(this,"boundsSize");this.seed=t,this.guid=s,this.file_name=n,this.file_hash=o,this.file_size=a,this.position=l,this.sender=e,this.serverUrl=c}}xi(wm,"FileSpawnModel");async function Pm(i,e,t){const s=i.name;return s.endsWith(".gltf")||s.endsWith(".glb")?new Promise((n,o)=>{const a=new FileReader;a.readAsDataURL(i),a.onloadend=async l=>{const c=a.result,h=pr(),d=new Ee(h),u=await Cs(e,c,d,!0);if(u&&u.scene){const _=u.scene;if(!_.guid){const b=new Ee(h);_.guid=b.generateUUID()}t&&Cm(e.connection,i,h,_,t),Ho(_,d),n(_)}}}):(console.warn("Unsupported file type: "+s),console.log(i),null)}xi(Pm,"addFile");async function xm(i,e){return new Promise(async(t,s)=>{const n=pr(),o=new Ee(n),a=await Cs(e,i.toString(),o,!0);if(a&&a.scene){const l=a.scene;Ho(l,o),t(l)}else console.warn("Unsupported file type: "+i.toString())})}xi(xm,"addFileFromUrl");function Om(i){i.connection.beginListen(zo.File_Spawned,async e=>{if(e.sender!==i.connection.connectionId){console.log("received file event",e),Sm(e,i);let t=null;try{t=await gl(e.file_name,e.file_hash,e.file_size,e.serverUrl)}finally{Rm(e)}if(t){const s=new Ee(e.seed),n=await Wn(i,t,null,s);if(n&&n.scene){const o=n.scene;if(Ho(o,s),e.parentGuid){const a=p.findByGuid(e.parentGuid,i.scene);"add"in a&&a.add(o)}o.parent||i.scene.add(o),e.position!==null&&o.position.copy(e.position)}}else console.error("download didnt return file")}})}xi(Om,"beginListenFileSpawn");async function Cm(i,e,t,s,n){var l;if(!i.connectionId){console.error("Can not upload file - no connection id");return}if(!s.guid){console.error("Can not upload file - no guid",s,s.guid);return}const o=await Cu(e,n);if(!o)return;if(!o.filename){console.error("Can not send upload event - no filename",e.name);return}if(!o.hash){console.error("Can not send upload event - no hash",e.name);return}const a=new wm(i.connectionId,t,s.guid,o.filename,o.hash,e.size,s.position,(l=o.url)!=null?l:n);s.parent&&(a.parentGuid=s.parent.guid),i.send(zo.File_Spawned,a)}xi(Cm,"handleUpload");const qc={};function Sm(i,e){const t=new Sh,s=new ii(t,new $s({color:65280})),n=new Dh(s,5592405);if(qc[i.guid]=n,e.scene.add(n),i.parentGuid){const o=p.findByGuid(i.parentGuid,e.scene);o&&o.add(n)}i.position&&n.position.copy(i.position)}xi(Sm,"addPreview");function Rm(i,e){const t=i.guid,s=qc[t];s&&(delete qc[t],s.removeFromParent())}xi(Rm,"removePreview");var tP=Object.defineProperty,Go=(i,e)=>tP(i,"name",{value:e,configurable:!0});O("debugassets");class iP{constructor(){r(this,"name");r(this,"sampler");r(this,"source");r(this,"extras")}}Go(iP,"TextureInfo");class sP{constructor(){r(this,"bufferView");r(this,"mimeType");r(this,"extras")}}Go(sP,"ImageInfo");class nP{constructor(){r(this,"textures");r(this,"bufferViews")}}Go(nP,"GltfJson");class Em{constructor(){r(this,"texturesLoader",new T_);r(this,"textures",{});r(this,"texturesLoading",{});r(this,"_materials",new Map);r(this,"_meshes",new Map);r(this,"_textures",new Map);window.addEventListener("unhandledrejection",e=>{var s;if(e.defaultPrevented)return;const t=(s=e==null?void 0:e.reason)==null?void 0:s.path;if(t){const n=t[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),e.preventDefault())}})}async loadTexture(e){if(this.textures[e])return this.textures[e];if(this.texturesLoading[e])return await this.texturesLoading[e];const t=this.texturesLoader.loadAsync(e);this.texturesLoading[e]=t;const s=await t;return delete this.texturesLoading[e],this.textures[e]=s,s}getTexture(e){return this._textures.get(e)||null}findTexture(e){for(const t of this._textures.values())if(t.name===e)return t;return null}findMesh(e){for(const t of this._meshes.values())if(t.name===e)return t;return null}findMaterial(e){for(const t of this._materials.values())if(t.name===e)return t;return null}async registerGltf(e){}registerAsset(e){}}Go(Em,"AssetDatabase");var rP=Object.defineProperty,oP=(i,e)=>rP(i,"name",{value:e,configurable:!0});const Am=!!O("debuglightmaps");class Tm{constructor(e){r(this,"_context");r(this,"_lightmaps",new Map);this._context=e}registerTexture(e,t,s,n){var l;Am&&console.log("Registering lightmap",e,Lt[t],s),this._lightmaps.has(e)||this._lightmaps.set(e,new Map);const o=this._lightmaps.get(e),a=(l=o==null?void 0:o.get(t))!=null?l:[];a.length<n&&(a.length=n+1),a[n]=s,o==null||o.set(t,a)}tryGetLightmap(e,t=0){return this.tryGet(e,Lt.Lightmap,t)}tryGetSkybox(e){return this.tryGet(e,Lt.Skybox,0)}tryGetReflection(e){return this.tryGet(e,Lt.Reflection,0)}tryGet(e,t,s){var o,a;if(!e)return Am&&console.warn("Missing source id"),null;const n=(a=(o=this._lightmaps.get(e))==null?void 0:o.get(t))!=null?a:null;return!(n==null?void 0:n.length)||n.length<=s?null:n[s]}}oP(Tm,"LightDataRegistry");Hs.lights_fragment_maps=Hs.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vUv2 );",`

    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);Hs.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;

        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;Hs.lights_fragment_begin=Hs.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);L_.lightmap.lightmapScaleOffset={value:new $(1,1,0,0)};var aP=Object.defineProperty,Vo=(i,e)=>aP(i,"name",{value:e,configurable:!0});const lP=O("debugSetup"),cP=O("stats"),qo={};class Lm{constructor(e){r(this,"name");r(this,"alias");r(this,"domElement");r(this,"renderer");this.domElement=e!=null?e:document.body}}Vo(Lm,"ContextArgs");var Ce;(function(i){i[i.EarlyUpdate=0]="EarlyUpdate",i[i.Update=1]="Update",i[i.LateUpdate=2]="LateUpdate",i[i.OnBeforeRender=3]="OnBeforeRender",i[i.OnAfterRender=4]="OnAfterRender",i[i.PhysicsStep=10]="PhysicsStep"})(Ce||(Ce={}));const Se=class{constructor(e){r(this,"name");r(this,"alias");r(this,"isManagedExternally",!1);r(this,"domElement");r(this,"scene");r(this,"renderer");r(this,"composer",null);r(this,"scripts",[]);r(this,"scripts_earlyUpdate",[]);r(this,"scripts_update",[]);r(this,"scripts_lateUpdate",[]);r(this,"scripts_onBeforeRender",[]);r(this,"scripts_onAfterRender",[]);r(this,"scripts_WithCorroutines",[]);r(this,"coroutines",{});r(this,"mainCameraComponent");r(this,"post_setup_callbacks",[]);r(this,"pre_update_callbacks",[]);r(this,"pre_render_callbacks",[]);r(this,"post_render_callbacks",[]);r(this,"new_scripts",[]);r(this,"new_script_start",[]);r(this,"new_scripts_pre_setup_callbacks",[]);r(this,"new_scripts_post_setup_callbacks",[]);r(this,"application");r(this,"time");r(this,"input");r(this,"physics");r(this,"connection");r(this,"assets");r(this,"mainLight",null);r(this,"rendererData");r(this,"addressables");r(this,"lightmaps");r(this,"_sizeChanged",!1);r(this,"_isCreated",!1);r(this,"_stats",cP?D_():null);r(this,"_cameraStack",[]);r(this,"_onBeforeRenderListeners",{});if(this.name=(e==null?void 0:e.name)||"",this.alias=e==null?void 0:e.alias,this.domElement=(e==null?void 0:e.domElement)||document.body,e==null?void 0:e.renderer)this.renderer=e.renderer,this.isManagedExternally=!0;else{const s=O("postfx");this.renderer=new yh({antialias:!0}),this.renderer.toneMappingExposure=1,this.renderer.toneMapping=k_,this.renderer.setClearColor(new g("lightgrey"),0),this.renderer.antialias=!0,this.renderer.alpha=!1,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=I_,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputEncoding=Gi,this.renderer.physicallyCorrectLights=!0,this.composer=s?new M_(this.renderer):null}this.scene=new vh,this.application=new wu(this),this.time=new Wd,this.input=new Sd(this),this.physics=new $d(this),this.connection=new Qd(this),this.assets=new Em,this.rendererData=new cm(this),this.addressables=new Hu(this),this.lightmaps=new Tm(this),window.addEventListener("resize",this.updateSize.bind(this)),new ResizeObserver(s=>this._sizeChanged=!0).observe(this.domElement)}static get Current(){return this._current}static set Current(e){this._current=e}get domWidth(){return this.domElement.clientWidth}get domHeight(){return this.domElement.clientHeight}get domX(){return this.domElement.offsetLeft}get domY(){return this.domElement.offsetTop}get isInXR(){return this.renderer.xr.isPresenting}get mainCamera(){if(this.mainCameraComponent){const e=this.mainCameraComponent;return e.cam||e.buildCamera(),e.cam}return null}updateSize(){if(!this.isManagedExternally&&!this.renderer.xr.isPresenting){this._sizeChanged=!1;const e=this.domWidth,t=this.domHeight,s=this.mainCamera;this.updateAspect(s),this.renderer.setSize(e,t),this.renderer.setPixelRatio(window.devicePixelRatio),this.composer&&(this.composer.setSize(e,t),this.composer.setPixelRatio(window.devicePixelRatio))}}updateAspect(e){if(!e)return;const t=this.domWidth,s=this.domHeight,n=e.aspect;e.aspect=t/s,n!==e.aspect&&e.updateProjectionMatrix()}onCreate(e,t){return this._isCreated?(console.warn("Context already created"),null):(this._isCreated=!0,this.internalOnCreate(e,t))}onDestroy(){var e,t;!this._isCreated||(this._isCreated=!1,p.destroy(this.scene,!0),(e=this.renderer)==null||e.setAnimationLoop(null),this.isManagedExternally||(t=this.renderer)==null||t.dispose())}registerCoroutineUpdate(e,t,s){return this.coroutines[s]||(this.coroutines[s]=[]),this.coroutines[s].push({comp:e,main:t}),t}unregisterCoroutineUpdate(e,t){if(!this.coroutines[t])return;const s=this.coroutines[t].findIndex(n=>n.main===e);s>=0&&this.coroutines[t].splice(s,1)}stopAllCoroutinesFrom(e){for(const t in this.coroutines){const s=this.coroutines[t];for(let n=s.length-1;n>=0;n--)s[n].comp===e&&s.splice(n,1)}}setCurrentCamera(e){var n;if(!e)return;if(e.cam||e.buildCamera(),!e.cam){console.warn("Camera component is missing camera",e);return}const t=this._cameraStack.indexOf(e);t>=0&&this._cameraStack.splice(t,1),this._cameraStack.push(e),this.mainCameraComponent=e;const s=e.cam;s.isPerspectiveCamera&&this.updateAspect(s),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}addBeforeRenderListener(e,t){if(!this._onBeforeRenderListeners[e.uuid]){this._onBeforeRenderListeners[e.uuid]=[];const s=Vo((n,o,a,l,c,h)=>{const d=this._onBeforeRenderListeners[e.uuid];if(!!d)for(let u=0;u<d.length;u++)d[u](n,o,a,l,c,h)},"onBeforeRenderCallback");e.onBeforeRender=s}this._onBeforeRenderListeners[e.uuid].push(t)}removeBeforeRenderListener(e,t){if(this._onBeforeRenderListeners[e.uuid]){const s=this._onBeforeRenderListeners[e.uuid],n=s.indexOf(t);n>=0&&s.splice(n,1)}}async internalOnCreate(e,t){var o;let s=!0;try{Se.Current=this,e&&await e(this,t)}catch(a){console.error(a),s=!1}if(!s)return;this.isManagedExternally||this.domElement.prepend(this.renderer.domElement),vd(this),bd(this),Om(this),Se._current=this;for(let a=0;a<this.new_scripts.length;a++){const l=this.new_scripts[a];if(l.gameObject!==void 0&&l.gameObject!==null){l.gameObject.userData===void 0&&(l.gameObject.userData={}),l.gameObject.userData.components===void 0&&(l.gameObject.userData.components=[]);const c=l.gameObject.userData.components;c.includes(l)||c.push(l)}}if(this.post_setup_callbacks)for(let a=0;a<this.post_setup_callbacks.length;a++)Se._current=this,await this.post_setup_callbacks[a](this);if(!this.mainCamera){Se._current=this;const a=p.findObjectsOfType(W,this),l=(o=a.find(c=>c.tag=="MainCamera"))!=null?o:a.find(c=>!0);if(l)l.tag!=="MainCamera"&&console.warn('No mainCamera configured. Some components rely on a mainCamera object being present. When exporting your scene, make sure to set the mainCamera tag on your camera. Using "'+l.name+'" as mainCamera now.'),this.setCurrentCamera(l);else{console.error("No camera found");const c=tu(this.scene);this.setCurrentCamera(c)}}Se._current=this,qi(this),nl!==void 0&&ni(nl,this);const n=this.mainCameraComponent;if(n&&n.applyClearFlagsIfIsActiveCamera(),!this.isManagedExternally&&this.composer&&this.mainCamera){const a=new j_(this.scene,this.mainCamera);this.renderer.setSize(this.domWidth,this.domHeight),this.composer.addPass(a),this.composer.setSize(this.domWidth,this.domHeight)}this._sizeChanged=!0,this._stats&&(this._stats.showPanel(1),this.domElement.appendChild(this._stats.dom)),this.renderer.setAnimationLoop(this.render.bind(this)),lP&&hr(this.scene,!0)}render(e,t){var s,n;for((s=this._stats)==null||s.begin(),Se._current=this,this.time.update(),qi(this),Zh(),Yh(this);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();for(let o=0;o<this.scripts_earlyUpdate.length;o++){const a=this.scripts_earlyUpdate[o];!a.activeAndEnabled||a.earlyUpdate!==void 0&&(Se._current=this,a.earlyUpdate())}this.executeCoroutines(0);for(let o=0;o<this.scripts_update.length;o++){const a=this.scripts_update[o];!a.activeAndEnabled||a.update!==void 0&&(Se._current=this,a.update())}this.executeCoroutines(1);for(let o=0;o<this.scripts_lateUpdate.length;o++){const a=this.scripts_lateUpdate[o];!a.activeAndEnabled||a.lateUpdate!==void 0&&(Se._current=this,a.lateUpdate())}this.mainLight=null,this.executeCoroutines(2);try{const o=2,a=this.time.deltaTime/o;for(let l=0;l<o;l++)this.physics.step(a),this.executeCoroutines(10)}catch(o){console.error(o)}this.physics.postStep();for(let o=0;o<this.scripts_onBeforeRender.length;o++){const a=this.scripts_onBeforeRender[o];!a.activeAndEnabled||a.onBeforeRender!==void 0&&(Se._current=this,a.onBeforeRender(t))}if(this.executeCoroutines(3),this._sizeChanged&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o]();this.isManagedExternally||(this.composer?this.composer.render():this.mainCamera&&this.renderer&&this.renderer.render(this.scene,this.mainCamera));for(let o=0;o<this.scripts_onAfterRender.length;o++){const a=this.scripts_onAfterRender[o];!a.activeAndEnabled||a.onAfterRender!==void 0&&(Se._current=this,a.onAfterRender())}if(this.executeCoroutines(4),this.post_render_callbacks)for(const o in this.post_render_callbacks)this.post_render_callbacks[o]();this.connection.sendBufferedMessagesNow(),(n=this._stats)==null||n.end()}executeCoroutines(e){if(this.coroutines[e]){const s=this.coroutines[e];for(let n=0;n<s.length;n++){const o=s[n];if(!o.comp||o.comp.destroyed||!o.main){s.splice(n,1),--n;continue}const a=o.chained;if(a&&a.length>0){const d=a[a.length-1].next();if(d.done&&a.pop(),t(d)&&(o.chained||(o.chained=[]),o.chained.push(d.value)),!d.done)continue}const l=o.main.next();if(l.done===!0){s.splice(n,1),--n;continue}const c=l.value;if(t(c)){if(c.next().done)continue;o.chained||(o.chained=[]),o.chained.push(c)}}}function t(s){return!!(s&&s.next&&s.return)}Vo(t,"isGenerator")}};let k=Se;r(k,"_current");Vo(k,"Context");var hP=Object.freeze(Object.defineProperty({__proto__:null,build_scene_functions:qo,ContextArgs:Lm,get FrameEvent(){return Ce},Context:k},Symbol.toStringTag,{value:"Module"}));const Ss=_a(dt(dt({},hP),J0),{RGBAColor:fe});var Dm=Object.defineProperty,dP=Object.getOwnPropertyDescriptor,Oi=(i,e)=>Dm(i,"name",{value:e,configurable:!0}),Ci=(i,e,t,s)=>{for(var n=s>1?void 0:s?dP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Dm(e,t,n),n};class Zt extends v{constructor(){super(...arguments);r(this,"id")}}Oi(Zt,"QueryNode");Ci([f()],Zt.prototype,"id",2);class Qc extends v{}Oi(Qc,"QueryResults");class Qo extends Zt{constructor(){super(...arguments);r(this,"result")}getResult(){return this.result}}Oi(Qo,"StaticMaterialQueryNode");Ci([f(Ih)],Qo.prototype,"result",2);class Xo extends Zt{constructor(){super(...arguments);r(this,"result")}getResult(){return this.result}}Oi(Xo,"StaticBoolQueryNode");Ci([f()],Xo.prototype,"result",2);class Rs{constructor(){r(this,"renderer");r(this,"index")}}Oi(Rs,"MaterialSlot");Ci([f(X)],Rs.prototype,"renderer",2);Ci([f()],Rs.prototype,"index",2);class Yo extends Zt{constructor(){super(...arguments);r(this,"result")}getResult(){return this.result}}Oi(Yo,"StaticListMaterialSlotQueryNode");Ci([f(Rs)],Yo.prototype,"result",2);class Jo extends Zt{constructor(){super(...arguments);r(this,"result")}getResult(){return this.result}}Oi(Jo,"StaticListGameObjectQueryNode");Ci([f(x)],Jo.prototype,"result",2);var km=Object.defineProperty,uP=Object.getOwnPropertyDescriptor,Zo=(i,e)=>km(i,"name",{value:e,configurable:!0}),Ko=(i,e,t,s)=>{for(var n=s>1?void 0:s?uP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&km(e,t,n),n};class Hn{constructor(){r(this,"id");r(this,"query");r(this,"_fetched",0);r(this,"_maxFetches",20)}fetch(e){if(this.query||this._fetched>=this._maxFetches)return;this._fetched+=1;const t=this._fetched>=this._maxFetches,s=this.find(e);s?this.query=s:t&&console.warn("Failed resolving",this)}find(e){const t=p.findObjectsOfType(Zt,e);for(const s of t)if(s.id===this.id)return s}}Zo(Hn,"DeferredQuery");Ko([f()],Hn.prototype,"id",2);Ko([f(Zt)],Hn.prototype,"query",2);class Es extends v{constructor(){super(...arguments);r(this,"targetDeferredQuery");r(this,"valueDeferredQuery")}get targetQuery(){var e;return(e=this.targetDeferredQuery)==null?void 0:e.query}get valueQuery(){var e;return(e=this.valueDeferredQuery)==null?void 0:e.query}invert(e){}resolveTarget(){var e;return(e=this.targetQuery)==null?void 0:e.getResult()}resolveValue(){var e;return(e=this.valueQuery)==null?void 0:e.getResult()}}Zo(Es,"Assignment");Ko([f(Hn)],Es.prototype,"targetDeferredQuery",2);Ko([f(Hn)],Es.prototype,"valueDeferredQuery",2);class Xc extends Es{apply(e,t){var o,a;(o=this.valueDeferredQuery)==null||o.fetch(),(a=this.targetDeferredQuery)==null||a.fetch();const s=this.resolveTarget(),n=this.resolveValue();if(s&&n){for(const l of s)if(l){if(t&&(t==null?void 0:t.isActiveInVariant(l)))continue;const c=e?!n:n;p.setActive(l,c)}}}invert(e){this.apply(!0,e)}}Zo(Xc,"GameObjectVisibilityAssignment");class Yc extends Es{start(){}apply(){var s,n,o,a;(s=this.valueDeferredQuery)==null||s.fetch(),(n=this.targetDeferredQuery)==null||n.fetch();const e=this.resolveValue(),t=this.resolveTarget();if(Array.isArray(t))for(const l of t){if(!((o=l.renderer)==null?void 0:o.sharedMaterials)){console.error("Invalid slot",l);continue}l.renderer.sharedMaterials[l.index]=e}else console.warn("Could not resolve target for material assignment",(a=this.targetDeferredQuery)==null?void 0:a.id)}}Zo(Yc,"MaterialAssignment");var fP=Object.defineProperty,pP=(i,e)=>fP(i,"name",{value:e,configurable:!0});const ea="ar",mP="quit-ar";class Im{constructor(){r(this,"arContainer",null);r(this,"closeARCallback");r(this,"currentSession",null);r(this,"registeredCloseEventElements",[]);r(this,"_createdAROnlyElements",[]);this.closeARCallback=this.onRequestedEndAR.bind(this)}get ARContainer(){return this.arContainer}requestEndAR(){this.onRequestedEndAR()}onBegin(e,t){if(this.currentSession=t,this.arContainer=e,!this.arContainer)return;const s=e.getElementsByClassName(mP);if(!s||s.length<=0)console.warn("Missing quit AR elements"),this.createFallbackCloseARButton(this.arContainer);else for(let n=0;n<s.length;n++){const o=s[n];!o||(o.addEventListener("click",this.closeARCallback),this.registeredCloseEventElements.push(o))}}onEnd(){for(const e of this._createdAROnlyElements)e.remove&&e.remove()}findArContainer(e){if(e.classList.contains(ea))return e;if(e.children){for(const t of e.children)if(!(!t||!t.classList)&&t.classList.contains(ea))return t}return null}onRequestedEndAR(){if(!!this.currentSession){this.currentSession.end(),this.currentSession=null;for(const e of this.registeredCloseEventElements)e.removeEventListener("click",this.closeARCallback);this.registeredCloseEventElements.length=0}}createFallbackCloseARButton(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","38px"),t.setAttribute("height","38px"),t.style.position="absolute",t.style.right="20px",t.style.top="40px",t.style.zIndex="9999",t.style.pointerEvents="auto",t.addEventListener("click",this.closeARCallback),e.appendChild(t),this._createdAROnlyElements.push(t);var s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),s.setAttribute("stroke","#eee"),s.setAttribute("stroke-width","2px"),t.appendChild(s),this._createdAROnlyElements.push(s)}}pP(Im,"AROverlayHandler");var gP=Object.defineProperty,ta=(i,e)=>gP(i,"name",{value:e,configurable:!0});const _P=O("debugloadingbar");class bP{constructor(){r(this,"className");r(this,"additionalClasses")}}ta(bP,"LoadingElementOptions");function Jc(i){return i.index/i.count+i.progress.loaded/i.progress.total/i.count}ta(Jc,"calculateProgress01");class Mm{constructor(e,t){r(this,"loadingProgress",0);r(this,"container");r(this,"_progress",0);r(this,"_allowCustomLoadingElement",!1);r(this,"_loadingElement");r(this,"_loadingTextContainer",null);r(this,"_loadingBar",null);r(this,"_messageContainer",null);r(this,"_loadingElementOptions");r(this,"_progressLoop");this.container=e,this._loadingElementOptions=t}onLoadingBegin(e){if(!this._loadingElement){for(let t=0;t<this.container.children.length;t++){const s=this.container.children[t];if(s.classList.contains("loading")){if(!this._allowCustomLoadingElement){this.container.removeChild(s);continue}this._loadingElement=this.createLoadingElement();return}}this._loadingElement=this.createLoadingElement()}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="",this.container.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(e!=null?e:"")}onLoadingUpdate(e,t){var n;((n=this._loadingElement)==null?void 0:n.parentElement)||this.onLoadingBegin(t);let s=0;typeof e=="number"?s=e:("index"in e&&(s=Jc(e)),!t&&"name"in e&&this.setMessage(e.name)),this.loadingProgress=s,t&&this.setMessage(t),this.updateDisplay()}onLoadingFinished(e){this.loadingProgress=1,this.setMessage(e!=null?e:"")}setMessage(e){this._messageContainer&&(this._messageContainer.innerText=e)}smoothProgressLoop(){if(this._progressLoop)return;let e=1/12;_P&&(e=.001);const t=1-.05;this._progressLoop=setInterval(()=>{if(this.loadingProgress>=1&&this._progress>=t){this._loadingElement&&(this._loadingElement.style.display="none",this._loadingElement.remove()),clearInterval(this._progressLoop),this._progressLoop=null;return}this._progress=L.lerp(this._progress,this.loadingProgress,e*this.loadingProgress),this.updateDisplay()},e)}updateDisplay(){const e=this._progress,t=(e*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=e*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=t)}createLoadingElement(e){var l,c,h;this._loadingElement=e||document.createElement("div");const t=(c=(l=this._loadingElementOptions)==null?void 0:l.className)!=null?c:"loading";if(this._loadingElement.classList.add(t),(h=this._loadingElementOptions)==null?void 0:h.additionalClasses)for(const d of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(d);e||(this._loadingElement.style.color="white",this._loadingElement.style.display="flex");const s=document.createElement("div"),n=20;s.style.display="flex",s.style.width=n+"%",s.style.height="2px",s.style.background="rgba(255,255,255,.1)",this._loadingElement.appendChild(s),this._loadingBar=document.createElement("div"),s.appendChild(this._loadingBar);const o=ta(function(d){return L.lerp(n*.5,100-n*.5,d)+"%"},"getGradientPos");this._loadingBar.style.background=`linear-gradient(90deg, #02022B ${o(0)}, #0BA398 ${o(.4)}, #99CC33 ${o(.5)}, #D7DB0A ${o(1)})`,this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",this._loadingTextContainer=document.createElement("div"),this._loadingTextContainer.style.display="flex",this._loadingTextContainer.style.justifyContent="center",this._loadingTextContainer.style.marginTop=".9em",this._loadingElement.appendChild(this._loadingTextContainer);const a=document.createElement("div");return this._messageContainer=a,a.style.display="flex",a.style.fontSize=".8em",a.style.paddingTop=".5em",a.style.color="rgba(255,255,255,.5)",this._loadingElement.appendChild(a),this._loadingElement}}ta(Mm,"EngineLoadingView");var yP=Object.defineProperty,As=(i,e)=>yP(i,"name",{value:e,configurable:!0});class jm{constructor(e,t){r(this,"id");r(this,"context");r(this,"previouslyAdded");r(this,"previousSource");r(this,"networkEvent");this.id=e,this.context=t,this.networkEvent="needle-engine-source-changed",this.id&&(this.networkEvent+="-"+this.id),this.context.connection.beginListen(this.networkEvent,s=>{this.onSourceChanged(s,!0)})}async onSourceChanged(e,t=!1,s=!1){this.previouslyAdded&&(t&&e===this.previousSource||p.destroySynced(this.previouslyAdded)),this.previouslyAdded=null,t||this.context.connection.send(this.networkEvent,e),this.previousSource=e,k.Current=this.context;const n=await Cs(this.context,e,this.getHashFromString(e));s||qi(this.context);const o=n==null?void 0:n.scene;o&&(this.previouslyAdded=o,this.context.scene.add(o))}getHashFromString(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}As(jm,"EngineElementSourceFileWatcher");const vP="needle-engine",wP="vr",PP="desktop",xP=[ea,wP,PP];class Fm extends HTMLElement{constructor(){super();r(this,"gameObject",p);r(this,"GameObject",p);r(this,"context",null);r(this,"overlay_ar");r(this,"_loadingProgress01",0);r(this,"_watcher");r(this,"_loadingView");this.overlay_ar=new Im}get loadingProgress01(){return this._loadingProgress01}get loadingFinished(){return this.loadingProgress01>.999}getContext(){return new Promise((e,t)=>{if(this.context&&this.loadingFinished)e(this.context);else{const s=As(()=>{this.removeEventListener("loading-finished",s),this.context&&this.loadingFinished&&e(this.context)},"cb");this.addEventListener("loading-finished",s)}})}async connectedCallback(){var a,l,c,h,d;this.onSetupDesktop();var e=new MutationObserver(this.onElementsChanged.bind(this));e.observe(this,{childList:!0});const t=As(()=>{const u=this.getAttribute("src");return(u==null?void 0:u.endsWith(".glb"))||(u==null?void 0:u.endsWith(".gltf"))?u:null},"srcFile");let s="loadScene";const n=t();n&&(s=n);const o=this.getAttribute("alias");if(this.context=new k({name:s,domElement:this,alias:o}),this._watcher=new jm((l=(a=this.getAttribute("id"))!=null?a:o)!=null?l:"",this.context),s&&s.length>0){if(!n)for(;Object.keys(qo).length<=0;){if(!this.isConnected)return;await qh(10)}let u=(c=qo[s])!=null?c:window[s],_=null;if((!u||n)&&(n&&(s=n),u=As(async b=>{const w=t();w&&this._watcher&&(_=w,await this._watcher.onSourceChanged(w,!0,!0))},"fn")),u){this.classList.add("loading"),console.log("Needle Engine: Begin loading",o!=null?o:"");const b=this.dispatchEvent(new CustomEvent("loadstart",{detail:{alias:o},cancelable:!0}));!this._loadingView&&b&&(this._loadingView=new Mm(this)),b&&((h=this._loadingView)==null||h.onLoadingBegin("begin load"));const w=As((S,A)=>{var M;this._loadingProgress01=Jc(S),b&&((M=this._loadingView)==null||M.onLoadingUpdate(S,A)),this.dispatchEvent(new CustomEvent("progress",{detail:{name:S.name,progress:S.progress,index:S.index,count:S.count,totalProgress01:this._loadingProgress01}}))},"loadingCallback");await this.context.onCreate(u,{progress:w});const C=t();C&&C!==_&&await this._watcher.onSourceChanged(C,!0,!0),this._loadingProgress01=1,b&&((d=this._loadingView)==null||d.onLoadingFinished("create scene")),this.classList.remove("loading"),this.classList.add("loading-finished"),console.log("Needle Engine: finished loading",o!=null?o:""),this.dispatchEvent(new CustomEvent("loadfinished",{detail:{src:o!=null?o:s}})),this.onSetupDesktop()}else console.error('Could not find scene function named "'+s+'", it must be either in global scope or added to build_scene_functions',qo)}else console.error("Missing src attribute - please provide a function name",this)}disconnectedCallback(){this.context&&this.context.onDestroy()}static get observedAttributes(){return["src"]}attributeChangedCallback(e,t,s){var n;(n=this._watcher)==null||n.onSourceChanged(s)}getAROverlayContainer(){var t;return(t=this.overlay_ar)==null?void 0:t.findArContainer(this)}getVROverlayContainer(){for(let e=0;e<this.children.length;e++){const t=this.children[e];if(t.classList.contains("vr"))return t}return null}onEnterAR(e,t){var s;this.onSetupAR(),this.overlay_ar.onBegin(t,e),this.dispatchEvent(new CustomEvent("enter-ar",{detail:{session:e,context:this.context,htmlContainer:(s=this.overlay_ar)==null?void 0:s.ARContainer}}))}onExitAR(e){var t;this.overlay_ar.onEnd(),this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-ar",{detail:{session:e,context:this.context,htmlContainer:(t=this.overlay_ar)==null?void 0:t.ARContainer}}))}onEnterVR(e){this.onSetupVR(),this.dispatchEvent(new CustomEvent("enter-vr",{detail:{session:e,context:this.context}}))}onExitVR(e){this.onSetupDesktop(),this.dispatchEvent(new CustomEvent("exit-vr",{detail:{session:e,context:this.context}}))}onElementsChanged(){}onSetupAR(){this.classList.add("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,ea))}onSetupVR(){this.classList.remove("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,"vr"))}onSetupDesktop(){this.classList.remove("ar-session-active"),this.classList.add("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,"desktop"))}setupElementsForMode(e,t,s=null){var o;if(e===((o=this.context)==null?void 0:o.renderer.domElement)||e.id==="VRButton"||e.id==="ARButton")return;if(e.style.position="absolute",e.classList.contains(t))e.style.visibility="visible",e.style.display="block";else for(const a of xP)e.classList.contains(a)&&(e.style.visibility="hidden",e.style.display="none")}foreachHtmlElement(e){for(let t=0;t<this.children.length;t++){const s=this.children[t];s.style&&e(s)}}}As(Fm,"EngineElement");window.customElements.define(vP,Fm);var OP=Object.defineProperty,CP=(i,e)=>OP(i,"name",{value:e,configurable:!0});const Bs=class extends v{constructor(){super(...arguments);r(this,"id");r(this,"fieldOfView",60);r(this,"targetDistance",.5)}static tryGetView(e){return this.views.find(t=>t.id===e)||null}onEnable(){var e;Bs.views.push(this),(e=Bs.viewRegisteredCallback)==null||e.call(this,this)}onDisable(){const e=Bs.views.indexOf(this);e>=0&&Bs.views.splice(e,1)}};let Kt=Bs;r(Kt,"views",[]),r(Kt,"viewRegisteredCallback");CP(Kt,"CameraView");var Bm=Object.defineProperty,SP=Object.getOwnPropertyDescriptor,Zc=(i,e)=>Bm(i,"name",{value:e,configurable:!0}),ia=(i,e,t,s)=>{for(var n=s>1?void 0:s?SP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Bm(e,t,n),n};class ei extends v{constructor(){super(...arguments);r(this,"code")}}Zc(ei,"FeatureBase");ia([f()],ei.prototype,"code",2);class De extends v{constructor(){super(...arguments);r(this,"features");r(this,"defaultFeature");r(this,"selectedFeature")}selectFeature(e){this.deselectFeature(),this.selectedFeature=e}deselectFeature(){this.selectedFeature=void 0}}Zc(De,"FeatureSet");ia([f(ei)],De.prototype,"features",2);ia([f(ei)],De.prototype,"defaultFeature",2);ia([f(ei)],De.prototype,"selectedFeature",2);class sa extends De{}Zc(sa,"PackSet");var Um=Object.defineProperty,RP=Object.getOwnPropertyDescriptor,Nm=(i,e)=>Um(i,"name",{value:e,configurable:!0}),$m=(i,e,t,s)=>{for(var n=s>1?void 0:s?RP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Um(e,t,n),n};class Si extends ei{constructor(){super(...arguments);r(this,"featureSet")}}Nm(Si,"Feature");$m([f(De)],Si.prototype,"featureSet",2);class Ts extends Si{constructor(){super(...arguments);r(this,"features")}}Nm(Ts,"Pack");$m([f(Si)],Ts.prototype,"features",2);var Wm=Object.defineProperty,EP=Object.getOwnPropertyDescriptor,Hm=(i,e)=>Wm(i,"name",{value:e,configurable:!0}),na=(i,e,t,s)=>{for(var n=s>1?void 0:s?EP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Wm(e,t,n),n};class zn{constructor(){r(this,"keys");r(this,"values")}}Hm(zn,"SerializedDictionary");na([f(De)],zn.prototype,"keys",2);na([f(Si)],zn.prototype,"values",2);class Gn extends v{constructor(){super(...arguments);r(this,"appliedFeatures");r(this,"featureSelections")}}Hm(Gn,"Configuration");na([f(zn)],Gn.prototype,"appliedFeatures",2);na([f(zn)],Gn.prototype,"featureSelections",2);var zm=Object.defineProperty,AP=Object.getOwnPropertyDescriptor,Kc=(i,e)=>zm(i,"name",{value:e,configurable:!0}),eh=(i,e,t,s)=>{for(var n=s>1?void 0:s?AP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&zm(e,t,n),n};class Ri extends v{constructor(){super(...arguments);r(this,"featureSets",[])}start(){const e=p.findObjectOfType(Ei);e&&(e.table=this)}}Kc(Ri,"VariantTable");eh([f(De)],Ri.prototype,"featureSets",2);class Vn extends Si{constructor(){super(...arguments);r(this,"assignments")}isActiveInVariant(e){var t,s;if(!this.assignments)return!1;for(const n of this.assignments)if((s=(t=n.targetQuery)==null?void 0:t.getResult())==null?void 0:s.includes(e))return!0;return!1}}Kc(Vn,"Variant");eh([f(Es)],Vn.prototype,"assignments",2);class ra extends De{constructor(){super(...arguments);r(this,"variantTable")}}Kc(ra,"VariantSet");eh([f(Ri)],ra.prototype,"variantTable",2);var TP=Object.defineProperty,LP=(i,e)=>TP(i,"name",{value:e,configurable:!0});const DP=O("debugforma"),mh=class extends v{constructor(){super(...arguments);r(this,"table")}awake(){DP&&console.log(this),this.table=p.findObjectOfType(Ri)}nextFeature(){var n,o,a;if(!((n=this.table)==null?void 0:n.featureSets))return;const e=mh.index++%this.table.featureSets.length,t=this.table.featureSets[e],s=t.features[Math.floor(Math.random()*t.features.length)];if(!s.name.startsWith("Pack"))return this.nextFeature();console.log(e,"SELECT",(a=(o=s==null?void 0:s.gameObject)==null?void 0:o.parent)==null?void 0:a.name,s==null?void 0:s.name,t),this.switchFeature(t,s)}switchFeature(e,t,s){const n=e instanceof sa,o=t instanceof Ts;if(n||o){const a=t;if(e==null||e.selectFeature(t),a==null?void 0:a.features)for(const l of a.features){if(!l)continue;let c=l.featureSet;l instanceof Ts&&(c=void 0),this.switchFeature(c,l,s)}}else if(t instanceof Vn){const a=t,l=e;e==null||e.selectFeature(a);for(const c of l.features){if(!c)continue;c===t?this.applyVariantAssignments(a):this.invertVariantAssignments(c,a)}}}applyVariantAssignments(e){if(e.assignments)for(const t of e.assignments)t.apply()}invertVariantAssignments(e,t){if(e.assignments)for(const s of e.assignments)s.invert(t)}};let Ei=mh;r(Ei,"index",0);LP(Ei,"Switcher");var Gm=Object.defineProperty,kP=Object.getOwnPropertyDescriptor,qn=(i,e)=>Gm(i,"name",{value:e,configurable:!0}),ot=(i,e,t,s)=>{for(var n=s>1?void 0:s?kP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Gm(e,t,n),n},Vm;(function(i){i[i.Active=0]="Active",i[i.Disabled=1]="Disabled",i[i.Hidden=2]="Hidden"})(Vm||(Vm={}));class Ls{constructor(){r(this,"description");r(this,"name");r(this,"thumbnail");r(this,"visibilityStatus")}}qn(Ls,"DisplayInfoContent");ot([f()],Ls.prototype,"description",2);ot([f()],Ls.prototype,"name",2);ot([f()],Ls.prototype,"visibilityStatus",2);class oa{constructor(){r(this,"target");r(this,"content")}}qn(oa,"FeatureDisplayInfo");ot([f(Si)],oa.prototype,"target",2);ot([f(Ls)],oa.prototype,"content",2);class aa{constructor(){r(this,"target");r(this,"content")}}qn(aa,"FeatureSetDisplayInfo");ot([f(De)],aa.prototype,"target",2);ot([f(Ls)],aa.prototype,"content",2);var gh;const th=(gh=class extends v{constructor(){super(...arguments);r(this,"variantTable");r(this,"featureSetDisplayInfos",[]);r(this,"featureDisplayInfos",[]);r(this,"switcher");r(this,"uiContainer");r(this,"uiParent");r(this,"selectFunctionsByFeatureId",new Map);r(this,"onIframeMessage",i=>{if(window===i.source)return;const{method:e,args:t}=i.data;if(e==="setVariant"){const s=t[0],n=this.selectFunctionsByFeatureId.get(s);n&&n()}})}awake(){this.switcher=p.findObjectOfType(Ei);const i=document.createElement("div");i.classList.add("selection-container"),this.uiContainer=i;const e=document.getElementById("forma-options");if(!e){console.error("Couldnt find forma-options");return}this.uiParent=e,th.engraving||(th.engraving=document.getElementById("engraving"))}saveSelectedFeature(i){}start(){for(const i of this.featureSetDisplayInfos)if(i.content.visibilityStatus===0){const e=i.content.name,t=[],s=i.target;for(const o of s.features){const a=this.findDisplayInfo(o);if(a){const l=qn(()=>{this.saveSelectedFeature(o.code),this.switcher.switchFeature(i.target,o)},"selectFn");t.push({label:a.name,select:l}),this.selectFunctionsByFeatureId.set(o.code,l)}else console.warn("Couldnt find: ",o)}const n=this.createDropdownWithItems(e,t);this.uiContainer.appendChild(n)}}onFinishedLoading(){}onEnable(){this.uiParent.appendChild(this.uiContainer),window.addEventListener("message",this.onIframeMessage,!1)}onDisable(){var i;(i=this.uiContainer)==null||i.remove(),window.removeEventListener("message",this.onIframeMessage,!1)}findDisplayInfo(i){for(const e of this.featureDisplayInfos)if(e.target===i)return e.content;return null}createDropdownWithItems(i,e){const t="div",s="button",n=document.createElement("div");n.classList.add("dropdown"),n.classList.add("variants");const o=document.createElement("h3");o.classList.add("dropdown-label"),o.innerText=i,n.appendChild(o);const a=document.createElement(t);a.classList.add("dropdown-list"),t.startsWith("select")&&a.addEventListener("change",l=>{const c=a.selectedIndex;e[c].select.call(a)}),n.appendChild(a);for(const l of e){const c=document.createElement(s);c.classList.add("dropdown-item"),c.innerText=l.label,a.appendChild(c),s.startsWith("button")&&c.addEventListener("click",()=>l.select.call(a))}return n}},r(gh,"engraving"),gh);let Ai=th;qn(Ai,"ProductRuntimeUIData");ot([f(Ri)],Ai.prototype,"variantTable",2);ot([f(aa)],Ai.prototype,"featureSetDisplayInfos",2);ot([f(oa)],Ai.prototype,"featureDisplayInfos",2);var qm=Object.defineProperty,IP=Object.getOwnPropertyDescriptor,ti=(i,e)=>qm(i,"name",{value:e,configurable:!0}),Qn=(i,e,t,s)=>{for(var n=s>1?void 0:s?IP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&qm(e,t,n),n};const at=O("debugforma")||O("debugformaselection");function Qm(){return 0}ti(Qm,"getLastSelectedProduct");function MP(i){}ti(MP,"saveLastSelectedProduct");class ih{constructor(){r(this,"product")}}ti(ih,"ProductReference");Qn([f(Te)],ih.prototype,"product",2);class la extends v{constructor(){super(...arguments);r(this,"productPrefabs");r(this,"productInstances",[]);r(this,"activeProductIndex",-1);r(this,"loadingProductIndex",-1);r(this,"activeProduct",null)}async awake(){at&&console.log(this),window.addEventListener("keydown",t=>{const s=Number.parseInt(t.key);s>0&&this.selectProduct(s-1)});let e=Qm();at&&console.log("Last selected product was: "+e),(e>=this.productPrefabs.length||e<0)&&(e=0),await this.selectProduct(e);for(let t=0;t<this.productPrefabs.length;t++)await this.loadProduct(t);window.addEventListener("message",t=>{if(window===t.source)return;const{method:s,args:n}=t.data;s==="switchProduct"&&this.selectProduct(n[0])},!1)}async selectProduct(e){if(at&&console.log(e),!(e===this.activeProductIndex||e===this.loadingProductIndex)){if(this.activeProduct&&p.remove(this.activeProduct),e>=this.productInstances.length||!this.productInstances[e]){if(e>=this.productPrefabs.length){at&&console.warn("Invalid index",e,this);return}await this.loadProduct(e)}if(at&&console.log("SELECT PRODUCT",e),this.activeProductIndex=e,this.activeProduct=this.productInstances[e],this.activeProduct){this.activeProduct;const t=this.gameObject;p.add(this.activeProduct,t),this.context.domElement.dispatchEvent(new CustomEvent("product-selected",{detail:this.activeProduct})),p.getComponentInChildren(t,Ai)}else at&&console.error("No product",e,this.activeProduct)}}async loadProduct(e){var n;if(this.productInstances[e]||this.loadingProductIndex===e)return;this.loadingProductIndex=e;const t=this.productPrefabs[e];at&&console.log("Begin loading: "+t.product.uri,e);const s=await t.product.loadAssetAsync();if(this.productInstances[e]=s,this.loadingProductIndex=-1,s){const o=p.getComponentInChildren(s,Ds);at&&console.log("Finished loading: "+((n=t.product)==null?void 0:n.uri)),o&&this.onLoadedProduct(o,e)}}onLoadedProduct(e,t){const s=e.definition.defaultThumbnail;ti(o=>{if(!o)return;o.classList.add("product");const a=document.querySelector("#forma-products");a&&(a.children.length>t?a.insertBefore(o,a.children[t]):a==null||a.appendChild(o),o.addEventListener("click",()=>{this.selectProduct(t)}))},"append")(gd(s,!1))}}ti(la,"ConfiguratorSettings");Qn([f(ih)],la.prototype,"productPrefabs",2);class sh{constructor(){r(this,"defaultThumbnail")}}ti(sh,"ProductDefinition");Qn([f(Hi)],sh.prototype,"defaultThumbnail",2);class Ds extends v{constructor(){super(...arguments);r(this,"modelSetPrefab");r(this,"definition");r(this,"awaken",!1)}async awake(){if(at&&console.log(this),this.modelSetPrefab){const e=await this.modelSetPrefab.loadAssetAsync();this.gameObject.add(e)}else console.error("missing modelsetprefab",this.modelSetPrefab);this.awaken=!0,window.parent.postMessage(["productLoaded"],"*")}onEnable(){this.awaken&&window.parent.postMessage(["productLoaded"],"*")}}ti(Ds,"Product");Qn([f(Te)],Ds.prototype,"modelSetPrefab",2);Qn([f(sh)],Ds.prototype,"definition",2);class nh extends v{awake(){at&&console.log(this)}}ti(nh,"ModelSet");var jP=Object.defineProperty,FP=(i,e)=>jP(i,"name",{value:e,configurable:!0});class rh extends v{}FP(rh,"Rules");m.add("GameObjectVisibilityAssignment",Xc);m.add("MaterialAssignment",Yc);m.add("CameraView",Kt);m.add("Configuration",Gn);m.add("Pack",Ts);m.add("FeatureBase",ei);m.add("FeatureSet",De);m.add("PackSet",sa);m.add("ConfiguratorSettings",la);m.add("Product",Ds);m.add("ModelSet",nh);m.add("ProductRuntimeUIData",Ai);m.add("QueryResults",Qc);m.add("StaticMaterialQueryNode",Qo);m.add("StaticBoolQueryNode",Xo);m.add("MaterialSlot",Rs);m.add("StaticListMaterialSlotQueryNode",Yo);m.add("StaticListGameObjectQueryNode",Jo);m.add("Rules",rh);m.add("Switcher",Ei);m.add("VariantTable",Ri);m.add("Variant",Vn);m.add("VariantSet",ra);var Xm=Object.defineProperty,BP=Object.getOwnPropertyDescriptor,UP=(i,e)=>Xm(i,"name",{value:e,configurable:!0}),Xn=(i,e,t,s)=>{for(var n=s>1?void 0:s?BP(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Xm(e,t,n),n},Yn;(function(i){i[i.Realtime=0]="Realtime",i[i.FixedTime=1]="FixedTime",i[i.FastForward=2]="FastForward"})(Yn||(Yn={}));var _h;const ks=(_h=class extends v{constructor(){super(...arguments);r(this,"hourHand",null);r(this,"minuteHand",null);r(this,"secondHand",null);r(this,"secondHandGraphics",null);r(this,"secondHandBlurred",null);r(this,"speed",1);r(this,"lastUpdate",-1e3);r(this,"baseUtc");r(this,"now_utc",0)}static saveClockMode(){window.localStorage.setItem("clockMode",this.clockMode.toString())}fullDate(i){return Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds())}awake(){const i=window.localStorage.getItem("clockMode");i&&(ks.clockMode=parseInt(i));const e=new Date;this.baseUtc=this.fullDate(e)}onEnable(){this.setTimeBasedOnClockMode(0),this.baseUtc=this.now_utc}setTimeBasedOnClockMode(i){const e=new Date;ks.clockMode===1?(e.setHours(10,10,36,0),this.now_utc=this.fullDate(e)):ks.clockMode===2?this.now_utc+=i*1e3*1e3:this.now_utc=this.fullDate(e)}update(){if(this.context.time.time-this.lastUpdate<.01)return;this.lastUpdate=this.context.time.time;let i=this.context.time.deltaTime;this.setTimeBasedOnClockMode(i),this.secondHandGraphics&&p.setActive(this.secondHandGraphics,ks.clockMode!==2),this.secondHandBlurred&&p.setActive(this.secondHandBlurred,ks.clockMode===2),this.baseUtc=L.lerp(this.baseUtc,this.now_utc,i*10);let e=new Date(this.baseUtc);const t=e.getSeconds();if(this.secondHand&&(this.secondHand.rotation.z=t/60*Math.PI*2),this.minuteHand){let s=e.getMinutes()+e.getSeconds()/60;this.minuteHand.rotation.z=s/60*Math.PI*2}if(this.hourHand){const s=e.getHours()+e.getMinutes()/60;this.hourHand.rotation.z=s/12*Math.PI*2}}},r(_h,"clockMode"),_h);let ge=ks;UP(ge,"Clock");Xn([f(x)],ge.prototype,"hourHand",2);Xn([f(x)],ge.prototype,"minuteHand",2);Xn([f(x)],ge.prototype,"secondHand",2);Xn([f(x)],ge.prototype,"secondHandGraphics",2);Xn([f(x)],ge.prototype,"secondHandBlurred",2);var NP=Object.defineProperty,Ym=(i,e)=>NP(i,"name",{value:e,configurable:!0});const ca=O("debugforma");function Jm(i,e){}Ym(Jm,"saveCameraPosition");class oh extends v{constructor(){super(...arguments);r(this,"orbit",null);r(this,"lastSelectedViewPointId")}start(){var e;this.orbit=p.findObjectOfType(Mt),this.startCoroutine(this.saveCameraView(),Ce.OnAfterRender),this.lastSelectedViewPointId="front",(e=this.setViewPoint)==null||e.call(this,this.lastSelectedViewPointId,!0),this.context.domElement.addEventListener("product-selected",async()=>{var t;(t=this.setViewPoint)==null||t.call(this,this.lastSelectedViewPointId,!0)}),this.context.time.time,Kt.viewRegisteredCallback=t=>{var s;t.id===this.lastSelectedViewPointId&&((s=this.setViewPoint)==null||s.call(this,t.id,!0))}}*saveCameraView(){var e;for(;;)if(yield,this.context.time.frameCount%90==0&&this.orbit){const t=this.orbit.controllerObject;Jm(t,(e=this.orbit.controls)==null?void 0:e.target)}}setRealtime(){ca&&console.log("REALTIME"),ge.clockMode=Yn.Realtime,ge.saveClockMode()}setFixedTime(){ca&&console.log("FIXED TIME"),ge.clockMode=Yn.FixedTime,ge.saveClockMode()}setFastForward(){ca&&console.log("FAST FORWARD"),ge.clockMode=Yn.FastForward,ge.saveClockMode()}setViewPoint(e,t=!1){this.lastSelectedViewPointId=e;const s=Kt.tryGetView(e);if(s&&this.orbit){ca&&console.log("SET CAMERA VIEW",e,s.fieldOfView);const n=R(s.gameObject);this.orbit.useSlerp=!0,this.orbit.setCameraTarget(n,t);const o=n.clone().addScaledVector(s.forward,s.targetDistance);this.orbit.setTarget(o,t),t&&this.orbit.controllerObject,this.context.mainCameraComponent&&(this.context.mainCameraComponent.fieldOfView=s.fieldOfView)}}}Ym(oh,"CartierViewer");var $P=Object.defineProperty,WP=(i,e)=>$P(i,"name",{value:e,configurable:!0});const Li=class extends v{constructor(){super(...arguments);r(this,"renderer");r(this,"cssHasLoaded",!1);r(this,"listener");r(this,"lastHistoryUpdate",new Date);r(this,"data",{engraving:`UNITY
\u2716
CARTIER`})}parseHashAndSetText(){var s;var e=window.location.hash.substring(1),t=e.split("&").reduce(function(n,o){var a=o.split("=");return n[a[0]]=decodeURIComponent(a[1]),n},{});this.data.engraving=(s=t.engraving)!=null?s:this.data.engraving,Li.input&&(Li.input.value=this.data.engraving),this.regenText()}start(){this.preLoadFont();const e=document.getElementById("engraving");if(e){if(!Li.input){const s=document.createElement("textarea");s.classList.add("dropdown-list"),s.rows=3,s.cols=11,e.appendChild(s),Li.input=s}const t=Li.input;t.value=this.data.engraving,t.addEventListener("input",s=>{if(s.target){const n=this.convertToEngravingText(t.value);t.value=n,this.data.engraving=n,this.regenTextAndSetHistory()}}),window.addEventListener("message",s=>{if(window===s.source)return;const{method:n,args:o}=s.data;if(n==="engrave"){const a=this.convertToEngravingText(o[0]);t.value=a,this.data.engraving=a,this.regenTextAndSetHistory()}})}this.parseHashAndSetText(),this.listener=this.refreshHash.bind(this),this.regenTextAndSetHistory()}refreshHash(e){e.preventDefault(),this.parseHashAndSetText()}onEnable(){window.addEventListener("hashchange",this.listener),this.renderer=p.getComponent(this.gameObject,X),this.regenText()}onDisable(){window.removeEventListener("hashchange",this.listener)}regenTextAndSetHistory(){const e=this;this.regenText();let t=new Date;(t.getTime()-this.lastHistoryUpdate.getTime())/1e3,this.lastHistoryUpdate=t;let s="Cartier \u2013";e.data.engraving&&(s+=" "+e.data.engraving);let n="#";e.data.engraving&&(n+="engraving="+encodeURIComponent(e.data.engraving)),document.title="Cartier \u2013 "+s,window.location.hash=n}regenText(){if(!this.renderer)return;const e=this.renderer.material;e&&(e.map=this.getTextureForText(null,this.data.engraving),e.needsUpdate=!0)}preLoadFont(){const e=this,t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href="https://fonts.googleapis.com/css2?family=Battambang&display=swap",document.getElementsByTagName("head")[0].appendChild(t),t.onload=function(){e.cssHasLoaded=!0};const s=document.createElement("p");s.textContent="font sampler",s.style.font="110pt 'Battambang', sans-serif",s.style.position="fixed",s.style.top="-1000px",document.getElementsByTagName("body")[0].appendChild(s)}getTextureForText(e,t){let s=t.toUpperCase().split(/\r?\n/);const n=document.createElement("canvas");n.width=1024,n.height=512;const o=n.getContext("2d");e&&o.drawImage(e,0,0,1024,512),o.font="80pt 'Battambang', sans-serif",o.textAlign="center",o.textBaseline="middle";var a=0;for(let h=0;h<s.length;h++)s[h]&&a++;const l=(3-a)*135/2;for(let h=0;h<s.length;h++){const d=512,u=135*h+135+l;o.fillStyle="#555",o.fillText(s[h],d,u)}const c=new Hi(n);return c.needsUpdate=!0,c.flipY=!1,c.wrapS=Nh,c.wrapT=Nh,c}convertToEngravingText(e){const t=e.split(`
`);for(let s=0;s<t.length;s++)t[s]=t[s].substring(0,11);return t.join(`
`)}};let Jn=Li;r(Jn,"input",null);WP(Jn,"Engraving");m.add("CartierViewer",oh);m.add("Clock",ge);m.add("Engraving",Jn);const ah={AlignmentConstraint:fl,Animation:Nt,AnimationCurve:Nr,Animator:_t,AnimatorController:hi,AudioListener:Zi,AudioSource:ae,AvatarModel:Wr,AvatarLoader:on,AxesHelper:Ki,BasicIKConstraint:yl,BoxCollider:vl,BoxHelperComponent:es,Camera:W,InstantiateOptions:Ae,UnityObject:Pl,DeleteBox:Hr,Deletable:xl,DeviceFlag:zr,DragControls:Pt,DropListener:fn,Duplicatable:fi,CallInfo:os,EventList:tt,EventTrigger:Tl,FlyControls:Ll,BoxGizmo:pn,GltfExportBox:Il,GltfExport:xt,GridHelper:as,Interactable:ts,UsageMarker:is,Light:Ot,LODModel:pi,LODGroup:gn,LookAtConstraint:Zs,MeshCollider:Bl,NavMesh:Ul,NavMeshAgent:Nl,NestedGltf:ho,Networking:It,OffsetConstraint:Wl,OrbitControls:Mt,ParticleSystemRenderer:uo,ParticleSystem:Ql,MainModule:zl,EmissionModule:Gl,ShapeModule:Vl,PlayerColor:St,FieldWithDefault:Qa,Renderer:X,MeshRenderer:vr,SkinnedMeshRenderer:Xa,InstancingUtil:ue,RendererLightmap:Qs,Rigidbody:hs,SceneSettings:Xl,ScreenCapture:Jl,ShadowCatcher:_n,SmoothFollow:bn,SpatialTriggerReceiver:ds,SpatialTrigger:yn,SpatialTriggerEventArgs:mo,SpectatorCamera:Kl,SphereCollider:vn,SpringJoint:ec,Sprite:bo,SpriteRenderer:us,SyncedCamera:wn,SyncedRoom:Vt,SyncedTransform:yt,TestRunner:nc,TestSimulateUserData:rc,TransformGizmo:vo,VideoPlayer:We,Voip:vt,VolumeParameter:ac,VolumeComponent:_i,ToneMapping:xn,ColorAdjustments:On,VolumeProfile:Cn,Volume:wo,WebARSessionRoot:cn,WebXR:D,WebAR:rs,AvatarMarker:ie,WebXRAvatar:wt,TeleportTarget:Kr,WebXRController:U,AttachedObject:$e,XRGrabModel:Po,XRGrabRendering:lc,XRRig:to,VRUserState:et,WebXRSync:dn,XRState:Ke,XRFlag:te,AvatarBlink_Simple:bi,AvatarEyeLook_Rotation:fs,Avatar_POI:le,Avatar_Brain_LookAt:ln,Avatar_MouthShapes:Sn,Avatar_MustacheShake:hc,LogStats:dc,RGBAColor:fe,PlayableDirector:gs,SignalAsset:Oo,SignalReceiverEvent:Co,SignalReceiver:Rn,AnimationTrackHandler:Ro,AudioTrackHandler:Eo,SignalTrackHandler:Tn,ControlTrackHandler:ms,BaseUIComponent:nt,UIRootComponent:Ln,Button:Et,Canvas:Xt,CanvasGroup:wc,EventSystem:Ge,Graphic:Qt,MaskableGraphic:kn,Image:In,RawImage:Do,Keyboard:xc,LayoutGroup:ys,VerticalLayoutGroup:Oc,HorizontalLayoutGroup:Cc,GridLayoutGroup:Sc,PointerEventData:yi,Raycaster:Mo,ObjectRaycaster:vs,GraphicRaycaster:Ec,Size:gc,Rect:Lo,RectTransform:Rt,SpatialHtml:Ac,Text:xe,PresentationMode:Lc,LinesDrawer:jn,LineInstanceHandler:ws,LinesManager:Mn,PlayerSync:Fo,PlayerState:wi,GameObjectVisibilityAssignment:Xc,MaterialAssignment:Yc,CameraView:Kt,Configuration:Gn,Pack:Ts,FeatureBase:ei,FeatureSet:De,PackSet:sa,ConfiguratorSettings:la,Product:Ds,ModelSet:nh,ProductRuntimeUIData:Ai,QueryResults:Qc,StaticMaterialQueryNode:Qo,StaticBoolQueryNode:Xo,MaterialSlot:Rs,StaticListMaterialSlotQueryNode:Yo,StaticListGameObjectQueryNode:Jo,Rules:rh,Switcher:Ei,VariantTable:Ri,Variant:Vn,VariantSet:ra,CartierViewer:oh,Clock:ge,Engraving:Jn},HP=async function(i,e){const t=i.scene;let s=i.new_scripts;const n=new ah.WebXR;n.guid="1558752838",s.push(n);const o=new x;o.name="WebXR",o.guid="1558752837",o.position.set(0,0,0),o.setRotationFromQuaternion(new P(0,0,0,1)),o.scale.set(1,1,1),t.add(o);const a=await Ss.loadSync(i,"/assets/glTFSceneRoot.glb",null,!1,ma=>{var Ns;return(Ns=e==null?void 0:e.progress)==null?void 0:Ns.call(e,{name:"glTFSceneRoot.glb",progress:ma,index:0,count:2})});a&&t.add(a.scene);const l=await Ss.loadSync(i,"/assets/configurator.glb",null,!1,ma=>{var Ns;return(Ns=e==null?void 0:e.progress)==null?void 0:Ns.call(e,{name:"configurator.glb",progress:ma,index:1,count:2})});l&&t.add(l.scene);const c=new x;c.name="Configurator_Commands",c.guid="1402226770",c.position.set(0,0,0),c.setRotationFromQuaternion(new P(0,0,0,1)),c.scale.set(1,1,1),t.add(c);const h=new x;h.name="Basic White URP-Environment_Item_Commands",h.guid="3532316757488195863_591734116",h.position.set(0,0,0),h.setRotationFromQuaternion(new P(0,0,0,1)),h.scale.set(1,1,1),c.add(h);const d=new x;d.name="enterCommands",d.guid="478680180110530203_591734116",d.position.set(0,0,0),d.setRotationFromQuaternion(new P(0,0,0,1)),d.scale.set(1,1,1),h.add(d);const u=new x;u.name="LoadScenesCommandAsync",u.guid="1444108630539135985_591734116",u.position.set(0,0,0),u.setRotationFromQuaternion(new P(0,0,0,1)),u.scale.set(1,1,1),d.add(u);const _=new x;_.name="ProductLocation",_.guid="5618824812863154791_591734116",_.position.set(0,0,0),_.setRotationFromQuaternion(new P(0,0,0,1)),_.scale.set(1,1,1),u.add(_);const b=new x;b.name="FadeScreenshotCommand",b.guid="1512364338642226418_591734116",b.position.set(0,0,0),b.setRotationFromQuaternion(new P(0,0,0,1)),b.scale.set(1,1,1),d.add(b);const w=new x;w.name="exitCommands",w.guid="1417800061085150591_591734116",w.position.set(0,0,0),w.setRotationFromQuaternion(new P(0,0,0,1)),w.scale.set(1,1,1),h.add(w);const C=new x;C.name="ScreenshotCommand",C.guid="1584644347193926774_591734116",C.position.set(0,0,0),C.setRotationFromQuaternion(new P(0,0,0,1)),C.scale.set(1,1,1),w.add(C);const S=new x;S.name="UnLoadScenesCommandAsync",S.guid="8659645434826632000_591734116",S.position.set(0,0,0),S.setRotationFromQuaternion(new P(0,0,0,1)),S.scale.set(1,1,1),w.add(S);const A=new x;A.name="settings",A.guid="8213127649432988281_591734116",A.position.set(0,0,0),A.setRotationFromQuaternion(new P(0,0,0,1)),A.scale.set(1,1,1),h.add(A);const M=new x;M.name="RenderScale",M.guid="1690333518",M.position.set(0,.5,.5850754),M.setRotationFromQuaternion(new P(0,0,0,1)),M.scale.set(1,1,1),t.add(M);const E=new x;E.name="WebGL",E.guid="1201392091",E.position.set(0,0,0),E.setRotationFromQuaternion(new P(0,0,0,1)),E.scale.set(1,1,1),t.add(E);const T=new x;T.name="WSTA0042",T.guid="554452470",T.position.set(0,0,0),T.setRotationFromQuaternion(new P(0,0,0,1)),T.scale.set(1,1,1),E.add(T);const I=new x;I.name="WSTA0051",I.guid="546553223",I.position.set(0,0,0),I.setRotationFromQuaternion(new P(0,0,0,1)),I.scale.set(1,1,1),E.add(I);const ke=new x;ke.name="WSTA0060",ke.guid="389821293",ke.position.set(0,0,0),ke.setRotationFromQuaternion(new P(0,0,0,1)),ke.scale.set(1,1,1),E.add(ke);const Ie=new x;Ie.name="WSTA0061",Ie.guid="1531544539",Ie.position.set(0,0,0),Ie.setRotationFromQuaternion(new P(0,0,0,1)),Ie.scale.set(1,1,1),E.add(Ie);const se=new x;se.name="W4TA0016",se.guid="551003252",se.position.set(0,0,0),se.setRotationFromQuaternion(new P(0,0,0,1)),se.scale.set(1,1,1),E.add(se);const Re=new x;Re.name="WSTA0041",Re.guid="1768805749",Re.position.set(0,0,0),Re.setRotationFromQuaternion(new P(0,0,0,1)),Re.scale.set(1,1,1),E.add(Re);const ht=new x;ht.name="WSTA0052",ht.guid="668917364",ht.position.set(0,0,0),ht.setRotationFromQuaternion(new P(0,0,0,1)),ht.scale.set(1,1,1),E.add(ht);const Di=new x;Di.name="WSTA0054",Di.guid="279129467",Di.position.set(0,0,0),Di.setRotationFromQuaternion(new P(0,0,0,1)),Di.scale.set(1,1,1),E.add(Di);const ki=new x;ki.name="WSTA0055",ki.guid="703560025",ki.position.set(0,0,0),ki.setRotationFromQuaternion(new P(0,0,0,1)),ki.scale.set(1,1,1),E.add(ki);const Ii=new x;Ii.name="WSTA0056",Ii.guid="785294166",Ii.position.set(0,0,0),Ii.setRotationFromQuaternion(new P(0,0,0,1)),Ii.scale.set(1,1,1),E.add(Ii);const Mi=new x;Mi.name="WSTA0059",Mi.guid="1712643218",Mi.position.set(0,0,0),Mi.setRotationFromQuaternion(new P(0,0,0,1)),Mi.scale.set(1,1,1),E.add(Mi);const ji=new x;ji.name="WSTA0062",ji.guid="886165866",ji.position.set(0,0,0),ji.setRotationFromQuaternion(new P(0,0,0,1)),ji.scale.set(1,1,1),E.add(ji);const Fi=new x;Fi.name="W4TA0017",Fi.guid="341267020",Fi.position.set(0,0,0),Fi.setRotationFromQuaternion(new P(0,0,0,1)),Fi.scale.set(1,1,1),E.add(Fi);const Bi=new x;Bi.name="WSTA0040",Bi.guid="300804564",Bi.position.set(0,0,0),Bi.setRotationFromQuaternion(new P(0,0,0,1)),Bi.scale.set(1,1,1),E.add(Bi);const Ui=new x;Ui.name="WSTA0053",Ui.guid="2129232266",Ui.position.set(0,0,0),Ui.setRotationFromQuaternion(new P(0,0,0,1)),Ui.scale.set(1,1,1),E.add(Ui);const Ni=new x;Ni.name="FPSLimiter",Ni.guid="770455322",Ni.position.set(0,0,0),Ni.setRotationFromQuaternion(new P(0,0,0,1)),Ni.scale.set(1,1,1),t.add(Ni);const ne=new ah.EventSystem;ne.guid="1097481835",s.push(ne);const $i=new x;$i.name="EventSystem",$i.guid="1097481836",$i.position.set(0,0,0),$i.setRotationFromQuaternion(new P(0,0,0,1)),$i.scale.set(1,1,1),t.add($i);const Us=new ah.CartierViewer;Us.guid="1859427921",s.push(Us);const Wi=new x;Wi.name="Cartier",Wi.guid="1859427922",Wi.position.set(0,0,0),Wi.setRotationFromQuaternion(new P(0,0,0,1)),Wi.scale.set(1,1,1),t.add(Wi),n.enabled=!0,n.enableVR=!1,n.enableAR=!0,n.defaultAvatar=null,n.createVRButton=!1,n.createARButton=!0,n.enabled=!0;const Me=Ss.tryFindObject("1558752837",t,!0);Me&&(Me.layers.set(0),Me.visible=!0,Me.userData.layer=0,Me.userData.name="WebXR",Me.userData.tag="Untagged",Me.userData.hideFlags=0,Me.userData.activeSelf=!0,Me.userData.static=!1,Me.guid="1558752837"),n.gameObject=Me,ne.enabled=!0,ne.firstSelected=null,ne.sendNavigationEvents=!0,ne.dragThreshold=10,ne.sendNavigationEvents=!0,ne.pixelDragThreshold=10,ne.currentInputModule=null,ne.firstSelectedGameObject=null,ne.currentSelectedGameObject=null,ne.isFocused=!0,ne.alreadySelecting=!1,ne.enabled=!0;const je=Ss.tryFindObject("1097481836",t,!0);je&&(je.layers.set(0),je.visible=!0,je.userData.layer=0,je.userData.name="EventSystem",je.userData.tag="Untagged",je.userData.hideFlags=0,je.userData.activeSelf=!0,je.userData.static=!1,je.guid="1097481836"),ne.gameObject=je,Us.enabled=!0,Us.enabled=!0;const Fe=Ss.tryFindObject("1859427922",t,!0);Fe&&(Fe.layers.set(0),Fe.visible=!0,Fe.userData.layer=0,Fe.userData.name="Cartier",Fe.userData.tag="Untagged",Fe.userData.hideFlags=0,Fe.userData.activeSelf=!0,Fe.userData.static=!1,Fe.guid="1859427922"),Us.gameObject=Fe,s=i.scripts};Ss.build_scene_functions.loadScene=HP;console.log("Made with \u2665 by \u{1F335} needle - https://needle.tools");
